<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="/_next/static/css/f8ad259a7d5c0bf2.css" data-precedence="next"/><link rel="stylesheet" href="/_next/static/css/2715c8fee6b9b9b3.css" data-precedence="next"/><link rel="preload" as="script" fetchPriority="low" href="/_next/static/chunks/webpack-b9e10351bdf2da00.js"/><script src="/_next/static/chunks/fd9d1056-046e85abdd898386.js" async=""></script><script src="/_next/static/chunks/23-7c06e0849434312b.js" async=""></script><script src="/_next/static/chunks/main-app-c5d9736a6945eeb9.js" async=""></script><script src="/_next/static/chunks/257-d6408e43d3a4c1f7.js" async=""></script><script src="/_next/static/chunks/231-75c2bb16e5311c25.js" async=""></script><script src="/_next/static/chunks/app/layout-5aac403eda8ffac1.js" async=""></script><script src="/_next/static/chunks/app/post/%5Bcategory%5D/%5Btitle%5D/page-bb1b5c27d30bc491.js" async=""></script><title>文章 | react源码阅读</title><meta name="description" content="新宸悦雨 博客 网站 个人网站"/><meta name="google-site-verification" content="LiZ4kQwHGTLadwCnDnrXngpwNqoQjmFOCOVTtr_PWVo"/><link rel="icon" href="/icon.svg?d2cf70afa15ddfd8" type="image/svg+xml" sizes="any"/><script src="/_next/static/chunks/polyfills-78c92fac7aa8fdd8.js" noModule=""></script></head><body class="min-h-screen bg-background font-sans antialiased __variable_aaf875"><script>!function(){try{var d=document.documentElement,c=d.classList;c.remove('light','dark');var e=localStorage.getItem('theme');if('system'===e||(!e&&true)){var t='(prefers-color-scheme: dark)',m=window.matchMedia(t);if(m.media!==t||m.matches){d.style.colorScheme = 'dark';c.add('dark')}else{d.style.colorScheme = 'light';c.add('light')}}else if(e){c.add(e|| '')}if(e==='light'||e==='dark')d.style.colorScheme=e}catch(e){}}()</script><script>
    function setColor() {
      const color = localStorage.getItem('primary-color')
      const el = document.documentElement
      el.classList.remove("rose","blue","green","orange")
      color && el.classList.add(color)
    }
    setColor()
  </script><header class="sticky top-0 z-50 w-full border-b border-primary/40 bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60"><div class="container flex h-14 max-w-screen-2xl items-center justify-between"><div class="mr-4 flex"><a class="mr-6 flex items-center space-x-2" href="/"><span class="inline-block w-8 h-8"><svg viewBox="0 0 64 64"><g fill="none" fill-rule="evenodd"><circle cx="32" cy="32" r="26" fill="hsl(var(--primary))"></circle><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="26" height="26" x="19" y="10" viewBox="0 0 24 24"><path fill="hsl(var(--background))" d="M5.438 2c-.512 0-1.02.203-1.407.594L2.594 4.03a1.987 1.987 0 0 0 0 2.813l2.125 2.125C3.977 10.46 3.207 12.016 3 12.375c-.469.813-1 1.617-1 2.625 0 1.473.805 2.746 2 3.438.184.105 4.188 2.906 4.188 2.906h.03C8.896 21.75 9.66 22 10.5 22h3c.832 0 1.613-.223 2.281-.625.38-.227 4.031-2.664 5.219-3.75.688-.633 1-1.621 1-2.625s-.414-1.754-1-2.625c-.277-.43-1.023-1.96-1.719-3.406l2.125-2.125a1.987 1.987 0 0 0 0-2.813L19.97 2.594a1.987 1.987 0 0 0-2.813 0l-1.5 1.5A2.2 2.2 0 0 0 15 4H9a2.8 2.8 0 0 0-.656.094l-1.5-1.5A1.98 1.98 0 0 0 5.437 2M9.5 10a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3m5 0a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3M12 13.813c.395 0 .79.054 1 .187.95.59 3 2.883 3 4 0 .559-1.328 1.781-2 2-.953.309-3.047.309-4 0-.672-.219-2-1.441-2-2 0-1.117 2.05-3.41 3-4 .21-.133.605-.187 1-.187M11 17c-.363 0-.57.43-.312.688l1.03 1.218c.16.16.403.16.563 0l1.031-1.218C13.57 17.43 13.364 17 13 17Z"></path></svg><text fill="hsl(var(--background))" data-text-alignment="C" font-family="Fira Mono" font-size="14" font-weight="700" letter-spacing="0.81" transform="translate(-4 33)"><tspan x="17.07" y="17">XCYY</tspan></text><circle cx="32" cy="32" r="30" stroke="hsl(var(--primary))" stroke-width="2"></circle></g></svg></span><span class="text-primary">新宸悦雨</span></a><nav class="hidden items-center gap-4 text-sm lg:gap-6 md:flex"><a class="transition-colors hover:text-primary/80 text-foreground/60" href="/">首页</a><a class="transition-colors hover:text-primary/80 text-primary" href="/post">博客</a></nav></div><nav class="flex items-center space-x-2"><button class="inline-flex items-center justify-center whitespace-nowrap text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 hover:bg-accent h-9 rounded-md px-3 text-primary hover:text-primary !fouse-visible:outline-none" type="button" id="radix-:R36ja:" aria-haspopup="menu" aria-expanded="false" data-state="closed"><span class="inline-block w-3 h-3 rounded-full bg-primary"></span><span class="sr-only">Toggle color</span></button><button class="inline-flex items-center justify-center whitespace-nowrap text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 hover:bg-accent h-9 rounded-md px-3 text-primary hover:text-primary !fouse-visible:outline-none" type="button" id="radix-:R56ja:" aria-haspopup="menu" aria-expanded="false" data-state="closed"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-sun h-[1.2rem] w-[1.2rem] rotate-0 scale-100 transition-all dark:-rotate-90 dark:scale-0"><circle cx="12" cy="12" r="4"></circle><path d="M12 2v2"></path><path d="M12 20v2"></path><path d="m4.93 4.93 1.41 1.41"></path><path d="m17.66 17.66 1.41 1.41"></path><path d="M2 12h2"></path><path d="M20 12h2"></path><path d="m6.34 17.66-1.41 1.41"></path><path d="m19.07 4.93-1.41 1.41"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-moon absolute h-[1.2rem] w-[1.2rem] rotate-90 scale-0 transition-all dark:rotate-0 dark:scale-100"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path></svg><span class="sr-only">Toggle theme</span></button><div class="md:hidden"><button class="inline-flex items-center justify-center whitespace-nowrap text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 hover:bg-accent h-9 rounded-md px-3 text-primary hover:text-primary !fouse-visible:outline-none" type="button" id="radix-:R76ja:" aria-haspopup="menu" aria-expanded="false" data-state="closed"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-list h-[1.2rem] w-[1.2rem] rotate-0 scale-100 transition-all"><line x1="8" x2="21" y1="6" y2="6"></line><line x1="8" x2="21" y1="12" y2="12"></line><line x1="8" x2="21" y1="18" y2="18"></line><line x1="3" x2="3.01" y1="6" y2="6"></line><line x1="3" x2="3.01" y1="12" y2="12"></line><line x1="3" x2="3.01" y1="18" y2="18"></line></svg><span class="sr-only">Toggle Nav</span></button></div></nav></div></header><main class="container max-w-screen-2xl py-6"><div><h1 class="text-3xl font-semibold">react源码阅读</h1><div class="fixed right-12 bottom-20 "><button class="inline-flex items-center justify-center whitespace-nowrap text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 p-3 rounded-full h-12 w-12 shadow-md shadow-primary" type="button" id="radix-:Rkvfffaja:" aria-haspopup="menu" aria-expanded="false" data-state="closed">目录</button></div><div class="page_content__nM6Lc">
<h1 id="react数据结构定义">React数据结构定义</h1>
<h2 id="reactfiberroot">ReactFiberRoot</h2>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// packages\react-reconciler\src\ReactFiberRoot.js</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">FiberRootNode</span>(<span class="hljs-params">containerInfo, tag, hydrate</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">tag</span> = tag;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">current</span> = <span class="hljs-literal">null</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">containerInfo</span> = containerInfo;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">pendingChildren</span> = <span class="hljs-literal">null</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">pingCache</span> = <span class="hljs-literal">null</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">finishedExpirationTime</span> = <span class="hljs-title class_">NoWork</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">finishedWork</span> = <span class="hljs-literal">null</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">timeoutHandle</span> = noTimeout;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span> = <span class="hljs-literal">null</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">pendingContext</span> = <span class="hljs-literal">null</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">hydrate</span> = hydrate;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">firstBatch</span> = <span class="hljs-literal">null</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">callbackNode</span> = <span class="hljs-literal">null</span>;
  <span class="hljs-comment">// NoPriority 详见React类型/常量定义-SchedulerWithReactIntegration.js</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">callbackPriority</span> = <span class="hljs-title class_">NoPriority</span>;
  <span class="hljs-comment">// NoWork 详见React类型/常量定义-ReactFiberExpirationTime.js</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">firstPendingTime</span> = <span class="hljs-title class_">NoWork</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">firstSuspendedTime</span> = <span class="hljs-title class_">NoWork</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">lastSuspendedTime</span> = <span class="hljs-title class_">NoWork</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">nextKnownPendingLevel</span> = <span class="hljs-title class_">NoWork</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">lastPingedTime</span> = <span class="hljs-title class_">NoWork</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">lastExpiredTime</span> = <span class="hljs-title class_">NoWork</span>;

  <span class="hljs-keyword">if</span> (enableSchedulerTracing) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">interactionThreadID</span> = <span class="hljs-title function_">unstable_getThreadID</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">memoizedInteractions</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">pendingInteractionMap</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
  }
  <span class="hljs-keyword">if</span> (enableSuspenseCallback) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">hydrationCallbacks</span> = <span class="hljs-literal">null</span>;
  }
}
</code></pre>
<h2 id="reactfiber">ReactFiber</h2>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// packages\react-reconciler\src\ReactFiber.js</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">FiberNode</span>(<span class="hljs-params">
  tag: WorkTag,
  pendingProps: mixed,
  key: <span class="hljs-literal">null</span> | string,
  mode: TypeOfMode,
</span>) {
  <span class="hljs-comment">// Instance</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">tag</span> = tag;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">key</span> = key;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">elementType</span> = <span class="hljs-literal">null</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">type</span> = <span class="hljs-literal">null</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">stateNode</span> = <span class="hljs-literal">null</span>;

  <span class="hljs-comment">// Fiber</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">return</span> = <span class="hljs-literal">null</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">child</span> = <span class="hljs-literal">null</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">sibling</span> = <span class="hljs-literal">null</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">index</span> = <span class="hljs-number">0</span>;

  <span class="hljs-variable language_">this</span>.<span class="hljs-property">ref</span> = <span class="hljs-literal">null</span>;

  <span class="hljs-variable language_">this</span>.<span class="hljs-property">pendingProps</span> = pendingProps;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">memoizedProps</span> = <span class="hljs-literal">null</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">updateQueue</span> = <span class="hljs-literal">null</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">memoizedState</span> = <span class="hljs-literal">null</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">dependencies</span> = <span class="hljs-literal">null</span>;

  <span class="hljs-variable language_">this</span>.<span class="hljs-property">mode</span> = mode;

  <span class="hljs-comment">// Effects</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">effectTag</span> = <span class="hljs-title class_">NoEffect</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">nextEffect</span> = <span class="hljs-literal">null</span>;

  <span class="hljs-variable language_">this</span>.<span class="hljs-property">firstEffect</span> = <span class="hljs-literal">null</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">lastEffect</span> = <span class="hljs-literal">null</span>;

  <span class="hljs-variable language_">this</span>.<span class="hljs-property">expirationTime</span> = <span class="hljs-title class_">NoWork</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">childExpirationTime</span> = <span class="hljs-title class_">NoWork</span>;

  <span class="hljs-variable language_">this</span>.<span class="hljs-property">alternate</span> = <span class="hljs-literal">null</span>;

  <span class="hljs-keyword">if</span> (enableProfilerTimer) {
    <span class="hljs-comment">// Note: The following is done to avoid a v8 performance cliff.</span>
    <span class="hljs-comment">//</span>
    <span class="hljs-comment">// Initializing the fields below to smis and later updating them with</span>
    <span class="hljs-comment">// double values will cause Fibers to end up having separate shapes.</span>
    <span class="hljs-comment">// This behavior/bug has something to do with Object.preventExtension().</span>
    <span class="hljs-comment">// Fortunately this only impacts DEV builds.</span>
    <span class="hljs-comment">// Unfortunately it makes React unusably slow for some applications.</span>
    <span class="hljs-comment">// To work around this, initialize the fields below with doubles.</span>
    <span class="hljs-comment">//</span>
    <span class="hljs-comment">// Learn more about this here:</span>
    <span class="hljs-comment">// https://github.com/facebook/react/issues/14365</span>
    <span class="hljs-comment">// https://bugs.chromium.org/p/v8/issues/detail?id=8538</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">actualDuration</span> = <span class="hljs-title class_">Number</span>.<span class="hljs-property">NaN</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">actualStartTime</span> = <span class="hljs-title class_">Number</span>.<span class="hljs-property">NaN</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">selfBaseDuration</span> = <span class="hljs-title class_">Number</span>.<span class="hljs-property">NaN</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">treeBaseDuration</span> = <span class="hljs-title class_">Number</span>.<span class="hljs-property">NaN</span>;

    <span class="hljs-comment">// It's okay to replace the initial doubles with smis after initialization.</span>
    <span class="hljs-comment">// This won't trigger the performance cliff mentioned above,</span>
    <span class="hljs-comment">// and it simplifies other profiler code (including DevTools).</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">actualDuration</span> = <span class="hljs-number">0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">actualStartTime</span> = -<span class="hljs-number">1</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">selfBaseDuration</span> = <span class="hljs-number">0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">treeBaseDuration</span> = <span class="hljs-number">0</span>;
  }

  <span class="hljs-comment">// This is normally DEV-only except www when it adds listeners.</span>
  <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> remove the User Timing integration in favor of Root Events.</span>
  <span class="hljs-keyword">if</span> (enableUserTimingAPI) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_debugID</span> = debugCounter++;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_debugIsCurrentlyTiming</span> = <span class="hljs-literal">false</span>;
  }

  <span class="hljs-keyword">if</span> (__DEV__) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_debugSource</span> = <span class="hljs-literal">null</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_debugOwner</span> = <span class="hljs-literal">null</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_debugNeedsRemount</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_debugHookTypes</span> = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">if</span> (!hasBadMapPolyfill &#x26;&#x26; <span class="hljs-keyword">typeof</span> <span class="hljs-title class_">Object</span>.<span class="hljs-property">preventExtensions</span> === <span class="hljs-string">'function'</span>) {
      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">preventExtensions</span>(<span class="hljs-variable language_">this</span>);
    }
  }
}
</code></pre>
<h2 id="update">Update</h2>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// packages\react-reconciler\src\ReactUpdateQueue.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createUpdate</span>(<span class="hljs-params">
  expirationTime: ExpirationTime,
  suspenseConfig: <span class="hljs-literal">null</span> | SuspenseConfig,
</span>): <span class="hljs-title class_">Update</span>&#x3C;*> {
  <span class="hljs-keyword">let</span> <span class="hljs-attr">update</span>: <span class="hljs-title class_">Update</span>&#x3C;*> = {
    expirationTime,
    suspenseConfig,

    <span class="hljs-attr">tag</span>: <span class="hljs-title class_">UpdateState</span>,
    <span class="hljs-attr">payload</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">callback</span>: <span class="hljs-literal">null</span>,

    <span class="hljs-attr">next</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">nextEffect</span>: <span class="hljs-literal">null</span>,
  };
  <span class="hljs-keyword">if</span> (__DEV__) {
    update.<span class="hljs-property">priority</span> = <span class="hljs-title function_">getCurrentPriorityLevel</span>();
  }
  <span class="hljs-keyword">return</span> update;
}
</code></pre>
<h2 id="updatequeue">UpdateQueue</h2>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// packages\react-reconciler\src\ReactUpdateQueue.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> createUpdateQueue&#x3C;<span class="hljs-title class_">State</span>>(<span class="hljs-attr">baseState</span>: <span class="hljs-title class_">State</span>): <span class="hljs-title class_">UpdateQueue</span>&#x3C;<span class="hljs-title class_">State</span>> {
  <span class="hljs-keyword">const</span> <span class="hljs-attr">queue</span>: <span class="hljs-title class_">UpdateQueue</span>&#x3C;<span class="hljs-title class_">State</span>> = {
    baseState,
    <span class="hljs-attr">firstUpdate</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">lastUpdate</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">firstCapturedUpdate</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">lastCapturedUpdate</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">firstEffect</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">lastEffect</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">firstCapturedEffect</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">lastCapturedEffect</span>: <span class="hljs-literal">null</span>,
  };
  <span class="hljs-keyword">return</span> queue;
}
</code></pre>
<h1 id="react类型常量定义">React类型/常量定义</h1>
<h2 id="reactroottagsjs">ReactRootTags.js</h2>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// packages\shared\ReactRootTags.js</span>
<span class="hljs-keyword">export</span> type <span class="hljs-title class_">RootTag</span> = <span class="hljs-number">0</span> | <span class="hljs-number">1</span> | <span class="hljs-number">2</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">LegacyRoot</span> = <span class="hljs-number">0</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">BatchedRoot</span> = <span class="hljs-number">1</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">ConcurrentRoot</span> = <span class="hljs-number">2</span>;
</code></pre>
<h2 id="reactfiberexpirationtimejs">ReactFiberExpirationTime.js</h2>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// packages\react-reconciler\src\ReactFiberExpirationTime.js</span>

<span class="hljs-keyword">import</span> type {<span class="hljs-title class_">ReactPriorityLevel</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./SchedulerWithReactIntegration'</span>;

<span class="hljs-keyword">import</span> <span class="hljs-variable constant_">MAX_SIGNED_31_BIT_INT</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./maxSigned31BitInt'</span>;

<span class="hljs-keyword">import</span> {
  <span class="hljs-title class_">ImmediatePriority</span>,
  <span class="hljs-title class_">UserBlockingPriority</span>,
  <span class="hljs-title class_">NormalPriority</span>,
  <span class="hljs-title class_">IdlePriority</span>,
} <span class="hljs-keyword">from</span> <span class="hljs-string">'./SchedulerWithReactIntegration'</span>;

<span class="hljs-keyword">export</span> type <span class="hljs-title class_">ExpirationTime</span> = number;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">NoWork</span> = <span class="hljs-number">0</span>;
<span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> Think of a better name for Never. The key difference with Idle is that</span>
<span class="hljs-comment">// Never work can be committed in an inconsistent state without tearing the UI.</span>
<span class="hljs-comment">// The main example is offscreen content, like a hidden subtree. So one possible</span>
<span class="hljs-comment">// name is Offscreen. However, it also includes dehydrated Suspense boundaries,</span>
<span class="hljs-comment">// which are inconsistent in the sense that they haven't finished yet, but</span>
<span class="hljs-comment">// aren't visibly inconsistent because the server rendered HTML matches what the</span>
<span class="hljs-comment">// hydrated tree would look like.</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">Never</span> = <span class="hljs-number">1</span>;
<span class="hljs-comment">// Idle is slightly higher priority than Never. It must completely finish in</span>
<span class="hljs-comment">// order to be consistent.</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">Idle</span> = <span class="hljs-number">2</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">Sync</span> = <span class="hljs-variable constant_">MAX_SIGNED_31_BIT_INT</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">Batched</span> = <span class="hljs-title class_">Sync</span> - <span class="hljs-number">1</span>;

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">UNIT_SIZE</span> = <span class="hljs-number">10</span>;
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MAGIC_NUMBER_OFFSET</span> = <span class="hljs-title class_">Batched</span> - <span class="hljs-number">1</span>;

<span class="hljs-comment">// 1 unit of expiration time represents 10ms.</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">msToExpirationTime</span>(<span class="hljs-params">ms: number</span>): <span class="hljs-title class_">ExpirationTime</span> {
  <span class="hljs-comment">// Always add an offset so that we don't clash with the magic number for NoWork.</span>
  <span class="hljs-keyword">return</span> <span class="hljs-variable constant_">MAGIC_NUMBER_OFFSET</span> - ((ms / <span class="hljs-variable constant_">UNIT_SIZE</span>) | <span class="hljs-number">0</span>);
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">expirationTimeToMs</span>(<span class="hljs-params">expirationTime: ExpirationTime</span>): number {
  <span class="hljs-keyword">return</span> (<span class="hljs-variable constant_">MAGIC_NUMBER_OFFSET</span> - expirationTime) * <span class="hljs-variable constant_">UNIT_SIZE</span>;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">ceiling</span>(<span class="hljs-params">num: number, precision: number</span>): number {
  <span class="hljs-keyword">return</span> (((num / precision) | <span class="hljs-number">0</span>) + <span class="hljs-number">1</span>) * precision;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">computeExpirationBucket</span>(<span class="hljs-params">
  currentTime,
  expirationInMs,
  bucketSizeMs,
</span>): <span class="hljs-title class_">ExpirationTime</span> {
  <span class="hljs-keyword">return</span> (
    <span class="hljs-variable constant_">MAGIC_NUMBER_OFFSET</span> -
    <span class="hljs-title function_">ceiling</span>(
      <span class="hljs-variable constant_">MAGIC_NUMBER_OFFSET</span> - currentTime + expirationInMs / <span class="hljs-variable constant_">UNIT_SIZE</span>,
      bucketSizeMs / <span class="hljs-variable constant_">UNIT_SIZE</span>,
    )
  );
}

<span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> This corresponds to Scheduler's NormalPriority, not LowPriority. Update</span>
<span class="hljs-comment">// the names to reflect.</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">LOW_PRIORITY_EXPIRATION</span> = <span class="hljs-number">5000</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">LOW_PRIORITY_BATCH_SIZE</span> = <span class="hljs-number">250</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">computeAsyncExpiration</span>(<span class="hljs-params">
  currentTime: ExpirationTime,
</span>): <span class="hljs-title class_">ExpirationTime</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">computeExpirationBucket</span>(
    currentTime,
    <span class="hljs-variable constant_">LOW_PRIORITY_EXPIRATION</span>,
    <span class="hljs-variable constant_">LOW_PRIORITY_BATCH_SIZE</span>,
  );
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">computeSuspenseExpiration</span>(<span class="hljs-params">
  currentTime: ExpirationTime,
  timeoutMs: number,
</span>): <span class="hljs-title class_">ExpirationTime</span> {
  <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> Should we warn if timeoutMs is lower than the normal pri expiration time?</span>
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">computeExpirationBucket</span>(
    currentTime,
    timeoutMs,
    <span class="hljs-variable constant_">LOW_PRIORITY_BATCH_SIZE</span>,
  );
}

<span class="hljs-comment">// We intentionally set a higher expiration time for interactive updates in</span>
<span class="hljs-comment">// dev than in production.</span>
<span class="hljs-comment">//</span>
<span class="hljs-comment">// If the main thread is being blocked so long that you hit the expiration,</span>
<span class="hljs-comment">// it's a problem that could be solved with better scheduling.</span>
<span class="hljs-comment">//</span>
<span class="hljs-comment">// People will be more likely to notice this and fix it with the long</span>
<span class="hljs-comment">// expiration time in development.</span>
<span class="hljs-comment">//</span>
<span class="hljs-comment">// In production we opt for better UX at the risk of masking scheduling</span>
<span class="hljs-comment">// problems, by expiring fast.</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">HIGH_PRIORITY_EXPIRATION</span> = __DEV__ ? <span class="hljs-number">500</span> : <span class="hljs-number">150</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">HIGH_PRIORITY_BATCH_SIZE</span> = <span class="hljs-number">100</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">computeInteractiveExpiration</span>(<span class="hljs-params">currentTime: ExpirationTime</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">computeExpirationBucket</span>(
    currentTime,
    <span class="hljs-variable constant_">HIGH_PRIORITY_EXPIRATION</span>,
    <span class="hljs-variable constant_">HIGH_PRIORITY_BATCH_SIZE</span>,
  );
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">inferPriorityFromExpirationTime</span>(<span class="hljs-params">
  currentTime: ExpirationTime,
  expirationTime: ExpirationTime,
</span>): <span class="hljs-title class_">ReactPriorityLevel</span> {
  <span class="hljs-keyword">if</span> (expirationTime === <span class="hljs-title class_">Sync</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">ImmediatePriority</span>;
  }
  <span class="hljs-keyword">if</span> (expirationTime === <span class="hljs-title class_">Never</span> || expirationTime === <span class="hljs-title class_">Idle</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">IdlePriority</span>;
  }
  <span class="hljs-keyword">const</span> msUntil =
    <span class="hljs-title function_">expirationTimeToMs</span>(expirationTime) - <span class="hljs-title function_">expirationTimeToMs</span>(currentTime);
  <span class="hljs-keyword">if</span> (msUntil &#x3C;= <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">ImmediatePriority</span>;
  }
  <span class="hljs-keyword">if</span> (msUntil &#x3C;= <span class="hljs-variable constant_">HIGH_PRIORITY_EXPIRATION</span> + <span class="hljs-variable constant_">HIGH_PRIORITY_BATCH_SIZE</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">UserBlockingPriority</span>;
  }
  <span class="hljs-keyword">if</span> (msUntil &#x3C;= <span class="hljs-variable constant_">LOW_PRIORITY_EXPIRATION</span> + <span class="hljs-variable constant_">LOW_PRIORITY_BATCH_SIZE</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">NormalPriority</span>;
  }

  <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> Handle LowPriority</span>

  <span class="hljs-comment">// Assume anything lower has idle priority</span>
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">IdlePriority</span>;
}

</code></pre>
<h2 id="schedulerwithreactintegrationjs">SchedulerWithReactIntegration.js</h2>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// packages\react-reconciler\src\SchedulerWithReactIntegration.js</span>
<span class="hljs-comment">/**
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 *
 * <span class="hljs-doctag">@flow</span>
 */</span>

<span class="hljs-comment">// Intentionally not named imports because Rollup would use dynamic dispatch for</span>
<span class="hljs-comment">// CommonJS interop named imports.</span>
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-title class_">Scheduler</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'scheduler'</span>;
<span class="hljs-keyword">import</span> {__interactionsRef} <span class="hljs-keyword">from</span> <span class="hljs-string">'scheduler/tracing'</span>;
<span class="hljs-keyword">import</span> {enableSchedulerTracing} <span class="hljs-keyword">from</span> <span class="hljs-string">'shared/ReactFeatureFlags'</span>;
<span class="hljs-keyword">import</span> invariant <span class="hljs-keyword">from</span> <span class="hljs-string">'shared/invariant'</span>;

<span class="hljs-keyword">const</span> {
  <span class="hljs-attr">unstable_runWithPriority</span>: <span class="hljs-title class_">Scheduler</span>_runWithPriority,
  <span class="hljs-attr">unstable_scheduleCallback</span>: <span class="hljs-title class_">Scheduler</span>_scheduleCallback,
  <span class="hljs-attr">unstable_cancelCallback</span>: <span class="hljs-title class_">Scheduler</span>_cancelCallback,
  <span class="hljs-attr">unstable_shouldYield</span>: <span class="hljs-title class_">Scheduler</span>_shouldYield,
  <span class="hljs-attr">unstable_requestPaint</span>: <span class="hljs-title class_">Scheduler</span>_requestPaint,
  <span class="hljs-attr">unstable_now</span>: <span class="hljs-title class_">Scheduler</span>_now,
  <span class="hljs-attr">unstable_getCurrentPriorityLevel</span>: <span class="hljs-title class_">Scheduler</span>_getCurrentPriorityLevel,
  <span class="hljs-attr">unstable_ImmediatePriority</span>: <span class="hljs-title class_">Scheduler</span>_ImmediatePriority,
  <span class="hljs-attr">unstable_UserBlockingPriority</span>: <span class="hljs-title class_">Scheduler</span>_UserBlockingPriority,
  <span class="hljs-attr">unstable_NormalPriority</span>: <span class="hljs-title class_">Scheduler</span>_NormalPriority,
  <span class="hljs-attr">unstable_LowPriority</span>: <span class="hljs-title class_">Scheduler</span>_LowPriority,
  <span class="hljs-attr">unstable_IdlePriority</span>: <span class="hljs-title class_">Scheduler</span>_IdlePriority,
} = <span class="hljs-title class_">Scheduler</span>;

<span class="hljs-keyword">if</span> (enableSchedulerTracing) {
  <span class="hljs-comment">// Provide explicit error message when production+profiling bundle of e.g.</span>
  <span class="hljs-comment">// react-dom is used with production (non-profiling) bundle of</span>
  <span class="hljs-comment">// scheduler/tracing</span>
  <span class="hljs-title function_">invariant</span>(
    __interactionsRef != <span class="hljs-literal">null</span> &#x26;&#x26; __interactionsRef.<span class="hljs-property">current</span> != <span class="hljs-literal">null</span>,
    <span class="hljs-string">'It is not supported to run the profiling version of a renderer (for '</span> +
      <span class="hljs-string">'example, `react-dom/profiling`) without also replacing the '</span> +
      <span class="hljs-string">'`scheduler/tracing` module with `scheduler/tracing-profiling`. Your '</span> +
      <span class="hljs-string">'bundler might have a setting for aliasing both modules. Learn more at '</span> +
      <span class="hljs-string">'http://fb.me/react-profiling'</span>,
  );
}

<span class="hljs-keyword">export</span> type <span class="hljs-title class_">ReactPriorityLevel</span> = <span class="hljs-number">99</span> | <span class="hljs-number">98</span> | <span class="hljs-number">97</span> | <span class="hljs-number">96</span> | <span class="hljs-number">95</span> | <span class="hljs-number">90</span>;
<span class="hljs-keyword">export</span> type <span class="hljs-title class_">SchedulerCallback</span> = <span class="hljs-function">(<span class="hljs-params">isSync: boolean</span>) =></span> <span class="hljs-title class_">SchedulerCallback</span> | <span class="hljs-literal">null</span>;

type <span class="hljs-title class_">SchedulerCallbackOptions</span> = {
  timeout?: number,
};

<span class="hljs-keyword">const</span> fakeCallbackNode = {};

<span class="hljs-comment">// Except for NoPriority, these correspond to Scheduler priorities. We use</span>
<span class="hljs-comment">// ascending numbers so we can compare them like numbers. They start at 90 to</span>
<span class="hljs-comment">// avoid clashing with Scheduler's priorities.</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">ImmediatePriority</span>: <span class="hljs-title class_">ReactPriorityLevel</span> = <span class="hljs-number">99</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">UserBlockingPriority</span>: <span class="hljs-title class_">ReactPriorityLevel</span> = <span class="hljs-number">98</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">NormalPriority</span>: <span class="hljs-title class_">ReactPriorityLevel</span> = <span class="hljs-number">97</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">LowPriority</span>: <span class="hljs-title class_">ReactPriorityLevel</span> = <span class="hljs-number">96</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">IdlePriority</span>: <span class="hljs-title class_">ReactPriorityLevel</span> = <span class="hljs-number">95</span>;
<span class="hljs-comment">// NoPriority is the absence of priority. Also React-only.</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">NoPriority</span>: <span class="hljs-title class_">ReactPriorityLevel</span> = <span class="hljs-number">90</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> shouldYield = <span class="hljs-title class_">Scheduler</span>_shouldYield;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> requestPaint =
  <span class="hljs-comment">// Fall back gracefully if we're running an older version of Scheduler.</span>
  <span class="hljs-title class_">Scheduler</span>_requestPaint !== <span class="hljs-literal">undefined</span> ? <span class="hljs-title class_">Scheduler</span>_requestPaint : <span class="hljs-function">() =></span> {};

<span class="hljs-keyword">let</span> <span class="hljs-attr">syncQueue</span>: <span class="hljs-title class_">Array</span>&#x3C;<span class="hljs-title class_">SchedulerCallback</span>> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;
<span class="hljs-keyword">let</span> <span class="hljs-attr">immediateQueueCallbackNode</span>: mixed | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;
<span class="hljs-keyword">let</span> <span class="hljs-attr">isFlushingSyncQueue</span>: boolean = <span class="hljs-literal">false</span>;
<span class="hljs-keyword">let</span> <span class="hljs-attr">initialTimeMs</span>: number = <span class="hljs-title class_">Scheduler</span>_now();

<span class="hljs-comment">// If the initial timestamp is reasonably small, use Scheduler's `now` directly.</span>
<span class="hljs-comment">// This will be the case for modern browsers that support `performance.now`. In</span>
<span class="hljs-comment">// older browsers, Scheduler falls back to `Date.now`, which returns a Unix</span>
<span class="hljs-comment">// timestamp. In that case, subtract the module initialization time to simulate</span>
<span class="hljs-comment">// the behavior of performance.now and keep our times small enough to fit</span>
<span class="hljs-comment">// within 32 bits.</span>
<span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> Consider lifting this into Scheduler.</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> now =
  initialTimeMs &#x3C; <span class="hljs-number">10000</span> ? <span class="hljs-title class_">Scheduler</span>_now : <span class="hljs-function">() =></span> <span class="hljs-title class_">Scheduler</span>_now() - initialTimeMs;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getCurrentPriorityLevel</span>(<span class="hljs-params"></span>): <span class="hljs-title class_">ReactPriorityLevel</span> {
  <span class="hljs-keyword">switch</span> (<span class="hljs-title class_">Scheduler</span>_getCurrentPriorityLevel()) {
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">Scheduler</span><span class="hljs-attr">_ImmediatePriority</span>:
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">ImmediatePriority</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">Scheduler</span><span class="hljs-attr">_UserBlockingPriority</span>:
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">UserBlockingPriority</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">Scheduler</span><span class="hljs-attr">_NormalPriority</span>:
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">NormalPriority</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">Scheduler</span><span class="hljs-attr">_LowPriority</span>:
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">LowPriority</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">Scheduler</span><span class="hljs-attr">_IdlePriority</span>:
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">IdlePriority</span>;
    <span class="hljs-attr">default</span>:
      <span class="hljs-title function_">invariant</span>(<span class="hljs-literal">false</span>, <span class="hljs-string">'Unknown priority level.'</span>);
  }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">reactPriorityToSchedulerPriority</span>(<span class="hljs-params">reactPriorityLevel</span>) {
  <span class="hljs-keyword">switch</span> (reactPriorityLevel) {
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">ImmediatePriority</span>:
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">Scheduler</span>_ImmediatePriority;
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">UserBlockingPriority</span>:
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">Scheduler</span>_UserBlockingPriority;
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">NormalPriority</span>:
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">Scheduler</span>_NormalPriority;
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">LowPriority</span>:
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">Scheduler</span>_LowPriority;
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">IdlePriority</span>:
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">Scheduler</span>_IdlePriority;
    <span class="hljs-attr">default</span>:
      <span class="hljs-title function_">invariant</span>(<span class="hljs-literal">false</span>, <span class="hljs-string">'Unknown priority level.'</span>);
  }
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> runWithPriority&#x3C;T>(
  <span class="hljs-attr">reactPriorityLevel</span>: <span class="hljs-title class_">ReactPriorityLevel</span>,
  <span class="hljs-attr">fn</span>: <span class="hljs-function">() =></span> T,
): T {
  <span class="hljs-keyword">const</span> priorityLevel = <span class="hljs-title function_">reactPriorityToSchedulerPriority</span>(reactPriorityLevel);
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Scheduler</span>_runWithPriority(priorityLevel, fn);
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">scheduleCallback</span>(<span class="hljs-params">
  reactPriorityLevel: ReactPriorityLevel,
  callback: SchedulerCallback,
  options: SchedulerCallbackOptions | <span class="hljs-keyword">void</span> | <span class="hljs-literal">null</span>,
</span>) {
  <span class="hljs-keyword">const</span> priorityLevel = <span class="hljs-title function_">reactPriorityToSchedulerPriority</span>(reactPriorityLevel);
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Scheduler</span>_scheduleCallback(priorityLevel, callback, options);
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">scheduleSyncCallback</span>(<span class="hljs-params">callback: SchedulerCallback</span>) {
  <span class="hljs-comment">// Push this callback into an internal queue. We'll flush these either in</span>
  <span class="hljs-comment">// the next tick, or earlier if something calls `flushSyncCallbackQueue`.</span>
  <span class="hljs-keyword">if</span> (syncQueue === <span class="hljs-literal">null</span>) {
    syncQueue = [callback];
    <span class="hljs-comment">// Flush the queue in the next tick, at the earliest.</span>
    immediateQueueCallbackNode = <span class="hljs-title class_">Scheduler</span>_scheduleCallback(
      <span class="hljs-title class_">Scheduler</span>_ImmediatePriority,
      flushSyncCallbackQueueImpl,
    );
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// Push onto existing queue. Don't need to schedule a callback because</span>
    <span class="hljs-comment">// we already scheduled one when we created the queue.</span>
    syncQueue.<span class="hljs-title function_">push</span>(callback);
  }
  <span class="hljs-keyword">return</span> fakeCallbackNode;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">cancelCallback</span>(<span class="hljs-params">callbackNode: mixed</span>) {
  <span class="hljs-keyword">if</span> (callbackNode !== fakeCallbackNode) {
    <span class="hljs-title class_">Scheduler</span>_cancelCallback(callbackNode);
  }
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">flushSyncCallbackQueue</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">if</span> (immediateQueueCallbackNode !== <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">const</span> node = immediateQueueCallbackNode;
    immediateQueueCallbackNode = <span class="hljs-literal">null</span>;
    <span class="hljs-title class_">Scheduler</span>_cancelCallback(node);
  }
  <span class="hljs-title function_">flushSyncCallbackQueueImpl</span>();
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">flushSyncCallbackQueueImpl</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">if</span> (!isFlushingSyncQueue &#x26;&#x26; syncQueue !== <span class="hljs-literal">null</span>) {
    <span class="hljs-comment">// Prevent re-entrancy.</span>
    isFlushingSyncQueue = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> isSync = <span class="hljs-literal">true</span>;
      <span class="hljs-keyword">const</span> queue = syncQueue;
      <span class="hljs-title function_">runWithPriority</span>(<span class="hljs-title class_">ImmediatePriority</span>, <span class="hljs-function">() =></span> {
        <span class="hljs-keyword">for</span> (; i &#x3C; queue.<span class="hljs-property">length</span>; i++) {
          <span class="hljs-keyword">let</span> callback = queue[i];
          <span class="hljs-keyword">do</span> {
            callback = <span class="hljs-title function_">callback</span>(isSync);
          } <span class="hljs-keyword">while</span> (callback !== <span class="hljs-literal">null</span>);
        }
      });
      syncQueue = <span class="hljs-literal">null</span>;
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-comment">// If something throws, leave the remaining callbacks on the queue.</span>
      <span class="hljs-keyword">if</span> (syncQueue !== <span class="hljs-literal">null</span>) {
        syncQueue = syncQueue.<span class="hljs-title function_">slice</span>(i + <span class="hljs-number">1</span>);
      }
      <span class="hljs-comment">// Resume flushing in the next tick</span>
      <span class="hljs-title class_">Scheduler</span>_scheduleCallback(
        <span class="hljs-title class_">Scheduler</span>_ImmediatePriority,
        flushSyncCallbackQueue,
      );
      <span class="hljs-keyword">throw</span> error;
    } <span class="hljs-keyword">finally</span> {
      isFlushingSyncQueue = <span class="hljs-literal">false</span>;
    }
  }
}

</code></pre>
<h2 id="reactworktagsjs">ReactWorkTags.js</h2>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// packages\shared\ReactWorkTags.js</span>
<span class="hljs-comment">/**
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 *
 * <span class="hljs-doctag">@flow</span>
 */</span>

<span class="hljs-keyword">export</span> type <span class="hljs-title class_">WorkTag</span> =
  | <span class="hljs-number">0</span>
  | <span class="hljs-number">1</span>
  | <span class="hljs-number">2</span>
  | <span class="hljs-number">3</span>
  | <span class="hljs-number">4</span>
  | <span class="hljs-number">5</span>
  | <span class="hljs-number">6</span>
  | <span class="hljs-number">7</span>
  | <span class="hljs-number">8</span>
  | <span class="hljs-number">9</span>
  | <span class="hljs-number">10</span>
  | <span class="hljs-number">11</span>
  | <span class="hljs-number">12</span>
  | <span class="hljs-number">13</span>
  | <span class="hljs-number">14</span>
  | <span class="hljs-number">15</span>
  | <span class="hljs-number">16</span>
  | <span class="hljs-number">17</span>
  | <span class="hljs-number">18</span>
  | <span class="hljs-number">19</span>
  | <span class="hljs-number">20</span>
  | <span class="hljs-number">21</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">FunctionComponent</span> = <span class="hljs-number">0</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">ClassComponent</span> = <span class="hljs-number">1</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">IndeterminateComponent</span> = <span class="hljs-number">2</span>; <span class="hljs-comment">// Before we know whether it is function or class</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">HostRoot</span> = <span class="hljs-number">3</span>; <span class="hljs-comment">// Root of a host tree. Could be nested inside another node.</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">HostPortal</span> = <span class="hljs-number">4</span>; <span class="hljs-comment">// A subtree. Could be an entry point to a different renderer.</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">HostComponent</span> = <span class="hljs-number">5</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">HostText</span> = <span class="hljs-number">6</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">Fragment</span> = <span class="hljs-number">7</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">Mode</span> = <span class="hljs-number">8</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">ContextConsumer</span> = <span class="hljs-number">9</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">ContextProvider</span> = <span class="hljs-number">10</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">ForwardRef</span> = <span class="hljs-number">11</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">Profiler</span> = <span class="hljs-number">12</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">SuspenseComponent</span> = <span class="hljs-number">13</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">MemoComponent</span> = <span class="hljs-number">14</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">SimpleMemoComponent</span> = <span class="hljs-number">15</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">LazyComponent</span> = <span class="hljs-number">16</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">IncompleteClassComponent</span> = <span class="hljs-number">17</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">DehydratedFragment</span> = <span class="hljs-number">18</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">SuspenseListComponent</span> = <span class="hljs-number">19</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">FundamentalComponent</span> = <span class="hljs-number">20</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">ScopeComponent</span> = <span class="hljs-number">21</span>;

</code></pre>
<h2 id="reactsideeffecttagsjs">ReactSideEffectTags.js</h2>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// packages\shared\ReactSideEffectTags.js</span>
<span class="hljs-comment">/**
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 *
 * <span class="hljs-doctag">@flow</span>
 */</span>

<span class="hljs-keyword">export</span> type <span class="hljs-title class_">SideEffectTag</span> = number;

<span class="hljs-comment">// Don't change these two values. They're used by React Dev Tools.</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">NoEffect</span> = <span class="hljs-comment">/*              */</span> <span class="hljs-number">0b0000000000000</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">PerformedWork</span> = <span class="hljs-comment">/*         */</span> <span class="hljs-number">0b0000000000001</span>;

<span class="hljs-comment">// You can change the rest (and add more).</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">Placement</span> = <span class="hljs-comment">/*             */</span> <span class="hljs-number">0b0000000000010</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">Update</span> = <span class="hljs-comment">/*                */</span> <span class="hljs-number">0b0000000000100</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">PlacementAndUpdate</span> = <span class="hljs-comment">/*    */</span> <span class="hljs-number">0b0000000000110</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">Deletion</span> = <span class="hljs-comment">/*              */</span> <span class="hljs-number">0b0000000001000</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">ContentReset</span> = <span class="hljs-comment">/*          */</span> <span class="hljs-number">0b0000000010000</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">Callback</span> = <span class="hljs-comment">/*              */</span> <span class="hljs-number">0b0000000100000</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">DidCapture</span> = <span class="hljs-comment">/*            */</span> <span class="hljs-number">0b0000001000000</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">Ref</span> = <span class="hljs-comment">/*                   */</span> <span class="hljs-number">0b0000010000000</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">Snapshot</span> = <span class="hljs-comment">/*              */</span> <span class="hljs-number">0b0000100000000</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">Passive</span> = <span class="hljs-comment">/*               */</span> <span class="hljs-number">0b0001000000000</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">Hydrating</span> = <span class="hljs-comment">/*             */</span> <span class="hljs-number">0b0010000000000</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">HydratingAndUpdate</span> = <span class="hljs-comment">/*    */</span> <span class="hljs-number">0b0010000000100</span>;

<span class="hljs-comment">// Passive &#x26; Update &#x26; Callback &#x26; Ref &#x26; Snapshot</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">LifecycleEffectMask</span> = <span class="hljs-comment">/*   */</span> <span class="hljs-number">0b0001110100100</span>;

<span class="hljs-comment">// Union of all host effects</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">HostEffectMask</span> = <span class="hljs-comment">/*        */</span> <span class="hljs-number">0b0011111111111</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">Incomplete</span> = <span class="hljs-comment">/*            */</span> <span class="hljs-number">0b0100000000000</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">ShouldCapture</span> = <span class="hljs-comment">/*         */</span> <span class="hljs-number">0b1000000000000</span>;

</code></pre>
<h2 id="reacttypeofmodejs">ReactTypeOfMode.js</h2>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// packages\react-reconciler\src\ReactTypeOfMode.js</span>
<span class="hljs-comment">/**
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 *
 * <span class="hljs-doctag">@flow</span>
 */</span>

<span class="hljs-keyword">export</span> type <span class="hljs-title class_">TypeOfMode</span> = number;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">NoMode</span> = <span class="hljs-number">0b0000</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">StrictMode</span> = <span class="hljs-number">0b0001</span>;
<span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> Remove BatchedMode and ConcurrentMode by reading from the root</span>
<span class="hljs-comment">// tag instead</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">BatchedMode</span> = <span class="hljs-number">0b0010</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">ConcurrentMode</span> = <span class="hljs-number">0b0100</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">ProfileMode</span> = <span class="hljs-number">0b1000</span>;

</code></pre>
<h2 id="reactfiberworkloopjs">ReactFiberWorkLoop.js</h2>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// packages\react-reconciler\src\ReactFiberWorkLoop.js</span>
<span class="hljs-keyword">const</span> ceil = <span class="hljs-title class_">Math</span>.<span class="hljs-property">ceil</span>;

<span class="hljs-keyword">const</span> {
  <span class="hljs-title class_">ReactCurrentDispatcher</span>,
  <span class="hljs-title class_">ReactCurrentOwner</span>,
  <span class="hljs-title class_">IsSomeRendererActing</span>,
} = <span class="hljs-title class_">ReactSharedInternals</span>;

type <span class="hljs-title class_">ExecutionContext</span> = number;

<span class="hljs-keyword">const</span> <span class="hljs-title class_">NoContext</span> = <span class="hljs-comment">/*                    */</span> <span class="hljs-number">0b000000</span>;
<span class="hljs-keyword">const</span> <span class="hljs-title class_">BatchedContext</span> = <span class="hljs-comment">/*               */</span> <span class="hljs-number">0b000001</span>;
<span class="hljs-keyword">const</span> <span class="hljs-title class_">EventContext</span> = <span class="hljs-comment">/*                 */</span> <span class="hljs-number">0b000010</span>;
<span class="hljs-keyword">const</span> <span class="hljs-title class_">DiscreteEventContext</span> = <span class="hljs-comment">/*         */</span> <span class="hljs-number">0b000100</span>;
<span class="hljs-keyword">const</span> <span class="hljs-title class_">LegacyUnbatchedContext</span> = <span class="hljs-comment">/*       */</span> <span class="hljs-number">0b001000</span>;
<span class="hljs-keyword">const</span> <span class="hljs-title class_">RenderContext</span> = <span class="hljs-comment">/*                */</span> <span class="hljs-number">0b010000</span>;
<span class="hljs-keyword">const</span> <span class="hljs-title class_">CommitContext</span> = <span class="hljs-comment">/*                */</span> <span class="hljs-number">0b100000</span>;

type <span class="hljs-title class_">RootExitStatus</span> = <span class="hljs-number">0</span> | <span class="hljs-number">1</span> | <span class="hljs-number">2</span> | <span class="hljs-number">3</span> | <span class="hljs-number">4</span> | <span class="hljs-number">5</span> | <span class="hljs-number">6</span>;
<span class="hljs-keyword">const</span> <span class="hljs-title class_">RootIncomplete</span> = <span class="hljs-number">0</span>;
<span class="hljs-keyword">const</span> <span class="hljs-title class_">RootFatalErrored</span> = <span class="hljs-number">1</span>;
<span class="hljs-keyword">const</span> <span class="hljs-title class_">RootErrored</span> = <span class="hljs-number">2</span>;
<span class="hljs-keyword">const</span> <span class="hljs-title class_">RootSuspended</span> = <span class="hljs-number">3</span>;
<span class="hljs-keyword">const</span> <span class="hljs-title class_">RootSuspendedWithDelay</span> = <span class="hljs-number">4</span>;
<span class="hljs-keyword">const</span> <span class="hljs-title class_">RootCompleted</span> = <span class="hljs-number">5</span>;
<span class="hljs-keyword">const</span> <span class="hljs-title class_">RootLocked</span> = <span class="hljs-number">6</span>;

<span class="hljs-keyword">export</span> type <span class="hljs-title class_">Thenable</span> = {
  <span class="hljs-title function_">then</span>(<span class="hljs-attr">resolve</span>: <span class="hljs-function">() =></span> mixed, reject?: <span class="hljs-function">() =></span> mixed): <span class="hljs-title class_">Thenable</span> | <span class="hljs-keyword">void</span>,

  <span class="hljs-comment">// Special flag to opt out of tracing interactions across a Suspense boundary.</span>
  __reactDoNotTraceInteractions?: boolean,
};

<span class="hljs-comment">// Describes where we are in the React execution stack</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">executionContext</span>: <span class="hljs-title class_">ExecutionContext</span> = <span class="hljs-title class_">NoContext</span>;
<span class="hljs-comment">// The root we're working on</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">workInProgressRoot</span>: <span class="hljs-title class_">FiberRoot</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;
<span class="hljs-comment">// The fiber we're working on</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">workInProgress</span>: <span class="hljs-title class_">Fiber</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;
<span class="hljs-comment">// The expiration time we're rendering</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">renderExpirationTime</span>: <span class="hljs-title class_">ExpirationTime</span> = <span class="hljs-title class_">NoWork</span>;
<span class="hljs-comment">// Whether to root completed, errored, suspended, etc.</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">workInProgressRootExitStatus</span>: <span class="hljs-title class_">RootExitStatus</span> = <span class="hljs-title class_">RootIncomplete</span>;
<span class="hljs-comment">// A fatal error, if one is thrown</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">workInProgressRootFatalError</span>: mixed = <span class="hljs-literal">null</span>;
<span class="hljs-comment">// Most recent event time among processed updates during this render.</span>
<span class="hljs-comment">// This is conceptually a time stamp but expressed in terms of an ExpirationTime</span>
<span class="hljs-comment">// because we deal mostly with expiration times in the hot path, so this avoids</span>
<span class="hljs-comment">// the conversion happening in the hot path.</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">workInProgressRootLatestProcessedExpirationTime</span>: <span class="hljs-title class_">ExpirationTime</span> = <span class="hljs-title class_">Sync</span>;
<span class="hljs-keyword">let</span> <span class="hljs-attr">workInProgressRootLatestSuspenseTimeout</span>: <span class="hljs-title class_">ExpirationTime</span> = <span class="hljs-title class_">Sync</span>;
<span class="hljs-keyword">let</span> <span class="hljs-attr">workInProgressRootCanSuspendUsingConfig</span>: <span class="hljs-literal">null</span> | <span class="hljs-title class_">SuspenseConfig</span> = <span class="hljs-literal">null</span>;
<span class="hljs-comment">// The work left over by components that were visited during this render. Only</span>
<span class="hljs-comment">// includes unprocessed updates, not work in bailed out children.</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">workInProgressRootNextUnprocessedUpdateTime</span>: <span class="hljs-title class_">ExpirationTime</span> = <span class="hljs-title class_">NoWork</span>;

<span class="hljs-comment">// If we're pinged while rendering we don't always restart immediately.</span>
<span class="hljs-comment">// This flag determines if it might be worthwhile to restart if an opportunity</span>
<span class="hljs-comment">// happens latere.</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">workInProgressRootHasPendingPing</span>: boolean = <span class="hljs-literal">false</span>;
<span class="hljs-comment">// The most recent time we committed a fallback. This lets us ensure a train</span>
<span class="hljs-comment">// model where we don't commit new loading states in too quick succession.</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">globalMostRecentFallbackTime</span>: number = <span class="hljs-number">0</span>;
<span class="hljs-keyword">const</span> <span class="hljs-attr">FALLBACK_THROTTLE_MS</span>: number = <span class="hljs-number">500</span>;

<span class="hljs-keyword">let</span> <span class="hljs-attr">nextEffect</span>: <span class="hljs-title class_">Fiber</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;
<span class="hljs-keyword">let</span> hasUncaughtError = <span class="hljs-literal">false</span>;
<span class="hljs-keyword">let</span> firstUncaughtError = <span class="hljs-literal">null</span>;
<span class="hljs-keyword">let</span> <span class="hljs-attr">legacyErrorBoundariesThatAlreadyFailed</span>: <span class="hljs-title class_">Set</span>&#x3C;mixed> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;

<span class="hljs-keyword">let</span> <span class="hljs-attr">rootDoesHavePassiveEffects</span>: boolean = <span class="hljs-literal">false</span>;
<span class="hljs-keyword">let</span> <span class="hljs-attr">rootWithPendingPassiveEffects</span>: <span class="hljs-title class_">FiberRoot</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;
<span class="hljs-keyword">let</span> <span class="hljs-attr">pendingPassiveEffectsRenderPriority</span>: <span class="hljs-title class_">ReactPriorityLevel</span> = <span class="hljs-title class_">NoPriority</span>;
<span class="hljs-keyword">let</span> <span class="hljs-attr">pendingPassiveEffectsExpirationTime</span>: <span class="hljs-title class_">ExpirationTime</span> = <span class="hljs-title class_">NoWork</span>;

<span class="hljs-keyword">let</span> <span class="hljs-attr">rootsWithPendingDiscreteUpdates</span>: <span class="hljs-title class_">Map</span>&#x3C;
  <span class="hljs-title class_">FiberRoot</span>,
  <span class="hljs-title class_">ExpirationTime</span>,
> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;

<span class="hljs-comment">// Use these to prevent an infinite loop of nested updates</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">NESTED_UPDATE_LIMIT</span> = <span class="hljs-number">50</span>;
<span class="hljs-keyword">let</span> <span class="hljs-attr">nestedUpdateCount</span>: number = <span class="hljs-number">0</span>;
<span class="hljs-keyword">let</span> <span class="hljs-attr">rootWithNestedUpdates</span>: <span class="hljs-title class_">FiberRoot</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">NESTED_PASSIVE_UPDATE_LIMIT</span> = <span class="hljs-number">50</span>;
<span class="hljs-keyword">let</span> <span class="hljs-attr">nestedPassiveUpdateCount</span>: number = <span class="hljs-number">0</span>;

<span class="hljs-keyword">let</span> <span class="hljs-attr">interruptedBy</span>: <span class="hljs-title class_">Fiber</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;

<span class="hljs-comment">// Marks the need to reschedule pending interactions at these expiration times</span>
<span class="hljs-comment">// during the commit phase. This enables them to be traced across components</span>
<span class="hljs-comment">// that spawn new work during render. E.g. hidden boundaries, suspended SSR</span>
<span class="hljs-comment">// hydration or SuspenseList.</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">spawnedWorkDuringRender</span>: <span class="hljs-literal">null</span> | <span class="hljs-title class_">Array</span>&#x3C;<span class="hljs-title class_">ExpirationTime</span>> = <span class="hljs-literal">null</span>;

<span class="hljs-comment">// Expiration times are computed by adding to the current time (the start</span>
<span class="hljs-comment">// time). However, if two updates are scheduled within the same event, we</span>
<span class="hljs-comment">// should treat their start times as simultaneous, even if the actual clock</span>
<span class="hljs-comment">// time has advanced between the first and second call.</span>

<span class="hljs-comment">// In other words, because expiration times determine how updates are batched,</span>
<span class="hljs-comment">// we want all updates of like priority that occur within the same event to</span>
<span class="hljs-comment">// receive the same expiration time. Otherwise we get tearing.</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">currentEventTime</span>: <span class="hljs-title class_">ExpirationTime</span> = <span class="hljs-title class_">NoWork</span>;
</code></pre>
<h2 id="reactsharedinternalsjs">ReactSharedInternals.js</h2>
<pre><code class="hljs language-javascript"><span class="hljs-comment">//packages\shared\ReactSharedInternals.js</span>
<span class="hljs-comment">/**
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */</span>

<span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title class_">ReactSharedInternals</span> =
  <span class="hljs-title class_">React</span>.<span class="hljs-property">__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED</span>;

<span class="hljs-comment">// Prevent newer renderers from RTE when used with older react package versions.</span>
<span class="hljs-comment">// Current owner and dispatcher used to share the same ref,</span>
<span class="hljs-comment">// but PR #14548 split them out to better support the react-debug-tools package.</span>
<span class="hljs-keyword">if</span> (!<span class="hljs-title class_">ReactSharedInternals</span>.<span class="hljs-title function_">hasOwnProperty</span>(<span class="hljs-string">'ReactCurrentDispatcher'</span>)) {
  <span class="hljs-title class_">ReactSharedInternals</span>.<span class="hljs-property">ReactCurrentDispatcher</span> = {
    <span class="hljs-attr">current</span>: <span class="hljs-literal">null</span>,
  };
}
<span class="hljs-keyword">if</span> (!<span class="hljs-title class_">ReactSharedInternals</span>.<span class="hljs-title function_">hasOwnProperty</span>(<span class="hljs-string">'ReactCurrentBatchConfig'</span>)) {
  <span class="hljs-title class_">ReactSharedInternals</span>.<span class="hljs-property">ReactCurrentBatchConfig</span> = {
    <span class="hljs-attr">suspense</span>: <span class="hljs-literal">null</span>,
  };
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">ReactSharedInternals</span>;

</code></pre>
<h1 id="reactdomrender调用过程">ReactDOM.render调用过程</h1>
<h2 id="reactdomrender">ReactDOM.render</h2>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// packages\react-dom\src\client\ReactDOM.js</span>
<span class="hljs-title function_">render</span>(<span class="hljs-params">
    element: React$Element&#x3C;any>,
    container: DOMContainer,
    callback: ?<span class="hljs-built_in">Function</span>,
  </span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">legacyRenderSubtreeIntoContainer</span>(
      <span class="hljs-literal">null</span>,
      element,
      container,
      <span class="hljs-literal">false</span>,
      callback,
    );
  }
</code></pre>
<h2 id="legacyrendersubtreeintocontainer">legacyRenderSubtreeIntoContainer</h2>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// packages\react-dom\src\client\ReactDOM.js</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">legacyRenderSubtreeIntoContainer</span>(<span class="hljs-params">
  parentComponent: ?React$Component&#x3C;any, any>,
  children: ReactNodeList,
  container: DOMContainer,
  forceHydrate: boolean,
  callback: ?<span class="hljs-built_in">Function</span>,
</span>) {
  <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> Without `any` type, Flow says "Property cannot be accessed on any</span>
  <span class="hljs-comment">// member of intersection type." Whyyyyyy.</span>
  <span class="hljs-keyword">let</span> <span class="hljs-attr">root</span>: _ReactSyncRoot = (container.<span class="hljs-property">_reactRootContainer</span>: any);
  <span class="hljs-keyword">let</span> fiberRoot;
  <span class="hljs-comment">// 没有root则创建，有了root之后执行update</span>
  <span class="hljs-keyword">if</span> (!root) {
    <span class="hljs-comment">// Initial mount</span>
    root = container.<span class="hljs-property">_reactRootContainer</span> = <span class="hljs-title function_">legacyCreateRootFromDOMContainer</span>(
      container,
      forceHydrate,
    );
    fiberRoot = root.<span class="hljs-property">_internalRoot</span>;
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> callback === <span class="hljs-string">'function'</span>) {
      <span class="hljs-keyword">const</span> originalCallback = callback;
      callback = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) {
        <span class="hljs-keyword">const</span> instance = <span class="hljs-title function_">getPublicRootInstance</span>(fiberRoot);
        originalCallback.<span class="hljs-title function_">call</span>(instance);
      };
    }
    <span class="hljs-comment">// Initial mount should not be batched.</span>
    <span class="hljs-title function_">unbatchedUpdates</span>(<span class="hljs-function">() =></span> {
      <span class="hljs-title function_">updateContainer</span>(children, fiberRoot, parentComponent, callback);
    });
  } <span class="hljs-keyword">else</span> {
    fiberRoot = root.<span class="hljs-property">_internalRoot</span>;
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> callback === <span class="hljs-string">'function'</span>) {
      <span class="hljs-keyword">const</span> originalCallback = callback;
      callback = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) {
        <span class="hljs-keyword">const</span> instance = <span class="hljs-title function_">getPublicRootInstance</span>(fiberRoot);
        originalCallback.<span class="hljs-title function_">call</span>(instance);
      };
    }
    <span class="hljs-comment">// Update</span>
    <span class="hljs-title function_">updateContainer</span>(children, fiberRoot, parentComponent, callback);
  }
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">getPublicRootInstance</span>(fiberRoot);
}
</code></pre>
<h3 id="root创建过程">root创建过程</h3>
<h4 id="legacycreaterootfromdomcontainer">legacyCreateRootFromDOMContainer</h4>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// packages\react-dom\src\client\ReactDOM.js</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">legacyCreateRootFromDOMContainer</span>(<span class="hljs-params">
  container: DOMContainer,
  forceHydrate: boolean,
</span>): _ReactSyncRoot {
  <span class="hljs-comment">// hydrate 描述的是 ReactDOM 复用 ReactDOMServer 服务端渲染的内容时尽可能保留结构，并补充事件绑定等 Client 特有内容的过程。</span>
  <span class="hljs-keyword">const</span> shouldHydrate =
    forceHydrate || <span class="hljs-title function_">shouldHydrateDueToLegacyHeuristic</span>(container);
  <span class="hljs-comment">// First clear any existing content.</span>
  <span class="hljs-keyword">if</span> (!shouldHydrate) {
    <span class="hljs-keyword">let</span> warned = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">let</span> rootSibling;
    <span class="hljs-keyword">while</span> ((rootSibling = container.<span class="hljs-property">lastChild</span>)) {
      <span class="hljs-keyword">if</span> (__DEV__) {
        <span class="hljs-keyword">if</span> (
          !warned &#x26;&#x26;
          rootSibling.<span class="hljs-property">nodeType</span> === <span class="hljs-variable constant_">ELEMENT_NODE</span> &#x26;&#x26;
          (<span class="hljs-attr">rootSibling</span>: any).<span class="hljs-title function_">hasAttribute</span>(<span class="hljs-variable constant_">ROOT_ATTRIBUTE_NAME</span>)
        ) {
          warned = <span class="hljs-literal">true</span>;
          <span class="hljs-title function_">warningWithoutStack</span>(
            <span class="hljs-literal">false</span>,
            <span class="hljs-string">'render(): Target node has markup rendered by React, but there '</span> +
              <span class="hljs-string">'are unrelated nodes as well. This is most commonly caused by '</span> +
              <span class="hljs-string">'white-space inserted around server-rendered markup.'</span>,
          );
        }
      }
      container.<span class="hljs-title function_">removeChild</span>(rootSibling);
    }
  }

  <span class="hljs-comment">// Legacy roots are not batched.</span>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReactSyncRoot</span>(
    container,
    <span class="hljs-title class_">LegacyRoot</span>,
    shouldHydrate
      ? {
          <span class="hljs-attr">hydrate</span>: <span class="hljs-literal">true</span>,
        }
      : <span class="hljs-literal">undefined</span>,
  );
}
</code></pre>
<h4 id="new-reactsyncroot">new ReactSyncRoot</h4>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// packages\react-dom\src\client\ReactDOM.js</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">ReactSyncRoot</span>(<span class="hljs-params">
  container: DOMContainer,
  tag: RootTag,
  options: <span class="hljs-keyword">void</span> | RootOptions,
</span>) {
  <span class="hljs-comment">// 挂载fiberRoot</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">_internalRoot</span> = <span class="hljs-title function_">createRootImpl</span>(container, tag, options);
}

<span class="hljs-title class_">ReactRoot</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">render</span> = <span class="hljs-title class_">ReactSyncRoot</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">render</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">
  children: ReactNodeList,
  callback: ?() => mixed,
</span>): <span class="hljs-title class_">Work</span> {
  <span class="hljs-keyword">const</span> root = <span class="hljs-variable language_">this</span>.<span class="hljs-property">_internalRoot</span>;
  <span class="hljs-keyword">const</span> work = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReactWork</span>();
  callback = callback === <span class="hljs-literal">undefined</span> ? <span class="hljs-literal">null</span> : callback;
  <span class="hljs-keyword">if</span> (callback !== <span class="hljs-literal">null</span>) {
    work.<span class="hljs-title function_">then</span>(callback);
  }
  <span class="hljs-title function_">updateContainer</span>(children, root, <span class="hljs-literal">null</span>, work.<span class="hljs-property">_onCommit</span>);
  <span class="hljs-keyword">return</span> work;
};

<span class="hljs-title class_">ReactRoot</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">unmount</span> = <span class="hljs-title class_">ReactSyncRoot</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">unmount</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">
  callback: ?() => mixed,
</span>): <span class="hljs-title class_">Work</span> {
  <span class="hljs-keyword">const</span> root = <span class="hljs-variable language_">this</span>.<span class="hljs-property">_internalRoot</span>;
  <span class="hljs-keyword">const</span> work = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReactWork</span>();
  callback = callback === <span class="hljs-literal">undefined</span> ? <span class="hljs-literal">null</span> : callback;
  <span class="hljs-keyword">if</span> (callback !== <span class="hljs-literal">null</span>) {
    work.<span class="hljs-title function_">then</span>(callback);
  }
  <span class="hljs-title function_">updateContainer</span>(<span class="hljs-literal">null</span>, root, <span class="hljs-literal">null</span>, work.<span class="hljs-property">_onCommit</span>);
  <span class="hljs-keyword">return</span> work;
};
</code></pre>
<h4 id="createrootimpl">createRootImpl</h4>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// packages\react-dom\src\client\ReactDOM.js</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createRootImpl</span>(<span class="hljs-params">
  container: DOMContainer,
  tag: RootTag,
  options: <span class="hljs-keyword">void</span> | RootOptions,
</span>) {
  <span class="hljs-comment">// Tag is either LegacyRoot or Concurrent Root</span>
  <span class="hljs-keyword">const</span> hydrate = options != <span class="hljs-literal">null</span> &#x26;&#x26; options.<span class="hljs-property">hydrate</span> === <span class="hljs-literal">true</span>;
  <span class="hljs-keyword">const</span> hydrationCallbacks =
    (options != <span class="hljs-literal">null</span> &#x26;&#x26; options.<span class="hljs-property">hydrationOptions</span>) || <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">const</span> root = <span class="hljs-title function_">createContainer</span>(container, tag, hydrate, hydrationCallbacks);
  <span class="hljs-title function_">markContainerAsRoot</span>(root.<span class="hljs-property">current</span>, container);
  <span class="hljs-keyword">if</span> (hydrate &#x26;&#x26; tag !== <span class="hljs-title class_">LegacyRoot</span>) {
    <span class="hljs-keyword">const</span> doc =
      container.<span class="hljs-property">nodeType</span> === <span class="hljs-variable constant_">DOCUMENT_NODE</span>
        ? container
        : container.<span class="hljs-property">ownerDocument</span>;
    <span class="hljs-title function_">eagerlyTrapReplayableEvents</span>(doc);
  }
  <span class="hljs-keyword">return</span> root;
}
</code></pre>
<h5 id="createcontainer">createContainer</h5>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// packages\react-reconciler\src\ReactFiberReconciler.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createContainer</span>(<span class="hljs-params">
  containerInfo: Container,
  tag: RootTag,
  hydrate: boolean,
  hydrationCallbacks: <span class="hljs-literal">null</span> | SuspenseHydrationCallbacks,
</span>): <span class="hljs-title class_">OpaqueRoot</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">createFiberRoot</span>(containerInfo, tag, hydrate, hydrationCallbacks);
}
</code></pre>
<h6 id="createfiberroot">createFiberRoot</h6>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// packages\react-reconciler\src\ReactFiberRoot.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createFiberRoot</span>(<span class="hljs-params">
  containerInfo: any,
  tag: RootTag,
  hydrate: boolean,
  hydrationCallbacks: <span class="hljs-literal">null</span> | SuspenseHydrationCallbacks,
</span>): <span class="hljs-title class_">FiberRoot</span> {
  <span class="hljs-keyword">const</span> <span class="hljs-attr">root</span>: <span class="hljs-title class_">FiberRoot</span> = (<span class="hljs-keyword">new</span> <span class="hljs-title class_">FiberRootNode</span>(containerInfo, tag, hydrate): any);
  <span class="hljs-keyword">if</span> (enableSuspenseCallback) {
    root.<span class="hljs-property">hydrationCallbacks</span> = hydrationCallbacks;
  }

  <span class="hljs-comment">// Cyclic construction. This cheats the type system right now because</span>
  <span class="hljs-comment">// stateNode is any.</span>
  <span class="hljs-keyword">const</span> uninitializedFiber = <span class="hljs-title function_">createHostRootFiber</span>(tag);
  root.<span class="hljs-property">current</span> = uninitializedFiber;
  uninitializedFiber.<span class="hljs-property">stateNode</span> = root;

  <span class="hljs-keyword">return</span> root;
}
</code></pre>
<h6 id="new-fiberrootnode">new FiberRootNode</h6>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// packages\react-reconciler\src\ReactFiberRoot.js</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">FiberRootNode</span>(<span class="hljs-params">containerInfo, tag, hydrate</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">tag</span> = tag;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">current</span> = <span class="hljs-literal">null</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">containerInfo</span> = containerInfo;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">pendingChildren</span> = <span class="hljs-literal">null</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">pingCache</span> = <span class="hljs-literal">null</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">finishedExpirationTime</span> = <span class="hljs-title class_">NoWork</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">finishedWork</span> = <span class="hljs-literal">null</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">timeoutHandle</span> = noTimeout;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span> = <span class="hljs-literal">null</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">pendingContext</span> = <span class="hljs-literal">null</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">hydrate</span> = hydrate;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">firstBatch</span> = <span class="hljs-literal">null</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">callbackNode</span> = <span class="hljs-literal">null</span>;
  <span class="hljs-comment">// NoPriority 详见React类型/常量定义-SchedulerWithReactIntegration.js</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">callbackPriority</span> = <span class="hljs-title class_">NoPriority</span>;
  <span class="hljs-comment">// NoWork 详见React类型/常量定义-ReactFiberExpirationTime.js</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">firstPendingTime</span> = <span class="hljs-title class_">NoWork</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">firstSuspendedTime</span> = <span class="hljs-title class_">NoWork</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">lastSuspendedTime</span> = <span class="hljs-title class_">NoWork</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">nextKnownPendingLevel</span> = <span class="hljs-title class_">NoWork</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">lastPingedTime</span> = <span class="hljs-title class_">NoWork</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">lastExpiredTime</span> = <span class="hljs-title class_">NoWork</span>;

  <span class="hljs-keyword">if</span> (enableSchedulerTracing) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">interactionThreadID</span> = <span class="hljs-title function_">unstable_getThreadID</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">memoizedInteractions</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">pendingInteractionMap</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
  }
  <span class="hljs-keyword">if</span> (enableSuspenseCallback) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">hydrationCallbacks</span> = <span class="hljs-literal">null</span>;
  }
}
</code></pre>
<h6 id="createhostrootfiber">createHostRootFiber</h6>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// packages\react-reconciler\src\ReactFiber.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createHostRootFiber</span>(<span class="hljs-params">tag: RootTag</span>): <span class="hljs-title class_">Fiber</span> {
  <span class="hljs-keyword">let</span> mode;
    
  <span class="hljs-comment">// ConcurrentMode、BatchedMode 详见React类型/常量定义-ReactTypeOfMode.js</span>
  <span class="hljs-keyword">if</span> (tag === <span class="hljs-title class_">ConcurrentRoot</span>) {
    mode = <span class="hljs-title class_">ConcurrentMode</span> | <span class="hljs-title class_">BatchedMode</span> | <span class="hljs-title class_">StrictMode</span>;
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (tag === <span class="hljs-title class_">BatchedRoot</span>) {
    mode = <span class="hljs-title class_">BatchedMode</span> | <span class="hljs-title class_">StrictMode</span>;
  } <span class="hljs-keyword">else</span> {
    mode = <span class="hljs-title class_">NoMode</span>;
  }

  <span class="hljs-keyword">if</span> (enableProfilerTimer &#x26;&#x26; isDevToolsPresent) {
    <span class="hljs-comment">// Always collect profile timings when DevTools are present.</span>
    <span class="hljs-comment">// This enables DevTools to start capturing timing at any point–</span>
    <span class="hljs-comment">// Without some nodes in the tree having empty base times.</span>
    mode |= <span class="hljs-title class_">ProfileMode</span>;
  }

  <span class="hljs-keyword">return</span> <span class="hljs-title function_">createFiber</span>(<span class="hljs-title class_">HostRoot</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, mode);
}
</code></pre>
<h6 id="createfiber">createFiber</h6>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// packages\react-reconciler\src\ReactFiber.js</span>
<span class="hljs-keyword">const</span> createFiber = <span class="hljs-keyword">function</span>(<span class="hljs-params">
  tag: WorkTag,
  pendingProps: mixed,
  key: <span class="hljs-literal">null</span> | string,
  mode: TypeOfMode,
</span>): <span class="hljs-title class_">Fiber</span> {
  <span class="hljs-comment">// $FlowFixMe: the shapes are exact here but Flow doesn't like constructors</span>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FiberNode</span>(tag, pendingProps, key, mode);
};
</code></pre>
<h6 id="new-fibernode">new FiberNode</h6>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// packages\react-reconciler\src\ReactFiber.js</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">FiberNode</span>(<span class="hljs-params">
  tag: WorkTag,
  pendingProps: mixed,
  key: <span class="hljs-literal">null</span> | string,
  mode: TypeOfMode,
</span>) {
  <span class="hljs-comment">// Instance</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">tag</span> = tag;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">key</span> = key;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">elementType</span> = <span class="hljs-literal">null</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">type</span> = <span class="hljs-literal">null</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">stateNode</span> = <span class="hljs-literal">null</span>;

  <span class="hljs-comment">// Fiber</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">return</span> = <span class="hljs-literal">null</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">child</span> = <span class="hljs-literal">null</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">sibling</span> = <span class="hljs-literal">null</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">index</span> = <span class="hljs-number">0</span>;

  <span class="hljs-variable language_">this</span>.<span class="hljs-property">ref</span> = <span class="hljs-literal">null</span>;

  <span class="hljs-variable language_">this</span>.<span class="hljs-property">pendingProps</span> = pendingProps;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">memoizedProps</span> = <span class="hljs-literal">null</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">updateQueue</span> = <span class="hljs-literal">null</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">memoizedState</span> = <span class="hljs-literal">null</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">dependencies</span> = <span class="hljs-literal">null</span>;

  <span class="hljs-variable language_">this</span>.<span class="hljs-property">mode</span> = mode;

  <span class="hljs-comment">// Effects</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">effectTag</span> = <span class="hljs-title class_">NoEffect</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">nextEffect</span> = <span class="hljs-literal">null</span>;

  <span class="hljs-variable language_">this</span>.<span class="hljs-property">firstEffect</span> = <span class="hljs-literal">null</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">lastEffect</span> = <span class="hljs-literal">null</span>;

  <span class="hljs-variable language_">this</span>.<span class="hljs-property">expirationTime</span> = <span class="hljs-title class_">NoWork</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">childExpirationTime</span> = <span class="hljs-title class_">NoWork</span>;

  <span class="hljs-variable language_">this</span>.<span class="hljs-property">alternate</span> = <span class="hljs-literal">null</span>;

  <span class="hljs-keyword">if</span> (enableProfilerTimer) {
    <span class="hljs-comment">// Note: The following is done to avoid a v8 performance cliff.</span>
    <span class="hljs-comment">//</span>
    <span class="hljs-comment">// Initializing the fields below to smis and later updating them with</span>
    <span class="hljs-comment">// double values will cause Fibers to end up having separate shapes.</span>
    <span class="hljs-comment">// This behavior/bug has something to do with Object.preventExtension().</span>
    <span class="hljs-comment">// Fortunately this only impacts DEV builds.</span>
    <span class="hljs-comment">// Unfortunately it makes React unusably slow for some applications.</span>
    <span class="hljs-comment">// To work around this, initialize the fields below with doubles.</span>
    <span class="hljs-comment">//</span>
    <span class="hljs-comment">// Learn more about this here:</span>
    <span class="hljs-comment">// https://github.com/facebook/react/issues/14365</span>
    <span class="hljs-comment">// https://bugs.chromium.org/p/v8/issues/detail?id=8538</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">actualDuration</span> = <span class="hljs-title class_">Number</span>.<span class="hljs-property">NaN</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">actualStartTime</span> = <span class="hljs-title class_">Number</span>.<span class="hljs-property">NaN</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">selfBaseDuration</span> = <span class="hljs-title class_">Number</span>.<span class="hljs-property">NaN</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">treeBaseDuration</span> = <span class="hljs-title class_">Number</span>.<span class="hljs-property">NaN</span>;

    <span class="hljs-comment">// It's okay to replace the initial doubles with smis after initialization.</span>
    <span class="hljs-comment">// This won't trigger the performance cliff mentioned above,</span>
    <span class="hljs-comment">// and it simplifies other profiler code (including DevTools).</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">actualDuration</span> = <span class="hljs-number">0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">actualStartTime</span> = -<span class="hljs-number">1</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">selfBaseDuration</span> = <span class="hljs-number">0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">treeBaseDuration</span> = <span class="hljs-number">0</span>;
  }

  <span class="hljs-comment">// This is normally DEV-only except www when it adds listeners.</span>
  <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> remove the User Timing integration in favor of Root Events.</span>
  <span class="hljs-keyword">if</span> (enableUserTimingAPI) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_debugID</span> = debugCounter++;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_debugIsCurrentlyTiming</span> = <span class="hljs-literal">false</span>;
  }

  <span class="hljs-keyword">if</span> (__DEV__) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_debugSource</span> = <span class="hljs-literal">null</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_debugOwner</span> = <span class="hljs-literal">null</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_debugNeedsRemount</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_debugHookTypes</span> = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">if</span> (!hasBadMapPolyfill &#x26;&#x26; <span class="hljs-keyword">typeof</span> <span class="hljs-title class_">Object</span>.<span class="hljs-property">preventExtensions</span> === <span class="hljs-string">'function'</span>) {
      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">preventExtensions</span>(<span class="hljs-variable language_">this</span>);
    }
  }
}
</code></pre>
<h5 id="markcontainerasroot">markContainerAsRoot</h5>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// packages\react-dom\src\client\ReactDOMComponentTree.js</span>
<span class="hljs-keyword">const</span> randomKey = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>()
  .<span class="hljs-title function_">toString</span>(<span class="hljs-number">36</span>)
  .<span class="hljs-title function_">slice</span>(<span class="hljs-number">2</span>);
<span class="hljs-keyword">const</span> internalInstanceKey = <span class="hljs-string">'__reactInternalInstance$'</span> + randomKey;
<span class="hljs-keyword">const</span> internalEventHandlersKey = <span class="hljs-string">'__reactEventHandlers$'</span> + randomKey;
<span class="hljs-keyword">const</span> internalContainerInstanceKey = <span class="hljs-string">'__reactContainere$'</span> + randomKey;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">precacheFiberNode</span>(<span class="hljs-params">hostInst, node</span>) {
  node[internalInstanceKey] = hostInst;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">markContainerAsRoot</span>(<span class="hljs-params">hostRoot, node</span>) {
  node[internalContainerInstanceKey] = hostRoot;
}
</code></pre>
<h3 id="callback调用过程">callback调用过程</h3>
<h4 id="getpublicrootinstance">getPublicRootInstance</h4>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// packages\react-reconciler\src\ReactFiberReconciler.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getPublicRootInstance</span>(<span class="hljs-params">
  container: OpaqueRoot,
</span>): <span class="hljs-title class_">React</span>$Component&#x3C;any, any> | <span class="hljs-title class_">PublicInstance</span> | <span class="hljs-literal">null</span> {
  <span class="hljs-keyword">const</span> containerFiber = container.<span class="hljs-property">current</span>;
  <span class="hljs-keyword">if</span> (!containerFiber.<span class="hljs-property">child</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  }
  <span class="hljs-keyword">switch</span> (containerFiber.<span class="hljs-property">child</span>.<span class="hljs-property">tag</span>) {
    <span class="hljs-comment">// HostComponent 详见React类型/常量定义-ReactWorkTags.js</span>
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">HostComponent</span>:
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">getPublicInstance</span>(containerFiber.<span class="hljs-property">child</span>.<span class="hljs-property">stateNode</span>);
    <span class="hljs-attr">default</span>:
      <span class="hljs-keyword">return</span> containerFiber.<span class="hljs-property">child</span>.<span class="hljs-property">stateNode</span>;
  }
}
</code></pre>
<h3 id="updatecontainer调用过程">updateContainer调用过程</h3>
<h4 id="unbatchedupdates">unbatchedUpdates</h4>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// packages\react-reconciler\src\ReactFiberWorkLoop.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> unbatchedUpdates&#x3C;A, R>(<span class="hljs-attr">fn</span>: <span class="hljs-function">(<span class="hljs-params">a: A</span>) =></span> R, <span class="hljs-attr">a</span>: A): R {
  <span class="hljs-comment">// executionContext、BatchedContext 详见React类型/常量定义-ReactFiberWorkLoop.js</span>
  <span class="hljs-keyword">const</span> prevExecutionContext = executionContext;
  executionContext &#x26;= ~<span class="hljs-title class_">BatchedContext</span>;
  executionContext |= <span class="hljs-title class_">LegacyUnbatchedContext</span>;
  <span class="hljs-comment">// executionContext now is 8</span>
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">fn</span>(a);
  } <span class="hljs-keyword">finally</span> {
    executionContext = prevExecutionContext;
    <span class="hljs-keyword">if</span> (executionContext === <span class="hljs-title class_">NoContext</span>) {
      <span class="hljs-comment">// Flush the immediate callbacks that were scheduled during this batch</span>
      <span class="hljs-title function_">flushSyncCallbackQueue</span>();
    }
  }
}
</code></pre>
<h4 id="updatecontainer">updateContainer</h4>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// packages\react-reconciler\src\ReactFiberReconciler.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">updateContainer</span>(<span class="hljs-params">
  element: ReactNodeList,
  container: OpaqueRoot,
  parentComponent: ?React$Component&#x3C;any, any>,
  callback: ?<span class="hljs-built_in">Function</span>,
</span>): <span class="hljs-title class_">ExpirationTime</span> {
  <span class="hljs-keyword">const</span> current = container.<span class="hljs-property">current</span>;
  <span class="hljs-keyword">const</span> currentTime = <span class="hljs-title function_">requestCurrentTime</span>();
  <span class="hljs-keyword">if</span> (__DEV__) {
    <span class="hljs-comment">// $FlowExpectedError - jest isn't a global, and isn't recognized outside of tests</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-string">'undefined'</span> !== <span class="hljs-keyword">typeof</span> jest) {
      <span class="hljs-title function_">warnIfUnmockedScheduler</span>(current);
      <span class="hljs-title function_">warnIfNotScopedWithMatchingAct</span>(current);
    }
  }
  <span class="hljs-keyword">const</span> suspenseConfig = <span class="hljs-title function_">requestCurrentSuspenseConfig</span>();
  <span class="hljs-keyword">const</span> expirationTime = <span class="hljs-title function_">computeExpirationForFiber</span>(
    currentTime,
    current,
    suspenseConfig,
  );
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">updateContainerAtExpirationTime</span>(
    element,
    container,
    parentComponent,
    expirationTime,
    suspenseConfig,
    callback,
  );
}
</code></pre>
<h5 id="requestcurrenttime">requestCurrentTime</h5>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// packages\react-reconciler\src\ReactFiberWorkLoop.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">requestCurrentTime</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">if</span> ((executionContext &#x26; (<span class="hljs-title class_">RenderContext</span> | <span class="hljs-title class_">CommitContext</span>)) !== <span class="hljs-title class_">NoContext</span>) {
    <span class="hljs-comment">// We're inside React, so it's fine to read the actual time.</span>
    <span class="hljs-comment">// now()方法的定义：如果是浏览器支持则定义为()=>performance.now()，否则为Date.now()-react库加载执行时的Date.now()</span>
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">msToExpirationTime</span>(<span class="hljs-title function_">now</span>());
  }
  <span class="hljs-comment">// We're not inside React, so we may be in the middle of a browser event.</span>
  <span class="hljs-keyword">if</span> (currentEventTime !== <span class="hljs-title class_">NoWork</span>) {
    <span class="hljs-comment">// Use the same start time for all updates until we enter React again.</span>
    <span class="hljs-keyword">return</span> currentEventTime;
  }
  <span class="hljs-comment">// This is the first update since React yielded. Compute a new start time.</span>
  <span class="hljs-comment">// 1073741823-1-1-now()</span>
  currentEventTime = <span class="hljs-title function_">msToExpirationTime</span>(<span class="hljs-title function_">now</span>());
  <span class="hljs-keyword">return</span> currentEventTime;
}
</code></pre>
<h5 id="mstoexpirationtime">msToExpirationTime</h5>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// packages\react-reconciler\src\ReactFiberExpirationTime.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">msToExpirationTime</span>(<span class="hljs-params">ms: number</span>): <span class="hljs-title class_">ExpirationTime</span> {
  <span class="hljs-comment">// Always add an offset so that we don't clash with the magic number for NoWork.</span>
  <span class="hljs-comment">// MAGIC_NUMBER_OFFSET、UNIT_SIZE 详见React类型/常量定义-ReactFiberExpirationTime.js</span>
  <span class="hljs-keyword">return</span> <span class="hljs-variable constant_">MAGIC_NUMBER_OFFSET</span> - ((ms / <span class="hljs-variable constant_">UNIT_SIZE</span>) | <span class="hljs-number">0</span>);
}
</code></pre>
<h5 id="requestcurrentsuspenseconfig">requestCurrentSuspenseConfig</h5>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// packages\react-reconciler\src\ReactFiberSuspenseConfig.js</span>
<span class="hljs-comment">/**
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 *
 * <span class="hljs-doctag">@flow</span>
 */</span>

<span class="hljs-keyword">import</span> <span class="hljs-title class_">ReactSharedInternals</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'shared/ReactSharedInternals'</span>;

<span class="hljs-keyword">const</span> {<span class="hljs-title class_">ReactCurrentBatchConfig</span>} = <span class="hljs-title class_">ReactSharedInternals</span>;

<span class="hljs-keyword">export</span> type <span class="hljs-title class_">SuspenseConfig</span> = {|
  <span class="hljs-attr">timeoutMs</span>: number,
  busyDelayMs?: number,
  busyMinDurationMs?: number,
|};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">requestCurrentSuspenseConfig</span>(<span class="hljs-params"></span>): <span class="hljs-literal">null</span> | <span class="hljs-title class_">SuspenseConfig</span> {
  <span class="hljs-comment">// ReactCurrentBatchConfig 详见React类型/常量定义-ReactSharedInternals.js</span>
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">ReactCurrentBatchConfig</span>.<span class="hljs-property">suspense</span>;
}

</code></pre>
<h5 id="computeexpirationforfiber">computeExpirationForFiber</h5>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// packages\react-reconciler\src\ReactFiberWorkLoop.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">computeExpirationForFiber</span>(<span class="hljs-params">
  currentTime: ExpirationTime,
  fiber: Fiber,
  suspenseConfig: <span class="hljs-literal">null</span> | SuspenseConfig,
</span>): <span class="hljs-title class_">ExpirationTime</span> {
  <span class="hljs-keyword">const</span> mode = fiber.<span class="hljs-property">mode</span>;
  <span class="hljs-keyword">if</span> ((mode &#x26; <span class="hljs-title class_">BatchedMode</span>) === <span class="hljs-title class_">NoMode</span>) {
    <span class="hljs-comment">// Sync 详见React类型/常量定义-ReactFiberExpirationTime.js</span>
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Sync</span>;
  }

  <span class="hljs-keyword">const</span> priorityLevel = <span class="hljs-title function_">getCurrentPriorityLevel</span>();
  <span class="hljs-keyword">if</span> ((mode &#x26; <span class="hljs-title class_">ConcurrentMode</span>) === <span class="hljs-title class_">NoMode</span>) {
    <span class="hljs-keyword">return</span> priorityLevel === <span class="hljs-title class_">ImmediatePriority</span> ? <span class="hljs-title class_">Sync</span> : <span class="hljs-title class_">Batched</span>;
  }

  <span class="hljs-keyword">if</span> ((executionContext &#x26; <span class="hljs-title class_">RenderContext</span>) !== <span class="hljs-title class_">NoContext</span>) {
    <span class="hljs-comment">// Use whatever time we're already rendering</span>
    <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> Should there be a way to opt out, like with `runWithPriority`?</span>
    <span class="hljs-keyword">return</span> renderExpirationTime;
  }

  <span class="hljs-keyword">let</span> expirationTime;
  <span class="hljs-keyword">if</span> (suspenseConfig !== <span class="hljs-literal">null</span>) {
    <span class="hljs-comment">// Compute an expiration time based on the Suspense timeout.</span>
    expirationTime = <span class="hljs-title function_">computeSuspenseExpiration</span>(
      currentTime,
      suspenseConfig.<span class="hljs-property">timeoutMs</span> | <span class="hljs-number">0</span> || <span class="hljs-variable constant_">LOW_PRIORITY_EXPIRATION</span>,
    );
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// Compute an expiration time based on the Scheduler priority.</span>
    <span class="hljs-keyword">switch</span> (priorityLevel) {
      <span class="hljs-keyword">case</span> <span class="hljs-title class_">ImmediatePriority</span>:
        expirationTime = <span class="hljs-title class_">Sync</span>;
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-title class_">UserBlockingPriority</span>:
        <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> Rename this to computeUserBlockingExpiration</span>
        expirationTime = <span class="hljs-title function_">computeInteractiveExpiration</span>(currentTime);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-title class_">NormalPriority</span>:
      <span class="hljs-keyword">case</span> <span class="hljs-title class_">LowPriority</span>: <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> Handle LowPriority</span>
        <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> Rename this to... something better.</span>
        expirationTime = <span class="hljs-title function_">computeAsyncExpiration</span>(currentTime);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-title class_">IdlePriority</span>:
        expirationTime = <span class="hljs-title class_">Idle</span>;
        <span class="hljs-keyword">break</span>;
      <span class="hljs-attr">default</span>:
        <span class="hljs-title function_">invariant</span>(<span class="hljs-literal">false</span>, <span class="hljs-string">'Expected a valid priority level'</span>);
    }
  }

  <span class="hljs-comment">// If we're in the middle of rendering a tree, do not update at the same</span>
  <span class="hljs-comment">// expiration time that is already rendering.</span>
  <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> We shouldn't have to do this if the update is on a different root.</span>
  <span class="hljs-comment">// Refactor computeExpirationForFiber + scheduleUpdate so we have access to</span>
  <span class="hljs-comment">// the root when we check for this condition.</span>
  <span class="hljs-keyword">if</span> (workInProgressRoot !== <span class="hljs-literal">null</span> &#x26;&#x26; expirationTime === renderExpirationTime) {
    <span class="hljs-comment">// This is a trick to move this update into a separate batch</span>
    expirationTime -= <span class="hljs-number">1</span>;
  }

  <span class="hljs-keyword">return</span> expirationTime;
}
</code></pre>
<h4 id="updatecontaineratexpirationtime">updateContainerAtExpirationTime</h4>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// packages\react-reconciler\src\ReactFiberReconciler.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">updateContainerAtExpirationTime</span>(<span class="hljs-params">
  element: ReactNodeList,
  container: OpaqueRoot,
  parentComponent: ?React$Component&#x3C;any, any>,
  expirationTime: ExpirationTime,
  suspenseConfig: <span class="hljs-literal">null</span> | SuspenseConfig,
  callback: ?<span class="hljs-built_in">Function</span>,
</span>) {
  <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> If this is a nested container, this won't be the root.</span>
  <span class="hljs-keyword">const</span> current = container.<span class="hljs-property">current</span>;

  <span class="hljs-keyword">const</span> context = <span class="hljs-title function_">getContextForSubtree</span>(parentComponent);
  <span class="hljs-keyword">if</span> (container.<span class="hljs-property">context</span> === <span class="hljs-literal">null</span>) {
    container.<span class="hljs-property">context</span> = context;
  } <span class="hljs-keyword">else</span> {
    container.<span class="hljs-property">pendingContext</span> = context;
  }

  <span class="hljs-keyword">return</span> <span class="hljs-title function_">scheduleRootUpdate</span>(
    current,
    element,
    expirationTime,
    suspenseConfig,
    callback,
  );
}
</code></pre>
<h5 id="getcontextforsubtree">getContextForSubtree</h5>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// packages\react-reconciler\src\ReactFiberReconciler.js</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getContextForSubtree</span>(<span class="hljs-params">
  parentComponent: ?React$Component&#x3C;any, any>,
</span>): <span class="hljs-title class_">Object</span> {
  <span class="hljs-keyword">if</span> (!parentComponent) {
    <span class="hljs-keyword">return</span> emptyContextObject;
  }
  <span class="hljs-comment">// 此处取的是parentComponent._reactInternalFiber</span>
  <span class="hljs-keyword">const</span> fiber = <span class="hljs-title function_">getInstance</span>(parentComponent);
  <span class="hljs-keyword">const</span> parentContext = <span class="hljs-title function_">findCurrentUnmaskedContext</span>(fiber);

  <span class="hljs-keyword">if</span> (fiber.<span class="hljs-property">tag</span> === <span class="hljs-title class_">ClassComponent</span>) {
    <span class="hljs-keyword">const</span> <span class="hljs-title class_">Component</span> = fiber.<span class="hljs-property">type</span>;
    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isLegacyContextProvider</span>(<span class="hljs-title class_">Component</span>)) {
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">processChildContext</span>(fiber, <span class="hljs-title class_">Component</span>, parentContext);
    }
  }

  <span class="hljs-keyword">return</span> parentContext;
}
</code></pre>
<h5 id="findcurrentunmaskedcontext">findCurrentUnmaskedContext</h5>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// packages\react-reconciler\src\ReactFiberContext.js</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">findCurrentUnmaskedContext</span>(<span class="hljs-params">fiber: Fiber</span>): <span class="hljs-title class_">Object</span> {
  <span class="hljs-keyword">if</span> (disableLegacyContext) {
    <span class="hljs-keyword">return</span> emptyContextObject;
  } <span class="hljs-keyword">else</span> {

    <span class="hljs-keyword">let</span> node = fiber;
    <span class="hljs-keyword">do</span> {
      <span class="hljs-keyword">switch</span> (node.<span class="hljs-property">tag</span>) {
        <span class="hljs-keyword">case</span> <span class="hljs-title class_">HostRoot</span>:
          <span class="hljs-keyword">return</span> node.<span class="hljs-property">stateNode</span>.<span class="hljs-property">context</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-title class_">ClassComponent</span>: {
          <span class="hljs-keyword">const</span> <span class="hljs-title class_">Component</span> = node.<span class="hljs-property">type</span>;
          <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isContextProvider</span>(<span class="hljs-title class_">Component</span>)) {
            <span class="hljs-keyword">return</span> node.<span class="hljs-property">stateNode</span>.<span class="hljs-property">__reactInternalMemoizedMergedChildContext</span>;
          }
          <span class="hljs-keyword">break</span>;
        }
      }
      node = node.<span class="hljs-property">return</span>;
    } <span class="hljs-keyword">while</span> (node !== <span class="hljs-literal">null</span>);
  }
}
</code></pre>
<h4 id="schedulerootupdate">scheduleRootUpdate</h4>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// packages\react-reconciler\src\ReactFiberReconciler.js</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">scheduleRootUpdate</span>(<span class="hljs-params">
  current: Fiber,
  element: ReactNodeList,
  expirationTime: ExpirationTime,
  suspenseConfig: <span class="hljs-literal">null</span> | SuspenseConfig,
  callback: ?<span class="hljs-built_in">Function</span>,
</span>) {
  <span class="hljs-keyword">const</span> update = <span class="hljs-title function_">createUpdate</span>(expirationTime, suspenseConfig);
  <span class="hljs-comment">// Caution: React DevTools currently depends on this property</span>
  <span class="hljs-comment">// being called "element".</span>
  update.<span class="hljs-property">payload</span> = {element};

  callback = callback === <span class="hljs-literal">undefined</span> ? <span class="hljs-literal">null</span> : callback;
  <span class="hljs-keyword">if</span> (callback !== <span class="hljs-literal">null</span>) {
    <span class="hljs-title function_">warningWithoutStack</span>(
      <span class="hljs-keyword">typeof</span> callback === <span class="hljs-string">'function'</span>,
      <span class="hljs-string">'render(...): Expected the last optional `callback` argument to be a '</span> +
        <span class="hljs-string">'function. Instead received: %s.'</span>,
      callback,
    );
    update.<span class="hljs-property">callback</span> = callback;
  }

  <span class="hljs-title function_">enqueueUpdate</span>(current, update);
  <span class="hljs-title function_">scheduleWork</span>(current, expirationTime);

  <span class="hljs-keyword">return</span> expirationTime;
}
</code></pre>
<h5 id="createupdate">createUpdate</h5>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// packages\react-reconciler\src\ReactUpdateQueue.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createUpdate</span>(<span class="hljs-params">
  expirationTime: ExpirationTime,
  suspenseConfig: <span class="hljs-literal">null</span> | SuspenseConfig,
</span>): <span class="hljs-title class_">Update</span>&#x3C;*> {
  <span class="hljs-keyword">let</span> <span class="hljs-attr">update</span>: <span class="hljs-title class_">Update</span>&#x3C;*> = {
    expirationTime,
    suspenseConfig,

    <span class="hljs-attr">tag</span>: <span class="hljs-title class_">UpdateState</span>,
    <span class="hljs-attr">payload</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">callback</span>: <span class="hljs-literal">null</span>,

    <span class="hljs-attr">next</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">nextEffect</span>: <span class="hljs-literal">null</span>,
  };
  <span class="hljs-keyword">if</span> (__DEV__) {
    update.<span class="hljs-property">priority</span> = <span class="hljs-title function_">getCurrentPriorityLevel</span>();
  }
  <span class="hljs-keyword">return</span> update;
}
</code></pre>
<h5 id="enqueueupdate">enqueueUpdate</h5>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// packages\react-reconciler\src\ReactUpdateQueue.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> enqueueUpdate&#x3C;<span class="hljs-title class_">State</span>>(<span class="hljs-attr">fiber</span>: <span class="hljs-title class_">Fiber</span>, <span class="hljs-attr">update</span>: <span class="hljs-title class_">Update</span>&#x3C;<span class="hljs-title class_">State</span>>) {
  <span class="hljs-comment">// Update queues are created lazily.</span>
  <span class="hljs-keyword">const</span> alternate = fiber.<span class="hljs-property">alternate</span>;
  <span class="hljs-keyword">let</span> queue1;
  <span class="hljs-keyword">let</span> queue2;
  <span class="hljs-keyword">if</span> (alternate === <span class="hljs-literal">null</span>) {
    <span class="hljs-comment">// There's only one fiber.</span>
    queue1 = fiber.<span class="hljs-property">updateQueue</span>;
    queue2 = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">if</span> (queue1 === <span class="hljs-literal">null</span>) {
      queue1 = fiber.<span class="hljs-property">updateQueue</span> = <span class="hljs-title function_">createUpdateQueue</span>(fiber.<span class="hljs-property">memoizedState</span>);
    }
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// There are two owners.</span>
    queue1 = fiber.<span class="hljs-property">updateQueue</span>;
    queue2 = alternate.<span class="hljs-property">updateQueue</span>;
    <span class="hljs-keyword">if</span> (queue1 === <span class="hljs-literal">null</span>) {
      <span class="hljs-keyword">if</span> (queue2 === <span class="hljs-literal">null</span>) {
        <span class="hljs-comment">// Neither fiber has an update queue. Create new ones.</span>
        queue1 = fiber.<span class="hljs-property">updateQueue</span> = <span class="hljs-title function_">createUpdateQueue</span>(fiber.<span class="hljs-property">memoizedState</span>);
        queue2 = alternate.<span class="hljs-property">updateQueue</span> = <span class="hljs-title function_">createUpdateQueue</span>(
          alternate.<span class="hljs-property">memoizedState</span>,
        );
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// Only one fiber has an update queue. Clone to create a new one.</span>
        queue1 = fiber.<span class="hljs-property">updateQueue</span> = <span class="hljs-title function_">cloneUpdateQueue</span>(queue2);
      }
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">if</span> (queue2 === <span class="hljs-literal">null</span>) {
        <span class="hljs-comment">// Only one fiber has an update queue. Clone to create a new one.</span>
        queue2 = alternate.<span class="hljs-property">updateQueue</span> = <span class="hljs-title function_">cloneUpdateQueue</span>(queue1);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// Both owners have an update queue.</span>
      }
    }
  }
  <span class="hljs-keyword">if</span> (queue2 === <span class="hljs-literal">null</span> || queue1 === queue2) {
    <span class="hljs-comment">// There's only a single queue.</span>
    <span class="hljs-title function_">appendUpdateToQueue</span>(queue1, update);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// There are two queues. We need to append the update to both queues,</span>
    <span class="hljs-comment">// while accounting for the persistent structure of the list — we don't</span>
    <span class="hljs-comment">// want the same update to be added multiple times.</span>
    <span class="hljs-keyword">if</span> (queue1.<span class="hljs-property">lastUpdate</span> === <span class="hljs-literal">null</span> || queue2.<span class="hljs-property">lastUpdate</span> === <span class="hljs-literal">null</span>) {
      <span class="hljs-comment">// One of the queues is not empty. We must add the update to both queues.</span>
      <span class="hljs-title function_">appendUpdateToQueue</span>(queue1, update);
      <span class="hljs-title function_">appendUpdateToQueue</span>(queue2, update);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// Both queues are non-empty. The last update is the same in both lists,</span>
      <span class="hljs-comment">// because of structural sharing. So, only append to one of the lists.</span>
      <span class="hljs-title function_">appendUpdateToQueue</span>(queue1, update);
      <span class="hljs-comment">// But we still need to update the `lastUpdate` pointer of queue2.</span>
      queue2.<span class="hljs-property">lastUpdate</span> = update;
    }
  }
}
</code></pre>
<h6 id="createupdatequeue">createUpdateQueue</h6>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// packages\react-reconciler\src\ReactUpdateQueue.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> createUpdateQueue&#x3C;<span class="hljs-title class_">State</span>>(<span class="hljs-attr">baseState</span>: <span class="hljs-title class_">State</span>): <span class="hljs-title class_">UpdateQueue</span>&#x3C;<span class="hljs-title class_">State</span>> {
  <span class="hljs-keyword">const</span> <span class="hljs-attr">queue</span>: <span class="hljs-title class_">UpdateQueue</span>&#x3C;<span class="hljs-title class_">State</span>> = {
    baseState,
    <span class="hljs-attr">firstUpdate</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">lastUpdate</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">firstCapturedUpdate</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">lastCapturedUpdate</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">firstEffect</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">lastEffect</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">firstCapturedEffect</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">lastCapturedEffect</span>: <span class="hljs-literal">null</span>,
  };
  <span class="hljs-keyword">return</span> queue;
}
</code></pre>
<h6 id="cloneupdatequeue">cloneUpdateQueue</h6>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// packages\react-reconciler\src\ReactUpdateQueue.js</span>
<span class="hljs-keyword">function</span> cloneUpdateQueue&#x3C;<span class="hljs-title class_">State</span>>(
  <span class="hljs-attr">currentQueue</span>: <span class="hljs-title class_">UpdateQueue</span>&#x3C;<span class="hljs-title class_">State</span>>,
): <span class="hljs-title class_">UpdateQueue</span>&#x3C;<span class="hljs-title class_">State</span>> {
  <span class="hljs-keyword">const</span> <span class="hljs-attr">queue</span>: <span class="hljs-title class_">UpdateQueue</span>&#x3C;<span class="hljs-title class_">State</span>> = {
    <span class="hljs-attr">baseState</span>: currentQueue.<span class="hljs-property">baseState</span>,
    <span class="hljs-attr">firstUpdate</span>: currentQueue.<span class="hljs-property">firstUpdate</span>,
    <span class="hljs-attr">lastUpdate</span>: currentQueue.<span class="hljs-property">lastUpdate</span>,

    <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> With resuming, if we bail out and resuse the child tree, we should</span>
    <span class="hljs-comment">// keep these effects.</span>
    <span class="hljs-attr">firstCapturedUpdate</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">lastCapturedUpdate</span>: <span class="hljs-literal">null</span>,

    <span class="hljs-attr">firstEffect</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">lastEffect</span>: <span class="hljs-literal">null</span>,

    <span class="hljs-attr">firstCapturedEffect</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">lastCapturedEffect</span>: <span class="hljs-literal">null</span>,
  };
  <span class="hljs-keyword">return</span> queue;
}
</code></pre>
<h6 id="appendupdatetoqueue">appendUpdateToQueue</h6>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// packages\react-reconciler\src\ReactUpdateQueue.js</span>
<span class="hljs-keyword">function</span> appendUpdateToQueue&#x3C;<span class="hljs-title class_">State</span>>(
  <span class="hljs-attr">queue</span>: <span class="hljs-title class_">UpdateQueue</span>&#x3C;<span class="hljs-title class_">State</span>>,
  <span class="hljs-attr">update</span>: <span class="hljs-title class_">Update</span>&#x3C;<span class="hljs-title class_">State</span>>,
) {
  <span class="hljs-comment">// Append the update to the end of the list.</span>
  <span class="hljs-keyword">if</span> (queue.<span class="hljs-property">lastUpdate</span> === <span class="hljs-literal">null</span>) {
    <span class="hljs-comment">// Queue is empty</span>
    queue.<span class="hljs-property">firstUpdate</span> = queue.<span class="hljs-property">lastUpdate</span> = update;
  } <span class="hljs-keyword">else</span> {
    queue.<span class="hljs-property">lastUpdate</span>.<span class="hljs-property">next</span> = update;
    queue.<span class="hljs-property">lastUpdate</span> = update;
  }
}
</code></pre>
<h4 id="schedulework">scheduleWork</h4>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// packages\react-reconciler\src\ReactFiberWorkLoop.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">scheduleUpdateOnFiber</span>(<span class="hljs-params">
  fiber: Fiber,
  expirationTime: ExpirationTime,
</span>) {
  <span class="hljs-title function_">checkForNestedUpdates</span>();
  <span class="hljs-title function_">warnAboutInvalidUpdatesOnClassComponentsInDEV</span>(fiber);

  <span class="hljs-keyword">const</span> root = <span class="hljs-title function_">markUpdateTimeFromFiberToRoot</span>(fiber, expirationTime);
  <span class="hljs-keyword">if</span> (root === <span class="hljs-literal">null</span>) {
    <span class="hljs-title function_">warnAboutUpdateOnUnmountedFiberInDEV</span>(fiber);
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-title function_">checkForInterruption</span>(fiber, expirationTime);
  <span class="hljs-title function_">recordScheduleUpdate</span>();

  <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> computeExpirationForFiber also reads the priority. Pass the</span>
  <span class="hljs-comment">// priority as an argument to that function and this one.</span>
  <span class="hljs-keyword">const</span> priorityLevel = <span class="hljs-title function_">getCurrentPriorityLevel</span>();

  <span class="hljs-keyword">if</span> (expirationTime === <span class="hljs-title class_">Sync</span>) {
    <span class="hljs-keyword">if</span> (
      <span class="hljs-comment">// Check if we're inside unbatchedUpdates</span>
      (executionContext &#x26; <span class="hljs-title class_">LegacyUnbatchedContext</span>) !== <span class="hljs-title class_">NoContext</span> &#x26;&#x26;
      <span class="hljs-comment">// Check if we're not already rendering</span>
      (executionContext &#x26; (<span class="hljs-title class_">RenderContext</span> | <span class="hljs-title class_">CommitContext</span>)) === <span class="hljs-title class_">NoContext</span>
    ) {
      <span class="hljs-comment">// Register pending interactions on the root to avoid losing traced interaction data.</span>
      <span class="hljs-title function_">schedulePendingInteractions</span>(root, expirationTime);

      <span class="hljs-comment">// This is a legacy edge case. The initial mount of a ReactDOM.render-ed</span>
      <span class="hljs-comment">// root inside of batchedUpdates should be synchronous, but layout updates</span>
      <span class="hljs-comment">// should be deferred until the end of the batch.</span>
      <span class="hljs-title function_">performSyncWorkOnRoot</span>(root);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-title function_">ensureRootIsScheduled</span>(root);
      <span class="hljs-title function_">schedulePendingInteractions</span>(root, expirationTime);
      <span class="hljs-keyword">if</span> (executionContext === <span class="hljs-title class_">NoContext</span>) {
        <span class="hljs-comment">// Flush the synchronous work now, unless we're already working or inside</span>
        <span class="hljs-comment">// a batch. This is intentionally inside scheduleUpdateOnFiber instead of</span>
        <span class="hljs-comment">// scheduleCallbackForFiber to preserve the ability to schedule a callback</span>
        <span class="hljs-comment">// without immediately flushing it. We only do this for user-initiated</span>
        <span class="hljs-comment">// updates, to preserve historical behavior of sync mode.</span>
        <span class="hljs-title function_">flushSyncCallbackQueue</span>();
      }
    }
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-title function_">ensureRootIsScheduled</span>(root);
    <span class="hljs-title function_">schedulePendingInteractions</span>(root, expirationTime);
  }

  <span class="hljs-keyword">if</span> (
    (executionContext &#x26; <span class="hljs-title class_">DiscreteEventContext</span>) !== <span class="hljs-title class_">NoContext</span> &#x26;&#x26;
    <span class="hljs-comment">// Only updates at user-blocking priority or greater are considered</span>
    <span class="hljs-comment">// discrete, even inside a discrete event.</span>
    (priorityLevel === <span class="hljs-title class_">UserBlockingPriority</span> ||
      priorityLevel === <span class="hljs-title class_">ImmediatePriority</span>)
  ) {
    <span class="hljs-comment">// This is the result of a discrete event. Track the lowest priority</span>
    <span class="hljs-comment">// discrete update per root so we can flush them early, if needed.</span>
    <span class="hljs-keyword">if</span> (rootsWithPendingDiscreteUpdates === <span class="hljs-literal">null</span>) {
      rootsWithPendingDiscreteUpdates = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>([[root, expirationTime]]);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">const</span> lastDiscreteTime = rootsWithPendingDiscreteUpdates.<span class="hljs-title function_">get</span>(root);
      <span class="hljs-keyword">if</span> (lastDiscreteTime === <span class="hljs-literal">undefined</span> || lastDiscreteTime > expirationTime) {
        rootsWithPendingDiscreteUpdates.<span class="hljs-title function_">set</span>(root, expirationTime);
      }
    }
  }
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> scheduleWork = scheduleUpdateOnFiber;
</code></pre>
<h6 id="checkfornestedupdates">checkForNestedUpdates</h6>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// packages\react-reconciler\src\ReactFiberWorkLoop.js</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">checkForNestedUpdates</span>(<span class="hljs-params"></span>) {
  <span class="hljs-comment">// nestedUpdateCount默认为0</span>
  <span class="hljs-comment">// NESTED_UPDATE_LIMIT = 50</span>
  <span class="hljs-keyword">if</span> (nestedUpdateCount > <span class="hljs-variable constant_">NESTED_UPDATE_LIMIT</span>) {
    nestedUpdateCount = <span class="hljs-number">0</span>;
    rootWithNestedUpdates = <span class="hljs-literal">null</span>;
  }
}
</code></pre>
<h6 id="markupdatetimefromfibertoroot">markUpdateTimeFromFiberToRoot</h6>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// packages\react-reconciler\src\ReactFiberWorkLoop.js</span>

<span class="hljs-comment">// This is split into a separate function so we can mark a fiber with pending</span>
<span class="hljs-comment">// work without treating it as a typical update that originates from an event;</span>
<span class="hljs-comment">// e.g. retrying a Suspense boundary isn't an update, but it does schedule work</span>
<span class="hljs-comment">// on a fiber.</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">markUpdateTimeFromFiberToRoot</span>(<span class="hljs-params">fiber, expirationTime</span>) {
  <span class="hljs-comment">// Update the source fiber's expiration time</span>
  <span class="hljs-keyword">if</span> (fiber.<span class="hljs-property">expirationTime</span> &#x3C; expirationTime) {
    fiber.<span class="hljs-property">expirationTime</span> = expirationTime;
  }
  <span class="hljs-keyword">let</span> alternate = fiber.<span class="hljs-property">alternate</span>;
  <span class="hljs-keyword">if</span> (alternate !== <span class="hljs-literal">null</span> &#x26;&#x26; alternate.<span class="hljs-property">expirationTime</span> &#x3C; expirationTime) {
    alternate.<span class="hljs-property">expirationTime</span> = expirationTime;
  }
  <span class="hljs-comment">// Walk the parent path to the root and update the child expiration time.</span>
  <span class="hljs-keyword">let</span> node = fiber.<span class="hljs-property">return</span>;
  <span class="hljs-keyword">let</span> root = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">if</span> (node === <span class="hljs-literal">null</span> &#x26;&#x26; fiber.<span class="hljs-property">tag</span> === <span class="hljs-title class_">HostRoot</span>) {
    root = fiber.<span class="hljs-property">stateNode</span>;
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">while</span> (node !== <span class="hljs-literal">null</span>) {
      alternate = node.<span class="hljs-property">alternate</span>;
      <span class="hljs-keyword">if</span> (node.<span class="hljs-property">childExpirationTime</span> &#x3C; expirationTime) {
        node.<span class="hljs-property">childExpirationTime</span> = expirationTime;
        <span class="hljs-keyword">if</span> (
          alternate !== <span class="hljs-literal">null</span> &#x26;&#x26;
          alternate.<span class="hljs-property">childExpirationTime</span> &#x3C; expirationTime
        ) {
          alternate.<span class="hljs-property">childExpirationTime</span> = expirationTime;
        }
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (
        alternate !== <span class="hljs-literal">null</span> &#x26;&#x26;
        alternate.<span class="hljs-property">childExpirationTime</span> &#x3C; expirationTime
      ) {
        alternate.<span class="hljs-property">childExpirationTime</span> = expirationTime;
      }
      <span class="hljs-keyword">if</span> (node.<span class="hljs-property">return</span> === <span class="hljs-literal">null</span> &#x26;&#x26; node.<span class="hljs-property">tag</span> === <span class="hljs-title class_">HostRoot</span>) {
        root = node.<span class="hljs-property">stateNode</span>;
        <span class="hljs-keyword">break</span>;
      }
      node = node.<span class="hljs-property">return</span>;
    }
  }

  <span class="hljs-keyword">if</span> (root !== <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">if</span> (workInProgressRoot === root) {
      <span class="hljs-comment">// Received an update to a tree that's in the middle of rendering. Mark</span>
      <span class="hljs-comment">// that's unprocessed work on this root.</span>
      <span class="hljs-title function_">markUnprocessedUpdateTime</span>(expirationTime);

      <span class="hljs-keyword">if</span> (workInProgressRootExitStatus === <span class="hljs-title class_">RootSuspendedWithDelay</span>) {
        <span class="hljs-comment">// The root already suspended with a delay, which means this render</span>
        <span class="hljs-comment">// definitely won't finish. Since we have a new update, let's mark it as</span>
        <span class="hljs-comment">// suspended now, right before marking the incoming update. This has the</span>
        <span class="hljs-comment">// effect of interrupting the current render and switching to the update.</span>
        <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> This happens to work when receiving an update during the render</span>
        <span class="hljs-comment">// phase, because of the trick inside computeExpirationForFiber to</span>
        <span class="hljs-comment">// subtract 1 from `renderExpirationTime` to move it into a</span>
        <span class="hljs-comment">// separate bucket. But we should probably model it with an exception,</span>
        <span class="hljs-comment">// using the same mechanism we use to force hydration of a subtree.</span>
        <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> This does not account for low pri updates that were already</span>
        <span class="hljs-comment">// scheduled before the root started rendering. Need to track the next</span>
        <span class="hljs-comment">// pending expiration time (perhaps by backtracking the return path) and</span>
        <span class="hljs-comment">// then trigger a restart in the `renderDidSuspendDelayIfPossible` path.</span>
        <span class="hljs-title function_">markRootSuspendedAtTime</span>(root, renderExpirationTime);
      }
    }
    <span class="hljs-comment">// Mark that the root has a pending update.</span>
    <span class="hljs-title function_">markRootUpdatedAtTime</span>(root, expirationTime);
  }

  <span class="hljs-keyword">return</span> root;
}
</code></pre>
<p>markUnprocessedUpdateTime</p>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// packages\react-reconciler\src\ReactFiberWorkLoop.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">markUnprocessedUpdateTime</span>(<span class="hljs-params">
  expirationTime: ExpirationTime,
</span>): <span class="hljs-keyword">void</span> {
  <span class="hljs-keyword">if</span> (expirationTime > workInProgressRootNextUnprocessedUpdateTime) {
    workInProgressRootNextUnprocessedUpdateTime = expirationTime;
  }
}
</code></pre>
<p>markRootUpdatedAtTime</p>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// packages\react-reconciler\src\ReactFiberRoot.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">markRootUpdatedAtTime</span>(<span class="hljs-params">
  root: FiberRoot,
  expirationTime: ExpirationTime,
</span>): <span class="hljs-keyword">void</span> {
  <span class="hljs-comment">// Update the range of pending times</span>
  <span class="hljs-keyword">const</span> firstPendingTime = root.<span class="hljs-property">firstPendingTime</span>;
  <span class="hljs-keyword">if</span> (expirationTime > firstPendingTime) {
    root.<span class="hljs-property">firstPendingTime</span> = expirationTime;
  }

  <span class="hljs-comment">// Update the range of suspended times. Treat everything lower priority or</span>
  <span class="hljs-comment">// equal to this update as unsuspended.</span>
  <span class="hljs-keyword">const</span> firstSuspendedTime = root.<span class="hljs-property">firstSuspendedTime</span>;
  <span class="hljs-keyword">if</span> (firstSuspendedTime !== <span class="hljs-title class_">NoWork</span>) {
    <span class="hljs-keyword">if</span> (expirationTime >= firstSuspendedTime) {
      <span class="hljs-comment">// The entire suspended range is now unsuspended.</span>
      root.<span class="hljs-property">firstSuspendedTime</span> = root.<span class="hljs-property">lastSuspendedTime</span> = root.<span class="hljs-property">nextKnownPendingLevel</span> = <span class="hljs-title class_">NoWork</span>;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (expirationTime >= root.<span class="hljs-property">lastSuspendedTime</span>) {
      root.<span class="hljs-property">lastSuspendedTime</span> = expirationTime + <span class="hljs-number">1</span>;
    }

    <span class="hljs-comment">// This is a pending level. Check if it's higher priority than the next</span>
    <span class="hljs-comment">// known pending level.</span>
    <span class="hljs-keyword">if</span> (expirationTime > root.<span class="hljs-property">nextKnownPendingLevel</span>) {
      root.<span class="hljs-property">nextKnownPendingLevel</span> = expirationTime;
    }
  }
}
</code></pre>
<h6 id="checkforinterruption">checkForInterruption</h6>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// packages\react-reconciler\src\ReactFiberWorkLoop.js</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">checkForInterruption</span>(<span class="hljs-params">
  fiberThatReceivedUpdate: Fiber,
  updateExpirationTime: ExpirationTime,
</span>) {
  <span class="hljs-keyword">if</span> (
    enableUserTimingAPI &#x26;&#x26;
    workInProgressRoot !== <span class="hljs-literal">null</span> &#x26;&#x26;
    updateExpirationTime > renderExpirationTime
  ) {
    interruptedBy = fiberThatReceivedUpdate;
  }
}
</code></pre>
<h6 id="recordscheduleupdate">recordScheduleUpdate</h6>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// packages\react-reconciler\src\ReactDebugFiberPerf.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">recordScheduleUpdate</span>(<span class="hljs-params"></span>): <span class="hljs-keyword">void</span> {
  <span class="hljs-keyword">if</span> (enableUserTimingAPI) {
    <span class="hljs-keyword">if</span> (isCommitting) {
      hasScheduledUpdateInCurrentCommit = <span class="hljs-literal">true</span>;
    }
    <span class="hljs-keyword">if</span> (
      currentPhase !== <span class="hljs-literal">null</span> &#x26;&#x26;
      currentPhase !== <span class="hljs-string">'componentWillMount'</span> &#x26;&#x26;
      currentPhase !== <span class="hljs-string">'componentWillReceiveProps'</span>
    ) {
      hasScheduledUpdateInCurrentPhase = <span class="hljs-literal">true</span>;
    }
  }
}
</code></pre>
<h6 id="getcurrentprioritylevel">getCurrentPriorityLevel</h6>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// packages\react-reconciler\src\SchedulerWithReactIntegration.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getCurrentPriorityLevel</span>(<span class="hljs-params"></span>): <span class="hljs-title class_">ReactPriorityLevel</span> {
  <span class="hljs-keyword">switch</span> (<span class="hljs-title class_">Scheduler</span>_getCurrentPriorityLevel()) {
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">Scheduler</span><span class="hljs-attr">_ImmediatePriority</span>:
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">ImmediatePriority</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">Scheduler</span><span class="hljs-attr">_UserBlockingPriority</span>:
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">UserBlockingPriority</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">Scheduler</span><span class="hljs-attr">_NormalPriority</span>:
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">NormalPriority</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">Scheduler</span><span class="hljs-attr">_LowPriority</span>:
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">LowPriority</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">Scheduler</span><span class="hljs-attr">_IdlePriority</span>:
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">IdlePriority</span>;
    <span class="hljs-attr">default</span>:
      <span class="hljs-title function_">invariant</span>(<span class="hljs-literal">false</span>, <span class="hljs-string">'Unknown priority level.'</span>);
  }
}
</code></pre>
<h6 id="schedulependinginteractions">schedulePendingInteractions</h6>
<pre><code class="hljs language-javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">schedulePendingInteractions</span>(<span class="hljs-params">root, expirationTime</span>) {
  <span class="hljs-comment">// This is called when work is scheduled on a root.</span>
  <span class="hljs-comment">// It associates the current interactions with the newly-scheduled expiration.</span>
  <span class="hljs-comment">// They will be restored when that expiration is later committed.</span>
  <span class="hljs-keyword">if</span> (!enableSchedulerTracing) {
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-title function_">scheduleInteractions</span>(root, expirationTime, __interactionsRef.<span class="hljs-property">current</span>);
}
</code></pre>
<p>scheduleInteractions</p>
<pre><code class="hljs language-javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">scheduleInteractions</span>(<span class="hljs-params">root, expirationTime, interactions</span>) {
  <span class="hljs-keyword">if</span> (!enableSchedulerTracing) {
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-keyword">if</span> (interactions.<span class="hljs-property">size</span> > <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">const</span> pendingInteractionMap = root.<span class="hljs-property">pendingInteractionMap</span>;
    <span class="hljs-keyword">const</span> pendingInteractions = pendingInteractionMap.<span class="hljs-title function_">get</span>(expirationTime);
    <span class="hljs-keyword">if</span> (pendingInteractions != <span class="hljs-literal">null</span>) {
      interactions.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">interaction</span> =></span> {
        <span class="hljs-keyword">if</span> (!pendingInteractions.<span class="hljs-title function_">has</span>(interaction)) {
          <span class="hljs-comment">// Update the pending async work count for previously unscheduled interaction.</span>
          interaction.<span class="hljs-property">__count</span>++;
        }

        pendingInteractions.<span class="hljs-title function_">add</span>(interaction);
      });
    } <span class="hljs-keyword">else</span> {
      pendingInteractionMap.<span class="hljs-title function_">set</span>(expirationTime, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>(interactions));

      <span class="hljs-comment">// Update the pending async work count for the current interactions.</span>
      interactions.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">interaction</span> =></span> {
        interaction.<span class="hljs-property">__count</span>++;
      });
    }

    <span class="hljs-keyword">const</span> subscriber = __subscriberRef.<span class="hljs-property">current</span>;
    <span class="hljs-keyword">if</span> (subscriber !== <span class="hljs-literal">null</span>) {
      <span class="hljs-keyword">const</span> threadID = <span class="hljs-title function_">computeThreadID</span>(root, expirationTime);
      subscriber.<span class="hljs-title function_">onWorkScheduled</span>(interactions, threadID);
    }
  }
}
</code></pre>
<h6 id="performsyncworkonroot">performSyncWorkOnRoot</h6>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// packages\react-reconciler\src\ReactFiberWorkLoop.js</span>

<span class="hljs-comment">// This is the entry point for synchronous tasks that don't go</span>
<span class="hljs-comment">// through Scheduler</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">performSyncWorkOnRoot</span>(<span class="hljs-params">root</span>) {
  <span class="hljs-comment">// Check if there's expired work on this root. Otherwise, render at Sync.</span>
  <span class="hljs-keyword">const</span> lastExpiredTime = root.<span class="hljs-property">lastExpiredTime</span>;
  <span class="hljs-keyword">const</span> expirationTime = lastExpiredTime !== <span class="hljs-title class_">NoWork</span> ? lastExpiredTime : <span class="hljs-title class_">Sync</span>;
  <span class="hljs-keyword">if</span> (root.<span class="hljs-property">finishedExpirationTime</span> === expirationTime) {
    <span class="hljs-comment">// There's already a pending commit at this expiration time.</span>
    <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> This is poorly factored. This case only exists for the</span>
    <span class="hljs-comment">// batch.commit() API.</span>
    <span class="hljs-title function_">commitRoot</span>(root);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-title function_">invariant</span>(
      (executionContext &#x26; (<span class="hljs-title class_">RenderContext</span> | <span class="hljs-title class_">CommitContext</span>)) === <span class="hljs-title class_">NoContext</span>,
      <span class="hljs-string">'Should not already be working.'</span>,
    );

    <span class="hljs-title function_">flushPassiveEffects</span>();

    <span class="hljs-comment">// If the root or expiration time have changed, throw out the existing stack</span>
    <span class="hljs-comment">// and prepare a fresh one. Otherwise we'll continue where we left off.</span>
    <span class="hljs-keyword">if</span> (
      root !== workInProgressRoot ||
      expirationTime !== renderExpirationTime
    ) {
      <span class="hljs-title function_">prepareFreshStack</span>(root, expirationTime);
      <span class="hljs-title function_">startWorkOnPendingInteractions</span>(root, expirationTime);
    }

    <span class="hljs-comment">// If we have a work-in-progress fiber, it means there's still work to do</span>
    <span class="hljs-comment">// in this root.</span>
    <span class="hljs-keyword">if</span> (workInProgress !== <span class="hljs-literal">null</span>) {
      <span class="hljs-keyword">const</span> prevExecutionContext = executionContext;
      executionContext |= <span class="hljs-title class_">RenderContext</span>;
      <span class="hljs-keyword">const</span> prevDispatcher = <span class="hljs-title function_">pushDispatcher</span>(root);
      <span class="hljs-keyword">const</span> prevInteractions = <span class="hljs-title function_">pushInteractions</span>(root);
      <span class="hljs-title function_">startWorkLoopTimer</span>(workInProgress);

      <span class="hljs-keyword">do</span> {
        <span class="hljs-keyword">try</span> {
          <span class="hljs-title function_">workLoopSync</span>();
          <span class="hljs-keyword">break</span>;
        } <span class="hljs-keyword">catch</span> (thrownValue) {
          <span class="hljs-title function_">handleError</span>(root, thrownValue);
        }
      } <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>);
      <span class="hljs-title function_">resetContextDependencies</span>();
      executionContext = prevExecutionContext;
      <span class="hljs-title function_">popDispatcher</span>(prevDispatcher);
      <span class="hljs-keyword">if</span> (enableSchedulerTracing) {
        <span class="hljs-title function_">popInteractions</span>(((<span class="hljs-attr">prevInteractions</span>: any): <span class="hljs-title class_">Set</span>&#x3C;<span class="hljs-title class_">Interaction</span>>));
      }

      <span class="hljs-keyword">if</span> (workInProgressRootExitStatus === <span class="hljs-title class_">RootFatalErrored</span>) {
        <span class="hljs-keyword">const</span> fatalError = workInProgressRootFatalError;
        <span class="hljs-title function_">stopInterruptedWorkLoopTimer</span>();
        <span class="hljs-title function_">prepareFreshStack</span>(root, expirationTime);
        <span class="hljs-title function_">markRootSuspendedAtTime</span>(root, expirationTime);
        <span class="hljs-title function_">ensureRootIsScheduled</span>(root);
        <span class="hljs-keyword">throw</span> fatalError;
      }

      <span class="hljs-keyword">if</span> (workInProgress !== <span class="hljs-literal">null</span>) {
        <span class="hljs-comment">// This is a sync render, so we should have finished the whole tree.</span>
        <span class="hljs-title function_">invariant</span>(
          <span class="hljs-literal">false</span>,
          <span class="hljs-string">'Cannot commit an incomplete root. This error is likely caused by a '</span> +
            <span class="hljs-string">'bug in React. Please file an issue.'</span>,
        );
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// We now have a consistent tree. Because this is a sync render, we</span>
        <span class="hljs-comment">// will commit it even if something suspended. The only exception is</span>
        <span class="hljs-comment">// if the root is locked (using the unstable_createBatch API).</span>
        <span class="hljs-title function_">stopFinishedWorkLoopTimer</span>();
        root.<span class="hljs-property">finishedWork</span> = (root.<span class="hljs-property">current</span>.<span class="hljs-property">alternate</span>: any);
        root.<span class="hljs-property">finishedExpirationTime</span> = expirationTime;
        <span class="hljs-title function_">resolveLocksOnRoot</span>(root, expirationTime);
        <span class="hljs-title function_">finishSyncRender</span>(root, workInProgressRootExitStatus, expirationTime);
      }

      <span class="hljs-comment">// Before exiting, make sure there's a callback scheduled for the next</span>
      <span class="hljs-comment">// pending level.</span>
      <span class="hljs-title function_">ensureRootIsScheduled</span>(root);
    }
  }

  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}
</code></pre>
<h5 id="preparefreshstack">prepareFreshStack</h5>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// packages\react-reconciler\src\ReactFiberWorkLoop.js</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">prepareFreshStack</span>(<span class="hljs-params">root, expirationTime</span>) {
  root.<span class="hljs-property">finishedWork</span> = <span class="hljs-literal">null</span>;
  root.<span class="hljs-property">finishedExpirationTime</span> = <span class="hljs-title class_">NoWork</span>;

  <span class="hljs-keyword">const</span> timeoutHandle = root.<span class="hljs-property">timeoutHandle</span>;
  <span class="hljs-keyword">if</span> (timeoutHandle !== noTimeout) {
    <span class="hljs-comment">// The root previous suspended and scheduled a timeout to commit a fallback</span>
    <span class="hljs-comment">// state. Now that we have additional work, cancel the timeout.</span>
    root.<span class="hljs-property">timeoutHandle</span> = noTimeout;
    <span class="hljs-comment">// $FlowFixMe Complains noTimeout is not a TimeoutID, despite the check above</span>
    <span class="hljs-title function_">cancelTimeout</span>(timeoutHandle);
  }

  <span class="hljs-keyword">if</span> (workInProgress !== <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">let</span> interruptedWork = workInProgress.<span class="hljs-property">return</span>;
    <span class="hljs-keyword">while</span> (interruptedWork !== <span class="hljs-literal">null</span>) {
      <span class="hljs-title function_">unwindInterruptedWork</span>(interruptedWork);
      interruptedWork = interruptedWork.<span class="hljs-property">return</span>;
    }
  }
  workInProgressRoot = root;
  workInProgress = <span class="hljs-title function_">createWorkInProgress</span>(root.<span class="hljs-property">current</span>, <span class="hljs-literal">null</span>, expirationTime);
  renderExpirationTime = expirationTime;
  workInProgressRootExitStatus = <span class="hljs-title class_">RootIncomplete</span>;
  workInProgressRootFatalError = <span class="hljs-literal">null</span>;
  workInProgressRootLatestProcessedExpirationTime = <span class="hljs-title class_">Sync</span>;
  workInProgressRootLatestSuspenseTimeout = <span class="hljs-title class_">Sync</span>;
  workInProgressRootCanSuspendUsingConfig = <span class="hljs-literal">null</span>;
  workInProgressRootNextUnprocessedUpdateTime = <span class="hljs-title class_">NoWork</span>;
  workInProgressRootHasPendingPing = <span class="hljs-literal">false</span>;

  <span class="hljs-keyword">if</span> (enableSchedulerTracing) {
    spawnedWorkDuringRender = <span class="hljs-literal">null</span>;
  }

  <span class="hljs-keyword">if</span> (__DEV__) {
    <span class="hljs-title class_">ReactStrictModeWarnings</span>.<span class="hljs-title function_">discardPendingWarnings</span>();
    componentsThatTriggeredHighPriSuspend = <span class="hljs-literal">null</span>;
  }
}
</code></pre>
<h6 id="createworkinprogress">createWorkInProgress</h6>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// packages\react-reconciler\src\ReactFiber.js</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createWorkInProgress</span>(<span class="hljs-params">
  current: Fiber,
  pendingProps: any,
  expirationTime: ExpirationTime,
</span>): <span class="hljs-title class_">Fiber</span> {
  <span class="hljs-keyword">let</span> workInProgress = current.<span class="hljs-property">alternate</span>;
  <span class="hljs-keyword">if</span> (workInProgress === <span class="hljs-literal">null</span>) {
    <span class="hljs-comment">// We use a double buffering pooling technique because we know that we'll</span>
    <span class="hljs-comment">// only ever need at most two versions of a tree. We pool the "other" unused</span>
    <span class="hljs-comment">// node that we're free to reuse. This is lazily created to avoid allocating</span>
    <span class="hljs-comment">// extra objects for things that are never updated. It also allow us to</span>
    <span class="hljs-comment">// reclaim the extra memory if needed.</span>
    workInProgress = <span class="hljs-title function_">createFiber</span>(
      current.<span class="hljs-property">tag</span>,
      pendingProps,
      current.<span class="hljs-property">key</span>,
      current.<span class="hljs-property">mode</span>,
    );
    workInProgress.<span class="hljs-property">elementType</span> = current.<span class="hljs-property">elementType</span>;
    workInProgress.<span class="hljs-property">type</span> = current.<span class="hljs-property">type</span>;
    workInProgress.<span class="hljs-property">stateNode</span> = current.<span class="hljs-property">stateNode</span>;

    <span class="hljs-keyword">if</span> (__DEV__) {
      <span class="hljs-comment">// DEV-only fields</span>
      workInProgress.<span class="hljs-property">_debugID</span> = current.<span class="hljs-property">_debugID</span>;
      workInProgress.<span class="hljs-property">_debugSource</span> = current.<span class="hljs-property">_debugSource</span>;
      workInProgress.<span class="hljs-property">_debugOwner</span> = current.<span class="hljs-property">_debugOwner</span>;
      workInProgress.<span class="hljs-property">_debugHookTypes</span> = current.<span class="hljs-property">_debugHookTypes</span>;
    }

    workInProgress.<span class="hljs-property">alternate</span> = current;
    current.<span class="hljs-property">alternate</span> = workInProgress;
  } <span class="hljs-keyword">else</span> {
    workInProgress.<span class="hljs-property">pendingProps</span> = pendingProps;

    <span class="hljs-comment">// We already have an alternate.</span>
    <span class="hljs-comment">// Reset the effect tag.</span>
    workInProgress.<span class="hljs-property">effectTag</span> = <span class="hljs-title class_">NoEffect</span>;

    <span class="hljs-comment">// The effect list is no longer valid.</span>
    workInProgress.<span class="hljs-property">nextEffect</span> = <span class="hljs-literal">null</span>;
    workInProgress.<span class="hljs-property">firstEffect</span> = <span class="hljs-literal">null</span>;
    workInProgress.<span class="hljs-property">lastEffect</span> = <span class="hljs-literal">null</span>;

    <span class="hljs-keyword">if</span> (enableProfilerTimer) {
      <span class="hljs-comment">// We intentionally reset, rather than copy, actualDuration &#x26; actualStartTime.</span>
      <span class="hljs-comment">// This prevents time from endlessly accumulating in new commits.</span>
      <span class="hljs-comment">// This has the downside of resetting values for different priority renders,</span>
      <span class="hljs-comment">// But works for yielding (the common case) and should support resuming.</span>
      workInProgress.<span class="hljs-property">actualDuration</span> = <span class="hljs-number">0</span>;
      workInProgress.<span class="hljs-property">actualStartTime</span> = -<span class="hljs-number">1</span>;
    }
  }

  workInProgress.<span class="hljs-property">childExpirationTime</span> = current.<span class="hljs-property">childExpirationTime</span>;
  workInProgress.<span class="hljs-property">expirationTime</span> = current.<span class="hljs-property">expirationTime</span>;

  workInProgress.<span class="hljs-property">child</span> = current.<span class="hljs-property">child</span>;
  workInProgress.<span class="hljs-property">memoizedProps</span> = current.<span class="hljs-property">memoizedProps</span>;
  workInProgress.<span class="hljs-property">memoizedState</span> = current.<span class="hljs-property">memoizedState</span>;
  workInProgress.<span class="hljs-property">updateQueue</span> = current.<span class="hljs-property">updateQueue</span>;

  <span class="hljs-comment">// Clone the dependencies object. This is mutated during the render phase, so</span>
  <span class="hljs-comment">// it cannot be shared with the current fiber.</span>
  <span class="hljs-keyword">const</span> currentDependencies = current.<span class="hljs-property">dependencies</span>;
  workInProgress.<span class="hljs-property">dependencies</span> =
    currentDependencies === <span class="hljs-literal">null</span>
      ? <span class="hljs-literal">null</span>
      : {
          <span class="hljs-attr">expirationTime</span>: currentDependencies.<span class="hljs-property">expirationTime</span>,
          <span class="hljs-attr">firstContext</span>: currentDependencies.<span class="hljs-property">firstContext</span>,
          <span class="hljs-attr">responders</span>: currentDependencies.<span class="hljs-property">responders</span>,
        };

  <span class="hljs-comment">// These will be overridden during the parent's reconciliation</span>
  workInProgress.<span class="hljs-property">sibling</span> = current.<span class="hljs-property">sibling</span>;
  workInProgress.<span class="hljs-property">index</span> = current.<span class="hljs-property">index</span>;
  workInProgress.<span class="hljs-property">ref</span> = current.<span class="hljs-property">ref</span>;

  <span class="hljs-keyword">if</span> (enableProfilerTimer) {
    workInProgress.<span class="hljs-property">selfBaseDuration</span> = current.<span class="hljs-property">selfBaseDuration</span>;
    workInProgress.<span class="hljs-property">treeBaseDuration</span> = current.<span class="hljs-property">treeBaseDuration</span>;
  }

  <span class="hljs-keyword">if</span> (__DEV__) {
    workInProgress.<span class="hljs-property">_debugNeedsRemount</span> = current.<span class="hljs-property">_debugNeedsRemount</span>;
    <span class="hljs-keyword">switch</span> (workInProgress.<span class="hljs-property">tag</span>) {
      <span class="hljs-keyword">case</span> <span class="hljs-title class_">IndeterminateComponent</span>:
      <span class="hljs-keyword">case</span> <span class="hljs-title class_">FunctionComponent</span>:
      <span class="hljs-keyword">case</span> <span class="hljs-title class_">SimpleMemoComponent</span>:
        workInProgress.<span class="hljs-property">type</span> = <span class="hljs-title function_">resolveFunctionForHotReloading</span>(current.<span class="hljs-property">type</span>);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-title class_">ClassComponent</span>:
        workInProgress.<span class="hljs-property">type</span> = <span class="hljs-title function_">resolveClassForHotReloading</span>(current.<span class="hljs-property">type</span>);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-title class_">ForwardRef</span>:
        workInProgress.<span class="hljs-property">type</span> = <span class="hljs-title function_">resolveForwardRefForHotReloading</span>(current.<span class="hljs-property">type</span>);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-attr">default</span>:
        <span class="hljs-keyword">break</span>;
    }
  }

  <span class="hljs-keyword">return</span> workInProgress;
}
</code></pre>
<h6 id="pushdispatcher">pushDispatcher</h6>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// packages\react-reconciler\src\ReactFiberWorkLoop.js</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">pushDispatcher</span>(<span class="hljs-params">root</span>) {
  <span class="hljs-keyword">const</span> prevDispatcher = <span class="hljs-title class_">ReactCurrentDispatcher</span>.<span class="hljs-property">current</span>;
  <span class="hljs-title class_">ReactCurrentDispatcher</span>.<span class="hljs-property">current</span> = <span class="hljs-title class_">ContextOnlyDispatcher</span>;
  <span class="hljs-keyword">if</span> (prevDispatcher === <span class="hljs-literal">null</span>) {
    <span class="hljs-comment">// The React isomorphic package does not include a default dispatcher.</span>
    <span class="hljs-comment">// Instead the first renderer will lazily attach one, in order to give</span>
    <span class="hljs-comment">// nicer error messages.</span>
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">ContextOnlyDispatcher</span>;
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">return</span> prevDispatcher;
  }
}
</code></pre>
<h6 id="workloopsync">workLoopSync</h6>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// packages\react-reconciler\src\ReactFiberWorkLoop.js</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">workLoopSync</span>(<span class="hljs-params"></span>) {
  <span class="hljs-comment">// Already timed out, so perform work without checking if we need to yield.</span>
  <span class="hljs-keyword">while</span> (workInProgress !== <span class="hljs-literal">null</span>) {
    workInProgress = <span class="hljs-title function_">performUnitOfWork</span>(workInProgress);
  }
}
</code></pre>
<h6 id="performunitofwork">performUnitOfWork</h6>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// packages\react-reconciler\src\ReactFiberWorkLoop.js</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">performUnitOfWork</span>(<span class="hljs-params">unitOfWork: Fiber</span>): <span class="hljs-title class_">Fiber</span> | <span class="hljs-literal">null</span> {
  <span class="hljs-comment">// The current, flushed, state of this fiber is the alternate. Ideally</span>
  <span class="hljs-comment">// nothing should rely on this, but relying on it here means that we don't</span>
  <span class="hljs-comment">// need an additional field on the work in progress.</span>
  <span class="hljs-keyword">const</span> current = unitOfWork.<span class="hljs-property">alternate</span>;

  <span class="hljs-title function_">startWorkTimer</span>(unitOfWork);
  <span class="hljs-title function_">setCurrentDebugFiberInDEV</span>(unitOfWork);

  <span class="hljs-keyword">let</span> next;
  <span class="hljs-keyword">if</span> (enableProfilerTimer &#x26;&#x26; (unitOfWork.<span class="hljs-property">mode</span> &#x26; <span class="hljs-title class_">ProfileMode</span>) !== <span class="hljs-title class_">NoMode</span>) {
    <span class="hljs-title function_">startProfilerTimer</span>(unitOfWork);
    next = <span class="hljs-title function_">beginWork</span>(current, unitOfWork, renderExpirationTime);
    <span class="hljs-title function_">stopProfilerTimerIfRunningAndRecordDelta</span>(unitOfWork, <span class="hljs-literal">true</span>);
  } <span class="hljs-keyword">else</span> {
    next = <span class="hljs-title function_">beginWork</span>(current, unitOfWork, renderExpirationTime);
  }

  <span class="hljs-title function_">resetCurrentDebugFiberInDEV</span>();
  unitOfWork.<span class="hljs-property">memoizedProps</span> = unitOfWork.<span class="hljs-property">pendingProps</span>;
  <span class="hljs-keyword">if</span> (next === <span class="hljs-literal">null</span>) {
    <span class="hljs-comment">// If this doesn't spawn new work, complete the current work.</span>
    next = <span class="hljs-title function_">completeUnitOfWork</span>(unitOfWork);
  }

  <span class="hljs-title class_">ReactCurrentOwner</span>.<span class="hljs-property">current</span> = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">return</span> next;
}
</code></pre>
<h4 id="beginwork">beginWork</h4>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// packages\react-reconciler\src\ReactFiberBeginWork.js</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">beginWork</span>(<span class="hljs-params">
  current: Fiber | <span class="hljs-literal">null</span>,
  workInProgress: Fiber,
  renderExpirationTime: ExpirationTime,
</span>): <span class="hljs-title class_">Fiber</span> | <span class="hljs-literal">null</span> {
  <span class="hljs-keyword">const</span> updateExpirationTime = workInProgress.<span class="hljs-property">expirationTime</span>;

  <span class="hljs-keyword">if</span> (__DEV__) {
    <span class="hljs-keyword">if</span> (workInProgress.<span class="hljs-property">_debugNeedsRemount</span> &#x26;&#x26; current !== <span class="hljs-literal">null</span>) {
      <span class="hljs-comment">// This will restart the begin phase with a new fiber.</span>
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">remountFiber</span>(
        current,
        workInProgress,
        <span class="hljs-title function_">createFiberFromTypeAndProps</span>(
          workInProgress.<span class="hljs-property">type</span>,
          workInProgress.<span class="hljs-property">key</span>,
          workInProgress.<span class="hljs-property">pendingProps</span>,
          workInProgress.<span class="hljs-property">_debugOwner</span> || <span class="hljs-literal">null</span>,
          workInProgress.<span class="hljs-property">mode</span>,
          workInProgress.<span class="hljs-property">expirationTime</span>,
        ),
      );
    }
  }

  <span class="hljs-keyword">if</span> (current !== <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">const</span> oldProps = current.<span class="hljs-property">memoizedProps</span>;
    <span class="hljs-keyword">const</span> newProps = workInProgress.<span class="hljs-property">pendingProps</span>;

    <span class="hljs-keyword">if</span> (
      oldProps !== newProps ||
      <span class="hljs-title function_">hasLegacyContextChanged</span>() ||
      <span class="hljs-comment">// Force a re-render if the implementation changed due to hot reload:</span>
      (__DEV__ ? workInProgress.<span class="hljs-property">type</span> !== current.<span class="hljs-property">type</span> : <span class="hljs-literal">false</span>)
    ) {
      <span class="hljs-comment">// If props or context changed, mark the fiber as having performed work.</span>
      <span class="hljs-comment">// This may be unset if the props are determined to be equal later (memo).</span>
      didReceiveUpdate = <span class="hljs-literal">true</span>;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (updateExpirationTime &#x3C; renderExpirationTime) {
      didReceiveUpdate = <span class="hljs-literal">false</span>;
      <span class="hljs-comment">// This fiber does not have any pending work. Bailout without entering</span>
      <span class="hljs-comment">// the begin phase. There's still some bookkeeping we that needs to be done</span>
      <span class="hljs-comment">// in this optimized path, mostly pushing stuff onto the stack.</span>
      <span class="hljs-keyword">switch</span> (workInProgress.<span class="hljs-property">tag</span>) {
        <span class="hljs-keyword">case</span> <span class="hljs-title class_">HostRoot</span>:
          <span class="hljs-title function_">pushHostRootContext</span>(workInProgress);
          <span class="hljs-title function_">resetHydrationState</span>();
          <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-title class_">HostComponent</span>:
          <span class="hljs-title function_">pushHostContext</span>(workInProgress);
          <span class="hljs-keyword">if</span> (
            workInProgress.<span class="hljs-property">mode</span> &#x26; <span class="hljs-title class_">ConcurrentMode</span> &#x26;&#x26;
            renderExpirationTime !== <span class="hljs-title class_">Never</span> &#x26;&#x26;
            <span class="hljs-title function_">shouldDeprioritizeSubtree</span>(workInProgress.<span class="hljs-property">type</span>, newProps)
          ) {
            <span class="hljs-keyword">if</span> (enableSchedulerTracing) {
              <span class="hljs-title function_">markSpawnedWork</span>(<span class="hljs-title class_">Never</span>);
            }
            <span class="hljs-comment">// Schedule this fiber to re-render at offscreen priority. Then bailout.</span>
            workInProgress.<span class="hljs-property">expirationTime</span> = workInProgress.<span class="hljs-property">childExpirationTime</span> = <span class="hljs-title class_">Never</span>;
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
          }
          <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-title class_">ClassComponent</span>: {
          <span class="hljs-keyword">const</span> <span class="hljs-title class_">Component</span> = workInProgress.<span class="hljs-property">type</span>;
          <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isLegacyContextProvider</span>(<span class="hljs-title class_">Component</span>)) {
            <span class="hljs-title function_">pushLegacyContextProvider</span>(workInProgress);
          }
          <span class="hljs-keyword">break</span>;
        }
        <span class="hljs-keyword">case</span> <span class="hljs-title class_">HostPortal</span>:
          <span class="hljs-title function_">pushHostContainer</span>(
            workInProgress,
            workInProgress.<span class="hljs-property">stateNode</span>.<span class="hljs-property">containerInfo</span>,
          );
          <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-title class_">ContextProvider</span>: {
          <span class="hljs-keyword">const</span> newValue = workInProgress.<span class="hljs-property">memoizedProps</span>.<span class="hljs-property">value</span>;
          <span class="hljs-title function_">pushProvider</span>(workInProgress, newValue);
          <span class="hljs-keyword">break</span>;
        }
        <span class="hljs-keyword">case</span> <span class="hljs-title class_">Profiler</span>:
          <span class="hljs-keyword">if</span> (enableProfilerTimer) {
            workInProgress.<span class="hljs-property">effectTag</span> |= <span class="hljs-title class_">Update</span>;
          }
          <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-title class_">SuspenseComponent</span>: {
          <span class="hljs-keyword">const</span> <span class="hljs-attr">state</span>: <span class="hljs-title class_">SuspenseState</span> | <span class="hljs-literal">null</span> = workInProgress.<span class="hljs-property">memoizedState</span>;
          <span class="hljs-keyword">if</span> (state !== <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">if</span> (enableSuspenseServerRenderer) {
              <span class="hljs-keyword">if</span> (state.<span class="hljs-property">dehydrated</span> !== <span class="hljs-literal">null</span>) {
                <span class="hljs-title function_">pushSuspenseContext</span>(
                  workInProgress,
                  <span class="hljs-title function_">setDefaultShallowSuspenseContext</span>(suspenseStackCursor.<span class="hljs-property">current</span>),
                );
                <span class="hljs-comment">// We know that this component will suspend again because if it has</span>
                <span class="hljs-comment">// been unsuspended it has committed as a resolved Suspense component.</span>
                <span class="hljs-comment">// If it needs to be retried, it should have work scheduled on it.</span>
                workInProgress.<span class="hljs-property">effectTag</span> |= <span class="hljs-title class_">DidCapture</span>;
                <span class="hljs-keyword">break</span>;
              }
            }

            <span class="hljs-comment">// If this boundary is currently timed out, we need to decide</span>
            <span class="hljs-comment">// whether to retry the primary children, or to skip over it and</span>
            <span class="hljs-comment">// go straight to the fallback. Check the priority of the primary</span>
            <span class="hljs-comment">// child fragment.</span>
            <span class="hljs-keyword">const</span> <span class="hljs-attr">primaryChildFragment</span>: <span class="hljs-title class_">Fiber</span> = (workInProgress.<span class="hljs-property">child</span>: any);
            <span class="hljs-keyword">const</span> primaryChildExpirationTime =
              primaryChildFragment.<span class="hljs-property">childExpirationTime</span>;
            <span class="hljs-keyword">if</span> (
              primaryChildExpirationTime !== <span class="hljs-title class_">NoWork</span> &#x26;&#x26;
              primaryChildExpirationTime >= renderExpirationTime
            ) {
              <span class="hljs-comment">// The primary children have pending work. Use the normal path</span>
              <span class="hljs-comment">// to attempt to render the primary children again.</span>
              <span class="hljs-keyword">return</span> <span class="hljs-title function_">updateSuspenseComponent</span>(
                current,
                workInProgress,
                renderExpirationTime,
              );
            } <span class="hljs-keyword">else</span> {
              <span class="hljs-title function_">pushSuspenseContext</span>(
                workInProgress,
                <span class="hljs-title function_">setDefaultShallowSuspenseContext</span>(suspenseStackCursor.<span class="hljs-property">current</span>),
              );
              <span class="hljs-comment">// The primary children do not have pending work with sufficient</span>
              <span class="hljs-comment">// priority. Bailout.</span>
              <span class="hljs-keyword">const</span> child = <span class="hljs-title function_">bailoutOnAlreadyFinishedWork</span>(
                current,
                workInProgress,
                renderExpirationTime,
              );
              <span class="hljs-keyword">if</span> (child !== <span class="hljs-literal">null</span>) {
                <span class="hljs-comment">// The fallback children have pending work. Skip over the</span>
                <span class="hljs-comment">// primary children and work on the fallback.</span>
                <span class="hljs-keyword">return</span> child.<span class="hljs-property">sibling</span>;
              } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
              }
            }
          } <span class="hljs-keyword">else</span> {
            <span class="hljs-title function_">pushSuspenseContext</span>(
              workInProgress,
              <span class="hljs-title function_">setDefaultShallowSuspenseContext</span>(suspenseStackCursor.<span class="hljs-property">current</span>),
            );
          }
          <span class="hljs-keyword">break</span>;
        }
        <span class="hljs-keyword">case</span> <span class="hljs-title class_">SuspenseListComponent</span>: {
          <span class="hljs-keyword">const</span> didSuspendBefore =
            (current.<span class="hljs-property">effectTag</span> &#x26; <span class="hljs-title class_">DidCapture</span>) !== <span class="hljs-title class_">NoEffect</span>;

          <span class="hljs-keyword">const</span> hasChildWork =
            workInProgress.<span class="hljs-property">childExpirationTime</span> >= renderExpirationTime;

          <span class="hljs-keyword">if</span> (didSuspendBefore) {
            <span class="hljs-keyword">if</span> (hasChildWork) {
              <span class="hljs-comment">// If something was in fallback state last time, and we have all the</span>
              <span class="hljs-comment">// same children then we're still in progressive loading state.</span>
              <span class="hljs-comment">// Something might get unblocked by state updates or retries in the</span>
              <span class="hljs-comment">// tree which will affect the tail. So we need to use the normal</span>
              <span class="hljs-comment">// path to compute the correct tail.</span>
              <span class="hljs-keyword">return</span> <span class="hljs-title function_">updateSuspenseListComponent</span>(
                current,
                workInProgress,
                renderExpirationTime,
              );
            }
            <span class="hljs-comment">// If none of the children had any work, that means that none of</span>
            <span class="hljs-comment">// them got retried so they'll still be blocked in the same way</span>
            <span class="hljs-comment">// as before. We can fast bail out.</span>
            workInProgress.<span class="hljs-property">effectTag</span> |= <span class="hljs-title class_">DidCapture</span>;
          }

          <span class="hljs-comment">// If nothing suspended before and we're rendering the same children,</span>
          <span class="hljs-comment">// then the tail doesn't matter. Anything new that suspends will work</span>
          <span class="hljs-comment">// in the "together" mode, so we can continue from the state we had.</span>
          <span class="hljs-keyword">let</span> renderState = workInProgress.<span class="hljs-property">memoizedState</span>;
          <span class="hljs-keyword">if</span> (renderState !== <span class="hljs-literal">null</span>) {
            <span class="hljs-comment">// Reset to the "together" mode in case we've started a different</span>
            <span class="hljs-comment">// update in the past but didn't complete it.</span>
            renderState.<span class="hljs-property">rendering</span> = <span class="hljs-literal">null</span>;
            renderState.<span class="hljs-property">tail</span> = <span class="hljs-literal">null</span>;
          }
          <span class="hljs-title function_">pushSuspenseContext</span>(workInProgress, suspenseStackCursor.<span class="hljs-property">current</span>);

          <span class="hljs-keyword">if</span> (hasChildWork) {
            <span class="hljs-keyword">break</span>;
          } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// If none of the children had any work, that means that none of</span>
            <span class="hljs-comment">// them got retried so they'll still be blocked in the same way</span>
            <span class="hljs-comment">// as before. We can fast bail out.</span>
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
          }
        }
      }
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">bailoutOnAlreadyFinishedWork</span>(
        current,
        workInProgress,
        renderExpirationTime,
      );
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// An update was scheduled on this fiber, but there are no new props</span>
      <span class="hljs-comment">// nor legacy context. Set this to false. If an update queue or context</span>
      <span class="hljs-comment">// consumer produces a changed value, it will set this to true. Otherwise,</span>
      <span class="hljs-comment">// the component will assume the children have not changed and bail out.</span>
      didReceiveUpdate = <span class="hljs-literal">false</span>;
    }
  } <span class="hljs-keyword">else</span> {
    didReceiveUpdate = <span class="hljs-literal">false</span>;
  }

  <span class="hljs-comment">// Before entering the begin phase, clear the expiration time.</span>
  workInProgress.<span class="hljs-property">expirationTime</span> = <span class="hljs-title class_">NoWork</span>;

  <span class="hljs-keyword">switch</span> (workInProgress.<span class="hljs-property">tag</span>) {
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">IndeterminateComponent</span>: {
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">mountIndeterminateComponent</span>(
        current,
        workInProgress,
        workInProgress.<span class="hljs-property">type</span>,
        renderExpirationTime,
      );
    }
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">LazyComponent</span>: {
      <span class="hljs-keyword">const</span> elementType = workInProgress.<span class="hljs-property">elementType</span>;
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">mountLazyComponent</span>(
        current,
        workInProgress,
        elementType,
        updateExpirationTime,
        renderExpirationTime,
      );
    }
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">FunctionComponent</span>: {
      <span class="hljs-keyword">const</span> <span class="hljs-title class_">Component</span> = workInProgress.<span class="hljs-property">type</span>;
      <span class="hljs-keyword">const</span> unresolvedProps = workInProgress.<span class="hljs-property">pendingProps</span>;
      <span class="hljs-keyword">const</span> resolvedProps =
        workInProgress.<span class="hljs-property">elementType</span> === <span class="hljs-title class_">Component</span>
          ? unresolvedProps
          : <span class="hljs-title function_">resolveDefaultProps</span>(<span class="hljs-title class_">Component</span>, unresolvedProps);
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">updateFunctionComponent</span>(
        current,
        workInProgress,
        <span class="hljs-title class_">Component</span>,
        resolvedProps,
        renderExpirationTime,
      );
    }
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">ClassComponent</span>: {
      <span class="hljs-keyword">const</span> <span class="hljs-title class_">Component</span> = workInProgress.<span class="hljs-property">type</span>;
      <span class="hljs-keyword">const</span> unresolvedProps = workInProgress.<span class="hljs-property">pendingProps</span>;
      <span class="hljs-keyword">const</span> resolvedProps =
        workInProgress.<span class="hljs-property">elementType</span> === <span class="hljs-title class_">Component</span>
          ? unresolvedProps
          : <span class="hljs-title function_">resolveDefaultProps</span>(<span class="hljs-title class_">Component</span>, unresolvedProps);
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">updateClassComponent</span>(
        current,
        workInProgress,
        <span class="hljs-title class_">Component</span>,
        resolvedProps,
        renderExpirationTime,
      );
    }
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">HostRoot</span>:
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">updateHostRoot</span>(current, workInProgress, renderExpirationTime);
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">HostComponent</span>:
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">updateHostComponent</span>(current, workInProgress, renderExpirationTime);
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">HostText</span>:
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">updateHostText</span>(current, workInProgress);
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">SuspenseComponent</span>:
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">updateSuspenseComponent</span>(
        current,
        workInProgress,
        renderExpirationTime,
      );
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">HostPortal</span>:
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">updatePortalComponent</span>(
        current,
        workInProgress,
        renderExpirationTime,
      );
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">ForwardRef</span>: {
      <span class="hljs-keyword">const</span> type = workInProgress.<span class="hljs-property">type</span>;
      <span class="hljs-keyword">const</span> unresolvedProps = workInProgress.<span class="hljs-property">pendingProps</span>;
      <span class="hljs-keyword">const</span> resolvedProps =
        workInProgress.<span class="hljs-property">elementType</span> === type
          ? unresolvedProps
          : <span class="hljs-title function_">resolveDefaultProps</span>(type, unresolvedProps);
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">updateForwardRef</span>(
        current,
        workInProgress,
        type,
        resolvedProps,
        renderExpirationTime,
      );
    }
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">Fragment</span>:
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">updateFragment</span>(current, workInProgress, renderExpirationTime);
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">Mode</span>:
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">updateMode</span>(current, workInProgress, renderExpirationTime);
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">Profiler</span>:
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">updateProfiler</span>(current, workInProgress, renderExpirationTime);
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">ContextProvider</span>:
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">updateContextProvider</span>(
        current,
        workInProgress,
        renderExpirationTime,
      );
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">ContextConsumer</span>:
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">updateContextConsumer</span>(
        current,
        workInProgress,
        renderExpirationTime,
      );
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">MemoComponent</span>: {
      <span class="hljs-keyword">const</span> type = workInProgress.<span class="hljs-property">type</span>;
      <span class="hljs-keyword">const</span> unresolvedProps = workInProgress.<span class="hljs-property">pendingProps</span>;
      <span class="hljs-comment">// Resolve outer props first, then resolve inner props.</span>
      <span class="hljs-keyword">let</span> resolvedProps = <span class="hljs-title function_">resolveDefaultProps</span>(type, unresolvedProps);
      <span class="hljs-keyword">if</span> (__DEV__) {
        <span class="hljs-keyword">if</span> (workInProgress.<span class="hljs-property">type</span> !== workInProgress.<span class="hljs-property">elementType</span>) {
          <span class="hljs-keyword">const</span> outerPropTypes = type.<span class="hljs-property">propTypes</span>;
          <span class="hljs-keyword">if</span> (outerPropTypes) {
            <span class="hljs-title function_">checkPropTypes</span>(
              outerPropTypes,
              resolvedProps, <span class="hljs-comment">// Resolved for outer only</span>
              <span class="hljs-string">'prop'</span>,
              <span class="hljs-title function_">getComponentName</span>(type),
              getCurrentFiberStackInDev,
            );
          }
        }
      }
      resolvedProps = <span class="hljs-title function_">resolveDefaultProps</span>(type.<span class="hljs-property">type</span>, resolvedProps);
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">updateMemoComponent</span>(
        current,
        workInProgress,
        type,
        resolvedProps,
        updateExpirationTime,
        renderExpirationTime,
      );
    }
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">SimpleMemoComponent</span>: {
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">updateSimpleMemoComponent</span>(
        current,
        workInProgress,
        workInProgress.<span class="hljs-property">type</span>,
        workInProgress.<span class="hljs-property">pendingProps</span>,
        updateExpirationTime,
        renderExpirationTime,
      );
    }
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">IncompleteClassComponent</span>: {
      <span class="hljs-keyword">const</span> <span class="hljs-title class_">Component</span> = workInProgress.<span class="hljs-property">type</span>;
      <span class="hljs-keyword">const</span> unresolvedProps = workInProgress.<span class="hljs-property">pendingProps</span>;
      <span class="hljs-keyword">const</span> resolvedProps =
        workInProgress.<span class="hljs-property">elementType</span> === <span class="hljs-title class_">Component</span>
          ? unresolvedProps
          : <span class="hljs-title function_">resolveDefaultProps</span>(<span class="hljs-title class_">Component</span>, unresolvedProps);
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">mountIncompleteClassComponent</span>(
        current,
        workInProgress,
        <span class="hljs-title class_">Component</span>,
        resolvedProps,
        renderExpirationTime,
      );
    }
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">SuspenseListComponent</span>: {
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">updateSuspenseListComponent</span>(
        current,
        workInProgress,
        renderExpirationTime,
      );
    }
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">FundamentalComponent</span>: {
      <span class="hljs-keyword">if</span> (enableFundamentalAPI) {
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">updateFundamentalComponent</span>(
          current,
          workInProgress,
          renderExpirationTime,
        );
      }
      <span class="hljs-keyword">break</span>;
    }
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">ScopeComponent</span>: {
      <span class="hljs-keyword">if</span> (enableScopeAPI) {
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">updateScopeComponent</span>(
          current,
          workInProgress,
          renderExpirationTime,
        );
      }
      <span class="hljs-keyword">break</span>;
    }
  }
  <span class="hljs-title function_">invariant</span>(
    <span class="hljs-literal">false</span>,
    <span class="hljs-string">'Unknown unit of work tag (%s). This error is likely caused by a bug in '</span> +
      <span class="hljs-string">'React. Please file an issue.'</span>,
    workInProgress.<span class="hljs-property">tag</span>,
  );
}
</code></pre>
<h5 id="updatehostroot">updateHostRoot</h5>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// packages\react-reconciler\src\ReactFiberBeginWork.js</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">updateHostRoot</span>(<span class="hljs-params">current, workInProgress, renderExpirationTime</span>) {
  <span class="hljs-title function_">pushHostRootContext</span>(workInProgress);
  <span class="hljs-keyword">const</span> updateQueue = workInProgress.<span class="hljs-property">updateQueue</span>;
  <span class="hljs-title function_">invariant</span>(
    updateQueue !== <span class="hljs-literal">null</span>,
    <span class="hljs-string">'If the root does not have an updateQueue, we should have already '</span> +
      <span class="hljs-string">'bailed out. This error is likely caused by a bug in React. Please '</span> +
      <span class="hljs-string">'file an issue.'</span>,
  );
  <span class="hljs-keyword">const</span> nextProps = workInProgress.<span class="hljs-property">pendingProps</span>;
  <span class="hljs-keyword">const</span> prevState = workInProgress.<span class="hljs-property">memoizedState</span>;
  <span class="hljs-keyword">const</span> prevChildren = prevState !== <span class="hljs-literal">null</span> ? prevState.<span class="hljs-property">element</span> : <span class="hljs-literal">null</span>;
  <span class="hljs-title function_">processUpdateQueue</span>(
    workInProgress,
    updateQueue,
    nextProps,
    <span class="hljs-literal">null</span>,
    renderExpirationTime,
  );
  <span class="hljs-keyword">const</span> nextState = workInProgress.<span class="hljs-property">memoizedState</span>;
  <span class="hljs-comment">// Caution: React DevTools currently depends on this property</span>
  <span class="hljs-comment">// being called "element".</span>
  <span class="hljs-keyword">const</span> nextChildren = nextState.<span class="hljs-property">element</span>;
  <span class="hljs-keyword">if</span> (nextChildren === prevChildren) {
    <span class="hljs-comment">// If the state is the same as before, that's a bailout because we had</span>
    <span class="hljs-comment">// no work that expires at this time.</span>
    <span class="hljs-title function_">resetHydrationState</span>();
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">bailoutOnAlreadyFinishedWork</span>(
      current,
      workInProgress,
      renderExpirationTime,
    );
  }
  <span class="hljs-keyword">const</span> <span class="hljs-attr">root</span>: <span class="hljs-title class_">FiberRoot</span> = workInProgress.<span class="hljs-property">stateNode</span>;
  <span class="hljs-keyword">if</span> (root.<span class="hljs-property">hydrate</span> &#x26;&#x26; <span class="hljs-title function_">enterHydrationState</span>(workInProgress)) {
    <span class="hljs-comment">// If we don't have any current children this might be the first pass.</span>
    <span class="hljs-comment">// We always try to hydrate. If this isn't a hydration pass there won't</span>
    <span class="hljs-comment">// be any children to hydrate which is effectively the same thing as</span>
    <span class="hljs-comment">// not hydrating.</span>

    <span class="hljs-keyword">let</span> child = <span class="hljs-title function_">mountChildFibers</span>(
      workInProgress,
      <span class="hljs-literal">null</span>,
      nextChildren,
      renderExpirationTime,
    );
    workInProgress.<span class="hljs-property">child</span> = child;

    <span class="hljs-keyword">let</span> node = child;
    <span class="hljs-keyword">while</span> (node) {
      <span class="hljs-comment">// Mark each child as hydrating. This is a fast path to know whether this</span>
      <span class="hljs-comment">// tree is part of a hydrating tree. This is used to determine if a child</span>
      <span class="hljs-comment">// node has fully mounted yet, and for scheduling event replaying.</span>
      <span class="hljs-comment">// Conceptually this is similar to Placement in that a new subtree is</span>
      <span class="hljs-comment">// inserted into the React tree here. It just happens to not need DOM</span>
      <span class="hljs-comment">// mutations because it already exists.</span>
      node.<span class="hljs-property">effectTag</span> = (node.<span class="hljs-property">effectTag</span> &#x26; ~<span class="hljs-title class_">Placement</span>) | <span class="hljs-title class_">Hydrating</span>;
      node = node.<span class="hljs-property">sibling</span>;
    }
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// Otherwise reset hydration state in case we aborted and resumed another</span>
    <span class="hljs-comment">// root.</span>
    <span class="hljs-title function_">reconcileChildren</span>(
      current,
      workInProgress,
      nextChildren,
      renderExpirationTime,
    );
    <span class="hljs-title function_">resetHydrationState</span>();
  }
  <span class="hljs-keyword">return</span> workInProgress.<span class="hljs-property">child</span>;
}
</code></pre>
<h6 id="pushhostrootcontext">pushHostRootContext</h6>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// packages\react-reconciler\src\ReactFiberBeginWork.js</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">pushHostRootContext</span>(<span class="hljs-params">workInProgress</span>) {
  <span class="hljs-keyword">const</span> root = (workInProgress.<span class="hljs-property">stateNode</span>: <span class="hljs-title class_">FiberRoot</span>);
  <span class="hljs-keyword">if</span> (root.<span class="hljs-property">pendingContext</span>) {
    <span class="hljs-title function_">pushTopLevelContextObject</span>(
      workInProgress,
      root.<span class="hljs-property">pendingContext</span>,
      root.<span class="hljs-property">pendingContext</span> !== root.<span class="hljs-property">context</span>,
    );
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (root.<span class="hljs-property">context</span>) {
    <span class="hljs-comment">// Should always be set</span>
    <span class="hljs-title function_">pushTopLevelContextObject</span>(workInProgress, root.<span class="hljs-property">context</span>, <span class="hljs-literal">false</span>);
  }
  <span class="hljs-title function_">pushHostContainer</span>(workInProgress, root.<span class="hljs-property">containerInfo</span>);
}
</code></pre>
<h6 id="pushtoplevelcontextobject">pushTopLevelContextObject</h6>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// packages\react-reconciler\src\ReactFiberContext.js</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">pushTopLevelContextObject</span>(<span class="hljs-params">
  fiber: Fiber,
  context: <span class="hljs-built_in">Object</span>,
  didChange: boolean,
</span>): <span class="hljs-keyword">void</span> {
  <span class="hljs-keyword">if</span> (disableLegacyContext) {
    <span class="hljs-keyword">return</span>;
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-title function_">invariant</span>(
      contextStackCursor.<span class="hljs-property">current</span> === emptyContextObject,
      <span class="hljs-string">'Unexpected context found on stack. '</span> +
        <span class="hljs-string">'This error is likely caused by a bug in React. Please file an issue.'</span>,
    );
	<span class="hljs-comment">// contextStackCursor默认为createCursor(emptyContextObject)，其中emptyContextObject = {}</span>
	<span class="hljs-comment">// function createCursor&#x3C;T>(defaultValue: T): StackCursor&#x3C;T> {</span>
    <span class="hljs-comment">//   return {</span>
    <span class="hljs-comment">//     current: defaultValue,</span>
    <span class="hljs-comment">//   };</span>
	<span class="hljs-comment">// }</span>
    <span class="hljs-title function_">push</span>(contextStackCursor, context, fiber);
    <span class="hljs-title function_">push</span>(didPerformWorkStackCursor, didChange, fiber);
  }
}
</code></pre>
<h6 id="push">push</h6>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// packages\react-reconciler\src\ReactFiberStack.js</span>
<span class="hljs-keyword">function</span> push&#x3C;T>(<span class="hljs-attr">cursor</span>: <span class="hljs-title class_">StackCursor</span>&#x3C;T>, <span class="hljs-attr">value</span>: T, <span class="hljs-attr">fiber</span>: <span class="hljs-title class_">Fiber</span>): <span class="hljs-keyword">void</span> {
  <span class="hljs-comment">// 默认index = -1</span>
  index++;
  <span class="hljs-comment">// 默认valueStack = []</span>
  valueStack[index] = cursor.<span class="hljs-property">current</span>;

  <span class="hljs-keyword">if</span> (__DEV__) {
    fiberStack[index] = fiber;
  }

  cursor.<span class="hljs-property">current</span> = value;
}
</code></pre>
<h6 id="pushhostcontainer">pushHostContainer</h6>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// packages\react-reconciler\src\ReactFiberHostContext.js</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">pushHostContainer</span>(<span class="hljs-params">fiber: Fiber, nextRootInstance: Container</span>) {
  <span class="hljs-comment">// Push current root instance onto the stack;</span>
  <span class="hljs-comment">// This allows us to reset root when portals are popped.</span>
  <span class="hljs-title function_">push</span>(rootInstanceStackCursor, nextRootInstance, fiber);
  <span class="hljs-comment">// Track the context and the Fiber that provided it.</span>
  <span class="hljs-comment">// This enables us to pop only Fibers that provide unique contexts.</span>
  <span class="hljs-title function_">push</span>(contextFiberStackCursor, fiber, fiber);

  <span class="hljs-comment">// Finally, we need to push the host context to the stack.</span>
  <span class="hljs-comment">// However, we can't just call getRootHostContext() and push it because</span>
  <span class="hljs-comment">// we'd have a different number of entries on the stack depending on</span>
  <span class="hljs-comment">// whether getRootHostContext() throws somewhere in renderer code or not.</span>
  <span class="hljs-comment">// So we push an empty value first. This lets us safely unwind on errors.</span>
  <span class="hljs-title function_">push</span>(contextStackCursor, <span class="hljs-variable constant_">NO_CONTEXT</span>, fiber);
  <span class="hljs-keyword">const</span> nextRootContext = <span class="hljs-title function_">getRootHostContext</span>(nextRootInstance);
  <span class="hljs-comment">// Now that we know this function doesn't throw, replace it.</span>
  <span class="hljs-title function_">pop</span>(contextStackCursor, fiber);
  <span class="hljs-title function_">push</span>(contextStackCursor, nextRootContext, fiber);
}
</code></pre>
<h5 id="processupdatequeue">processUpdateQueue</h5>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// packages\react-reconciler\src\ReactUpdateQueue.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> processUpdateQueue&#x3C;<span class="hljs-title class_">State</span>>(
  <span class="hljs-attr">workInProgress</span>: <span class="hljs-title class_">Fiber</span>,
  <span class="hljs-attr">queue</span>: <span class="hljs-title class_">UpdateQueue</span>&#x3C;<span class="hljs-title class_">State</span>>,
  <span class="hljs-attr">props</span>: any,
  <span class="hljs-attr">instance</span>: any,
  <span class="hljs-attr">renderExpirationTime</span>: <span class="hljs-title class_">ExpirationTime</span>,
): <span class="hljs-keyword">void</span> {
  hasForceUpdate = <span class="hljs-literal">false</span>;

  queue = <span class="hljs-title function_">ensureWorkInProgressQueueIsAClone</span>(workInProgress, queue);

  <span class="hljs-keyword">if</span> (__DEV__) {
    currentlyProcessingQueue = queue;
  }

  <span class="hljs-comment">// These values may change as we process the queue.</span>
  <span class="hljs-keyword">let</span> newBaseState = queue.<span class="hljs-property">baseState</span>;
  <span class="hljs-keyword">let</span> newFirstUpdate = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">let</span> newExpirationTime = <span class="hljs-title class_">NoWork</span>;

  <span class="hljs-comment">// Iterate through the list of updates to compute the result.</span>
  <span class="hljs-keyword">let</span> update = queue.<span class="hljs-property">firstUpdate</span>;
  <span class="hljs-keyword">let</span> resultState = newBaseState;
  <span class="hljs-keyword">while</span> (update !== <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">const</span> updateExpirationTime = update.<span class="hljs-property">expirationTime</span>;
    <span class="hljs-keyword">if</span> (updateExpirationTime &#x3C; renderExpirationTime) {
      <span class="hljs-comment">// This update does not have sufficient priority. Skip it.</span>
      <span class="hljs-keyword">if</span> (newFirstUpdate === <span class="hljs-literal">null</span>) {
        <span class="hljs-comment">// This is the first skipped update. It will be the first update in</span>
        <span class="hljs-comment">// the new list.</span>
        newFirstUpdate = update;
        <span class="hljs-comment">// Since this is the first update that was skipped, the current result</span>
        <span class="hljs-comment">// is the new base state.</span>
        newBaseState = resultState;
      }
      <span class="hljs-comment">// Since this update will remain in the list, update the remaining</span>
      <span class="hljs-comment">// expiration time.</span>
      <span class="hljs-keyword">if</span> (newExpirationTime &#x3C; updateExpirationTime) {
        newExpirationTime = updateExpirationTime;
      }
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// This update does have sufficient priority.</span>

      <span class="hljs-comment">// Mark the event time of this update as relevant to this render pass.</span>
      <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> This should ideally use the true event time of this update rather than</span>
      <span class="hljs-comment">// its priority which is a derived and not reverseable value.</span>
      <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> We should skip this update if it was already committed but currently</span>
      <span class="hljs-comment">// we have no way of detecting the difference between a committed and suspended</span>
      <span class="hljs-comment">// update here.</span>
      <span class="hljs-title function_">markRenderEventTimeAndConfig</span>(updateExpirationTime, update.<span class="hljs-property">suspenseConfig</span>);

      <span class="hljs-comment">// Process it and compute a new result.</span>
      resultState = <span class="hljs-title function_">getStateFromUpdate</span>(
        workInProgress,
        queue,
        update,
        resultState,
        props,
        instance,
      );
      <span class="hljs-keyword">const</span> callback = update.<span class="hljs-property">callback</span>;
      <span class="hljs-keyword">if</span> (callback !== <span class="hljs-literal">null</span>) {
        workInProgress.<span class="hljs-property">effectTag</span> |= <span class="hljs-title class_">Callback</span>;
        <span class="hljs-comment">// Set this to null, in case it was mutated during an aborted render.</span>
        update.<span class="hljs-property">nextEffect</span> = <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">if</span> (queue.<span class="hljs-property">lastEffect</span> === <span class="hljs-literal">null</span>) {
          queue.<span class="hljs-property">firstEffect</span> = queue.<span class="hljs-property">lastEffect</span> = update;
        } <span class="hljs-keyword">else</span> {
          queue.<span class="hljs-property">lastEffect</span>.<span class="hljs-property">nextEffect</span> = update;
          queue.<span class="hljs-property">lastEffect</span> = update;
        }
      }
    }
    <span class="hljs-comment">// Continue to the next update.</span>
    update = update.<span class="hljs-property">next</span>;
  }

  <span class="hljs-comment">// Separately, iterate though the list of captured updates.</span>
  <span class="hljs-keyword">let</span> newFirstCapturedUpdate = <span class="hljs-literal">null</span>;
  update = queue.<span class="hljs-property">firstCapturedUpdate</span>;
  <span class="hljs-keyword">while</span> (update !== <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">const</span> updateExpirationTime = update.<span class="hljs-property">expirationTime</span>;
    <span class="hljs-keyword">if</span> (updateExpirationTime &#x3C; renderExpirationTime) {
      <span class="hljs-comment">// This update does not have sufficient priority. Skip it.</span>
      <span class="hljs-keyword">if</span> (newFirstCapturedUpdate === <span class="hljs-literal">null</span>) {
        <span class="hljs-comment">// This is the first skipped captured update. It will be the first</span>
        <span class="hljs-comment">// update in the new list.</span>
        newFirstCapturedUpdate = update;
        <span class="hljs-comment">// If this is the first update that was skipped, the current result is</span>
        <span class="hljs-comment">// the new base state.</span>
        <span class="hljs-keyword">if</span> (newFirstUpdate === <span class="hljs-literal">null</span>) {
          newBaseState = resultState;
        }
      }
      <span class="hljs-comment">// Since this update will remain in the list, update the remaining</span>
      <span class="hljs-comment">// expiration time.</span>
      <span class="hljs-keyword">if</span> (newExpirationTime &#x3C; updateExpirationTime) {
        newExpirationTime = updateExpirationTime;
      }
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// This update does have sufficient priority. Process it and compute</span>
      <span class="hljs-comment">// a new result.</span>
      resultState = <span class="hljs-title function_">getStateFromUpdate</span>(
        workInProgress,
        queue,
        update,
        resultState,
        props,
        instance,
      );
      <span class="hljs-keyword">const</span> callback = update.<span class="hljs-property">callback</span>;
      <span class="hljs-keyword">if</span> (callback !== <span class="hljs-literal">null</span>) {
        workInProgress.<span class="hljs-property">effectTag</span> |= <span class="hljs-title class_">Callback</span>;
        <span class="hljs-comment">// Set this to null, in case it was mutated during an aborted render.</span>
        update.<span class="hljs-property">nextEffect</span> = <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">if</span> (queue.<span class="hljs-property">lastCapturedEffect</span> === <span class="hljs-literal">null</span>) {
          queue.<span class="hljs-property">firstCapturedEffect</span> = queue.<span class="hljs-property">lastCapturedEffect</span> = update;
        } <span class="hljs-keyword">else</span> {
          queue.<span class="hljs-property">lastCapturedEffect</span>.<span class="hljs-property">nextEffect</span> = update;
          queue.<span class="hljs-property">lastCapturedEffect</span> = update;
        }
      }
    }
    update = update.<span class="hljs-property">next</span>;
  }

  <span class="hljs-keyword">if</span> (newFirstUpdate === <span class="hljs-literal">null</span>) {
    queue.<span class="hljs-property">lastUpdate</span> = <span class="hljs-literal">null</span>;
  }
  <span class="hljs-keyword">if</span> (newFirstCapturedUpdate === <span class="hljs-literal">null</span>) {
    queue.<span class="hljs-property">lastCapturedUpdate</span> = <span class="hljs-literal">null</span>;
  } <span class="hljs-keyword">else</span> {
    workInProgress.<span class="hljs-property">effectTag</span> |= <span class="hljs-title class_">Callback</span>;
  }
  <span class="hljs-keyword">if</span> (newFirstUpdate === <span class="hljs-literal">null</span> &#x26;&#x26; newFirstCapturedUpdate === <span class="hljs-literal">null</span>) {
    <span class="hljs-comment">// We processed every update, without skipping. That means the new base</span>
    <span class="hljs-comment">// state is the same as the result state.</span>
    newBaseState = resultState;
  }

  queue.<span class="hljs-property">baseState</span> = newBaseState;
  queue.<span class="hljs-property">firstUpdate</span> = newFirstUpdate;
  queue.<span class="hljs-property">firstCapturedUpdate</span> = newFirstCapturedUpdate;

  <span class="hljs-comment">// Set the remaining expiration time to be whatever is remaining in the queue.</span>
  <span class="hljs-comment">// This should be fine because the only two other things that contribute to</span>
  <span class="hljs-comment">// expiration time are props and context. We're already in the middle of the</span>
  <span class="hljs-comment">// begin phase by the time we start processing the queue, so we've already</span>
  <span class="hljs-comment">// dealt with the props. Context in components that specify</span>
  <span class="hljs-comment">// shouldComponentUpdate is tricky; but we'll have to account for</span>
  <span class="hljs-comment">// that regardless.</span>
  <span class="hljs-title function_">markUnprocessedUpdateTime</span>(newExpirationTime);
  workInProgress.<span class="hljs-property">expirationTime</span> = newExpirationTime;
  workInProgress.<span class="hljs-property">memoizedState</span> = resultState;

  <span class="hljs-keyword">if</span> (__DEV__) {
    currentlyProcessingQueue = <span class="hljs-literal">null</span>;
  }
}
</code></pre>
<h6 id="getstatefromupdate">getStateFromUpdate</h6>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// packages\react-reconciler\src\ReactUpdateQueue.js</span>
<span class="hljs-keyword">function</span> getStateFromUpdate&#x3C;<span class="hljs-title class_">State</span>>(
  <span class="hljs-attr">workInProgress</span>: <span class="hljs-title class_">Fiber</span>,
  <span class="hljs-attr">queue</span>: <span class="hljs-title class_">UpdateQueue</span>&#x3C;<span class="hljs-title class_">State</span>>,
  <span class="hljs-attr">update</span>: <span class="hljs-title class_">Update</span>&#x3C;<span class="hljs-title class_">State</span>>,
  <span class="hljs-attr">prevState</span>: <span class="hljs-title class_">State</span>,
  <span class="hljs-attr">nextProps</span>: any,
  <span class="hljs-attr">instance</span>: any,
): any {
  <span class="hljs-keyword">switch</span> (update.<span class="hljs-property">tag</span>) {
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">ReplaceState</span>: {
      <span class="hljs-keyword">const</span> payload = update.<span class="hljs-property">payload</span>;
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> payload === <span class="hljs-string">'function'</span>) {
        <span class="hljs-comment">// Updater function</span>
        <span class="hljs-keyword">if</span> (__DEV__) {
          <span class="hljs-title function_">enterDisallowedContextReadInDEV</span>();
          <span class="hljs-keyword">if</span> (
            debugRenderPhaseSideEffects ||
            (debugRenderPhaseSideEffectsForStrictMode &#x26;&#x26;
              workInProgress.<span class="hljs-property">mode</span> &#x26; <span class="hljs-title class_">StrictMode</span>)
          ) {
            payload.<span class="hljs-title function_">call</span>(instance, prevState, nextProps);
          }
        }
        <span class="hljs-keyword">const</span> nextState = payload.<span class="hljs-title function_">call</span>(instance, prevState, nextProps);
        <span class="hljs-keyword">if</span> (__DEV__) {
          <span class="hljs-title function_">exitDisallowedContextReadInDEV</span>();
        }
        <span class="hljs-keyword">return</span> nextState;
      }
      <span class="hljs-comment">// State object</span>
      <span class="hljs-keyword">return</span> payload;
    }
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">CaptureUpdate</span>: {
      workInProgress.<span class="hljs-property">effectTag</span> =
        (workInProgress.<span class="hljs-property">effectTag</span> &#x26; ~<span class="hljs-title class_">ShouldCapture</span>) | <span class="hljs-title class_">DidCapture</span>;
    }
    <span class="hljs-comment">// Intentional fallthrough</span>
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">UpdateState</span>: {
      <span class="hljs-keyword">const</span> payload = update.<span class="hljs-property">payload</span>;
      <span class="hljs-keyword">let</span> partialState;
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> payload === <span class="hljs-string">'function'</span>) {
        <span class="hljs-comment">// Updater function</span>
        <span class="hljs-keyword">if</span> (__DEV__) {
          <span class="hljs-title function_">enterDisallowedContextReadInDEV</span>();
          <span class="hljs-keyword">if</span> (
            debugRenderPhaseSideEffects ||
            (debugRenderPhaseSideEffectsForStrictMode &#x26;&#x26;
              workInProgress.<span class="hljs-property">mode</span> &#x26; <span class="hljs-title class_">StrictMode</span>)
          ) {
            payload.<span class="hljs-title function_">call</span>(instance, prevState, nextProps);
          }
        }
        partialState = payload.<span class="hljs-title function_">call</span>(instance, prevState, nextProps);
        <span class="hljs-keyword">if</span> (__DEV__) {
          <span class="hljs-title function_">exitDisallowedContextReadInDEV</span>();
        }
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// Partial state object</span>
        partialState = payload;
      }
      <span class="hljs-keyword">if</span> (partialState === <span class="hljs-literal">null</span> || partialState === <span class="hljs-literal">undefined</span>) {
        <span class="hljs-comment">// Null and undefined are treated as no-ops.</span>
        <span class="hljs-keyword">return</span> prevState;
      }
      <span class="hljs-comment">// Merge the partial state and the previous state.</span>
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, prevState, partialState);
    }
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">ForceUpdate</span>: {
      hasForceUpdate = <span class="hljs-literal">true</span>;
      <span class="hljs-keyword">return</span> prevState;
    }
  }
  <span class="hljs-keyword">return</span> prevState;
}
</code></pre>
<h5 id="reconcilechildren">reconcileChildren</h5>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// packages\react-reconciler\src\ReactFiberBeginWork.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">reconcileChildren</span>(<span class="hljs-params">
  current: Fiber | <span class="hljs-literal">null</span>,
  workInProgress: Fiber,
  nextChildren: any,
  renderExpirationTime: ExpirationTime,
</span>) {
  <span class="hljs-keyword">if</span> (current === <span class="hljs-literal">null</span>) {
    <span class="hljs-comment">// If this is a fresh new component that hasn't been rendered yet, we</span>
    <span class="hljs-comment">// won't update its child set by applying minimal side-effects. Instead,</span>
    <span class="hljs-comment">// we will add them all to the child before it gets rendered. That means</span>
    <span class="hljs-comment">// we can optimize this reconciliation pass by not tracking side-effects.</span>
    workInProgress.<span class="hljs-property">child</span> = <span class="hljs-title function_">mountChildFibers</span>(
      workInProgress,
      <span class="hljs-literal">null</span>,
      nextChildren,
      renderExpirationTime,
    );
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// If the current child is the same as the work in progress, it means that</span>
    <span class="hljs-comment">// we haven't yet started any work on these children. Therefore, we use</span>
    <span class="hljs-comment">// the clone algorithm to create a copy of all the current children.</span>

    <span class="hljs-comment">// If we had any progressed work already, that is invalid at this point so</span>
    <span class="hljs-comment">// let's throw it out.</span>
    workInProgress.<span class="hljs-property">child</span> = <span class="hljs-title function_">reconcileChildFibers</span>(
      workInProgress,
      current.<span class="hljs-property">child</span>,
      nextChildren,
      renderExpirationTime,
    );
  }
}
</code></pre>
<h5 id="reconcilechildfibers">reconcileChildFibers</h5>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// packages\react-reconciler\src\ReactChildFiber.js</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">reconcileChildFibers</span>(<span class="hljs-params">
    returnFiber: Fiber,
    currentFirstChild: Fiber | <span class="hljs-literal">null</span>,
    newChild: any,
    expirationTime: ExpirationTime,
  </span>): <span class="hljs-title class_">Fiber</span> | <span class="hljs-literal">null</span> {
    <span class="hljs-comment">// This function is not recursive.</span>
    <span class="hljs-comment">// If the top level item is an array, we treat it as a set of children,</span>
    <span class="hljs-comment">// not as a fragment. Nested arrays on the other hand will be treated as</span>
    <span class="hljs-comment">// fragment nodes. Recursion happens at the normal flow.</span>

    <span class="hljs-comment">// Handle top level unkeyed fragments as if they were arrays.</span>
    <span class="hljs-comment">// This leads to an ambiguity between &#x3C;>{[...]}&#x3C;/> and &#x3C;>...&#x3C;/>.</span>
    <span class="hljs-comment">// We treat the ambiguous cases above the same.</span>
    <span class="hljs-keyword">const</span> isUnkeyedTopLevelFragment =
      <span class="hljs-keyword">typeof</span> newChild === <span class="hljs-string">'object'</span> &#x26;&#x26;
      newChild !== <span class="hljs-literal">null</span> &#x26;&#x26;
      newChild.<span class="hljs-property">type</span> === <span class="hljs-variable constant_">REACT_FRAGMENT_TYPE</span> &#x26;&#x26;
      newChild.<span class="hljs-property">key</span> === <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">if</span> (isUnkeyedTopLevelFragment) {
      newChild = newChild.<span class="hljs-property">props</span>.<span class="hljs-property">children</span>;
    }

    <span class="hljs-comment">// Handle object types</span>
    <span class="hljs-keyword">const</span> isObject = <span class="hljs-keyword">typeof</span> newChild === <span class="hljs-string">'object'</span> &#x26;&#x26; newChild !== <span class="hljs-literal">null</span>;

    <span class="hljs-keyword">if</span> (isObject) {
      <span class="hljs-keyword">switch</span> (newChild.<span class="hljs-property">$$typeof</span>) {
        <span class="hljs-keyword">case</span> <span class="hljs-attr">REACT_ELEMENT_TYPE</span>:
          <span class="hljs-keyword">return</span> <span class="hljs-title function_">placeSingleChild</span>(
            <span class="hljs-title function_">reconcileSingleElement</span>(
              returnFiber,
              currentFirstChild,
              newChild,
              expirationTime,
            ),
          );
        <span class="hljs-keyword">case</span> <span class="hljs-attr">REACT_PORTAL_TYPE</span>:
          <span class="hljs-keyword">return</span> <span class="hljs-title function_">placeSingleChild</span>(
            <span class="hljs-title function_">reconcileSinglePortal</span>(
              returnFiber,
              currentFirstChild,
              newChild,
              expirationTime,
            ),
          );
      }
    }

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> newChild === <span class="hljs-string">'string'</span> || <span class="hljs-keyword">typeof</span> newChild === <span class="hljs-string">'number'</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">placeSingleChild</span>(
        <span class="hljs-title function_">reconcileSingleTextNode</span>(
          returnFiber,
          currentFirstChild,
          <span class="hljs-string">''</span> + newChild,
          expirationTime,
        ),
      );
    }

    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isArray</span>(newChild)) {
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">reconcileChildrenArray</span>(
        returnFiber,
        currentFirstChild,
        newChild,
        expirationTime,
      );
    }

    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">getIteratorFn</span>(newChild)) {
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">reconcileChildrenIterator</span>(
        returnFiber,
        currentFirstChild,
        newChild,
        expirationTime,
      );
    }

    <span class="hljs-keyword">if</span> (isObject) {
      <span class="hljs-title function_">throwOnInvalidObjectType</span>(returnFiber, newChild);
    }

    <span class="hljs-keyword">if</span> (__DEV__) {
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> newChild === <span class="hljs-string">'function'</span>) {
        <span class="hljs-title function_">warnOnFunctionType</span>();
      }
    }
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> newChild === <span class="hljs-string">'undefined'</span> &#x26;&#x26; !isUnkeyedTopLevelFragment) {
      <span class="hljs-comment">// If the new child is undefined, and the return fiber is a composite</span>
      <span class="hljs-comment">// component, throw an error. If Fiber return types are disabled,</span>
      <span class="hljs-comment">// we already threw above.</span>
      <span class="hljs-keyword">switch</span> (returnFiber.<span class="hljs-property">tag</span>) {
        <span class="hljs-keyword">case</span> <span class="hljs-title class_">ClassComponent</span>: {
          <span class="hljs-keyword">if</span> (__DEV__) {
            <span class="hljs-keyword">const</span> instance = returnFiber.<span class="hljs-property">stateNode</span>;
            <span class="hljs-keyword">if</span> (instance.<span class="hljs-property">render</span>.<span class="hljs-property">_isMockFunction</span>) {
              <span class="hljs-comment">// We allow auto-mocks to proceed as if they're returning null.</span>
              <span class="hljs-keyword">break</span>;
            }
          }
        }
        <span class="hljs-comment">// Intentionally fall through to the next case, which handles both</span>
        <span class="hljs-comment">// functions and classes</span>
        <span class="hljs-comment">// eslint-disable-next-lined no-fallthrough</span>
        <span class="hljs-keyword">case</span> <span class="hljs-title class_">FunctionComponent</span>: {
          <span class="hljs-keyword">const</span> <span class="hljs-title class_">Component</span> = returnFiber.<span class="hljs-property">type</span>;
          <span class="hljs-title function_">invariant</span>(
            <span class="hljs-literal">false</span>,
            <span class="hljs-string">'%s(...): Nothing was returned from render. This usually means a '</span> +
              <span class="hljs-string">'return statement is missing. Or, to render nothing, '</span> +
              <span class="hljs-string">'return null.'</span>,
            <span class="hljs-title class_">Component</span>.<span class="hljs-property">displayName</span> || <span class="hljs-title class_">Component</span>.<span class="hljs-property">name</span> || <span class="hljs-string">'Component'</span>,
          );
        }
      }
    }

    <span class="hljs-comment">// Remaining cases are all treated as empty.</span>
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">deleteRemainingChildren</span>(returnFiber, currentFirstChild);
  }
</code></pre>
<h5 id="reconcilesingleelement">reconcileSingleElement</h5>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// packages\react-reconciler\src\ReactChildFiber.js</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">reconcileSingleElement</span>(<span class="hljs-params">
    returnFiber: Fiber,
    currentFirstChild: Fiber | <span class="hljs-literal">null</span>,
    element: ReactElement,
    expirationTime: ExpirationTime,
  </span>): <span class="hljs-title class_">Fiber</span> {
    <span class="hljs-keyword">const</span> key = element.<span class="hljs-property">key</span>;
    <span class="hljs-keyword">let</span> child = currentFirstChild;
    <span class="hljs-keyword">while</span> (child !== <span class="hljs-literal">null</span>) {
      <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> If key === null and child.key === null, then this only applies to</span>
      <span class="hljs-comment">// the first item in the list.</span>
      <span class="hljs-keyword">if</span> (child.<span class="hljs-property">key</span> === key) {
        <span class="hljs-keyword">if</span> (
          child.<span class="hljs-property">tag</span> === <span class="hljs-title class_">Fragment</span>
            ? element.<span class="hljs-property">type</span> === <span class="hljs-variable constant_">REACT_FRAGMENT_TYPE</span>
            : child.<span class="hljs-property">elementType</span> === element.<span class="hljs-property">type</span> ||
              <span class="hljs-comment">// Keep this check inline so it only runs on the false path:</span>
              (__DEV__
                ? <span class="hljs-title function_">isCompatibleFamilyForHotReloading</span>(child, element)
                : <span class="hljs-literal">false</span>)
        ) {
          <span class="hljs-title function_">deleteRemainingChildren</span>(returnFiber, child.<span class="hljs-property">sibling</span>);
          <span class="hljs-keyword">const</span> existing = <span class="hljs-title function_">useFiber</span>(
            child,
            element.<span class="hljs-property">type</span> === <span class="hljs-variable constant_">REACT_FRAGMENT_TYPE</span>
              ? element.<span class="hljs-property">props</span>.<span class="hljs-property">children</span>
              : element.<span class="hljs-property">props</span>,
            expirationTime,
          );
          existing.<span class="hljs-property">ref</span> = <span class="hljs-title function_">coerceRef</span>(returnFiber, child, element);
          existing.<span class="hljs-property">return</span> = returnFiber;
          <span class="hljs-keyword">if</span> (__DEV__) {
            existing.<span class="hljs-property">_debugSource</span> = element.<span class="hljs-property">_source</span>;
            existing.<span class="hljs-property">_debugOwner</span> = element.<span class="hljs-property">_owner</span>;
          }
          <span class="hljs-keyword">return</span> existing;
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-title function_">deleteRemainingChildren</span>(returnFiber, child);
          <span class="hljs-keyword">break</span>;
        }
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-title function_">deleteChild</span>(returnFiber, child);
      }
      child = child.<span class="hljs-property">sibling</span>;
    }

    <span class="hljs-keyword">if</span> (element.<span class="hljs-property">type</span> === <span class="hljs-variable constant_">REACT_FRAGMENT_TYPE</span>) {
      <span class="hljs-keyword">const</span> created = <span class="hljs-title function_">createFiberFromFragment</span>(
        element.<span class="hljs-property">props</span>.<span class="hljs-property">children</span>,
        returnFiber.<span class="hljs-property">mode</span>,
        expirationTime,
        element.<span class="hljs-property">key</span>,
      );
      created.<span class="hljs-property">return</span> = returnFiber;
      <span class="hljs-keyword">return</span> created;
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">const</span> created = <span class="hljs-title function_">createFiberFromElement</span>(
        element,
        returnFiber.<span class="hljs-property">mode</span>,
        expirationTime,
      );
      created.<span class="hljs-property">ref</span> = <span class="hljs-title function_">coerceRef</span>(returnFiber, currentFirstChild, element);
      created.<span class="hljs-property">return</span> = returnFiber;
      <span class="hljs-keyword">return</span> created;
    }
  }
</code></pre>
<h6 id="createfiberfromelement">createFiberFromElement</h6>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// packages\react-reconciler\src\ReactFiber.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createFiberFromElement</span>(<span class="hljs-params">
  element: ReactElement,
  mode: TypeOfMode,
  expirationTime: ExpirationTime,
</span>): <span class="hljs-title class_">Fiber</span> {
  <span class="hljs-keyword">let</span> owner = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">if</span> (__DEV__) {
    owner = element.<span class="hljs-property">_owner</span>;
  }
  <span class="hljs-keyword">const</span> type = element.<span class="hljs-property">type</span>;
  <span class="hljs-keyword">const</span> key = element.<span class="hljs-property">key</span>;
  <span class="hljs-keyword">const</span> pendingProps = element.<span class="hljs-property">props</span>;
  <span class="hljs-keyword">const</span> fiber = <span class="hljs-title function_">createFiberFromTypeAndProps</span>(
    type,
    key,
    pendingProps,
    owner,
    mode,
    expirationTime,
  );
  <span class="hljs-keyword">if</span> (__DEV__) {
    fiber.<span class="hljs-property">_debugSource</span> = element.<span class="hljs-property">_source</span>;
    fiber.<span class="hljs-property">_debugOwner</span> = element.<span class="hljs-property">_owner</span>;
  }
  <span class="hljs-keyword">return</span> fiber;
}
</code></pre>
<h6 id=""></h6>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// packages\react-reconciler\src\ReactChildFiber.js</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">coerceRef</span>(<span class="hljs-params">
  returnFiber: Fiber,
  current: Fiber | <span class="hljs-literal">null</span>,
  element: ReactElement,
</span>) {
  <span class="hljs-keyword">let</span> mixedRef = element.<span class="hljs-property">ref</span>;
  <span class="hljs-keyword">if</span> (
    mixedRef !== <span class="hljs-literal">null</span> &#x26;&#x26;
    <span class="hljs-keyword">typeof</span> mixedRef !== <span class="hljs-string">'function'</span> &#x26;&#x26;
    <span class="hljs-keyword">typeof</span> mixedRef !== <span class="hljs-string">'object'</span>
  ) {
    <span class="hljs-keyword">if</span> (__DEV__) {
      <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> Clean this up once we turn on the string ref warning for</span>
      <span class="hljs-comment">// everyone, because the strict mode case will no longer be relevant</span>
      <span class="hljs-keyword">if</span> (returnFiber.<span class="hljs-property">mode</span> &#x26; <span class="hljs-title class_">StrictMode</span> || warnAboutStringRefs) {
        <span class="hljs-keyword">const</span> componentName = <span class="hljs-title function_">getComponentName</span>(returnFiber.<span class="hljs-property">type</span>) || <span class="hljs-string">'Component'</span>;
        <span class="hljs-keyword">if</span> (!didWarnAboutStringRefs[componentName]) {
          <span class="hljs-keyword">if</span> (warnAboutStringRefs) {
            <span class="hljs-title function_">warningWithoutStack</span>(
              <span class="hljs-literal">false</span>,
              <span class="hljs-string">'Component "%s" contains the string ref "%s". Support for string refs '</span> +
                <span class="hljs-string">'will be removed in a future major release. We recommend using '</span> +
                <span class="hljs-string">'useRef() or createRef() instead. '</span> +
                <span class="hljs-string">'Learn more about using refs safely here: '</span> +
                <span class="hljs-string">'https://fb.me/react-strict-mode-string-ref%s'</span>,
              componentName,
              mixedRef,
              <span class="hljs-title function_">getStackByFiberInDevAndProd</span>(returnFiber),
            );
          } <span class="hljs-keyword">else</span> {
            <span class="hljs-title function_">warningWithoutStack</span>(
              <span class="hljs-literal">false</span>,
              <span class="hljs-string">'A string ref, "%s", has been found within a strict mode tree. '</span> +
                <span class="hljs-string">'String refs are a source of potential bugs and should be avoided. '</span> +
                <span class="hljs-string">'We recommend using useRef() or createRef() instead. '</span> +
                <span class="hljs-string">'Learn more about using refs safely here: '</span> +
                <span class="hljs-string">'https://fb.me/react-strict-mode-string-ref%s'</span>,
              mixedRef,
              <span class="hljs-title function_">getStackByFiberInDevAndProd</span>(returnFiber),
            );
          }
          didWarnAboutStringRefs[componentName] = <span class="hljs-literal">true</span>;
        }
      }
    }

    <span class="hljs-keyword">if</span> (element.<span class="hljs-property">_owner</span>) {
      <span class="hljs-keyword">const</span> <span class="hljs-attr">owner</span>: ?<span class="hljs-title class_">Fiber</span> = (element.<span class="hljs-property">_owner</span>: any);
      <span class="hljs-keyword">let</span> inst;
      <span class="hljs-keyword">if</span> (owner) {
        <span class="hljs-keyword">const</span> ownerFiber = ((<span class="hljs-attr">owner</span>: any): <span class="hljs-title class_">Fiber</span>);
        <span class="hljs-title function_">invariant</span>(
          ownerFiber.<span class="hljs-property">tag</span> === <span class="hljs-title class_">ClassComponent</span>,
          <span class="hljs-string">'Function components cannot have refs. '</span> +
            <span class="hljs-string">'Did you mean to use React.forwardRef()?'</span>,
        );
        inst = ownerFiber.<span class="hljs-property">stateNode</span>;
      }
      <span class="hljs-title function_">invariant</span>(
        inst,
        <span class="hljs-string">'Missing owner for string ref %s. This error is likely caused by a '</span> +
          <span class="hljs-string">'bug in React. Please file an issue.'</span>,
        mixedRef,
      );
      <span class="hljs-keyword">const</span> stringRef = <span class="hljs-string">''</span> + mixedRef;
      <span class="hljs-comment">// Check if previous string ref matches new string ref</span>
      <span class="hljs-keyword">if</span> (
        current !== <span class="hljs-literal">null</span> &#x26;&#x26;
        current.<span class="hljs-property">ref</span> !== <span class="hljs-literal">null</span> &#x26;&#x26;
        <span class="hljs-keyword">typeof</span> current.<span class="hljs-property">ref</span> === <span class="hljs-string">'function'</span> &#x26;&#x26;
        current.<span class="hljs-property">ref</span>.<span class="hljs-property">_stringRef</span> === stringRef
      ) {
        <span class="hljs-keyword">return</span> current.<span class="hljs-property">ref</span>;
      }
      <span class="hljs-keyword">const</span> ref = <span class="hljs-keyword">function</span>(<span class="hljs-params">value</span>) {
        <span class="hljs-keyword">let</span> refs = inst.<span class="hljs-property">refs</span>;
        <span class="hljs-keyword">if</span> (refs === emptyRefsObject) {
          <span class="hljs-comment">// This is a lazy pooled frozen object, so we need to initialize.</span>
          refs = inst.<span class="hljs-property">refs</span> = {};
        }
        <span class="hljs-keyword">if</span> (value === <span class="hljs-literal">null</span>) {
          <span class="hljs-keyword">delete</span> refs[stringRef];
        } <span class="hljs-keyword">else</span> {
          refs[stringRef] = value;
        }
      };
      ref.<span class="hljs-property">_stringRef</span> = stringRef;
      <span class="hljs-keyword">return</span> ref;
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-title function_">invariant</span>(
        <span class="hljs-keyword">typeof</span> mixedRef === <span class="hljs-string">'string'</span>,
        <span class="hljs-string">'Expected ref to be a function, a string, an object returned by React.createRef(), or null.'</span>,
      );
      <span class="hljs-title function_">invariant</span>(
        element.<span class="hljs-property">_owner</span>,
        <span class="hljs-string">'Element ref was specified as a string (%s) but no owner was set. This could happen for one of'</span> +
          <span class="hljs-string">' the following reasons:\n'</span> +
          <span class="hljs-string">'1. You may be adding a ref to a function component\n'</span> +
          <span class="hljs-string">"2. You may be adding a ref to a component that was not created inside a component's render method\n"</span> +
          <span class="hljs-string">'3. You have multiple copies of React loaded\n'</span> +
          <span class="hljs-string">'See https://fb.me/react-refs-must-have-owner for more information.'</span>,
        mixedRef,
      );
    }
  }
  <span class="hljs-keyword">return</span> mixedRef;
}
</code></pre>
<h5 id="placesinglechild">placeSingleChild</h5>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// packages\react-reconciler\src\ReactChildFiber.js</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">placeSingleChild</span>(<span class="hljs-params">newFiber: Fiber</span>): <span class="hljs-title class_">Fiber</span> {
    <span class="hljs-comment">// This is simpler for the single child case. We only need to do a</span>
    <span class="hljs-comment">// placement for inserting new children.</span>
    <span class="hljs-keyword">if</span> (shouldTrackSideEffects &#x26;&#x26; newFiber.<span class="hljs-property">alternate</span> === <span class="hljs-literal">null</span>) {
      newFiber.<span class="hljs-property">effectTag</span> = <span class="hljs-title class_">Placement</span>;
    }
    <span class="hljs-keyword">return</span> newFiber;
  }
</code></pre>
<h5 id="completeunitofwork">completeUnitOfWork</h5>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// packages\react-reconciler\src\ReactFiberWorkLoop.js</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">completeUnitOfWork</span>(<span class="hljs-params">unitOfWork: Fiber</span>): <span class="hljs-title class_">Fiber</span> | <span class="hljs-literal">null</span> {
  <span class="hljs-comment">// Attempt to complete the current unit of work, then move to the next</span>
  <span class="hljs-comment">// sibling. If there are no more siblings, return to the parent fiber.</span>
  workInProgress = unitOfWork;
  <span class="hljs-keyword">do</span> {
    <span class="hljs-comment">// The current, flushed, state of this fiber is the alternate. Ideally</span>
    <span class="hljs-comment">// nothing should rely on this, but relying on it here means that we don't</span>
    <span class="hljs-comment">// need an additional field on the work in progress.</span>
    <span class="hljs-keyword">const</span> current = workInProgress.<span class="hljs-property">alternate</span>;
    <span class="hljs-keyword">const</span> returnFiber = workInProgress.<span class="hljs-property">return</span>;

    <span class="hljs-comment">// Check if the work completed or if something threw.</span>
    <span class="hljs-keyword">if</span> ((workInProgress.<span class="hljs-property">effectTag</span> &#x26; <span class="hljs-title class_">Incomplete</span>) === <span class="hljs-title class_">NoEffect</span>) {
      <span class="hljs-title function_">setCurrentDebugFiberInDEV</span>(workInProgress);
      <span class="hljs-keyword">let</span> next;
      <span class="hljs-keyword">if</span> (
        !enableProfilerTimer ||
        (workInProgress.<span class="hljs-property">mode</span> &#x26; <span class="hljs-title class_">ProfileMode</span>) === <span class="hljs-title class_">NoMode</span>
      ) {
        next = <span class="hljs-title function_">completeWork</span>(current, workInProgress, renderExpirationTime);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-title function_">startProfilerTimer</span>(workInProgress);
        next = <span class="hljs-title function_">completeWork</span>(current, workInProgress, renderExpirationTime);
        <span class="hljs-comment">// Update render duration assuming we didn't error.</span>
        <span class="hljs-title function_">stopProfilerTimerIfRunningAndRecordDelta</span>(workInProgress, <span class="hljs-literal">false</span>);
      }
      <span class="hljs-title function_">stopWorkTimer</span>(workInProgress);
      <span class="hljs-title function_">resetCurrentDebugFiberInDEV</span>();
      <span class="hljs-title function_">resetChildExpirationTime</span>(workInProgress);

      <span class="hljs-keyword">if</span> (next !== <span class="hljs-literal">null</span>) {
        <span class="hljs-comment">// Completing this fiber spawned new work. Work on that next.</span>
        <span class="hljs-keyword">return</span> next;
      }

      <span class="hljs-keyword">if</span> (
        returnFiber !== <span class="hljs-literal">null</span> &#x26;&#x26;
        <span class="hljs-comment">// Do not append effects to parents if a sibling failed to complete</span>
        (returnFiber.<span class="hljs-property">effectTag</span> &#x26; <span class="hljs-title class_">Incomplete</span>) === <span class="hljs-title class_">NoEffect</span>
      ) {
        <span class="hljs-comment">// Append all the effects of the subtree and this fiber onto the effect</span>
        <span class="hljs-comment">// list of the parent. The completion order of the children affects the</span>
        <span class="hljs-comment">// side-effect order.</span>
        <span class="hljs-keyword">if</span> (returnFiber.<span class="hljs-property">firstEffect</span> === <span class="hljs-literal">null</span>) {
          returnFiber.<span class="hljs-property">firstEffect</span> = workInProgress.<span class="hljs-property">firstEffect</span>;
        }
        <span class="hljs-keyword">if</span> (workInProgress.<span class="hljs-property">lastEffect</span> !== <span class="hljs-literal">null</span>) {
          <span class="hljs-keyword">if</span> (returnFiber.<span class="hljs-property">lastEffect</span> !== <span class="hljs-literal">null</span>) {
            returnFiber.<span class="hljs-property">lastEffect</span>.<span class="hljs-property">nextEffect</span> = workInProgress.<span class="hljs-property">firstEffect</span>;
          }
          returnFiber.<span class="hljs-property">lastEffect</span> = workInProgress.<span class="hljs-property">lastEffect</span>;
        }

        <span class="hljs-comment">// If this fiber had side-effects, we append it AFTER the children's</span>
        <span class="hljs-comment">// side-effects. We can perform certain side-effects earlier if needed,</span>
        <span class="hljs-comment">// by doing multiple passes over the effect list. We don't want to</span>
        <span class="hljs-comment">// schedule our own side-effect on our own list because if end up</span>
        <span class="hljs-comment">// reusing children we'll schedule this effect onto itself since we're</span>
        <span class="hljs-comment">// at the end.</span>
        <span class="hljs-keyword">const</span> effectTag = workInProgress.<span class="hljs-property">effectTag</span>;

        <span class="hljs-comment">// Skip both NoWork and PerformedWork tags when creating the effect</span>
        <span class="hljs-comment">// list. PerformedWork effect is read by React DevTools but shouldn't be</span>
        <span class="hljs-comment">// committed.</span>
        <span class="hljs-keyword">if</span> (effectTag > <span class="hljs-title class_">PerformedWork</span>) {
          <span class="hljs-keyword">if</span> (returnFiber.<span class="hljs-property">lastEffect</span> !== <span class="hljs-literal">null</span>) {
            returnFiber.<span class="hljs-property">lastEffect</span>.<span class="hljs-property">nextEffect</span> = workInProgress;
          } <span class="hljs-keyword">else</span> {
            returnFiber.<span class="hljs-property">firstEffect</span> = workInProgress;
          }
          returnFiber.<span class="hljs-property">lastEffect</span> = workInProgress;
        }
      }
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// This fiber did not complete because something threw. Pop values off</span>
      <span class="hljs-comment">// the stack without entering the complete phase. If this is a boundary,</span>
      <span class="hljs-comment">// capture values if possible.</span>
      <span class="hljs-keyword">const</span> next = <span class="hljs-title function_">unwindWork</span>(workInProgress, renderExpirationTime);

      <span class="hljs-comment">// Because this fiber did not complete, don't reset its expiration time.</span>

      <span class="hljs-keyword">if</span> (
        enableProfilerTimer &#x26;&#x26;
        (workInProgress.<span class="hljs-property">mode</span> &#x26; <span class="hljs-title class_">ProfileMode</span>) !== <span class="hljs-title class_">NoMode</span>
      ) {
        <span class="hljs-comment">// Record the render duration for the fiber that errored.</span>
        <span class="hljs-title function_">stopProfilerTimerIfRunningAndRecordDelta</span>(workInProgress, <span class="hljs-literal">false</span>);

        <span class="hljs-comment">// Include the time spent working on failed children before continuing.</span>
        <span class="hljs-keyword">let</span> actualDuration = workInProgress.<span class="hljs-property">actualDuration</span>;
        <span class="hljs-keyword">let</span> child = workInProgress.<span class="hljs-property">child</span>;
        <span class="hljs-keyword">while</span> (child !== <span class="hljs-literal">null</span>) {
          actualDuration += child.<span class="hljs-property">actualDuration</span>;
          child = child.<span class="hljs-property">sibling</span>;
        }
        workInProgress.<span class="hljs-property">actualDuration</span> = actualDuration;
      }

      <span class="hljs-keyword">if</span> (next !== <span class="hljs-literal">null</span>) {
        <span class="hljs-comment">// If completing this work spawned new work, do that next. We'll come</span>
        <span class="hljs-comment">// back here again.</span>
        <span class="hljs-comment">// Since we're restarting, remove anything that is not a host effect</span>
        <span class="hljs-comment">// from the effect tag.</span>
        <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> The name stopFailedWorkTimer is misleading because Suspense</span>
        <span class="hljs-comment">// also captures and restarts.</span>
        <span class="hljs-title function_">stopFailedWorkTimer</span>(workInProgress);
        next.<span class="hljs-property">effectTag</span> &#x26;= <span class="hljs-title class_">HostEffectMask</span>;
        <span class="hljs-keyword">return</span> next;
      }
      <span class="hljs-title function_">stopWorkTimer</span>(workInProgress);

      <span class="hljs-keyword">if</span> (returnFiber !== <span class="hljs-literal">null</span>) {
        <span class="hljs-comment">// Mark the parent fiber as incomplete and clear its effect list.</span>
        returnFiber.<span class="hljs-property">firstEffect</span> = returnFiber.<span class="hljs-property">lastEffect</span> = <span class="hljs-literal">null</span>;
        returnFiber.<span class="hljs-property">effectTag</span> |= <span class="hljs-title class_">Incomplete</span>;
      }
    }

    <span class="hljs-keyword">const</span> siblingFiber = workInProgress.<span class="hljs-property">sibling</span>;
    <span class="hljs-keyword">if</span> (siblingFiber !== <span class="hljs-literal">null</span>) {
      <span class="hljs-comment">// If there is more work to do in this returnFiber, do that next.</span>
      <span class="hljs-keyword">return</span> siblingFiber;
    }
    <span class="hljs-comment">// Otherwise, return to the parent</span>
    workInProgress = returnFiber;
  } <span class="hljs-keyword">while</span> (workInProgress !== <span class="hljs-literal">null</span>);

  <span class="hljs-comment">// We've reached the root.</span>
  <span class="hljs-keyword">if</span> (workInProgressRootExitStatus === <span class="hljs-title class_">RootIncomplete</span>) {
    workInProgressRootExitStatus = <span class="hljs-title class_">RootCompleted</span>;
  }
  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}
</code></pre>
<h4 id="completework">completeWork</h4>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// packages\react-reconciler\src\ReactFiberCompleteWork.js</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">completeWork</span>(<span class="hljs-params">
  current: Fiber | <span class="hljs-literal">null</span>,
  workInProgress: Fiber,
  renderExpirationTime: ExpirationTime,
</span>): <span class="hljs-title class_">Fiber</span> | <span class="hljs-literal">null</span> {
  <span class="hljs-keyword">const</span> newProps = workInProgress.<span class="hljs-property">pendingProps</span>;

  <span class="hljs-keyword">switch</span> (workInProgress.<span class="hljs-property">tag</span>) {
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">IndeterminateComponent</span>:
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">LazyComponent</span>:
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">SimpleMemoComponent</span>:
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">FunctionComponent</span>:
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">ClassComponent</span>: {
      <span class="hljs-keyword">const</span> <span class="hljs-title class_">Component</span> = workInProgress.<span class="hljs-property">type</span>;
      <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isLegacyContextProvider</span>(<span class="hljs-title class_">Component</span>)) {
        <span class="hljs-title function_">popLegacyContext</span>(workInProgress);
      }
      <span class="hljs-keyword">break</span>;
    }
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">HostRoot</span>: {
      <span class="hljs-title function_">popHostContainer</span>(workInProgress);
      <span class="hljs-title function_">popTopLevelLegacyContextObject</span>(workInProgress);
      <span class="hljs-keyword">const</span> fiberRoot = (workInProgress.<span class="hljs-property">stateNode</span>: <span class="hljs-title class_">FiberRoot</span>);
      <span class="hljs-keyword">if</span> (fiberRoot.<span class="hljs-property">pendingContext</span>) {
        fiberRoot.<span class="hljs-property">context</span> = fiberRoot.<span class="hljs-property">pendingContext</span>;
        fiberRoot.<span class="hljs-property">pendingContext</span> = <span class="hljs-literal">null</span>;
      }
      <span class="hljs-keyword">if</span> (current === <span class="hljs-literal">null</span> || current.<span class="hljs-property">child</span> === <span class="hljs-literal">null</span>) {
        <span class="hljs-comment">// If we hydrated, pop so that we can delete any remaining children</span>
        <span class="hljs-comment">// that weren't hydrated.</span>
        <span class="hljs-keyword">let</span> wasHydrated = <span class="hljs-title function_">popHydrationState</span>(workInProgress);
        <span class="hljs-keyword">if</span> (wasHydrated) {
          <span class="hljs-comment">// If we hydrated, then we'll need to schedule an update for</span>
          <span class="hljs-comment">// the commit side-effects on the root.</span>
          <span class="hljs-title function_">markUpdate</span>(workInProgress);
        }
      }
      <span class="hljs-title function_">updateHostContainer</span>(workInProgress);
      <span class="hljs-keyword">break</span>;
    }
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">HostComponent</span>: {
      <span class="hljs-title function_">popHostContext</span>(workInProgress);
      <span class="hljs-keyword">const</span> rootContainerInstance = <span class="hljs-title function_">getRootHostContainer</span>();
      <span class="hljs-keyword">const</span> type = workInProgress.<span class="hljs-property">type</span>;
      <span class="hljs-keyword">if</span> (current !== <span class="hljs-literal">null</span> &#x26;&#x26; workInProgress.<span class="hljs-property">stateNode</span> != <span class="hljs-literal">null</span>) {
        <span class="hljs-title function_">updateHostComponent</span>(
          current,
          workInProgress,
          type,
          newProps,
          rootContainerInstance,
        );

        <span class="hljs-keyword">if</span> (enableFlareAPI) {
          <span class="hljs-keyword">const</span> prevListeners = current.<span class="hljs-property">memoizedProps</span>.<span class="hljs-property">listeners</span>;
          <span class="hljs-keyword">const</span> nextListeners = newProps.<span class="hljs-property">listeners</span>;
          <span class="hljs-keyword">if</span> (prevListeners !== nextListeners) {
            <span class="hljs-title function_">markUpdate</span>(workInProgress);
          }
        }

        <span class="hljs-keyword">if</span> (current.<span class="hljs-property">ref</span> !== workInProgress.<span class="hljs-property">ref</span>) {
          <span class="hljs-title function_">markRef</span>(workInProgress);
        }
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">if</span> (!newProps) {
          <span class="hljs-title function_">invariant</span>(
            workInProgress.<span class="hljs-property">stateNode</span> !== <span class="hljs-literal">null</span>,
            <span class="hljs-string">'We must have new props for new mounts. This error is likely '</span> +
              <span class="hljs-string">'caused by a bug in React. Please file an issue.'</span>,
          );
          <span class="hljs-comment">// This can happen when we abort work.</span>
          <span class="hljs-keyword">break</span>;
        }

        <span class="hljs-keyword">const</span> currentHostContext = <span class="hljs-title function_">getHostContext</span>();
        <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> Move createInstance to beginWork and keep it on a context</span>
        <span class="hljs-comment">// "stack" as the parent. Then append children as we go in beginWork</span>
        <span class="hljs-comment">// or completeWork depending on we want to add then top->down or</span>
        <span class="hljs-comment">// bottom->up. Top->down is faster in IE11.</span>
        <span class="hljs-keyword">let</span> wasHydrated = <span class="hljs-title function_">popHydrationState</span>(workInProgress);
        <span class="hljs-keyword">if</span> (wasHydrated) {
          <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> Move this and createInstance step into the beginPhase</span>
          <span class="hljs-comment">// to consolidate.</span>
          <span class="hljs-keyword">if</span> (
            <span class="hljs-title function_">prepareToHydrateHostInstance</span>(
              workInProgress,
              rootContainerInstance,
              currentHostContext,
            )
          ) {
            <span class="hljs-comment">// If changes to the hydrated node needs to be applied at the</span>
            <span class="hljs-comment">// commit-phase we mark this as such.</span>
            <span class="hljs-title function_">markUpdate</span>(workInProgress);
          }
          <span class="hljs-keyword">if</span> (enableFlareAPI) {
            <span class="hljs-keyword">const</span> listeners = newProps.<span class="hljs-property">listeners</span>;
            <span class="hljs-keyword">if</span> (listeners != <span class="hljs-literal">null</span>) {
              <span class="hljs-title function_">updateEventListeners</span>(
                listeners,
                workInProgress,
                rootContainerInstance,
              );
            }
          }
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">let</span> instance = <span class="hljs-title function_">createInstance</span>(
            type,
            newProps,
            rootContainerInstance,
            currentHostContext,
            workInProgress,
          );

          <span class="hljs-title function_">appendAllChildren</span>(instance, workInProgress, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>);

          <span class="hljs-comment">// This needs to be set before we mount Flare event listeners</span>
          workInProgress.<span class="hljs-property">stateNode</span> = instance;

          <span class="hljs-keyword">if</span> (enableFlareAPI) {
            <span class="hljs-keyword">const</span> listeners = newProps.<span class="hljs-property">listeners</span>;
            <span class="hljs-keyword">if</span> (listeners != <span class="hljs-literal">null</span>) {
              <span class="hljs-title function_">updateEventListeners</span>(
                listeners,
                workInProgress,
                rootContainerInstance,
              );
            }
          }

          <span class="hljs-comment">// Certain renderers require commit-time effects for initial mount.</span>
          <span class="hljs-comment">// (eg DOM renderer supports auto-focus for certain elements).</span>
          <span class="hljs-comment">// Make sure such renderers get scheduled for later work.</span>
          <span class="hljs-keyword">if</span> (
            <span class="hljs-title function_">finalizeInitialChildren</span>(
              instance,
              type,
              newProps,
              rootContainerInstance,
              currentHostContext,
            )
          ) {
            <span class="hljs-title function_">markUpdate</span>(workInProgress);
          }
        }

        <span class="hljs-keyword">if</span> (workInProgress.<span class="hljs-property">ref</span> !== <span class="hljs-literal">null</span>) {
          <span class="hljs-comment">// If there is a ref on a host node we need to schedule a callback</span>
          <span class="hljs-title function_">markRef</span>(workInProgress);
        }
      }
      <span class="hljs-keyword">break</span>;
    }
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">HostText</span>: {
      <span class="hljs-keyword">let</span> newText = newProps;
      <span class="hljs-keyword">if</span> (current &#x26;&#x26; workInProgress.<span class="hljs-property">stateNode</span> != <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">const</span> oldText = current.<span class="hljs-property">memoizedProps</span>;
        <span class="hljs-comment">// If we have an alternate, that means this is an update and we need</span>
        <span class="hljs-comment">// to schedule a side-effect to do the updates.</span>
        <span class="hljs-title function_">updateHostText</span>(current, workInProgress, oldText, newText);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> newText !== <span class="hljs-string">'string'</span>) {
          <span class="hljs-title function_">invariant</span>(
            workInProgress.<span class="hljs-property">stateNode</span> !== <span class="hljs-literal">null</span>,
            <span class="hljs-string">'We must have new props for new mounts. This error is likely '</span> +
              <span class="hljs-string">'caused by a bug in React. Please file an issue.'</span>,
          );
          <span class="hljs-comment">// This can happen when we abort work.</span>
        }
        <span class="hljs-keyword">const</span> rootContainerInstance = <span class="hljs-title function_">getRootHostContainer</span>();
        <span class="hljs-keyword">const</span> currentHostContext = <span class="hljs-title function_">getHostContext</span>();
        <span class="hljs-keyword">let</span> wasHydrated = <span class="hljs-title function_">popHydrationState</span>(workInProgress);
        <span class="hljs-keyword">if</span> (wasHydrated) {
          <span class="hljs-keyword">if</span> (<span class="hljs-title function_">prepareToHydrateHostTextInstance</span>(workInProgress)) {
            <span class="hljs-title function_">markUpdate</span>(workInProgress);
          }
        } <span class="hljs-keyword">else</span> {
          workInProgress.<span class="hljs-property">stateNode</span> = <span class="hljs-title function_">createTextInstance</span>(
            newText,
            rootContainerInstance,
            currentHostContext,
            workInProgress,
          );
        }
      }
      <span class="hljs-keyword">break</span>;
    }
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">ForwardRef</span>:
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">SuspenseComponent</span>: {
      <span class="hljs-title function_">popSuspenseContext</span>(workInProgress);
      <span class="hljs-keyword">const</span> <span class="hljs-attr">nextState</span>: <span class="hljs-literal">null</span> | <span class="hljs-title class_">SuspenseState</span> = workInProgress.<span class="hljs-property">memoizedState</span>;

      <span class="hljs-keyword">if</span> (enableSuspenseServerRenderer) {
        <span class="hljs-keyword">if</span> (nextState !== <span class="hljs-literal">null</span> &#x26;&#x26; nextState.<span class="hljs-property">dehydrated</span> !== <span class="hljs-literal">null</span>) {
          <span class="hljs-keyword">if</span> (current === <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">let</span> wasHydrated = <span class="hljs-title function_">popHydrationState</span>(workInProgress);
            <span class="hljs-title function_">invariant</span>(
              wasHydrated,
              <span class="hljs-string">'A dehydrated suspense component was completed without a hydrated node. '</span> +
                <span class="hljs-string">'This is probably a bug in React.'</span>,
            );
            <span class="hljs-title function_">prepareToHydrateHostSuspenseInstance</span>(workInProgress);
            <span class="hljs-keyword">if</span> (enableSchedulerTracing) {
              <span class="hljs-title function_">markSpawnedWork</span>(<span class="hljs-title class_">Never</span>);
            }
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
          } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// We should never have been in a hydration state if we didn't have a current.</span>
            <span class="hljs-comment">// However, in some of those paths, we might have reentered a hydration state</span>
            <span class="hljs-comment">// and then we might be inside a hydration state. In that case, we'll need to</span>
            <span class="hljs-comment">// exit out of it.</span>
            <span class="hljs-title function_">resetHydrationState</span>();
            <span class="hljs-keyword">if</span> ((workInProgress.<span class="hljs-property">effectTag</span> &#x26; <span class="hljs-title class_">DidCapture</span>) === <span class="hljs-title class_">NoEffect</span>) {
              <span class="hljs-comment">// This boundary did not suspend so it's now hydrated and unsuspended.</span>
              workInProgress.<span class="hljs-property">memoizedState</span> = <span class="hljs-literal">null</span>;
            }
            <span class="hljs-comment">// If nothing suspended, we need to schedule an effect to mark this boundary</span>
            <span class="hljs-comment">// as having hydrated so events know that they're free be invoked.</span>
            <span class="hljs-comment">// It's also a signal to replay events and the suspense callback.</span>
            <span class="hljs-comment">// If something suspended, schedule an effect to attach retry listeners.</span>
            <span class="hljs-comment">// So we might as well always mark this.</span>
            workInProgress.<span class="hljs-property">effectTag</span> |= <span class="hljs-title class_">Update</span>;
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
          }
        }
      }

      <span class="hljs-keyword">if</span> ((workInProgress.<span class="hljs-property">effectTag</span> &#x26; <span class="hljs-title class_">DidCapture</span>) !== <span class="hljs-title class_">NoEffect</span>) {
        <span class="hljs-comment">// Something suspended. Re-render with the fallback children.</span>
        workInProgress.<span class="hljs-property">expirationTime</span> = renderExpirationTime;
        <span class="hljs-comment">// Do not reset the effect list.</span>
        <span class="hljs-keyword">return</span> workInProgress;
      }

      <span class="hljs-keyword">const</span> nextDidTimeout = nextState !== <span class="hljs-literal">null</span>;
      <span class="hljs-keyword">let</span> prevDidTimeout = <span class="hljs-literal">false</span>;
      <span class="hljs-keyword">if</span> (current === <span class="hljs-literal">null</span>) {
        <span class="hljs-comment">// In cases where we didn't find a suitable hydration boundary we never</span>
        <span class="hljs-comment">// put this in dehydrated mode, but we still need to pop the hydration</span>
        <span class="hljs-comment">// state since we might be inside the insertion tree.</span>
        <span class="hljs-title function_">popHydrationState</span>(workInProgress);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">const</span> <span class="hljs-attr">prevState</span>: <span class="hljs-literal">null</span> | <span class="hljs-title class_">SuspenseState</span> = current.<span class="hljs-property">memoizedState</span>;
        prevDidTimeout = prevState !== <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">if</span> (!nextDidTimeout &#x26;&#x26; prevState !== <span class="hljs-literal">null</span>) {
          <span class="hljs-comment">// We just switched from the fallback to the normal children.</span>
          <span class="hljs-comment">// Delete the fallback.</span>
          <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> Would it be better to store the fallback fragment on</span>
          <span class="hljs-comment">// the stateNode during the begin phase?</span>
          <span class="hljs-keyword">const</span> <span class="hljs-attr">currentFallbackChild</span>: <span class="hljs-title class_">Fiber</span> | <span class="hljs-literal">null</span> = (current.<span class="hljs-property">child</span>: any)
            .<span class="hljs-property">sibling</span>;
          <span class="hljs-keyword">if</span> (currentFallbackChild !== <span class="hljs-literal">null</span>) {
            <span class="hljs-comment">// Deletions go at the beginning of the return fiber's effect list</span>
            <span class="hljs-keyword">const</span> first = workInProgress.<span class="hljs-property">firstEffect</span>;
            <span class="hljs-keyword">if</span> (first !== <span class="hljs-literal">null</span>) {
              workInProgress.<span class="hljs-property">firstEffect</span> = currentFallbackChild;
              currentFallbackChild.<span class="hljs-property">nextEffect</span> = first;
            } <span class="hljs-keyword">else</span> {
              workInProgress.<span class="hljs-property">firstEffect</span> = workInProgress.<span class="hljs-property">lastEffect</span> = currentFallbackChild;
              currentFallbackChild.<span class="hljs-property">nextEffect</span> = <span class="hljs-literal">null</span>;
            }
            currentFallbackChild.<span class="hljs-property">effectTag</span> = <span class="hljs-title class_">Deletion</span>;
          }
        }
      }

      <span class="hljs-keyword">if</span> (nextDidTimeout &#x26;&#x26; !prevDidTimeout) {
        <span class="hljs-comment">// If this subtreee is running in batched mode we can suspend,</span>
        <span class="hljs-comment">// otherwise we won't suspend.</span>
        <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> This will still suspend a synchronous tree if anything</span>
        <span class="hljs-comment">// in the concurrent tree already suspended during this render.</span>
        <span class="hljs-comment">// This is a known bug.</span>
        <span class="hljs-keyword">if</span> ((workInProgress.<span class="hljs-property">mode</span> &#x26; <span class="hljs-title class_">BatchedMode</span>) !== <span class="hljs-title class_">NoMode</span>) {
          <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> Move this back to throwException because this is too late</span>
          <span class="hljs-comment">// if this is a large tree which is common for initial loads. We</span>
          <span class="hljs-comment">// don't know if we should restart a render or not until we get</span>
          <span class="hljs-comment">// this marker, and this is too late.</span>
          <span class="hljs-comment">// If this render already had a ping or lower pri updates,</span>
          <span class="hljs-comment">// and this is the first time we know we're going to suspend we</span>
          <span class="hljs-comment">// should be able to immediately restart from within throwException.</span>
          <span class="hljs-keyword">const</span> hasInvisibleChildContext =
            current === <span class="hljs-literal">null</span> &#x26;&#x26;
            workInProgress.<span class="hljs-property">memoizedProps</span>.<span class="hljs-property">unstable_avoidThisFallback</span> !== <span class="hljs-literal">true</span>;
          <span class="hljs-keyword">if</span> (
            hasInvisibleChildContext ||
            <span class="hljs-title function_">hasSuspenseContext</span>(
              suspenseStackCursor.<span class="hljs-property">current</span>,
              (<span class="hljs-title class_">InvisibleParentSuspenseContext</span>: <span class="hljs-title class_">SuspenseContext</span>),
            )
          ) {
            <span class="hljs-comment">// If this was in an invisible tree or a new render, then showing</span>
            <span class="hljs-comment">// this boundary is ok.</span>
            <span class="hljs-title function_">renderDidSuspend</span>();
          } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// Otherwise, we're going to have to hide content so we should</span>
            <span class="hljs-comment">// suspend for longer if possible.</span>
            <span class="hljs-title function_">renderDidSuspendDelayIfPossible</span>();
          }
        }
      }

      <span class="hljs-keyword">if</span> (supportsPersistence) {
        <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> Only schedule updates if not prevDidTimeout.</span>
        <span class="hljs-keyword">if</span> (nextDidTimeout) {
          <span class="hljs-comment">// If this boundary just timed out, schedule an effect to attach a</span>
          <span class="hljs-comment">// retry listener to the proimse. This flag is also used to hide the</span>
          <span class="hljs-comment">// primary children.</span>
          workInProgress.<span class="hljs-property">effectTag</span> |= <span class="hljs-title class_">Update</span>;
        }
      }
      <span class="hljs-keyword">if</span> (supportsMutation) {
        <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> Only schedule updates if these values are non equal, i.e. it changed.</span>
        <span class="hljs-keyword">if</span> (nextDidTimeout || prevDidTimeout) {
          <span class="hljs-comment">// If this boundary just timed out, schedule an effect to attach a</span>
          <span class="hljs-comment">// retry listener to the proimse. This flag is also used to hide the</span>
          <span class="hljs-comment">// primary children. In mutation mode, we also need the flag to</span>
          <span class="hljs-comment">// *unhide* children that were previously hidden, so check if the</span>
          <span class="hljs-comment">// is currently timed out, too.</span>
          workInProgress.<span class="hljs-property">effectTag</span> |= <span class="hljs-title class_">Update</span>;
        }
      }
      <span class="hljs-keyword">if</span> (
        enableSuspenseCallback &#x26;&#x26;
        workInProgress.<span class="hljs-property">updateQueue</span> !== <span class="hljs-literal">null</span> &#x26;&#x26;
        workInProgress.<span class="hljs-property">memoizedProps</span>.<span class="hljs-property">suspenseCallback</span> != <span class="hljs-literal">null</span>
      ) {
        <span class="hljs-comment">// Always notify the callback</span>
        workInProgress.<span class="hljs-property">effectTag</span> |= <span class="hljs-title class_">Update</span>;
      }
      <span class="hljs-keyword">break</span>;
    }
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">Fragment</span>:
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">Mode</span>:
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">Profiler</span>:
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">HostPortal</span>:
      <span class="hljs-title function_">popHostContainer</span>(workInProgress);
      <span class="hljs-title function_">updateHostContainer</span>(workInProgress);
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">ContextProvider</span>:
      <span class="hljs-comment">// Pop provider fiber</span>
      <span class="hljs-title function_">popProvider</span>(workInProgress);
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">ContextConsumer</span>:
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">MemoComponent</span>:
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">IncompleteClassComponent</span>: {
      <span class="hljs-comment">// Same as class component case. I put it down here so that the tags are</span>
      <span class="hljs-comment">// sequential to ensure this switch is compiled to a jump table.</span>
      <span class="hljs-keyword">const</span> <span class="hljs-title class_">Component</span> = workInProgress.<span class="hljs-property">type</span>;
      <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isLegacyContextProvider</span>(<span class="hljs-title class_">Component</span>)) {
        <span class="hljs-title function_">popLegacyContext</span>(workInProgress);
      }
      <span class="hljs-keyword">break</span>;
    }
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">SuspenseListComponent</span>: {
      <span class="hljs-title function_">popSuspenseContext</span>(workInProgress);

      <span class="hljs-keyword">const</span> <span class="hljs-attr">renderState</span>: <span class="hljs-literal">null</span> | <span class="hljs-title class_">SuspenseListRenderState</span> =
        workInProgress.<span class="hljs-property">memoizedState</span>;

      <span class="hljs-keyword">if</span> (renderState === <span class="hljs-literal">null</span>) {
        <span class="hljs-comment">// We're running in the default, "independent" mode. We don't do anything</span>
        <span class="hljs-comment">// in this mode.</span>
        <span class="hljs-keyword">break</span>;
      }

      <span class="hljs-keyword">let</span> didSuspendAlready =
        (workInProgress.<span class="hljs-property">effectTag</span> &#x26; <span class="hljs-title class_">DidCapture</span>) !== <span class="hljs-title class_">NoEffect</span>;

      <span class="hljs-keyword">let</span> renderedTail = renderState.<span class="hljs-property">rendering</span>;
      <span class="hljs-keyword">if</span> (renderedTail === <span class="hljs-literal">null</span>) {
        <span class="hljs-comment">// We just rendered the head.</span>
        <span class="hljs-keyword">if</span> (!didSuspendAlready) {
          <span class="hljs-comment">// This is the first pass. We need to figure out if anything is still</span>
          <span class="hljs-comment">// suspended in the rendered set.</span>

          <span class="hljs-comment">// If new content unsuspended, but there's still some content that</span>
          <span class="hljs-comment">// didn't. Then we need to do a second pass that forces everything</span>
          <span class="hljs-comment">// to keep showing their fallbacks.</span>

          <span class="hljs-comment">// We might be suspended if something in this render pass suspended, or</span>
          <span class="hljs-comment">// something in the previous committed pass suspended. Otherwise,</span>
          <span class="hljs-comment">// there's no chance so we can skip the expensive call to</span>
          <span class="hljs-comment">// findFirstSuspended.</span>
          <span class="hljs-keyword">let</span> cannotBeSuspended =
            <span class="hljs-title function_">renderHasNotSuspendedYet</span>() &#x26;&#x26;
            (current === <span class="hljs-literal">null</span> || (current.<span class="hljs-property">effectTag</span> &#x26; <span class="hljs-title class_">DidCapture</span>) === <span class="hljs-title class_">NoEffect</span>);
          <span class="hljs-keyword">if</span> (!cannotBeSuspended) {
            <span class="hljs-keyword">let</span> row = workInProgress.<span class="hljs-property">child</span>;
            <span class="hljs-keyword">while</span> (row !== <span class="hljs-literal">null</span>) {
              <span class="hljs-keyword">let</span> suspended = <span class="hljs-title function_">findFirstSuspended</span>(row);
              <span class="hljs-keyword">if</span> (suspended !== <span class="hljs-literal">null</span>) {
                didSuspendAlready = <span class="hljs-literal">true</span>;
                workInProgress.<span class="hljs-property">effectTag</span> |= <span class="hljs-title class_">DidCapture</span>;
                <span class="hljs-title function_">cutOffTailIfNeeded</span>(renderState, <span class="hljs-literal">false</span>);

                <span class="hljs-comment">// If this is a newly suspended tree, it might not get committed as</span>
                <span class="hljs-comment">// part of the second pass. In that case nothing will subscribe to</span>
                <span class="hljs-comment">// its thennables. Instead, we'll transfer its thennables to the</span>
                <span class="hljs-comment">// SuspenseList so that it can retry if they resolve.</span>
                <span class="hljs-comment">// There might be multiple of these in the list but since we're</span>
                <span class="hljs-comment">// going to wait for all of them anyway, it doesn't really matter</span>
                <span class="hljs-comment">// which ones gets to ping. In theory we could get clever and keep</span>
                <span class="hljs-comment">// track of how many dependencies remain but it gets tricky because</span>
                <span class="hljs-comment">// in the meantime, we can add/remove/change items and dependencies.</span>
                <span class="hljs-comment">// We might bail out of the loop before finding any but that</span>
                <span class="hljs-comment">// doesn't matter since that means that the other boundaries that</span>
                <span class="hljs-comment">// we did find already has their listeners attached.</span>
                <span class="hljs-keyword">let</span> newThennables = suspended.<span class="hljs-property">updateQueue</span>;
                <span class="hljs-keyword">if</span> (newThennables !== <span class="hljs-literal">null</span>) {
                  workInProgress.<span class="hljs-property">updateQueue</span> = newThennables;
                  workInProgress.<span class="hljs-property">effectTag</span> |= <span class="hljs-title class_">Update</span>;
                }

                <span class="hljs-comment">// Rerender the whole list, but this time, we'll force fallbacks</span>
                <span class="hljs-comment">// to stay in place.</span>
                <span class="hljs-comment">// Reset the effect list before doing the second pass since that's now invalid.</span>
                workInProgress.<span class="hljs-property">firstEffect</span> = workInProgress.<span class="hljs-property">lastEffect</span> = <span class="hljs-literal">null</span>;
                <span class="hljs-comment">// Reset the child fibers to their original state.</span>
                <span class="hljs-title function_">resetChildFibers</span>(workInProgress, renderExpirationTime);

                <span class="hljs-comment">// Set up the Suspense Context to force suspense and immediately</span>
                <span class="hljs-comment">// rerender the children.</span>
                <span class="hljs-title function_">pushSuspenseContext</span>(
                  workInProgress,
                  <span class="hljs-title function_">setShallowSuspenseContext</span>(
                    suspenseStackCursor.<span class="hljs-property">current</span>,
                    <span class="hljs-title class_">ForceSuspenseFallback</span>,
                  ),
                );
                <span class="hljs-keyword">return</span> workInProgress.<span class="hljs-property">child</span>;
              }
              row = row.<span class="hljs-property">sibling</span>;
            }
          }
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-title function_">cutOffTailIfNeeded</span>(renderState, <span class="hljs-literal">false</span>);
        }
        <span class="hljs-comment">// Next we're going to render the tail.</span>
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// Append the rendered row to the child list.</span>
        <span class="hljs-keyword">if</span> (!didSuspendAlready) {
          <span class="hljs-keyword">let</span> suspended = <span class="hljs-title function_">findFirstSuspended</span>(renderedTail);
          <span class="hljs-keyword">if</span> (suspended !== <span class="hljs-literal">null</span>) {
            workInProgress.<span class="hljs-property">effectTag</span> |= <span class="hljs-title class_">DidCapture</span>;
            didSuspendAlready = <span class="hljs-literal">true</span>;
            <span class="hljs-title function_">cutOffTailIfNeeded</span>(renderState, <span class="hljs-literal">true</span>);
            <span class="hljs-comment">// This might have been modified.</span>
            <span class="hljs-keyword">if</span> (
              renderState.<span class="hljs-property">tail</span> === <span class="hljs-literal">null</span> &#x26;&#x26;
              renderState.<span class="hljs-property">tailMode</span> === <span class="hljs-string">'hidden'</span>
            ) {
              <span class="hljs-comment">// We need to delete the row we just rendered.</span>
              <span class="hljs-comment">// Ensure we transfer the update queue to the parent.</span>
              <span class="hljs-keyword">let</span> newThennables = suspended.<span class="hljs-property">updateQueue</span>;
              <span class="hljs-keyword">if</span> (newThennables !== <span class="hljs-literal">null</span>) {
                workInProgress.<span class="hljs-property">updateQueue</span> = newThennables;
                workInProgress.<span class="hljs-property">effectTag</span> |= <span class="hljs-title class_">Update</span>;
              }
              <span class="hljs-comment">// Reset the effect list to what it w as before we rendered this</span>
              <span class="hljs-comment">// child. The nested children have already appended themselves.</span>
              <span class="hljs-keyword">let</span> lastEffect = (workInProgress.<span class="hljs-property">lastEffect</span> =
                renderState.<span class="hljs-property">lastEffect</span>);
              <span class="hljs-comment">// Remove any effects that were appended after this point.</span>
              <span class="hljs-keyword">if</span> (lastEffect !== <span class="hljs-literal">null</span>) {
                lastEffect.<span class="hljs-property">nextEffect</span> = <span class="hljs-literal">null</span>;
              }
              <span class="hljs-comment">// We're done.</span>
              <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
            }
          } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (
            <span class="hljs-title function_">now</span>() > renderState.<span class="hljs-property">tailExpiration</span> &#x26;&#x26;
            renderExpirationTime > <span class="hljs-title class_">Never</span>
          ) {
            <span class="hljs-comment">// We have now passed our CPU deadline and we'll just give up further</span>
            <span class="hljs-comment">// attempts to render the main content and only render fallbacks.</span>
            <span class="hljs-comment">// The assumption is that this is usually faster.</span>
            workInProgress.<span class="hljs-property">effectTag</span> |= <span class="hljs-title class_">DidCapture</span>;
            didSuspendAlready = <span class="hljs-literal">true</span>;

            <span class="hljs-title function_">cutOffTailIfNeeded</span>(renderState, <span class="hljs-literal">false</span>);

            <span class="hljs-comment">// Since nothing actually suspended, there will nothing to ping this</span>
            <span class="hljs-comment">// to get it started back up to attempt the next item. If we can show</span>
            <span class="hljs-comment">// them, then they really have the same priority as this render.</span>
            <span class="hljs-comment">// So we'll pick it back up the very next render pass once we've had</span>
            <span class="hljs-comment">// an opportunity to yield for paint.</span>

            <span class="hljs-keyword">const</span> nextPriority = renderExpirationTime - <span class="hljs-number">1</span>;
            workInProgress.<span class="hljs-property">expirationTime</span> = workInProgress.<span class="hljs-property">childExpirationTime</span> = nextPriority;
            <span class="hljs-keyword">if</span> (enableSchedulerTracing) {
              <span class="hljs-title function_">markSpawnedWork</span>(nextPriority);
            }
          }
        }
        <span class="hljs-keyword">if</span> (renderState.<span class="hljs-property">isBackwards</span>) {
          <span class="hljs-comment">// The effect list of the backwards tail will have been added</span>
          <span class="hljs-comment">// to the end. This breaks the guarantee that life-cycles fire in</span>
          <span class="hljs-comment">// sibling order but that isn't a strong guarantee promised by React.</span>
          <span class="hljs-comment">// Especially since these might also just pop in during future commits.</span>
          <span class="hljs-comment">// Append to the beginning of the list.</span>
          renderedTail.<span class="hljs-property">sibling</span> = workInProgress.<span class="hljs-property">child</span>;
          workInProgress.<span class="hljs-property">child</span> = renderedTail;
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">let</span> previousSibling = renderState.<span class="hljs-property">last</span>;
          <span class="hljs-keyword">if</span> (previousSibling !== <span class="hljs-literal">null</span>) {
            previousSibling.<span class="hljs-property">sibling</span> = renderedTail;
          } <span class="hljs-keyword">else</span> {
            workInProgress.<span class="hljs-property">child</span> = renderedTail;
          }
          renderState.<span class="hljs-property">last</span> = renderedTail;
        }
      }

      <span class="hljs-keyword">if</span> (renderState.<span class="hljs-property">tail</span> !== <span class="hljs-literal">null</span>) {
        <span class="hljs-comment">// We still have tail rows to render.</span>
        <span class="hljs-keyword">if</span> (renderState.<span class="hljs-property">tailExpiration</span> === <span class="hljs-number">0</span>) {
          <span class="hljs-comment">// Heuristic for how long we're willing to spend rendering rows</span>
          <span class="hljs-comment">// until we just give up and show what we have so far.</span>
          <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">TAIL_EXPIRATION_TIMEOUT_MS</span> = <span class="hljs-number">500</span>;
          renderState.<span class="hljs-property">tailExpiration</span> = <span class="hljs-title function_">now</span>() + <span class="hljs-variable constant_">TAIL_EXPIRATION_TIMEOUT_MS</span>;
        }
        <span class="hljs-comment">// Pop a row.</span>
        <span class="hljs-keyword">let</span> next = renderState.<span class="hljs-property">tail</span>;
        renderState.<span class="hljs-property">rendering</span> = next;
        renderState.<span class="hljs-property">tail</span> = next.<span class="hljs-property">sibling</span>;
        renderState.<span class="hljs-property">lastEffect</span> = workInProgress.<span class="hljs-property">lastEffect</span>;
        next.<span class="hljs-property">sibling</span> = <span class="hljs-literal">null</span>;

        <span class="hljs-comment">// Restore the context.</span>
        <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> We can probably just avoid popping it instead and only</span>
        <span class="hljs-comment">// setting it the first time we go from not suspended to suspended.</span>
        <span class="hljs-keyword">let</span> suspenseContext = suspenseStackCursor.<span class="hljs-property">current</span>;
        <span class="hljs-keyword">if</span> (didSuspendAlready) {
          suspenseContext = <span class="hljs-title function_">setShallowSuspenseContext</span>(
            suspenseContext,
            <span class="hljs-title class_">ForceSuspenseFallback</span>,
          );
        } <span class="hljs-keyword">else</span> {
          suspenseContext = <span class="hljs-title function_">setDefaultShallowSuspenseContext</span>(suspenseContext);
        }
        <span class="hljs-title function_">pushSuspenseContext</span>(workInProgress, suspenseContext);
        <span class="hljs-comment">// Do a pass over the next row.</span>
        <span class="hljs-keyword">return</span> next;
      }
      <span class="hljs-keyword">break</span>;
    }
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">FundamentalComponent</span>: {
      <span class="hljs-keyword">if</span> (enableFundamentalAPI) {
        <span class="hljs-keyword">const</span> fundamentalImpl = workInProgress.<span class="hljs-property">type</span>.<span class="hljs-property">impl</span>;
        <span class="hljs-keyword">let</span> <span class="hljs-attr">fundamentalInstance</span>: <span class="hljs-title class_">ReactFundamentalComponentInstance</span>&#x3C;
          any,
          any,
        > | <span class="hljs-literal">null</span> =
          workInProgress.<span class="hljs-property">stateNode</span>;

        <span class="hljs-keyword">if</span> (fundamentalInstance === <span class="hljs-literal">null</span>) {
          <span class="hljs-keyword">const</span> getInitialState = fundamentalImpl.<span class="hljs-property">getInitialState</span>;
          <span class="hljs-keyword">let</span> fundamentalState;
          <span class="hljs-keyword">if</span> (getInitialState !== <span class="hljs-literal">undefined</span>) {
            fundamentalState = <span class="hljs-title function_">getInitialState</span>(newProps);
          }
          fundamentalInstance = workInProgress.<span class="hljs-property">stateNode</span> = <span class="hljs-title function_">createFundamentalStateInstance</span>(
            workInProgress,
            newProps,
            fundamentalImpl,
            fundamentalState || {},
          );
          <span class="hljs-keyword">const</span> instance = ((<span class="hljs-title function_">getFundamentalComponentInstance</span>(
            fundamentalInstance,
          ): any): <span class="hljs-title class_">Instance</span>);
          fundamentalInstance.<span class="hljs-property">instance</span> = instance;
          <span class="hljs-keyword">if</span> (fundamentalImpl.<span class="hljs-property">reconcileChildren</span> === <span class="hljs-literal">false</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
          }
          <span class="hljs-title function_">appendAllChildren</span>(instance, workInProgress, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>);
          <span class="hljs-title function_">mountFundamentalComponent</span>(fundamentalInstance);
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-comment">// We fire update in commit phase</span>
          <span class="hljs-keyword">const</span> prevProps = fundamentalInstance.<span class="hljs-property">props</span>;
          fundamentalInstance.<span class="hljs-property">prevProps</span> = prevProps;
          fundamentalInstance.<span class="hljs-property">props</span> = newProps;
          fundamentalInstance.<span class="hljs-property">currentFiber</span> = workInProgress;
          <span class="hljs-keyword">if</span> (supportsPersistence) {
            <span class="hljs-keyword">const</span> instance = <span class="hljs-title function_">cloneFundamentalInstance</span>(fundamentalInstance);
            fundamentalInstance.<span class="hljs-property">instance</span> = instance;
            <span class="hljs-title function_">appendAllChildren</span>(instance, workInProgress, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>);
          }
          <span class="hljs-keyword">const</span> shouldUpdate = <span class="hljs-title function_">shouldUpdateFundamentalComponent</span>(
            fundamentalInstance,
          );
          <span class="hljs-keyword">if</span> (shouldUpdate) {
            <span class="hljs-title function_">markUpdate</span>(workInProgress);
          }
        }
      }
      <span class="hljs-keyword">break</span>;
    }
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">ScopeComponent</span>: {
      <span class="hljs-keyword">if</span> (enableScopeAPI) {
        <span class="hljs-keyword">if</span> (current === <span class="hljs-literal">null</span>) {
          <span class="hljs-keyword">const</span> type = workInProgress.<span class="hljs-property">type</span>;
          <span class="hljs-keyword">const</span> <span class="hljs-attr">scopeInstance</span>: <span class="hljs-title class_">ReactScopeInstance</span> = {
            <span class="hljs-attr">fiber</span>: workInProgress,
            <span class="hljs-attr">methods</span>: <span class="hljs-literal">null</span>,
          };
          workInProgress.<span class="hljs-property">stateNode</span> = scopeInstance;
          scopeInstance.<span class="hljs-property">methods</span> = <span class="hljs-title function_">createScopeMethods</span>(type, scopeInstance);
          <span class="hljs-keyword">if</span> (enableFlareAPI) {
            <span class="hljs-keyword">const</span> listeners = newProps.<span class="hljs-property">listeners</span>;
            <span class="hljs-keyword">if</span> (listeners != <span class="hljs-literal">null</span>) {
              <span class="hljs-keyword">const</span> rootContainerInstance = <span class="hljs-title function_">getRootHostContainer</span>();
              <span class="hljs-title function_">updateEventListeners</span>(
                listeners,
                workInProgress,
                rootContainerInstance,
              );
            }
          }
          <span class="hljs-keyword">if</span> (workInProgress.<span class="hljs-property">ref</span> !== <span class="hljs-literal">null</span>) {
            <span class="hljs-title function_">markRef</span>(workInProgress);
            <span class="hljs-title function_">markUpdate</span>(workInProgress);
          }
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">if</span> (enableFlareAPI) {
            <span class="hljs-keyword">const</span> prevListeners = current.<span class="hljs-property">memoizedProps</span>.<span class="hljs-property">listeners</span>;
            <span class="hljs-keyword">const</span> nextListeners = newProps.<span class="hljs-property">listeners</span>;
            <span class="hljs-keyword">if</span> (
              prevListeners !== nextListeners ||
              workInProgress.<span class="hljs-property">ref</span> !== <span class="hljs-literal">null</span>
            ) {
              <span class="hljs-title function_">markUpdate</span>(workInProgress);
            }
          } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">if</span> (workInProgress.<span class="hljs-property">ref</span> !== <span class="hljs-literal">null</span>) {
              <span class="hljs-title function_">markUpdate</span>(workInProgress);
            }
          }
          <span class="hljs-keyword">if</span> (current.<span class="hljs-property">ref</span> !== workInProgress.<span class="hljs-property">ref</span>) {
            <span class="hljs-title function_">markRef</span>(workInProgress);
          }
        }
      }
      <span class="hljs-keyword">break</span>;
    }
    <span class="hljs-attr">default</span>:
      <span class="hljs-title function_">invariant</span>(
        <span class="hljs-literal">false</span>,
        <span class="hljs-string">'Unknown unit of work tag (%s). This error is likely caused by a bug in '</span> +
          <span class="hljs-string">'React. Please file an issue.'</span>,
        workInProgress.<span class="hljs-property">tag</span>,
      );
  }

  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}
</code></pre>
<h6 id="pophostcontainer">popHostContainer</h6>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// packages\react-reconciler\src\ReactFiberHostContext.js</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">popHostContainer</span>(<span class="hljs-params">fiber: Fiber</span>) {
  <span class="hljs-title function_">pop</span>(contextStackCursor, fiber);
  <span class="hljs-title function_">pop</span>(contextFiberStackCursor, fiber);
  <span class="hljs-title function_">pop</span>(rootInstanceStackCursor, fiber);
}
</code></pre>
<h6 id="poptoplevellegacycontextobject">popTopLevelLegacyContextObject</h6>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// packages\react-reconciler\src\ReactFiberContext.js</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">popTopLevelContextObject</span>(<span class="hljs-params">fiber: Fiber</span>): <span class="hljs-keyword">void</span> {
  <span class="hljs-keyword">if</span> (disableLegacyContext) {
    <span class="hljs-keyword">return</span>;
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-title function_">pop</span>(didPerformWorkStackCursor, fiber);
    <span class="hljs-title function_">pop</span>(contextStackCursor, fiber);
  }
}
</code></pre>
<h6 id="popdispatcher">popDispatcher</h6>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// packages\react-reconciler\src\ReactFiberWorkLoop.js</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">popDispatcher</span>(<span class="hljs-params">prevDispatcher</span>) {
  <span class="hljs-title class_">ReactCurrentDispatcher</span>.<span class="hljs-property">current</span> = prevDispatcher;
}
</code></pre>
<h5 id="finishsyncrender">finishSyncRender</h5>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// packages\react-reconciler\src\ReactFiberWorkLoop.js</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">finishSyncRender</span>(<span class="hljs-params">root, exitStatus, expirationTime</span>) {
  <span class="hljs-keyword">if</span> (exitStatus === <span class="hljs-title class_">RootLocked</span>) {
    <span class="hljs-comment">// This root has a lock that prevents it from committing. Exit. If we</span>
    <span class="hljs-comment">// begin work on the root again, without any intervening updates, it</span>
    <span class="hljs-comment">// will finish without doing additional work.</span>
    <span class="hljs-title function_">markRootSuspendedAtTime</span>(root, expirationTime);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// Set this to null to indicate there's no in-progress render.</span>
    workInProgressRoot = <span class="hljs-literal">null</span>;

    <span class="hljs-keyword">if</span> (__DEV__) {
      <span class="hljs-keyword">if</span> (
        exitStatus === <span class="hljs-title class_">RootSuspended</span> ||
        exitStatus === <span class="hljs-title class_">RootSuspendedWithDelay</span>
      ) {
        <span class="hljs-title function_">flushSuspensePriorityWarningInDEV</span>();
      }
    }
    <span class="hljs-title function_">commitRoot</span>(root);
  }
}
</code></pre>
<h5 id="commitroot">commitRoot</h5>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// packages\react-reconciler\src\ReactFiberWorkLoop.js</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">commitRoot</span>(<span class="hljs-params">root</span>) {
  <span class="hljs-keyword">const</span> renderPriorityLevel = <span class="hljs-title function_">getCurrentPriorityLevel</span>();
  <span class="hljs-title function_">runWithPriority</span>(
    <span class="hljs-title class_">ImmediatePriority</span>,
    commitRootImpl.<span class="hljs-title function_">bind</span>(<span class="hljs-literal">null</span>, root, renderPriorityLevel),
  );
  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">commitRootImpl</span>(<span class="hljs-params">root, renderPriorityLevel</span>) {
  <span class="hljs-title function_">flushPassiveEffects</span>();
  <span class="hljs-title function_">flushRenderPhaseStrictModeWarningsInDEV</span>();

  <span class="hljs-title function_">invariant</span>(
    (executionContext &#x26; (<span class="hljs-title class_">RenderContext</span> | <span class="hljs-title class_">CommitContext</span>)) === <span class="hljs-title class_">NoContext</span>,
    <span class="hljs-string">'Should not already be working.'</span>,
  );

  <span class="hljs-keyword">const</span> finishedWork = root.<span class="hljs-property">finishedWork</span>;
  <span class="hljs-keyword">const</span> expirationTime = root.<span class="hljs-property">finishedExpirationTime</span>;
  <span class="hljs-keyword">if</span> (finishedWork === <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  }
  root.<span class="hljs-property">finishedWork</span> = <span class="hljs-literal">null</span>;
  root.<span class="hljs-property">finishedExpirationTime</span> = <span class="hljs-title class_">NoWork</span>;

  <span class="hljs-title function_">invariant</span>(
    finishedWork !== root.<span class="hljs-property">current</span>,
    <span class="hljs-string">'Cannot commit the same tree as before. This error is likely caused by '</span> +
      <span class="hljs-string">'a bug in React. Please file an issue.'</span>,
  );

  <span class="hljs-comment">// commitRoot never returns a continuation; it always finishes synchronously.</span>
  <span class="hljs-comment">// So we can clear these now to allow a new callback to be scheduled.</span>
  root.<span class="hljs-property">callbackNode</span> = <span class="hljs-literal">null</span>;
  root.<span class="hljs-property">callbackExpirationTime</span> = <span class="hljs-title class_">NoWork</span>;
  root.<span class="hljs-property">callbackPriority</span> = <span class="hljs-title class_">NoPriority</span>;
  root.<span class="hljs-property">nextKnownPendingLevel</span> = <span class="hljs-title class_">NoWork</span>;

  <span class="hljs-title function_">startCommitTimer</span>();

  <span class="hljs-comment">// Update the first and last pending times on this root. The new first</span>
  <span class="hljs-comment">// pending time is whatever is left on the root fiber.</span>
  <span class="hljs-keyword">const</span> remainingExpirationTimeBeforeCommit = <span class="hljs-title function_">getRemainingExpirationTime</span>(
    finishedWork,
  );
  <span class="hljs-title function_">markRootFinishedAtTime</span>(
    root,
    expirationTime,
    remainingExpirationTimeBeforeCommit,
  );

  <span class="hljs-keyword">if</span> (root === workInProgressRoot) {
    <span class="hljs-comment">// We can reset these now that they are finished.</span>
    workInProgressRoot = <span class="hljs-literal">null</span>;
    workInProgress = <span class="hljs-literal">null</span>;
    renderExpirationTime = <span class="hljs-title class_">NoWork</span>;
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// This indicates that the last root we worked on is not the same one that</span>
    <span class="hljs-comment">// we're committing now. This most commonly happens when a suspended root</span>
    <span class="hljs-comment">// times out.</span>
  }

  <span class="hljs-comment">// Get the list of effects.</span>
  <span class="hljs-keyword">let</span> firstEffect;
  <span class="hljs-keyword">if</span> (finishedWork.<span class="hljs-property">effectTag</span> > <span class="hljs-title class_">PerformedWork</span>) {
    <span class="hljs-comment">// A fiber's effect list consists only of its children, not itself. So if</span>
    <span class="hljs-comment">// the root has an effect, we need to add it to the end of the list. The</span>
    <span class="hljs-comment">// resulting list is the set that would belong to the root's parent, if it</span>
    <span class="hljs-comment">// had one; that is, all the effects in the tree including the root.</span>
    <span class="hljs-keyword">if</span> (finishedWork.<span class="hljs-property">lastEffect</span> !== <span class="hljs-literal">null</span>) {
      finishedWork.<span class="hljs-property">lastEffect</span>.<span class="hljs-property">nextEffect</span> = finishedWork;
      firstEffect = finishedWork.<span class="hljs-property">firstEffect</span>;
    } <span class="hljs-keyword">else</span> {
      firstEffect = finishedWork;
    }
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// There is no effect on the root.</span>
    firstEffect = finishedWork.<span class="hljs-property">firstEffect</span>;
  }

  <span class="hljs-keyword">if</span> (firstEffect !== <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">const</span> prevExecutionContext = executionContext;
    executionContext |= <span class="hljs-title class_">CommitContext</span>;
    <span class="hljs-keyword">const</span> prevInteractions = <span class="hljs-title function_">pushInteractions</span>(root);

    <span class="hljs-comment">// Reset this to null before calling lifecycles</span>
    <span class="hljs-title class_">ReactCurrentOwner</span>.<span class="hljs-property">current</span> = <span class="hljs-literal">null</span>;

    <span class="hljs-comment">// The commit phase is broken into several sub-phases. We do a separate pass</span>
    <span class="hljs-comment">// of the effect list for each phase: all mutation effects come before all</span>
    <span class="hljs-comment">// layout effects, and so on.</span>

    <span class="hljs-comment">// The first phase a "before mutation" phase. We use this phase to read the</span>
    <span class="hljs-comment">// state of the host tree right before we mutate it. This is where</span>
    <span class="hljs-comment">// getSnapshotBeforeUpdate is called.</span>
    <span class="hljs-title function_">startCommitSnapshotEffectsTimer</span>();
    <span class="hljs-title function_">prepareForCommit</span>(root.<span class="hljs-property">containerInfo</span>);
    nextEffect = firstEffect;
    <span class="hljs-keyword">do</span> {
      <span class="hljs-keyword">if</span> (__DEV__) {
        <span class="hljs-title function_">invokeGuardedCallback</span>(<span class="hljs-literal">null</span>, commitBeforeMutationEffects, <span class="hljs-literal">null</span>);
        <span class="hljs-keyword">if</span> (<span class="hljs-title function_">hasCaughtError</span>()) {
          <span class="hljs-title function_">invariant</span>(nextEffect !== <span class="hljs-literal">null</span>, <span class="hljs-string">'Should be working on an effect.'</span>);
          <span class="hljs-keyword">const</span> error = <span class="hljs-title function_">clearCaughtError</span>();
          <span class="hljs-title function_">captureCommitPhaseError</span>(nextEffect, error);
          nextEffect = nextEffect.<span class="hljs-property">nextEffect</span>;
        }
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">try</span> {
          <span class="hljs-title function_">commitBeforeMutationEffects</span>();
        } <span class="hljs-keyword">catch</span> (error) {
          <span class="hljs-title function_">invariant</span>(nextEffect !== <span class="hljs-literal">null</span>, <span class="hljs-string">'Should be working on an effect.'</span>);
          <span class="hljs-title function_">captureCommitPhaseError</span>(nextEffect, error);
          nextEffect = nextEffect.<span class="hljs-property">nextEffect</span>;
        }
      }
    } <span class="hljs-keyword">while</span> (nextEffect !== <span class="hljs-literal">null</span>);
    <span class="hljs-title function_">stopCommitSnapshotEffectsTimer</span>();

    <span class="hljs-keyword">if</span> (enableProfilerTimer) {
      <span class="hljs-comment">// Mark the current commit time to be shared by all Profilers in this</span>
      <span class="hljs-comment">// batch. This enables them to be grouped later.</span>
      <span class="hljs-title function_">recordCommitTime</span>();
    }

    <span class="hljs-comment">// The next phase is the mutation phase, where we mutate the host tree.</span>
    <span class="hljs-title function_">startCommitHostEffectsTimer</span>();
    nextEffect = firstEffect;
    <span class="hljs-keyword">do</span> {
      <span class="hljs-keyword">if</span> (__DEV__) {
        <span class="hljs-title function_">invokeGuardedCallback</span>(
          <span class="hljs-literal">null</span>,
          commitMutationEffects,
          <span class="hljs-literal">null</span>,
          root,
          renderPriorityLevel,
        );
        <span class="hljs-keyword">if</span> (<span class="hljs-title function_">hasCaughtError</span>()) {
          <span class="hljs-title function_">invariant</span>(nextEffect !== <span class="hljs-literal">null</span>, <span class="hljs-string">'Should be working on an effect.'</span>);
          <span class="hljs-keyword">const</span> error = <span class="hljs-title function_">clearCaughtError</span>();
          <span class="hljs-title function_">captureCommitPhaseError</span>(nextEffect, error);
          nextEffect = nextEffect.<span class="hljs-property">nextEffect</span>;
        }
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">try</span> {
          <span class="hljs-title function_">commitMutationEffects</span>(root, renderPriorityLevel);
        } <span class="hljs-keyword">catch</span> (error) {
          <span class="hljs-title function_">invariant</span>(nextEffect !== <span class="hljs-literal">null</span>, <span class="hljs-string">'Should be working on an effect.'</span>);
          <span class="hljs-title function_">captureCommitPhaseError</span>(nextEffect, error);
          nextEffect = nextEffect.<span class="hljs-property">nextEffect</span>;
        }
      }
    } <span class="hljs-keyword">while</span> (nextEffect !== <span class="hljs-literal">null</span>);
    <span class="hljs-title function_">stopCommitHostEffectsTimer</span>();
    <span class="hljs-title function_">resetAfterCommit</span>(root.<span class="hljs-property">containerInfo</span>);

    <span class="hljs-comment">// The work-in-progress tree is now the current tree. This must come after</span>
    <span class="hljs-comment">// the mutation phase, so that the previous tree is still current during</span>
    <span class="hljs-comment">// componentWillUnmount, but before the layout phase, so that the finished</span>
    <span class="hljs-comment">// work is current during componentDidMount/Update.</span>
    root.<span class="hljs-property">current</span> = finishedWork;

    <span class="hljs-comment">// The next phase is the layout phase, where we call effects that read</span>
    <span class="hljs-comment">// the host tree after it's been mutated. The idiomatic use case for this is</span>
    <span class="hljs-comment">// layout, but class component lifecycles also fire here for legacy reasons.</span>
    <span class="hljs-title function_">startCommitLifeCyclesTimer</span>();
    nextEffect = firstEffect;
    <span class="hljs-keyword">do</span> {
      <span class="hljs-keyword">if</span> (__DEV__) {
        <span class="hljs-title function_">invokeGuardedCallback</span>(
          <span class="hljs-literal">null</span>,
          commitLayoutEffects,
          <span class="hljs-literal">null</span>,
          root,
          expirationTime,
        );
        <span class="hljs-keyword">if</span> (<span class="hljs-title function_">hasCaughtError</span>()) {
          <span class="hljs-title function_">invariant</span>(nextEffect !== <span class="hljs-literal">null</span>, <span class="hljs-string">'Should be working on an effect.'</span>);
          <span class="hljs-keyword">const</span> error = <span class="hljs-title function_">clearCaughtError</span>();
          <span class="hljs-title function_">captureCommitPhaseError</span>(nextEffect, error);
          nextEffect = nextEffect.<span class="hljs-property">nextEffect</span>;
        }
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">try</span> {
          <span class="hljs-title function_">commitLayoutEffects</span>(root, expirationTime);
        } <span class="hljs-keyword">catch</span> (error) {
          <span class="hljs-title function_">invariant</span>(nextEffect !== <span class="hljs-literal">null</span>, <span class="hljs-string">'Should be working on an effect.'</span>);
          <span class="hljs-title function_">captureCommitPhaseError</span>(nextEffect, error);
          nextEffect = nextEffect.<span class="hljs-property">nextEffect</span>;
        }
      }
    } <span class="hljs-keyword">while</span> (nextEffect !== <span class="hljs-literal">null</span>);
    <span class="hljs-title function_">stopCommitLifeCyclesTimer</span>();

    nextEffect = <span class="hljs-literal">null</span>;

    <span class="hljs-comment">// Tell Scheduler to yield at the end of the frame, so the browser has an</span>
    <span class="hljs-comment">// opportunity to paint.</span>
    <span class="hljs-title function_">requestPaint</span>();

    <span class="hljs-keyword">if</span> (enableSchedulerTracing) {
      <span class="hljs-title function_">popInteractions</span>(((<span class="hljs-attr">prevInteractions</span>: any): <span class="hljs-title class_">Set</span>&#x3C;<span class="hljs-title class_">Interaction</span>>));
    }
    executionContext = prevExecutionContext;
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// No effects.</span>
    root.<span class="hljs-property">current</span> = finishedWork;
    <span class="hljs-comment">// Measure these anyway so the flamegraph explicitly shows that there were</span>
    <span class="hljs-comment">// no effects.</span>
    <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> Maybe there's a better way to report this.</span>
    <span class="hljs-title function_">startCommitSnapshotEffectsTimer</span>();
    <span class="hljs-title function_">stopCommitSnapshotEffectsTimer</span>();
    <span class="hljs-keyword">if</span> (enableProfilerTimer) {
      <span class="hljs-title function_">recordCommitTime</span>();
    }
    <span class="hljs-title function_">startCommitHostEffectsTimer</span>();
    <span class="hljs-title function_">stopCommitHostEffectsTimer</span>();
    <span class="hljs-title function_">startCommitLifeCyclesTimer</span>();
    <span class="hljs-title function_">stopCommitLifeCyclesTimer</span>();
  }

  <span class="hljs-title function_">stopCommitTimer</span>();

  <span class="hljs-keyword">const</span> rootDidHavePassiveEffects = rootDoesHavePassiveEffects;

  <span class="hljs-keyword">if</span> (rootDoesHavePassiveEffects) {
    <span class="hljs-comment">// This commit has passive effects. Stash a reference to them. But don't</span>
    <span class="hljs-comment">// schedule a callback until after flushing layout work.</span>
    rootDoesHavePassiveEffects = <span class="hljs-literal">false</span>;
    rootWithPendingPassiveEffects = root;
    pendingPassiveEffectsExpirationTime = expirationTime;
    pendingPassiveEffectsRenderPriority = renderPriorityLevel;
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// We are done with the effect chain at this point so let's clear the</span>
    <span class="hljs-comment">// nextEffect pointers to assist with GC. If we have passive effects, we'll</span>
    <span class="hljs-comment">// clear this in flushPassiveEffects.</span>
    nextEffect = firstEffect;
    <span class="hljs-keyword">while</span> (nextEffect !== <span class="hljs-literal">null</span>) {
      <span class="hljs-keyword">const</span> nextNextEffect = nextEffect.<span class="hljs-property">nextEffect</span>;
      nextEffect.<span class="hljs-property">nextEffect</span> = <span class="hljs-literal">null</span>;
      nextEffect = nextNextEffect;
    }
  }

  <span class="hljs-comment">// Check if there's remaining work on this root</span>
  <span class="hljs-keyword">const</span> remainingExpirationTime = root.<span class="hljs-property">firstPendingTime</span>;
  <span class="hljs-keyword">if</span> (remainingExpirationTime !== <span class="hljs-title class_">NoWork</span>) {
    <span class="hljs-keyword">if</span> (enableSchedulerTracing) {
      <span class="hljs-keyword">if</span> (spawnedWorkDuringRender !== <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">const</span> expirationTimes = spawnedWorkDuringRender;
        spawnedWorkDuringRender = <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &#x3C; expirationTimes.<span class="hljs-property">length</span>; i++) {
          <span class="hljs-title function_">scheduleInteractions</span>(
            root,
            expirationTimes[i],
            root.<span class="hljs-property">memoizedInteractions</span>,
          );
        }
      }
      <span class="hljs-title function_">schedulePendingInteractions</span>(root, remainingExpirationTime);
    }
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// If there's no remaining work, we can clear the set of already failed</span>
    <span class="hljs-comment">// error boundaries.</span>
    legacyErrorBoundariesThatAlreadyFailed = <span class="hljs-literal">null</span>;
  }

  <span class="hljs-keyword">if</span> (enableSchedulerTracing) {
    <span class="hljs-keyword">if</span> (!rootDidHavePassiveEffects) {
      <span class="hljs-comment">// If there are no passive effects, then we can complete the pending interactions.</span>
      <span class="hljs-comment">// Otherwise, we'll wait until after the passive effects are flushed.</span>
      <span class="hljs-comment">// Wait to do this until after remaining work has been scheduled,</span>
      <span class="hljs-comment">// so that we don't prematurely signal complete for interactions when there's e.g. hidden work.</span>
      <span class="hljs-title function_">finishPendingInteractions</span>(root, expirationTime);
    }
  }

  <span class="hljs-keyword">if</span> (remainingExpirationTime === <span class="hljs-title class_">Sync</span>) {
    <span class="hljs-comment">// Count the number of times the root synchronously re-renders without</span>
    <span class="hljs-comment">// finishing. If there are too many, it indicates an infinite update loop.</span>
    <span class="hljs-keyword">if</span> (root === rootWithNestedUpdates) {
      nestedUpdateCount++;
    } <span class="hljs-keyword">else</span> {
      nestedUpdateCount = <span class="hljs-number">0</span>;
      rootWithNestedUpdates = root;
    }
  } <span class="hljs-keyword">else</span> {
    nestedUpdateCount = <span class="hljs-number">0</span>;
  }

  <span class="hljs-title function_">onCommitRoot</span>(finishedWork.<span class="hljs-property">stateNode</span>, expirationTime);

  <span class="hljs-comment">// Always call this before exiting `commitRoot`, to ensure that any</span>
  <span class="hljs-comment">// additional work on this root is scheduled.</span>
  <span class="hljs-title function_">ensureRootIsScheduled</span>(root);

  <span class="hljs-keyword">if</span> (hasUncaughtError) {
    hasUncaughtError = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">const</span> error = firstUncaughtError;
    firstUncaughtError = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">throw</span> error;
  }

  <span class="hljs-keyword">if</span> ((executionContext &#x26; <span class="hljs-title class_">LegacyUnbatchedContext</span>) !== <span class="hljs-title class_">NoContext</span>) {
    <span class="hljs-comment">// This is a legacy edge case. We just committed the initial mount of</span>
    <span class="hljs-comment">// a ReactDOM.render-ed root inside of batchedUpdates. The commit fired</span>
    <span class="hljs-comment">// synchronously, but layout updates should be deferred until the end</span>
    <span class="hljs-comment">// of the batch.</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  }

  <span class="hljs-comment">// If layout work was scheduled, flush it now.</span>
  <span class="hljs-title function_">flushSyncCallbackQueue</span>();
  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}
</code></pre></div></div></main><script src="/_next/static/chunks/webpack-b9e10351bdf2da00.js" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0]);self.__next_f.push([2,null])</script><script>self.__next_f.push([1,"1:HL[\"/_next/static/css/f8ad259a7d5c0bf2.css\",\"style\"]\n2:HL[\"/_next/static/css/2715c8fee6b9b9b3.css\",\"style\"]\n"])</script><script>self.__next_f.push([1,"3:I[5751,[],\"\"]\n6:I[9275,[],\"\"]\n9:I[1343,[],\"\"]\na:I[9512,[\"257\",\"static/chunks/257-d6408e43d3a4c1f7.js\",\"231\",\"static/chunks/231-75c2bb16e5311c25.js\",\"185\",\"static/chunks/app/layout-5aac403eda8ffac1.js\"],\"ThemeProvider\"]\nb:I[9890,[\"257\",\"static/chunks/257-d6408e43d3a4c1f7.js\",\"231\",\"static/chunks/231-75c2bb16e5311c25.js\",\"185\",\"static/chunks/app/layout-5aac403eda8ffac1.js\"],\"ColorProvider\"]\nc:I[1998,[\"257\",\"static/chunks/257-d6408e43d3a4c1f7.js\",\"231\",\"static/chunks/231-75c2bb16e5311c25.js\",\"185\",\"static/chunks/app/layout-5aac403eda8ffac1.js\"],\"default\"]\nd:I[3408,[\"257\",\"static/chunks/257-d6408e43d3a4c1f7.js\",\"231\",\"static/chunks/231-75c2bb16e5311c25.js\",\"185\",\"static/chunks/app/layout-5aac403eda8ffac1.js\"],\"ColorToggle\"]\ne:I[6345,[\"257\",\"static/chunks/257-d6408e43d3a4c1f7.js\",\"231\",\"static/chunks/231-75c2bb16e5311c25.js\",\"185\",\"static/chunks/app/layout-5aac403eda8ffac1.js\"],\"ThemeToggle\"]\nf:I[7970,[\"257\",\"static/chunks/257-d6408e43d3a4c1f7.js\",\"231\",\"static/chunks/231-75c2bb16e5311c25.js\",\"185\",\"static/chunks/app/layout-5aac403eda8ffac1.js\"],\"NavToggle\"]\n11:I[6130,[],\"\"]\n7:[\"category\",\"web--react\",\"d\"]\n8:[\"title\",\"react%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB\",\"d\"]\n12:[]\n"])</script><script>self.__next_f.push([1,"0:[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/f8ad259a7d5c0bf2.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\"}]],[\"$\",\"$L3\",null,{\"buildId\":\"GB6GWdwB48S_6jQAbWqVr\",\"assetPrefix\":\"\",\"initialCanonicalUrl\":\"/post/web--react/react%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB\",\"initialTree\":[\"\",{\"children\":[\"post\",{\"children\":[[\"category\",\"web--react\",\"d\"],{\"children\":[[\"title\",\"react%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB\",\"d\"],{\"children\":[\"__PAGE__?{\\\"category\\\":\\\"web--react\\\",\\\"title\\\":\\\"react源码阅读\\\"}\",{}]}]}]}]},\"$undefined\",\"$undefined\",true],\"initialSeedData\":[\"\",{\"children\":[\"post\",{\"children\":[[\"category\",\"web--react\",\"d\"],{\"children\":[[\"title\",\"react%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB\",\"d\"],{\"children\":[\"__PAGE__\",{},[[\"$L4\",\"$L5\"],null],null]},[\"$\",\"$L6\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"post\",\"children\",\"$7\",\"children\",\"$8\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L9\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"styles\":[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/2715c8fee6b9b9b3.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\"}]]}],null]},[\"$\",\"$L6\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"post\",\"children\",\"$7\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L9\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"styles\":null}],null]},[\"$\",\"$L6\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"post\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L9\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"styles\":null}],null]},[[\"$\",\"html\",null,{\"lang\":\"en\",\"suppressHydrationWarning\":true,\"children\":[\"$\",\"body\",null,{\"className\":\"min-h-screen bg-background font-sans antialiased __variable_aaf875\",\"children\":[\"$\",\"$La\",null,{\"attribute\":\"class\",\"defaultTheme\":\"system\",\"enableSystem\":true,\"disableTransitionOnChange\":true,\"children\":[\"$\",\"$Lb\",null,{\"children\":[[\"$\",\"header\",null,{\"className\":\"sticky top-0 z-50 w-full border-b border-primary/40 bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60\",\"children\":[\"$\",\"div\",null,{\"className\":\"container flex h-14 max-w-screen-2xl items-center justify-between\",\"children\":[[\"$\",\"div\",null,{\"className\":\"mr-4 flex\",\"children\":[[\"$\",\"a\",null,{\"className\":\"mr-6 flex items-center space-x-2\",\"href\":\"/\",\"children\":[[\"$\",\"span\",null,{\"className\":\"inline-block w-8 h-8\",\"children\":[\"$\",\"svg\",null,{\"viewBox\":\"0 0 64 64\",\"children\":[\"$\",\"g\",null,{\"fill\":\"none\",\"fillRule\":\"evenodd\",\"children\":[[\"$\",\"circle\",null,{\"cx\":32,\"cy\":32,\"r\":26,\"fill\":\"hsl(var(--primary))\"}],[\"$\",\"svg\",null,{\"xmlns\":\"http://www.w3.org/2000/svg\",\"xmlnsXlink\":\"http://www.w3.org/1999/xlink\",\"width\":26,\"height\":26,\"x\":19,\"y\":10,\"viewBox\":\"0 0 24 24\",\"children\":[\"$\",\"path\",null,{\"fill\":\"hsl(var(--background))\",\"d\":\"M5.438 2c-.512 0-1.02.203-1.407.594L2.594 4.03a1.987 1.987 0 0 0 0 2.813l2.125 2.125C3.977 10.46 3.207 12.016 3 12.375c-.469.813-1 1.617-1 2.625 0 1.473.805 2.746 2 3.438.184.105 4.188 2.906 4.188 2.906h.03C8.896 21.75 9.66 22 10.5 22h3c.832 0 1.613-.223 2.281-.625.38-.227 4.031-2.664 5.219-3.75.688-.633 1-1.621 1-2.625s-.414-1.754-1-2.625c-.277-.43-1.023-1.96-1.719-3.406l2.125-2.125a1.987 1.987 0 0 0 0-2.813L19.97 2.594a1.987 1.987 0 0 0-2.813 0l-1.5 1.5A2.2 2.2 0 0 0 15 4H9a2.8 2.8 0 0 0-.656.094l-1.5-1.5A1.98 1.98 0 0 0 5.437 2M9.5 10a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3m5 0a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3M12 13.813c.395 0 .79.054 1 .187.95.59 3 2.883 3 4 0 .559-1.328 1.781-2 2-.953.309-3.047.309-4 0-.672-.219-2-1.441-2-2 0-1.117 2.05-3.41 3-4 .21-.133.605-.187 1-.187M11 17c-.363 0-.57.43-.312.688l1.03 1.218c.16.16.403.16.563 0l1.031-1.218C13.57 17.43 13.364 17 13 17Z\"}]}],[\"$\",\"text\",null,{\"fill\":\"hsl(var(--background))\",\"data-text-alignment\":\"C\",\"fontFamily\":\"Fira Mono\",\"fontSize\":14,\"fontWeight\":700,\"letterSpacing\":0.81,\"transform\":\"translate(-4 33)\",\"children\":[\"$\",\"tspan\",null,{\"x\":17.07,\"y\":17,\"children\":\"XCYY\"}]}],[\"$\",\"circle\",null,{\"cx\":32,\"cy\":32,\"r\":30,\"stroke\":\"hsl(var(--primary))\",\"strokeWidth\":2}]]}]}]}],[\"$\",\"span\",null,{\"className\":\"text-primary\",\"children\":\"新宸悦雨\"}]]}],[\"$\",\"$Lc\",null,{}]]}],[\"$\",\"nav\",null,{\"className\":\"flex items-center space-x-2\",\"children\":[[\"$\",\"$Ld\",null,{}],[\"$\",\"$Le\",null,{}],[\"$\",\"div\",null,{\"className\":\"md:hidden\",\"children\":[\"$\",\"$Lf\",null,{}]}]]}]]}]}],[\"$\",\"main\",null,{\"className\":\"container max-w-screen-2xl py-6\",\"children\":[\"$\",\"$L6\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L9\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[[\"$\",\"title\",null,{\"children\":\"404: This page could not be found.\"}],[\"$\",\"div\",null,{\"style\":{\"fontFamily\":\"system-ui,\\\"Segoe UI\\\",Roboto,Helvetica,Arial,sans-serif,\\\"Apple Color Emoji\\\",\\\"Segoe UI Emoji\\\"\",\"height\":\"100vh\",\"textAlign\":\"center\",\"display\":\"flex\",\"flexDirection\":\"column\",\"alignItems\":\"center\",\"justifyContent\":\"center\"},\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"style\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}\"}}],[\"$\",\"h1\",null,{\"className\":\"next-error-h1\",\"style\":{\"display\":\"inline-block\",\"margin\":\"0 20px 0 0\",\"padding\":\"0 23px 0 0\",\"fontSize\":24,\"fontWeight\":500,\"verticalAlign\":\"top\",\"lineHeight\":\"49px\"},\"children\":\"404\"}],[\"$\",\"div\",null,{\"style\":{\"display\":\"inline-block\"},\"children\":[\"$\",\"h2\",null,{\"style\":{\"fontSize\":14,\"fontWeight\":400,\"lineHeight\":\"49px\",\"margin\":0},\"children\":\"This page could not be found.\"}]}]]}]}]],\"notFoundStyles\":[],\"styles\":null}]}]]}]}]}]}],null],null],\"couldBeIntercepted\":false,\"initialHead\":[false,\"$L10\"],\"globalErrorComponent\":\"$11\",\"missingSlots\":\"$W12\"}]]\n"])</script><script>self.__next_f.push([1,"13:I[789,[\"257\",\"static/chunks/257-d6408e43d3a4c1f7.js\",\"472\",\"static/chunks/app/post/%5Bcategory%5D/%5Btitle%5D/page-bb1b5c27d30bc491.js\"],\"default\"]\n14:T1568,"])</script><script>self.__next_f.push([1,"\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#react%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%AE%9A%E4%B9%89\"\u003eReact数据结构定义\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#reactfiberroot\"\u003eReactFiberRoot\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#reactfiber\"\u003eReactFiber\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#update\"\u003eUpdate\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#updatequeue\"\u003eUpdateQueue\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#react%E7%B1%BB%E5%9E%8B%E5%B8%B8%E9%87%8F%E5%AE%9A%E4%B9%89\"\u003eReact类型/常量定义\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#reactroottagsjs\"\u003eReactRootTags.js\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#reactfiberexpirationtimejs\"\u003eReactFiberExpirationTime.js\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#schedulerwithreactintegrationjs\"\u003eSchedulerWithReactIntegration.js\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#reactworktagsjs\"\u003eReactWorkTags.js\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#reactsideeffecttagsjs\"\u003eReactSideEffectTags.js\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#reacttypeofmodejs\"\u003eReactTypeOfMode.js\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#reactfiberworkloopjs\"\u003eReactFiberWorkLoop.js\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#reactsharedinternalsjs\"\u003eReactSharedInternals.js\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#reactdomrender%E8%B0%83%E7%94%A8%E8%BF%87%E7%A8%8B\"\u003eReactDOM.render调用过程\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#reactdomrender\"\u003eReactDOM.render\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#legacyrendersubtreeintocontainer\"\u003elegacyRenderSubtreeIntoContainer\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#root%E5%88%9B%E5%BB%BA%E8%BF%87%E7%A8%8B\"\u003eroot创建过程\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#legacycreaterootfromdomcontainer\"\u003elegacyCreateRootFromDOMContainer\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#new-reactsyncroot\"\u003enew ReactSyncRoot\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#createrootimpl\"\u003ecreateRootImpl\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#createcontainer\"\u003ecreateContainer\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#createfiberroot\"\u003ecreateFiberRoot\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#new-fiberrootnode\"\u003enew FiberRootNode\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#createhostrootfiber\"\u003ecreateHostRootFiber\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#createfiber\"\u003ecreateFiber\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#new-fibernode\"\u003enew FiberNode\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#markcontainerasroot\"\u003emarkContainerAsRoot\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#callback%E8%B0%83%E7%94%A8%E8%BF%87%E7%A8%8B\"\u003ecallback调用过程\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#getpublicrootinstance\"\u003egetPublicRootInstance\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#updatecontainer%E8%B0%83%E7%94%A8%E8%BF%87%E7%A8%8B\"\u003eupdateContainer调用过程\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#unbatchedupdates\"\u003eunbatchedUpdates\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#updatecontainer\"\u003eupdateContainer\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#requestcurrenttime\"\u003erequestCurrentTime\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#mstoexpirationtime\"\u003emsToExpirationTime\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#requestcurrentsuspenseconfig\"\u003erequestCurrentSuspenseConfig\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#computeexpirationforfiber\"\u003ecomputeExpirationForFiber\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#updatecontaineratexpirationtime\"\u003eupdateContainerAtExpirationTime\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#getcontextforsubtree\"\u003egetContextForSubtree\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#findcurrentunmaskedcontext\"\u003efindCurrentUnmaskedContext\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#schedulerootupdate\"\u003escheduleRootUpdate\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#createupdate\"\u003ecreateUpdate\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#enqueueupdate\"\u003eenqueueUpdate\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#createupdatequeue\"\u003ecreateUpdateQueue\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#cloneupdatequeue\"\u003ecloneUpdateQueue\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#appendupdatetoqueue\"\u003eappendUpdateToQueue\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#schedulework\"\u003escheduleWork\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#checkfornestedupdates\"\u003echeckForNestedUpdates\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#markupdatetimefromfibertoroot\"\u003emarkUpdateTimeFromFiberToRoot\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#checkforinterruption\"\u003echeckForInterruption\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#recordscheduleupdate\"\u003erecordScheduleUpdate\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#getcurrentprioritylevel\"\u003egetCurrentPriorityLevel\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#schedulependinginteractions\"\u003eschedulePendingInteractions\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#performsyncworkonroot\"\u003eperformSyncWorkOnRoot\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#preparefreshstack\"\u003eprepareFreshStack\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#createworkinprogress\"\u003ecreateWorkInProgress\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#pushdispatcher\"\u003epushDispatcher\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#workloopsync\"\u003eworkLoopSync\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#performunitofwork\"\u003eperformUnitOfWork\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#beginwork\"\u003ebeginWork\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#updatehostroot\"\u003eupdateHostRoot\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#pushhostrootcontext\"\u003epushHostRootContext\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#pushtoplevelcontextobject\"\u003epushTopLevelContextObject\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#push\"\u003epush\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#pushhostcontainer\"\u003epushHostContainer\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#processupdatequeue\"\u003eprocessUpdateQueue\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#getstatefromupdate\"\u003egetStateFromUpdate\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#reconcilechildren\"\u003ereconcileChildren\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#reconcilechildfibers\"\u003ereconcileChildFibers\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#reconcilesingleelement\"\u003ereconcileSingleElement\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#createfiberfromelement\"\u003ecreateFiberFromElement\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#\"\u003e\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#placesinglechild\"\u003eplaceSingleChild\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#completeunitofwork\"\u003ecompleteUnitOfWork\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#completework\"\u003ecompleteWork\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#pophostcontainer\"\u003epopHostContainer\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#poptoplevellegacycontextobject\"\u003epopTopLevelLegacyContextObject\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#popdispatcher\"\u003epopDispatcher\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#finishsyncrender\"\u003efinishSyncRender\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#commitroot\"\u003ecommitRoot\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e"])</script><script>self.__next_f.push([1,"15:T55a88,"])</script><script>self.__next_f.push([1,"\n\u003ch1 id=\"react数据结构定义\"\u003eReact数据结构定义\u003c/h1\u003e\n\u003ch2 id=\"reactfiberroot\"\u003eReactFiberRoot\u003c/h2\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// packages\\react-reconciler\\src\\ReactFiberRoot.js\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eFiberRootNode\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003econtainerInfo, tag, hydrate\u003c/span\u003e) {\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003etag\u003c/span\u003e = tag;\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ecurrent\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003econtainerInfo\u003c/span\u003e = containerInfo;\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ependingChildren\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003epingCache\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003efinishedExpirationTime\u003c/span\u003e = \u003cspan class=\"hljs-title class_\"\u003eNoWork\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003efinishedWork\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003etimeoutHandle\u003c/span\u003e = noTimeout;\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003econtext\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ependingContext\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ehydrate\u003c/span\u003e = hydrate;\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003efirstBatch\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ecallbackNode\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-comment\"\u003e// NoPriority 详见React类型/常量定义-SchedulerWithReactIntegration.js\u003c/span\u003e\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ecallbackPriority\u003c/span\u003e = \u003cspan class=\"hljs-title class_\"\u003eNoPriority\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-comment\"\u003e// NoWork 详见React类型/常量定义-ReactFiberExpirationTime.js\u003c/span\u003e\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003efirstPendingTime\u003c/span\u003e = \u003cspan class=\"hljs-title class_\"\u003eNoWork\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003efirstSuspendedTime\u003c/span\u003e = \u003cspan class=\"hljs-title class_\"\u003eNoWork\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003elastSuspendedTime\u003c/span\u003e = \u003cspan class=\"hljs-title class_\"\u003eNoWork\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003enextKnownPendingLevel\u003c/span\u003e = \u003cspan class=\"hljs-title class_\"\u003eNoWork\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003elastPingedTime\u003c/span\u003e = \u003cspan class=\"hljs-title class_\"\u003eNoWork\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003elastExpiredTime\u003c/span\u003e = \u003cspan class=\"hljs-title class_\"\u003eNoWork\u003c/span\u003e;\r\n\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (enableSchedulerTracing) {\r\n    \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003einteractionThreadID\u003c/span\u003e = \u003cspan class=\"hljs-title function_\"\u003eunstable_getThreadID\u003c/span\u003e();\r\n    \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ememoizedInteractions\u003c/span\u003e = \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eSet\u003c/span\u003e();\r\n    \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ependingInteractionMap\u003c/span\u003e = \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eMap\u003c/span\u003e();\r\n  }\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (enableSuspenseCallback) {\r\n    \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ehydrationCallbacks\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n  }\r\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2 id=\"reactfiber\"\u003eReactFiber\u003c/h2\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// packages\\react-reconciler\\src\\ReactFiber.js\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eFiberNode\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\r\n  tag: WorkTag,\r\n  pendingProps: mixed,\r\n  key: \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e | string,\r\n  mode: TypeOfMode,\r\n\u003c/span\u003e) {\r\n  \u003cspan class=\"hljs-comment\"\u003e// Instance\u003c/span\u003e\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003etag\u003c/span\u003e = tag;\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ekey\u003c/span\u003e = key;\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eelementType\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003etype\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003estateNode\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n\r\n  \u003cspan class=\"hljs-comment\"\u003e// Fiber\u003c/span\u003e\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ereturn\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003echild\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003esibling\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eindex\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e;\r\n\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eref\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ependingProps\u003c/span\u003e = pendingProps;\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ememoizedProps\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eupdateQueue\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ememoizedState\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003edependencies\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003emode\u003c/span\u003e = mode;\r\n\r\n  \u003cspan class=\"hljs-comment\"\u003e// Effects\u003c/span\u003e\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eeffectTag\u003c/span\u003e = \u003cspan class=\"hljs-title class_\"\u003eNoEffect\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003enextEffect\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003efirstEffect\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003elastEffect\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eexpirationTime\u003c/span\u003e = \u003cspan class=\"hljs-title class_\"\u003eNoWork\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003echildExpirationTime\u003c/span\u003e = \u003cspan class=\"hljs-title class_\"\u003eNoWork\u003c/span\u003e;\r\n\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ealternate\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (enableProfilerTimer) {\r\n    \u003cspan class=\"hljs-comment\"\u003e// Note: The following is done to avoid a v8 performance cliff.\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e//\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// Initializing the fields below to smis and later updating them with\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// double values will cause Fibers to end up having separate shapes.\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// This behavior/bug has something to do with Object.preventExtension().\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// Fortunately this only impacts DEV builds.\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// Unfortunately it makes React unusably slow for some applications.\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// To work around this, initialize the fields below with doubles.\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e//\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// Learn more about this here:\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// https://github.com/facebook/react/issues/14365\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// https://bugs.chromium.org/p/v8/issues/detail?id=8538\u003c/span\u003e\r\n    \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eactualDuration\u003c/span\u003e = \u003cspan class=\"hljs-title class_\"\u003eNumber\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eNaN\u003c/span\u003e;\r\n    \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eactualStartTime\u003c/span\u003e = \u003cspan class=\"hljs-title class_\"\u003eNumber\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eNaN\u003c/span\u003e;\r\n    \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eselfBaseDuration\u003c/span\u003e = \u003cspan class=\"hljs-title class_\"\u003eNumber\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eNaN\u003c/span\u003e;\r\n    \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003etreeBaseDuration\u003c/span\u003e = \u003cspan class=\"hljs-title class_\"\u003eNumber\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eNaN\u003c/span\u003e;\r\n\r\n    \u003cspan class=\"hljs-comment\"\u003e// It's okay to replace the initial doubles with smis after initialization.\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// This won't trigger the performance cliff mentioned above,\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// and it simplifies other profiler code (including DevTools).\u003c/span\u003e\r\n    \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eactualDuration\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e;\r\n    \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eactualStartTime\u003c/span\u003e = -\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e;\r\n    \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eselfBaseDuration\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e;\r\n    \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003etreeBaseDuration\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e;\r\n  }\r\n\r\n  \u003cspan class=\"hljs-comment\"\u003e// This is normally DEV-only except www when it adds listeners.\u003c/span\u003e\r\n  \u003cspan class=\"hljs-comment\"\u003e// \u003cspan class=\"hljs-doctag\"\u003eTODO:\u003c/span\u003e remove the User Timing integration in favor of Root Events.\u003c/span\u003e\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (enableUserTimingAPI) {\r\n    \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003e_debugID\u003c/span\u003e = debugCounter++;\r\n    \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003e_debugIsCurrentlyTiming\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e;\r\n  }\r\n\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (__DEV__) {\r\n    \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003e_debugSource\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n    \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003e_debugOwner\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n    \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003e_debugNeedsRemount\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e;\r\n    \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003e_debugHookTypes\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (!hasBadMapPolyfill \u0026#x26;\u0026#x26; \u003cspan class=\"hljs-keyword\"\u003etypeof\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eObject\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003epreventExtensions\u003c/span\u003e === \u003cspan class=\"hljs-string\"\u003e'function'\u003c/span\u003e) {\r\n      \u003cspan class=\"hljs-title class_\"\u003eObject\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003epreventExtensions\u003c/span\u003e(\u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e);\r\n    }\r\n  }\r\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2 id=\"update\"\u003eUpdate\u003c/h2\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// packages\\react-reconciler\\src\\ReactUpdateQueue.js\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003ecreateUpdate\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\r\n  expirationTime: ExpirationTime,\r\n  suspenseConfig: \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e | SuspenseConfig,\r\n\u003c/span\u003e): \u003cspan class=\"hljs-title class_\"\u003eUpdate\u003c/span\u003e\u0026#x3C;*\u003e {\r\n  \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003eupdate\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eUpdate\u003c/span\u003e\u0026#x3C;*\u003e = {\r\n    expirationTime,\r\n    suspenseConfig,\r\n\r\n    \u003cspan class=\"hljs-attr\"\u003etag\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eUpdateState\u003c/span\u003e,\r\n    \u003cspan class=\"hljs-attr\"\u003epayload\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e,\r\n    \u003cspan class=\"hljs-attr\"\u003ecallback\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e,\r\n\r\n    \u003cspan class=\"hljs-attr\"\u003enext\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e,\r\n    \u003cspan class=\"hljs-attr\"\u003enextEffect\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e,\r\n  };\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (__DEV__) {\r\n    update.\u003cspan class=\"hljs-property\"\u003epriority\u003c/span\u003e = \u003cspan class=\"hljs-title function_\"\u003egetCurrentPriorityLevel\u003c/span\u003e();\r\n  }\r\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e update;\r\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2 id=\"updatequeue\"\u003eUpdateQueue\u003c/h2\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// packages\\react-reconciler\\src\\ReactUpdateQueue.js\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e createUpdateQueue\u0026#x3C;\u003cspan class=\"hljs-title class_\"\u003eState\u003c/span\u003e\u003e(\u003cspan class=\"hljs-attr\"\u003ebaseState\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eState\u003c/span\u003e): \u003cspan class=\"hljs-title class_\"\u003eUpdateQueue\u003c/span\u003e\u0026#x3C;\u003cspan class=\"hljs-title class_\"\u003eState\u003c/span\u003e\u003e {\r\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003equeue\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eUpdateQueue\u003c/span\u003e\u0026#x3C;\u003cspan class=\"hljs-title class_\"\u003eState\u003c/span\u003e\u003e = {\r\n    baseState,\r\n    \u003cspan class=\"hljs-attr\"\u003efirstUpdate\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e,\r\n    \u003cspan class=\"hljs-attr\"\u003elastUpdate\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e,\r\n    \u003cspan class=\"hljs-attr\"\u003efirstCapturedUpdate\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e,\r\n    \u003cspan class=\"hljs-attr\"\u003elastCapturedUpdate\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e,\r\n    \u003cspan class=\"hljs-attr\"\u003efirstEffect\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e,\r\n    \u003cspan class=\"hljs-attr\"\u003elastEffect\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e,\r\n    \u003cspan class=\"hljs-attr\"\u003efirstCapturedEffect\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e,\r\n    \u003cspan class=\"hljs-attr\"\u003elastCapturedEffect\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e,\r\n  };\r\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e queue;\r\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch1 id=\"react类型常量定义\"\u003eReact类型/常量定义\u003c/h1\u003e\n\u003ch2 id=\"reactroottagsjs\"\u003eReactRootTags.js\u003c/h2\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// packages\\shared\\ReactRootTags.js\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e type \u003cspan class=\"hljs-title class_\"\u003eRootTag\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e | \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e | \u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e;\r\n\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eLegacyRoot\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e;\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eBatchedRoot\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e;\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eConcurrentRoot\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e;\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2 id=\"reactfiberexpirationtimejs\"\u003eReactFiberExpirationTime.js\u003c/h2\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// packages\\react-reconciler\\src\\ReactFiberExpirationTime.js\u003c/span\u003e\r\n\r\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e type {\u003cspan class=\"hljs-title class_\"\u003eReactPriorityLevel\u003c/span\u003e} \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'./SchedulerWithReactIntegration'\u003c/span\u003e;\r\n\r\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e \u003cspan class=\"hljs-variable constant_\"\u003eMAX_SIGNED_31_BIT_INT\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'./maxSigned31BitInt'\u003c/span\u003e;\r\n\r\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e {\r\n  \u003cspan class=\"hljs-title class_\"\u003eImmediatePriority\u003c/span\u003e,\r\n  \u003cspan class=\"hljs-title class_\"\u003eUserBlockingPriority\u003c/span\u003e,\r\n  \u003cspan class=\"hljs-title class_\"\u003eNormalPriority\u003c/span\u003e,\r\n  \u003cspan class=\"hljs-title class_\"\u003eIdlePriority\u003c/span\u003e,\r\n} \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'./SchedulerWithReactIntegration'\u003c/span\u003e;\r\n\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e type \u003cspan class=\"hljs-title class_\"\u003eExpirationTime\u003c/span\u003e = number;\r\n\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eNoWork\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e;\r\n\u003cspan class=\"hljs-comment\"\u003e// \u003cspan class=\"hljs-doctag\"\u003eTODO:\u003c/span\u003e Think of a better name for Never. The key difference with Idle is that\u003c/span\u003e\r\n\u003cspan class=\"hljs-comment\"\u003e// Never work can be committed in an inconsistent state without tearing the UI.\u003c/span\u003e\r\n\u003cspan class=\"hljs-comment\"\u003e// The main example is offscreen content, like a hidden subtree. So one possible\u003c/span\u003e\r\n\u003cspan class=\"hljs-comment\"\u003e// name is Offscreen. However, it also includes dehydrated Suspense boundaries,\u003c/span\u003e\r\n\u003cspan class=\"hljs-comment\"\u003e// which are inconsistent in the sense that they haven't finished yet, but\u003c/span\u003e\r\n\u003cspan class=\"hljs-comment\"\u003e// aren't visibly inconsistent because the server rendered HTML matches what the\u003c/span\u003e\r\n\u003cspan class=\"hljs-comment\"\u003e// hydrated tree would look like.\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eNever\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e;\r\n\u003cspan class=\"hljs-comment\"\u003e// Idle is slightly higher priority than Never. It must completely finish in\u003c/span\u003e\r\n\u003cspan class=\"hljs-comment\"\u003e// order to be consistent.\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eIdle\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e;\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eSync\u003c/span\u003e = \u003cspan class=\"hljs-variable constant_\"\u003eMAX_SIGNED_31_BIT_INT\u003c/span\u003e;\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eBatched\u003c/span\u003e = \u003cspan class=\"hljs-title class_\"\u003eSync\u003c/span\u003e - \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e;\r\n\r\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-variable constant_\"\u003eUNIT_SIZE\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e10\u003c/span\u003e;\r\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-variable constant_\"\u003eMAGIC_NUMBER_OFFSET\u003c/span\u003e = \u003cspan class=\"hljs-title class_\"\u003eBatched\u003c/span\u003e - \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e;\r\n\r\n\u003cspan class=\"hljs-comment\"\u003e// 1 unit of expiration time represents 10ms.\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003emsToExpirationTime\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003ems: number\u003c/span\u003e): \u003cspan class=\"hljs-title class_\"\u003eExpirationTime\u003c/span\u003e {\r\n  \u003cspan class=\"hljs-comment\"\u003e// Always add an offset so that we don't clash with the magic number for NoWork.\u003c/span\u003e\r\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-variable constant_\"\u003eMAGIC_NUMBER_OFFSET\u003c/span\u003e - ((ms / \u003cspan class=\"hljs-variable constant_\"\u003eUNIT_SIZE\u003c/span\u003e) | \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e);\r\n}\r\n\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eexpirationTimeToMs\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003eexpirationTime: ExpirationTime\u003c/span\u003e): number {\r\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e (\u003cspan class=\"hljs-variable constant_\"\u003eMAGIC_NUMBER_OFFSET\u003c/span\u003e - expirationTime) * \u003cspan class=\"hljs-variable constant_\"\u003eUNIT_SIZE\u003c/span\u003e;\r\n}\r\n\r\n\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eceiling\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003enum: number, precision: number\u003c/span\u003e): number {\r\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e (((num / precision) | \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e) + \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e) * precision;\r\n}\r\n\r\n\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003ecomputeExpirationBucket\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\r\n  currentTime,\r\n  expirationInMs,\r\n  bucketSizeMs,\r\n\u003c/span\u003e): \u003cspan class=\"hljs-title class_\"\u003eExpirationTime\u003c/span\u003e {\r\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e (\r\n    \u003cspan class=\"hljs-variable constant_\"\u003eMAGIC_NUMBER_OFFSET\u003c/span\u003e -\r\n    \u003cspan class=\"hljs-title function_\"\u003eceiling\u003c/span\u003e(\r\n      \u003cspan class=\"hljs-variable constant_\"\u003eMAGIC_NUMBER_OFFSET\u003c/span\u003e - currentTime + expirationInMs / \u003cspan class=\"hljs-variable constant_\"\u003eUNIT_SIZE\u003c/span\u003e,\r\n      bucketSizeMs / \u003cspan class=\"hljs-variable constant_\"\u003eUNIT_SIZE\u003c/span\u003e,\r\n    )\r\n  );\r\n}\r\n\r\n\u003cspan class=\"hljs-comment\"\u003e// \u003cspan class=\"hljs-doctag\"\u003eTODO:\u003c/span\u003e This corresponds to Scheduler's NormalPriority, not LowPriority. Update\u003c/span\u003e\r\n\u003cspan class=\"hljs-comment\"\u003e// the names to reflect.\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-variable constant_\"\u003eLOW_PRIORITY_EXPIRATION\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e5000\u003c/span\u003e;\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-variable constant_\"\u003eLOW_PRIORITY_BATCH_SIZE\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e250\u003c/span\u003e;\r\n\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003ecomputeAsyncExpiration\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\r\n  currentTime: ExpirationTime,\r\n\u003c/span\u003e): \u003cspan class=\"hljs-title class_\"\u003eExpirationTime\u003c/span\u003e {\r\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003ecomputeExpirationBucket\u003c/span\u003e(\r\n    currentTime,\r\n    \u003cspan class=\"hljs-variable constant_\"\u003eLOW_PRIORITY_EXPIRATION\u003c/span\u003e,\r\n    \u003cspan class=\"hljs-variable constant_\"\u003eLOW_PRIORITY_BATCH_SIZE\u003c/span\u003e,\r\n  );\r\n}\r\n\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003ecomputeSuspenseExpiration\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\r\n  currentTime: ExpirationTime,\r\n  timeoutMs: number,\r\n\u003c/span\u003e): \u003cspan class=\"hljs-title class_\"\u003eExpirationTime\u003c/span\u003e {\r\n  \u003cspan class=\"hljs-comment\"\u003e// \u003cspan class=\"hljs-doctag\"\u003eTODO:\u003c/span\u003e Should we warn if timeoutMs is lower than the normal pri expiration time?\u003c/span\u003e\r\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003ecomputeExpirationBucket\u003c/span\u003e(\r\n    currentTime,\r\n    timeoutMs,\r\n    \u003cspan class=\"hljs-variable constant_\"\u003eLOW_PRIORITY_BATCH_SIZE\u003c/span\u003e,\r\n  );\r\n}\r\n\r\n\u003cspan class=\"hljs-comment\"\u003e// We intentionally set a higher expiration time for interactive updates in\u003c/span\u003e\r\n\u003cspan class=\"hljs-comment\"\u003e// dev than in production.\u003c/span\u003e\r\n\u003cspan class=\"hljs-comment\"\u003e//\u003c/span\u003e\r\n\u003cspan class=\"hljs-comment\"\u003e// If the main thread is being blocked so long that you hit the expiration,\u003c/span\u003e\r\n\u003cspan class=\"hljs-comment\"\u003e// it's a problem that could be solved with better scheduling.\u003c/span\u003e\r\n\u003cspan class=\"hljs-comment\"\u003e//\u003c/span\u003e\r\n\u003cspan class=\"hljs-comment\"\u003e// People will be more likely to notice this and fix it with the long\u003c/span\u003e\r\n\u003cspan class=\"hljs-comment\"\u003e// expiration time in development.\u003c/span\u003e\r\n\u003cspan class=\"hljs-comment\"\u003e//\u003c/span\u003e\r\n\u003cspan class=\"hljs-comment\"\u003e// In production we opt for better UX at the risk of masking scheduling\u003c/span\u003e\r\n\u003cspan class=\"hljs-comment\"\u003e// problems, by expiring fast.\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-variable constant_\"\u003eHIGH_PRIORITY_EXPIRATION\u003c/span\u003e = __DEV__ ? \u003cspan class=\"hljs-number\"\u003e500\u003c/span\u003e : \u003cspan class=\"hljs-number\"\u003e150\u003c/span\u003e;\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-variable constant_\"\u003eHIGH_PRIORITY_BATCH_SIZE\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e100\u003c/span\u003e;\r\n\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003ecomputeInteractiveExpiration\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003ecurrentTime: ExpirationTime\u003c/span\u003e) {\r\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003ecomputeExpirationBucket\u003c/span\u003e(\r\n    currentTime,\r\n    \u003cspan class=\"hljs-variable constant_\"\u003eHIGH_PRIORITY_EXPIRATION\u003c/span\u003e,\r\n    \u003cspan class=\"hljs-variable constant_\"\u003eHIGH_PRIORITY_BATCH_SIZE\u003c/span\u003e,\r\n  );\r\n}\r\n\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003einferPriorityFromExpirationTime\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\r\n  currentTime: ExpirationTime,\r\n  expirationTime: ExpirationTime,\r\n\u003c/span\u003e): \u003cspan class=\"hljs-title class_\"\u003eReactPriorityLevel\u003c/span\u003e {\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (expirationTime === \u003cspan class=\"hljs-title class_\"\u003eSync\u003c/span\u003e) {\r\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eImmediatePriority\u003c/span\u003e;\r\n  }\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (expirationTime === \u003cspan class=\"hljs-title class_\"\u003eNever\u003c/span\u003e || expirationTime === \u003cspan class=\"hljs-title class_\"\u003eIdle\u003c/span\u003e) {\r\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eIdlePriority\u003c/span\u003e;\r\n  }\r\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e msUntil =\r\n    \u003cspan class=\"hljs-title function_\"\u003eexpirationTimeToMs\u003c/span\u003e(expirationTime) - \u003cspan class=\"hljs-title function_\"\u003eexpirationTimeToMs\u003c/span\u003e(currentTime);\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (msUntil \u0026#x3C;= \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e) {\r\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eImmediatePriority\u003c/span\u003e;\r\n  }\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (msUntil \u0026#x3C;= \u003cspan class=\"hljs-variable constant_\"\u003eHIGH_PRIORITY_EXPIRATION\u003c/span\u003e + \u003cspan class=\"hljs-variable constant_\"\u003eHIGH_PRIORITY_BATCH_SIZE\u003c/span\u003e) {\r\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eUserBlockingPriority\u003c/span\u003e;\r\n  }\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (msUntil \u0026#x3C;= \u003cspan class=\"hljs-variable constant_\"\u003eLOW_PRIORITY_EXPIRATION\u003c/span\u003e + \u003cspan class=\"hljs-variable constant_\"\u003eLOW_PRIORITY_BATCH_SIZE\u003c/span\u003e) {\r\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eNormalPriority\u003c/span\u003e;\r\n  }\r\n\r\n  \u003cspan class=\"hljs-comment\"\u003e// \u003cspan class=\"hljs-doctag\"\u003eTODO:\u003c/span\u003e Handle LowPriority\u003c/span\u003e\r\n\r\n  \u003cspan class=\"hljs-comment\"\u003e// Assume anything lower has idle priority\u003c/span\u003e\r\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eIdlePriority\u003c/span\u003e;\r\n}\r\n\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2 id=\"schedulerwithreactintegrationjs\"\u003eSchedulerWithReactIntegration.js\u003c/h2\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// packages\\react-reconciler\\src\\SchedulerWithReactIntegration.js\u003c/span\u003e\r\n\u003cspan class=\"hljs-comment\"\u003e/**\r\n * Copyright (c) Facebook, Inc. and its affiliates.\r\n *\r\n * This source code is licensed under the MIT license found in the\r\n * LICENSE file in the root directory of this source tree.\r\n *\r\n * \u003cspan class=\"hljs-doctag\"\u003e@flow\u003c/span\u003e\r\n */\u003c/span\u003e\r\n\r\n\u003cspan class=\"hljs-comment\"\u003e// Intentionally not named imports because Rollup would use dynamic dispatch for\u003c/span\u003e\r\n\u003cspan class=\"hljs-comment\"\u003e// CommonJS interop named imports.\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e * \u003cspan class=\"hljs-keyword\"\u003eas\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eScheduler\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'scheduler'\u003c/span\u003e;\r\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e {__interactionsRef} \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'scheduler/tracing'\u003c/span\u003e;\r\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e {enableSchedulerTracing} \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'shared/ReactFeatureFlags'\u003c/span\u003e;\r\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e invariant \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'shared/invariant'\u003c/span\u003e;\r\n\r\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e {\r\n  \u003cspan class=\"hljs-attr\"\u003eunstable_runWithPriority\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eScheduler\u003c/span\u003e_runWithPriority,\r\n  \u003cspan class=\"hljs-attr\"\u003eunstable_scheduleCallback\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eScheduler\u003c/span\u003e_scheduleCallback,\r\n  \u003cspan class=\"hljs-attr\"\u003eunstable_cancelCallback\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eScheduler\u003c/span\u003e_cancelCallback,\r\n  \u003cspan class=\"hljs-attr\"\u003eunstable_shouldYield\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eScheduler\u003c/span\u003e_shouldYield,\r\n  \u003cspan class=\"hljs-attr\"\u003eunstable_requestPaint\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eScheduler\u003c/span\u003e_requestPaint,\r\n  \u003cspan class=\"hljs-attr\"\u003eunstable_now\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eScheduler\u003c/span\u003e_now,\r\n  \u003cspan class=\"hljs-attr\"\u003eunstable_getCurrentPriorityLevel\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eScheduler\u003c/span\u003e_getCurrentPriorityLevel,\r\n  \u003cspan class=\"hljs-attr\"\u003eunstable_ImmediatePriority\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eScheduler\u003c/span\u003e_ImmediatePriority,\r\n  \u003cspan class=\"hljs-attr\"\u003eunstable_UserBlockingPriority\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eScheduler\u003c/span\u003e_UserBlockingPriority,\r\n  \u003cspan class=\"hljs-attr\"\u003eunstable_NormalPriority\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eScheduler\u003c/span\u003e_NormalPriority,\r\n  \u003cspan class=\"hljs-attr\"\u003eunstable_LowPriority\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eScheduler\u003c/span\u003e_LowPriority,\r\n  \u003cspan class=\"hljs-attr\"\u003eunstable_IdlePriority\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eScheduler\u003c/span\u003e_IdlePriority,\r\n} = \u003cspan class=\"hljs-title class_\"\u003eScheduler\u003c/span\u003e;\r\n\r\n\u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (enableSchedulerTracing) {\r\n  \u003cspan class=\"hljs-comment\"\u003e// Provide explicit error message when production+profiling bundle of e.g.\u003c/span\u003e\r\n  \u003cspan class=\"hljs-comment\"\u003e// react-dom is used with production (non-profiling) bundle of\u003c/span\u003e\r\n  \u003cspan class=\"hljs-comment\"\u003e// scheduler/tracing\u003c/span\u003e\r\n  \u003cspan class=\"hljs-title function_\"\u003einvariant\u003c/span\u003e(\r\n    __interactionsRef != \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e \u0026#x26;\u0026#x26; __interactionsRef.\u003cspan class=\"hljs-property\"\u003ecurrent\u003c/span\u003e != \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e,\r\n    \u003cspan class=\"hljs-string\"\u003e'It is not supported to run the profiling version of a renderer (for '\u003c/span\u003e +\r\n      \u003cspan class=\"hljs-string\"\u003e'example, `react-dom/profiling`) without also replacing the '\u003c/span\u003e +\r\n      \u003cspan class=\"hljs-string\"\u003e'`scheduler/tracing` module with `scheduler/tracing-profiling`. Your '\u003c/span\u003e +\r\n      \u003cspan class=\"hljs-string\"\u003e'bundler might have a setting for aliasing both modules. Learn more at '\u003c/span\u003e +\r\n      \u003cspan class=\"hljs-string\"\u003e'http://fb.me/react-profiling'\u003c/span\u003e,\r\n  );\r\n}\r\n\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e type \u003cspan class=\"hljs-title class_\"\u003eReactPriorityLevel\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e99\u003c/span\u003e | \u003cspan class=\"hljs-number\"\u003e98\u003c/span\u003e | \u003cspan class=\"hljs-number\"\u003e97\u003c/span\u003e | \u003cspan class=\"hljs-number\"\u003e96\u003c/span\u003e | \u003cspan class=\"hljs-number\"\u003e95\u003c/span\u003e | \u003cspan class=\"hljs-number\"\u003e90\u003c/span\u003e;\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e type \u003cspan class=\"hljs-title class_\"\u003eSchedulerCallback\u003c/span\u003e = \u003cspan class=\"hljs-function\"\u003e(\u003cspan class=\"hljs-params\"\u003eisSync: boolean\u003c/span\u003e) =\u003e\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eSchedulerCallback\u003c/span\u003e | \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n\r\ntype \u003cspan class=\"hljs-title class_\"\u003eSchedulerCallbackOptions\u003c/span\u003e = {\r\n  timeout?: number,\r\n};\r\n\r\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e fakeCallbackNode = {};\r\n\r\n\u003cspan class=\"hljs-comment\"\u003e// Except for NoPriority, these correspond to Scheduler priorities. We use\u003c/span\u003e\r\n\u003cspan class=\"hljs-comment\"\u003e// ascending numbers so we can compare them like numbers. They start at 90 to\u003c/span\u003e\r\n\u003cspan class=\"hljs-comment\"\u003e// avoid clashing with Scheduler's priorities.\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eImmediatePriority\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eReactPriorityLevel\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e99\u003c/span\u003e;\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eUserBlockingPriority\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eReactPriorityLevel\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e98\u003c/span\u003e;\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eNormalPriority\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eReactPriorityLevel\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e97\u003c/span\u003e;\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eLowPriority\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eReactPriorityLevel\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e96\u003c/span\u003e;\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eIdlePriority\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eReactPriorityLevel\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e95\u003c/span\u003e;\r\n\u003cspan class=\"hljs-comment\"\u003e// NoPriority is the absence of priority. Also React-only.\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eNoPriority\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eReactPriorityLevel\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e90\u003c/span\u003e;\r\n\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e shouldYield = \u003cspan class=\"hljs-title class_\"\u003eScheduler\u003c/span\u003e_shouldYield;\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e requestPaint =\r\n  \u003cspan class=\"hljs-comment\"\u003e// Fall back gracefully if we're running an older version of Scheduler.\u003c/span\u003e\r\n  \u003cspan class=\"hljs-title class_\"\u003eScheduler\u003c/span\u003e_requestPaint !== \u003cspan class=\"hljs-literal\"\u003eundefined\u003c/span\u003e ? \u003cspan class=\"hljs-title class_\"\u003eScheduler\u003c/span\u003e_requestPaint : \u003cspan class=\"hljs-function\"\u003e() =\u003e\u003c/span\u003e {};\r\n\r\n\u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003esyncQueue\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eArray\u003c/span\u003e\u0026#x3C;\u003cspan class=\"hljs-title class_\"\u003eSchedulerCallback\u003c/span\u003e\u003e | \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n\u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003eimmediateQueueCallbackNode\u003c/span\u003e: mixed | \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n\u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003eisFlushingSyncQueue\u003c/span\u003e: boolean = \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e;\r\n\u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003einitialTimeMs\u003c/span\u003e: number = \u003cspan class=\"hljs-title class_\"\u003eScheduler\u003c/span\u003e_now();\r\n\r\n\u003cspan class=\"hljs-comment\"\u003e// If the initial timestamp is reasonably small, use Scheduler's `now` directly.\u003c/span\u003e\r\n\u003cspan class=\"hljs-comment\"\u003e// This will be the case for modern browsers that support `performance.now`. In\u003c/span\u003e\r\n\u003cspan class=\"hljs-comment\"\u003e// older browsers, Scheduler falls back to `Date.now`, which returns a Unix\u003c/span\u003e\r\n\u003cspan class=\"hljs-comment\"\u003e// timestamp. In that case, subtract the module initialization time to simulate\u003c/span\u003e\r\n\u003cspan class=\"hljs-comment\"\u003e// the behavior of performance.now and keep our times small enough to fit\u003c/span\u003e\r\n\u003cspan class=\"hljs-comment\"\u003e// within 32 bits.\u003c/span\u003e\r\n\u003cspan class=\"hljs-comment\"\u003e// \u003cspan class=\"hljs-doctag\"\u003eTODO:\u003c/span\u003e Consider lifting this into Scheduler.\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e now =\r\n  initialTimeMs \u0026#x3C; \u003cspan class=\"hljs-number\"\u003e10000\u003c/span\u003e ? \u003cspan class=\"hljs-title class_\"\u003eScheduler\u003c/span\u003e_now : \u003cspan class=\"hljs-function\"\u003e() =\u003e\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eScheduler\u003c/span\u003e_now() - initialTimeMs;\r\n\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003egetCurrentPriorityLevel\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\u003c/span\u003e): \u003cspan class=\"hljs-title class_\"\u003eReactPriorityLevel\u003c/span\u003e {\r\n  \u003cspan class=\"hljs-keyword\"\u003eswitch\u003c/span\u003e (\u003cspan class=\"hljs-title class_\"\u003eScheduler\u003c/span\u003e_getCurrentPriorityLevel()) {\r\n    \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eScheduler\u003c/span\u003e\u003cspan class=\"hljs-attr\"\u003e_ImmediatePriority\u003c/span\u003e:\r\n      \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eImmediatePriority\u003c/span\u003e;\r\n    \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eScheduler\u003c/span\u003e\u003cspan class=\"hljs-attr\"\u003e_UserBlockingPriority\u003c/span\u003e:\r\n      \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eUserBlockingPriority\u003c/span\u003e;\r\n    \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eScheduler\u003c/span\u003e\u003cspan class=\"hljs-attr\"\u003e_NormalPriority\u003c/span\u003e:\r\n      \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eNormalPriority\u003c/span\u003e;\r\n    \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eScheduler\u003c/span\u003e\u003cspan class=\"hljs-attr\"\u003e_LowPriority\u003c/span\u003e:\r\n      \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eLowPriority\u003c/span\u003e;\r\n    \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eScheduler\u003c/span\u003e\u003cspan class=\"hljs-attr\"\u003e_IdlePriority\u003c/span\u003e:\r\n      \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eIdlePriority\u003c/span\u003e;\r\n    \u003cspan class=\"hljs-attr\"\u003edefault\u003c/span\u003e:\r\n      \u003cspan class=\"hljs-title function_\"\u003einvariant\u003c/span\u003e(\u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'Unknown priority level.'\u003c/span\u003e);\r\n  }\r\n}\r\n\r\n\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003ereactPriorityToSchedulerPriority\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003ereactPriorityLevel\u003c/span\u003e) {\r\n  \u003cspan class=\"hljs-keyword\"\u003eswitch\u003c/span\u003e (reactPriorityLevel) {\r\n    \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eImmediatePriority\u003c/span\u003e:\r\n      \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eScheduler\u003c/span\u003e_ImmediatePriority;\r\n    \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eUserBlockingPriority\u003c/span\u003e:\r\n      \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eScheduler\u003c/span\u003e_UserBlockingPriority;\r\n    \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eNormalPriority\u003c/span\u003e:\r\n      \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eScheduler\u003c/span\u003e_NormalPriority;\r\n    \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eLowPriority\u003c/span\u003e:\r\n      \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eScheduler\u003c/span\u003e_LowPriority;\r\n    \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eIdlePriority\u003c/span\u003e:\r\n      \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eScheduler\u003c/span\u003e_IdlePriority;\r\n    \u003cspan class=\"hljs-attr\"\u003edefault\u003c/span\u003e:\r\n      \u003cspan class=\"hljs-title function_\"\u003einvariant\u003c/span\u003e(\u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'Unknown priority level.'\u003c/span\u003e);\r\n  }\r\n}\r\n\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e runWithPriority\u0026#x3C;T\u003e(\r\n  \u003cspan class=\"hljs-attr\"\u003ereactPriorityLevel\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eReactPriorityLevel\u003c/span\u003e,\r\n  \u003cspan class=\"hljs-attr\"\u003efn\u003c/span\u003e: \u003cspan class=\"hljs-function\"\u003e() =\u003e\u003c/span\u003e T,\r\n): T {\r\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e priorityLevel = \u003cspan class=\"hljs-title function_\"\u003ereactPriorityToSchedulerPriority\u003c/span\u003e(reactPriorityLevel);\r\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eScheduler\u003c/span\u003e_runWithPriority(priorityLevel, fn);\r\n}\r\n\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003escheduleCallback\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\r\n  reactPriorityLevel: ReactPriorityLevel,\r\n  callback: SchedulerCallback,\r\n  options: SchedulerCallbackOptions | \u003cspan class=\"hljs-keyword\"\u003evoid\u003c/span\u003e | \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e,\r\n\u003c/span\u003e) {\r\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e priorityLevel = \u003cspan class=\"hljs-title function_\"\u003ereactPriorityToSchedulerPriority\u003c/span\u003e(reactPriorityLevel);\r\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eScheduler\u003c/span\u003e_scheduleCallback(priorityLevel, callback, options);\r\n}\r\n\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003escheduleSyncCallback\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003ecallback: SchedulerCallback\u003c/span\u003e) {\r\n  \u003cspan class=\"hljs-comment\"\u003e// Push this callback into an internal queue. We'll flush these either in\u003c/span\u003e\r\n  \u003cspan class=\"hljs-comment\"\u003e// the next tick, or earlier if something calls `flushSyncCallbackQueue`.\u003c/span\u003e\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (syncQueue === \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n    syncQueue = [callback];\r\n    \u003cspan class=\"hljs-comment\"\u003e// Flush the queue in the next tick, at the earliest.\u003c/span\u003e\r\n    immediateQueueCallbackNode = \u003cspan class=\"hljs-title class_\"\u003eScheduler\u003c/span\u003e_scheduleCallback(\r\n      \u003cspan class=\"hljs-title class_\"\u003eScheduler\u003c/span\u003e_ImmediatePriority,\r\n      flushSyncCallbackQueueImpl,\r\n    );\r\n  } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\r\n    \u003cspan class=\"hljs-comment\"\u003e// Push onto existing queue. Don't need to schedule a callback because\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// we already scheduled one when we created the queue.\u003c/span\u003e\r\n    syncQueue.\u003cspan class=\"hljs-title function_\"\u003epush\u003c/span\u003e(callback);\r\n  }\r\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e fakeCallbackNode;\r\n}\r\n\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003ecancelCallback\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003ecallbackNode: mixed\u003c/span\u003e) {\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (callbackNode !== fakeCallbackNode) {\r\n    \u003cspan class=\"hljs-title class_\"\u003eScheduler\u003c/span\u003e_cancelCallback(callbackNode);\r\n  }\r\n}\r\n\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eflushSyncCallbackQueue\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\u003c/span\u003e) {\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (immediateQueueCallbackNode !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e node = immediateQueueCallbackNode;\r\n    immediateQueueCallbackNode = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n    \u003cspan class=\"hljs-title class_\"\u003eScheduler\u003c/span\u003e_cancelCallback(node);\r\n  }\r\n  \u003cspan class=\"hljs-title function_\"\u003eflushSyncCallbackQueueImpl\u003c/span\u003e();\r\n}\r\n\r\n\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eflushSyncCallbackQueueImpl\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\u003c/span\u003e) {\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (!isFlushingSyncQueue \u0026#x26;\u0026#x26; syncQueue !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n    \u003cspan class=\"hljs-comment\"\u003e// Prevent re-entrancy.\u003c/span\u003e\r\n    isFlushingSyncQueue = \u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e;\r\n    \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e i = \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e;\r\n    \u003cspan class=\"hljs-keyword\"\u003etry\u003c/span\u003e {\r\n      \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e isSync = \u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e;\r\n      \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e queue = syncQueue;\r\n      \u003cspan class=\"hljs-title function_\"\u003erunWithPriority\u003c/span\u003e(\u003cspan class=\"hljs-title class_\"\u003eImmediatePriority\u003c/span\u003e, \u003cspan class=\"hljs-function\"\u003e() =\u003e\u003c/span\u003e {\r\n        \u003cspan class=\"hljs-keyword\"\u003efor\u003c/span\u003e (; i \u0026#x3C; queue.\u003cspan class=\"hljs-property\"\u003elength\u003c/span\u003e; i++) {\r\n          \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e callback = queue[i];\r\n          \u003cspan class=\"hljs-keyword\"\u003edo\u003c/span\u003e {\r\n            callback = \u003cspan class=\"hljs-title function_\"\u003ecallback\u003c/span\u003e(isSync);\r\n          } \u003cspan class=\"hljs-keyword\"\u003ewhile\u003c/span\u003e (callback !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e);\r\n        }\r\n      });\r\n      syncQueue = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n    } \u003cspan class=\"hljs-keyword\"\u003ecatch\u003c/span\u003e (error) {\r\n      \u003cspan class=\"hljs-comment\"\u003e// If something throws, leave the remaining callbacks on the queue.\u003c/span\u003e\r\n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (syncQueue !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n        syncQueue = syncQueue.\u003cspan class=\"hljs-title function_\"\u003eslice\u003c/span\u003e(i + \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e);\r\n      }\r\n      \u003cspan class=\"hljs-comment\"\u003e// Resume flushing in the next tick\u003c/span\u003e\r\n      \u003cspan class=\"hljs-title class_\"\u003eScheduler\u003c/span\u003e_scheduleCallback(\r\n        \u003cspan class=\"hljs-title class_\"\u003eScheduler\u003c/span\u003e_ImmediatePriority,\r\n        flushSyncCallbackQueue,\r\n      );\r\n      \u003cspan class=\"hljs-keyword\"\u003ethrow\u003c/span\u003e error;\r\n    } \u003cspan class=\"hljs-keyword\"\u003efinally\u003c/span\u003e {\r\n      isFlushingSyncQueue = \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e;\r\n    }\r\n  }\r\n}\r\n\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2 id=\"reactworktagsjs\"\u003eReactWorkTags.js\u003c/h2\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// packages\\shared\\ReactWorkTags.js\u003c/span\u003e\r\n\u003cspan class=\"hljs-comment\"\u003e/**\r\n * Copyright (c) Facebook, Inc. and its affiliates.\r\n *\r\n * This source code is licensed under the MIT license found in the\r\n * LICENSE file in the root directory of this source tree.\r\n *\r\n * \u003cspan class=\"hljs-doctag\"\u003e@flow\u003c/span\u003e\r\n */\u003c/span\u003e\r\n\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e type \u003cspan class=\"hljs-title class_\"\u003eWorkTag\u003c/span\u003e =\r\n  | \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e\r\n  | \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e\r\n  | \u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e\r\n  | \u003cspan class=\"hljs-number\"\u003e3\u003c/span\u003e\r\n  | \u003cspan class=\"hljs-number\"\u003e4\u003c/span\u003e\r\n  | \u003cspan class=\"hljs-number\"\u003e5\u003c/span\u003e\r\n  | \u003cspan class=\"hljs-number\"\u003e6\u003c/span\u003e\r\n  | \u003cspan class=\"hljs-number\"\u003e7\u003c/span\u003e\r\n  | \u003cspan class=\"hljs-number\"\u003e8\u003c/span\u003e\r\n  | \u003cspan class=\"hljs-number\"\u003e9\u003c/span\u003e\r\n  | \u003cspan class=\"hljs-number\"\u003e10\u003c/span\u003e\r\n  | \u003cspan class=\"hljs-number\"\u003e11\u003c/span\u003e\r\n  | \u003cspan class=\"hljs-number\"\u003e12\u003c/span\u003e\r\n  | \u003cspan class=\"hljs-number\"\u003e13\u003c/span\u003e\r\n  | \u003cspan class=\"hljs-number\"\u003e14\u003c/span\u003e\r\n  | \u003cspan class=\"hljs-number\"\u003e15\u003c/span\u003e\r\n  | \u003cspan class=\"hljs-number\"\u003e16\u003c/span\u003e\r\n  | \u003cspan class=\"hljs-number\"\u003e17\u003c/span\u003e\r\n  | \u003cspan class=\"hljs-number\"\u003e18\u003c/span\u003e\r\n  | \u003cspan class=\"hljs-number\"\u003e19\u003c/span\u003e\r\n  | \u003cspan class=\"hljs-number\"\u003e20\u003c/span\u003e\r\n  | \u003cspan class=\"hljs-number\"\u003e21\u003c/span\u003e;\r\n\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eFunctionComponent\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e;\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eClassComponent\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e;\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eIndeterminateComponent\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e; \u003cspan class=\"hljs-comment\"\u003e// Before we know whether it is function or class\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eHostRoot\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e3\u003c/span\u003e; \u003cspan class=\"hljs-comment\"\u003e// Root of a host tree. Could be nested inside another node.\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eHostPortal\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e4\u003c/span\u003e; \u003cspan class=\"hljs-comment\"\u003e// A subtree. Could be an entry point to a different renderer.\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eHostComponent\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e5\u003c/span\u003e;\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eHostText\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e6\u003c/span\u003e;\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eFragment\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e7\u003c/span\u003e;\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eMode\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e8\u003c/span\u003e;\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eContextConsumer\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e9\u003c/span\u003e;\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eContextProvider\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e10\u003c/span\u003e;\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eForwardRef\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e11\u003c/span\u003e;\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eProfiler\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e12\u003c/span\u003e;\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eSuspenseComponent\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e13\u003c/span\u003e;\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eMemoComponent\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e14\u003c/span\u003e;\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eSimpleMemoComponent\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e15\u003c/span\u003e;\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eLazyComponent\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e16\u003c/span\u003e;\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eIncompleteClassComponent\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e17\u003c/span\u003e;\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eDehydratedFragment\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e18\u003c/span\u003e;\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eSuspenseListComponent\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e19\u003c/span\u003e;\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eFundamentalComponent\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e20\u003c/span\u003e;\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eScopeComponent\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e21\u003c/span\u003e;\r\n\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2 id=\"reactsideeffecttagsjs\"\u003eReactSideEffectTags.js\u003c/h2\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// packages\\shared\\ReactSideEffectTags.js\u003c/span\u003e\r\n\u003cspan class=\"hljs-comment\"\u003e/**\r\n * Copyright (c) Facebook, Inc. and its affiliates.\r\n *\r\n * This source code is licensed under the MIT license found in the\r\n * LICENSE file in the root directory of this source tree.\r\n *\r\n * \u003cspan class=\"hljs-doctag\"\u003e@flow\u003c/span\u003e\r\n */\u003c/span\u003e\r\n\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e type \u003cspan class=\"hljs-title class_\"\u003eSideEffectTag\u003c/span\u003e = number;\r\n\r\n\u003cspan class=\"hljs-comment\"\u003e// Don't change these two values. They're used by React Dev Tools.\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eNoEffect\u003c/span\u003e = \u003cspan class=\"hljs-comment\"\u003e/*              */\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e0b0000000000000\u003c/span\u003e;\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003ePerformedWork\u003c/span\u003e = \u003cspan class=\"hljs-comment\"\u003e/*         */\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e0b0000000000001\u003c/span\u003e;\r\n\r\n\u003cspan class=\"hljs-comment\"\u003e// You can change the rest (and add more).\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003ePlacement\u003c/span\u003e = \u003cspan class=\"hljs-comment\"\u003e/*             */\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e0b0000000000010\u003c/span\u003e;\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eUpdate\u003c/span\u003e = \u003cspan class=\"hljs-comment\"\u003e/*                */\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e0b0000000000100\u003c/span\u003e;\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003ePlacementAndUpdate\u003c/span\u003e = \u003cspan class=\"hljs-comment\"\u003e/*    */\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e0b0000000000110\u003c/span\u003e;\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eDeletion\u003c/span\u003e = \u003cspan class=\"hljs-comment\"\u003e/*              */\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e0b0000000001000\u003c/span\u003e;\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eContentReset\u003c/span\u003e = \u003cspan class=\"hljs-comment\"\u003e/*          */\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e0b0000000010000\u003c/span\u003e;\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eCallback\u003c/span\u003e = \u003cspan class=\"hljs-comment\"\u003e/*              */\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e0b0000000100000\u003c/span\u003e;\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eDidCapture\u003c/span\u003e = \u003cspan class=\"hljs-comment\"\u003e/*            */\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e0b0000001000000\u003c/span\u003e;\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eRef\u003c/span\u003e = \u003cspan class=\"hljs-comment\"\u003e/*                   */\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e0b0000010000000\u003c/span\u003e;\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eSnapshot\u003c/span\u003e = \u003cspan class=\"hljs-comment\"\u003e/*              */\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e0b0000100000000\u003c/span\u003e;\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003ePassive\u003c/span\u003e = \u003cspan class=\"hljs-comment\"\u003e/*               */\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e0b0001000000000\u003c/span\u003e;\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eHydrating\u003c/span\u003e = \u003cspan class=\"hljs-comment\"\u003e/*             */\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e0b0010000000000\u003c/span\u003e;\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eHydratingAndUpdate\u003c/span\u003e = \u003cspan class=\"hljs-comment\"\u003e/*    */\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e0b0010000000100\u003c/span\u003e;\r\n\r\n\u003cspan class=\"hljs-comment\"\u003e// Passive \u0026#x26; Update \u0026#x26; Callback \u0026#x26; Ref \u0026#x26; Snapshot\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eLifecycleEffectMask\u003c/span\u003e = \u003cspan class=\"hljs-comment\"\u003e/*   */\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e0b0001110100100\u003c/span\u003e;\r\n\r\n\u003cspan class=\"hljs-comment\"\u003e// Union of all host effects\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eHostEffectMask\u003c/span\u003e = \u003cspan class=\"hljs-comment\"\u003e/*        */\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e0b0011111111111\u003c/span\u003e;\r\n\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eIncomplete\u003c/span\u003e = \u003cspan class=\"hljs-comment\"\u003e/*            */\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e0b0100000000000\u003c/span\u003e;\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eShouldCapture\u003c/span\u003e = \u003cspan class=\"hljs-comment\"\u003e/*         */\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e0b1000000000000\u003c/span\u003e;\r\n\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2 id=\"reacttypeofmodejs\"\u003eReactTypeOfMode.js\u003c/h2\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// packages\\react-reconciler\\src\\ReactTypeOfMode.js\u003c/span\u003e\r\n\u003cspan class=\"hljs-comment\"\u003e/**\r\n * Copyright (c) Facebook, Inc. and its affiliates.\r\n *\r\n * This source code is licensed under the MIT license found in the\r\n * LICENSE file in the root directory of this source tree.\r\n *\r\n * \u003cspan class=\"hljs-doctag\"\u003e@flow\u003c/span\u003e\r\n */\u003c/span\u003e\r\n\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e type \u003cspan class=\"hljs-title class_\"\u003eTypeOfMode\u003c/span\u003e = number;\r\n\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eNoMode\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e0b0000\u003c/span\u003e;\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eStrictMode\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e0b0001\u003c/span\u003e;\r\n\u003cspan class=\"hljs-comment\"\u003e// \u003cspan class=\"hljs-doctag\"\u003eTODO:\u003c/span\u003e Remove BatchedMode and ConcurrentMode by reading from the root\u003c/span\u003e\r\n\u003cspan class=\"hljs-comment\"\u003e// tag instead\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eBatchedMode\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e0b0010\u003c/span\u003e;\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eConcurrentMode\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e0b0100\u003c/span\u003e;\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eProfileMode\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e0b1000\u003c/span\u003e;\r\n\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2 id=\"reactfiberworkloopjs\"\u003eReactFiberWorkLoop.js\u003c/h2\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// packages\\react-reconciler\\src\\ReactFiberWorkLoop.js\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e ceil = \u003cspan class=\"hljs-title class_\"\u003eMath\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eceil\u003c/span\u003e;\r\n\r\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e {\r\n  \u003cspan class=\"hljs-title class_\"\u003eReactCurrentDispatcher\u003c/span\u003e,\r\n  \u003cspan class=\"hljs-title class_\"\u003eReactCurrentOwner\u003c/span\u003e,\r\n  \u003cspan class=\"hljs-title class_\"\u003eIsSomeRendererActing\u003c/span\u003e,\r\n} = \u003cspan class=\"hljs-title class_\"\u003eReactSharedInternals\u003c/span\u003e;\r\n\r\ntype \u003cspan class=\"hljs-title class_\"\u003eExecutionContext\u003c/span\u003e = number;\r\n\r\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eNoContext\u003c/span\u003e = \u003cspan class=\"hljs-comment\"\u003e/*                    */\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e0b000000\u003c/span\u003e;\r\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eBatchedContext\u003c/span\u003e = \u003cspan class=\"hljs-comment\"\u003e/*               */\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e0b000001\u003c/span\u003e;\r\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eEventContext\u003c/span\u003e = \u003cspan class=\"hljs-comment\"\u003e/*                 */\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e0b000010\u003c/span\u003e;\r\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eDiscreteEventContext\u003c/span\u003e = \u003cspan class=\"hljs-comment\"\u003e/*         */\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e0b000100\u003c/span\u003e;\r\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eLegacyUnbatchedContext\u003c/span\u003e = \u003cspan class=\"hljs-comment\"\u003e/*       */\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e0b001000\u003c/span\u003e;\r\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eRenderContext\u003c/span\u003e = \u003cspan class=\"hljs-comment\"\u003e/*                */\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e0b010000\u003c/span\u003e;\r\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eCommitContext\u003c/span\u003e = \u003cspan class=\"hljs-comment\"\u003e/*                */\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e0b100000\u003c/span\u003e;\r\n\r\ntype \u003cspan class=\"hljs-title class_\"\u003eRootExitStatus\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e | \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e | \u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e | \u003cspan class=\"hljs-number\"\u003e3\u003c/span\u003e | \u003cspan class=\"hljs-number\"\u003e4\u003c/span\u003e | \u003cspan class=\"hljs-number\"\u003e5\u003c/span\u003e | \u003cspan class=\"hljs-number\"\u003e6\u003c/span\u003e;\r\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eRootIncomplete\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e;\r\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eRootFatalErrored\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e;\r\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eRootErrored\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e;\r\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eRootSuspended\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e3\u003c/span\u003e;\r\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eRootSuspendedWithDelay\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e4\u003c/span\u003e;\r\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eRootCompleted\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e5\u003c/span\u003e;\r\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eRootLocked\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e6\u003c/span\u003e;\r\n\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e type \u003cspan class=\"hljs-title class_\"\u003eThenable\u003c/span\u003e = {\r\n  \u003cspan class=\"hljs-title function_\"\u003ethen\u003c/span\u003e(\u003cspan class=\"hljs-attr\"\u003eresolve\u003c/span\u003e: \u003cspan class=\"hljs-function\"\u003e() =\u003e\u003c/span\u003e mixed, reject?: \u003cspan class=\"hljs-function\"\u003e() =\u003e\u003c/span\u003e mixed): \u003cspan class=\"hljs-title class_\"\u003eThenable\u003c/span\u003e | \u003cspan class=\"hljs-keyword\"\u003evoid\u003c/span\u003e,\r\n\r\n  \u003cspan class=\"hljs-comment\"\u003e// Special flag to opt out of tracing interactions across a Suspense boundary.\u003c/span\u003e\r\n  __reactDoNotTraceInteractions?: boolean,\r\n};\r\n\r\n\u003cspan class=\"hljs-comment\"\u003e// Describes where we are in the React execution stack\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003eexecutionContext\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eExecutionContext\u003c/span\u003e = \u003cspan class=\"hljs-title class_\"\u003eNoContext\u003c/span\u003e;\r\n\u003cspan class=\"hljs-comment\"\u003e// The root we're working on\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003eworkInProgressRoot\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eFiberRoot\u003c/span\u003e | \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n\u003cspan class=\"hljs-comment\"\u003e// The fiber we're working on\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003eworkInProgress\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eFiber\u003c/span\u003e | \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n\u003cspan class=\"hljs-comment\"\u003e// The expiration time we're rendering\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003erenderExpirationTime\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eExpirationTime\u003c/span\u003e = \u003cspan class=\"hljs-title class_\"\u003eNoWork\u003c/span\u003e;\r\n\u003cspan class=\"hljs-comment\"\u003e// Whether to root completed, errored, suspended, etc.\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003eworkInProgressRootExitStatus\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eRootExitStatus\u003c/span\u003e = \u003cspan class=\"hljs-title class_\"\u003eRootIncomplete\u003c/span\u003e;\r\n\u003cspan class=\"hljs-comment\"\u003e// A fatal error, if one is thrown\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003eworkInProgressRootFatalError\u003c/span\u003e: mixed = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n\u003cspan class=\"hljs-comment\"\u003e// Most recent event time among processed updates during this render.\u003c/span\u003e\r\n\u003cspan class=\"hljs-comment\"\u003e// This is conceptually a time stamp but expressed in terms of an ExpirationTime\u003c/span\u003e\r\n\u003cspan class=\"hljs-comment\"\u003e// because we deal mostly with expiration times in the hot path, so this avoids\u003c/span\u003e\r\n\u003cspan class=\"hljs-comment\"\u003e// the conversion happening in the hot path.\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003eworkInProgressRootLatestProcessedExpirationTime\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eExpirationTime\u003c/span\u003e = \u003cspan class=\"hljs-title class_\"\u003eSync\u003c/span\u003e;\r\n\u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003eworkInProgressRootLatestSuspenseTimeout\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eExpirationTime\u003c/span\u003e = \u003cspan class=\"hljs-title class_\"\u003eSync\u003c/span\u003e;\r\n\u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003eworkInProgressRootCanSuspendUsingConfig\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e | \u003cspan class=\"hljs-title class_\"\u003eSuspenseConfig\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n\u003cspan class=\"hljs-comment\"\u003e// The work left over by components that were visited during this render. Only\u003c/span\u003e\r\n\u003cspan class=\"hljs-comment\"\u003e// includes unprocessed updates, not work in bailed out children.\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003eworkInProgressRootNextUnprocessedUpdateTime\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eExpirationTime\u003c/span\u003e = \u003cspan class=\"hljs-title class_\"\u003eNoWork\u003c/span\u003e;\r\n\r\n\u003cspan class=\"hljs-comment\"\u003e// If we're pinged while rendering we don't always restart immediately.\u003c/span\u003e\r\n\u003cspan class=\"hljs-comment\"\u003e// This flag determines if it might be worthwhile to restart if an opportunity\u003c/span\u003e\r\n\u003cspan class=\"hljs-comment\"\u003e// happens latere.\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003eworkInProgressRootHasPendingPing\u003c/span\u003e: boolean = \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e;\r\n\u003cspan class=\"hljs-comment\"\u003e// The most recent time we committed a fallback. This lets us ensure a train\u003c/span\u003e\r\n\u003cspan class=\"hljs-comment\"\u003e// model where we don't commit new loading states in too quick succession.\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003eglobalMostRecentFallbackTime\u003c/span\u003e: number = \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e;\r\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003eFALLBACK_THROTTLE_MS\u003c/span\u003e: number = \u003cspan class=\"hljs-number\"\u003e500\u003c/span\u003e;\r\n\r\n\u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003enextEffect\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eFiber\u003c/span\u003e | \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n\u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e hasUncaughtError = \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e;\r\n\u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e firstUncaughtError = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n\u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003elegacyErrorBoundariesThatAlreadyFailed\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eSet\u003c/span\u003e\u0026#x3C;mixed\u003e | \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n\r\n\u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003erootDoesHavePassiveEffects\u003c/span\u003e: boolean = \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e;\r\n\u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003erootWithPendingPassiveEffects\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eFiberRoot\u003c/span\u003e | \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n\u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003ependingPassiveEffectsRenderPriority\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eReactPriorityLevel\u003c/span\u003e = \u003cspan class=\"hljs-title class_\"\u003eNoPriority\u003c/span\u003e;\r\n\u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003ependingPassiveEffectsExpirationTime\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eExpirationTime\u003c/span\u003e = \u003cspan class=\"hljs-title class_\"\u003eNoWork\u003c/span\u003e;\r\n\r\n\u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003erootsWithPendingDiscreteUpdates\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eMap\u003c/span\u003e\u0026#x3C;\r\n  \u003cspan class=\"hljs-title class_\"\u003eFiberRoot\u003c/span\u003e,\r\n  \u003cspan class=\"hljs-title class_\"\u003eExpirationTime\u003c/span\u003e,\r\n\u003e | \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n\r\n\u003cspan class=\"hljs-comment\"\u003e// Use these to prevent an infinite loop of nested updates\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-variable constant_\"\u003eNESTED_UPDATE_LIMIT\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e50\u003c/span\u003e;\r\n\u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003enestedUpdateCount\u003c/span\u003e: number = \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e;\r\n\u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003erootWithNestedUpdates\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eFiberRoot\u003c/span\u003e | \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n\r\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-variable constant_\"\u003eNESTED_PASSIVE_UPDATE_LIMIT\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e50\u003c/span\u003e;\r\n\u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003enestedPassiveUpdateCount\u003c/span\u003e: number = \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e;\r\n\r\n\u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003einterruptedBy\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eFiber\u003c/span\u003e | \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n\r\n\u003cspan class=\"hljs-comment\"\u003e// Marks the need to reschedule pending interactions at these expiration times\u003c/span\u003e\r\n\u003cspan class=\"hljs-comment\"\u003e// during the commit phase. This enables them to be traced across components\u003c/span\u003e\r\n\u003cspan class=\"hljs-comment\"\u003e// that spawn new work during render. E.g. hidden boundaries, suspended SSR\u003c/span\u003e\r\n\u003cspan class=\"hljs-comment\"\u003e// hydration or SuspenseList.\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003espawnedWorkDuringRender\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e | \u003cspan class=\"hljs-title class_\"\u003eArray\u003c/span\u003e\u0026#x3C;\u003cspan class=\"hljs-title class_\"\u003eExpirationTime\u003c/span\u003e\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n\r\n\u003cspan class=\"hljs-comment\"\u003e// Expiration times are computed by adding to the current time (the start\u003c/span\u003e\r\n\u003cspan class=\"hljs-comment\"\u003e// time). However, if two updates are scheduled within the same event, we\u003c/span\u003e\r\n\u003cspan class=\"hljs-comment\"\u003e// should treat their start times as simultaneous, even if the actual clock\u003c/span\u003e\r\n\u003cspan class=\"hljs-comment\"\u003e// time has advanced between the first and second call.\u003c/span\u003e\r\n\r\n\u003cspan class=\"hljs-comment\"\u003e// In other words, because expiration times determine how updates are batched,\u003c/span\u003e\r\n\u003cspan class=\"hljs-comment\"\u003e// we want all updates of like priority that occur within the same event to\u003c/span\u003e\r\n\u003cspan class=\"hljs-comment\"\u003e// receive the same expiration time. Otherwise we get tearing.\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003ecurrentEventTime\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eExpirationTime\u003c/span\u003e = \u003cspan class=\"hljs-title class_\"\u003eNoWork\u003c/span\u003e;\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2 id=\"reactsharedinternalsjs\"\u003eReactSharedInternals.js\u003c/h2\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-comment\"\u003e//packages\\shared\\ReactSharedInternals.js\u003c/span\u003e\r\n\u003cspan class=\"hljs-comment\"\u003e/**\r\n * Copyright (c) Facebook, Inc. and its affiliates.\r\n *\r\n * This source code is licensed under the MIT license found in the\r\n * LICENSE file in the root directory of this source tree.\r\n */\u003c/span\u003e\r\n\r\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eReact\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'react'\u003c/span\u003e;\r\n\r\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eReactSharedInternals\u003c/span\u003e =\r\n  \u003cspan class=\"hljs-title class_\"\u003eReact\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003e__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED\u003c/span\u003e;\r\n\r\n\u003cspan class=\"hljs-comment\"\u003e// Prevent newer renderers from RTE when used with older react package versions.\u003c/span\u003e\r\n\u003cspan class=\"hljs-comment\"\u003e// Current owner and dispatcher used to share the same ref,\u003c/span\u003e\r\n\u003cspan class=\"hljs-comment\"\u003e// but PR #14548 split them out to better support the react-debug-tools package.\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (!\u003cspan class=\"hljs-title class_\"\u003eReactSharedInternals\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003ehasOwnProperty\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e'ReactCurrentDispatcher'\u003c/span\u003e)) {\r\n  \u003cspan class=\"hljs-title class_\"\u003eReactSharedInternals\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eReactCurrentDispatcher\u003c/span\u003e = {\r\n    \u003cspan class=\"hljs-attr\"\u003ecurrent\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e,\r\n  };\r\n}\r\n\u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (!\u003cspan class=\"hljs-title class_\"\u003eReactSharedInternals\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003ehasOwnProperty\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e'ReactCurrentBatchConfig'\u003c/span\u003e)) {\r\n  \u003cspan class=\"hljs-title class_\"\u003eReactSharedInternals\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eReactCurrentBatchConfig\u003c/span\u003e = {\r\n    \u003cspan class=\"hljs-attr\"\u003esuspense\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e,\r\n  };\r\n}\r\n\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003edefault\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eReactSharedInternals\u003c/span\u003e;\r\n\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch1 id=\"reactdomrender调用过程\"\u003eReactDOM.render调用过程\u003c/h1\u003e\n\u003ch2 id=\"reactdomrender\"\u003eReactDOM.render\u003c/h2\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// packages\\react-dom\\src\\client\\ReactDOM.js\u003c/span\u003e\r\n\u003cspan class=\"hljs-title function_\"\u003erender\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\r\n    element: React$Element\u0026#x3C;any\u003e,\r\n    container: DOMContainer,\r\n    callback: ?\u003cspan class=\"hljs-built_in\"\u003eFunction\u003c/span\u003e,\r\n  \u003c/span\u003e) {\r\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003elegacyRenderSubtreeIntoContainer\u003c/span\u003e(\r\n      \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e,\r\n      element,\r\n      container,\r\n      \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e,\r\n      callback,\r\n    );\r\n  }\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2 id=\"legacyrendersubtreeintocontainer\"\u003elegacyRenderSubtreeIntoContainer\u003c/h2\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// packages\\react-dom\\src\\client\\ReactDOM.js\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003elegacyRenderSubtreeIntoContainer\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\r\n  parentComponent: ?React$Component\u0026#x3C;any, any\u003e,\r\n  children: ReactNodeList,\r\n  container: DOMContainer,\r\n  forceHydrate: boolean,\r\n  callback: ?\u003cspan class=\"hljs-built_in\"\u003eFunction\u003c/span\u003e,\r\n\u003c/span\u003e) {\r\n  \u003cspan class=\"hljs-comment\"\u003e// \u003cspan class=\"hljs-doctag\"\u003eTODO:\u003c/span\u003e Without `any` type, Flow says \"Property cannot be accessed on any\u003c/span\u003e\r\n  \u003cspan class=\"hljs-comment\"\u003e// member of intersection type.\" Whyyyyyy.\u003c/span\u003e\r\n  \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003eroot\u003c/span\u003e: _ReactSyncRoot = (container.\u003cspan class=\"hljs-property\"\u003e_reactRootContainer\u003c/span\u003e: any);\r\n  \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e fiberRoot;\r\n  \u003cspan class=\"hljs-comment\"\u003e// 没有root则创建，有了root之后执行update\u003c/span\u003e\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (!root) {\r\n    \u003cspan class=\"hljs-comment\"\u003e// Initial mount\u003c/span\u003e\r\n    root = container.\u003cspan class=\"hljs-property\"\u003e_reactRootContainer\u003c/span\u003e = \u003cspan class=\"hljs-title function_\"\u003elegacyCreateRootFromDOMContainer\u003c/span\u003e(\r\n      container,\r\n      forceHydrate,\r\n    );\r\n    fiberRoot = root.\u003cspan class=\"hljs-property\"\u003e_internalRoot\u003c/span\u003e;\r\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (\u003cspan class=\"hljs-keyword\"\u003etypeof\u003c/span\u003e callback === \u003cspan class=\"hljs-string\"\u003e'function'\u003c/span\u003e) {\r\n      \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e originalCallback = callback;\r\n      callback = \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\u003c/span\u003e) {\r\n        \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e instance = \u003cspan class=\"hljs-title function_\"\u003egetPublicRootInstance\u003c/span\u003e(fiberRoot);\r\n        originalCallback.\u003cspan class=\"hljs-title function_\"\u003ecall\u003c/span\u003e(instance);\r\n      };\r\n    }\r\n    \u003cspan class=\"hljs-comment\"\u003e// Initial mount should not be batched.\u003c/span\u003e\r\n    \u003cspan class=\"hljs-title function_\"\u003eunbatchedUpdates\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e() =\u003e\u003c/span\u003e {\r\n      \u003cspan class=\"hljs-title function_\"\u003eupdateContainer\u003c/span\u003e(children, fiberRoot, parentComponent, callback);\r\n    });\r\n  } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\r\n    fiberRoot = root.\u003cspan class=\"hljs-property\"\u003e_internalRoot\u003c/span\u003e;\r\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (\u003cspan class=\"hljs-keyword\"\u003etypeof\u003c/span\u003e callback === \u003cspan class=\"hljs-string\"\u003e'function'\u003c/span\u003e) {\r\n      \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e originalCallback = callback;\r\n      callback = \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\u003c/span\u003e) {\r\n        \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e instance = \u003cspan class=\"hljs-title function_\"\u003egetPublicRootInstance\u003c/span\u003e(fiberRoot);\r\n        originalCallback.\u003cspan class=\"hljs-title function_\"\u003ecall\u003c/span\u003e(instance);\r\n      };\r\n    }\r\n    \u003cspan class=\"hljs-comment\"\u003e// Update\u003c/span\u003e\r\n    \u003cspan class=\"hljs-title function_\"\u003eupdateContainer\u003c/span\u003e(children, fiberRoot, parentComponent, callback);\r\n  }\r\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003egetPublicRootInstance\u003c/span\u003e(fiberRoot);\r\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"root创建过程\"\u003eroot创建过程\u003c/h3\u003e\n\u003ch4 id=\"legacycreaterootfromdomcontainer\"\u003elegacyCreateRootFromDOMContainer\u003c/h4\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// packages\\react-dom\\src\\client\\ReactDOM.js\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003elegacyCreateRootFromDOMContainer\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\r\n  container: DOMContainer,\r\n  forceHydrate: boolean,\r\n\u003c/span\u003e): _ReactSyncRoot {\r\n  \u003cspan class=\"hljs-comment\"\u003e// hydrate 描述的是 ReactDOM 复用 ReactDOMServer 服务端渲染的内容时尽可能保留结构，并补充事件绑定等 Client 特有内容的过程。\u003c/span\u003e\r\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e shouldHydrate =\r\n    forceHydrate || \u003cspan class=\"hljs-title function_\"\u003eshouldHydrateDueToLegacyHeuristic\u003c/span\u003e(container);\r\n  \u003cspan class=\"hljs-comment\"\u003e// First clear any existing content.\u003c/span\u003e\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (!shouldHydrate) {\r\n    \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e warned = \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e;\r\n    \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e rootSibling;\r\n    \u003cspan class=\"hljs-keyword\"\u003ewhile\u003c/span\u003e ((rootSibling = container.\u003cspan class=\"hljs-property\"\u003elastChild\u003c/span\u003e)) {\r\n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (__DEV__) {\r\n        \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (\r\n          !warned \u0026#x26;\u0026#x26;\r\n          rootSibling.\u003cspan class=\"hljs-property\"\u003enodeType\u003c/span\u003e === \u003cspan class=\"hljs-variable constant_\"\u003eELEMENT_NODE\u003c/span\u003e \u0026#x26;\u0026#x26;\r\n          (\u003cspan class=\"hljs-attr\"\u003erootSibling\u003c/span\u003e: any).\u003cspan class=\"hljs-title function_\"\u003ehasAttribute\u003c/span\u003e(\u003cspan class=\"hljs-variable constant_\"\u003eROOT_ATTRIBUTE_NAME\u003c/span\u003e)\r\n        ) {\r\n          warned = \u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e;\r\n          \u003cspan class=\"hljs-title function_\"\u003ewarningWithoutStack\u003c/span\u003e(\r\n            \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e,\r\n            \u003cspan class=\"hljs-string\"\u003e'render(): Target node has markup rendered by React, but there '\u003c/span\u003e +\r\n              \u003cspan class=\"hljs-string\"\u003e'are unrelated nodes as well. This is most commonly caused by '\u003c/span\u003e +\r\n              \u003cspan class=\"hljs-string\"\u003e'white-space inserted around server-rendered markup.'\u003c/span\u003e,\r\n          );\r\n        }\r\n      }\r\n      container.\u003cspan class=\"hljs-title function_\"\u003eremoveChild\u003c/span\u003e(rootSibling);\r\n    }\r\n  }\r\n\r\n  \u003cspan class=\"hljs-comment\"\u003e// Legacy roots are not batched.\u003c/span\u003e\r\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eReactSyncRoot\u003c/span\u003e(\r\n    container,\r\n    \u003cspan class=\"hljs-title class_\"\u003eLegacyRoot\u003c/span\u003e,\r\n    shouldHydrate\r\n      ? {\r\n          \u003cspan class=\"hljs-attr\"\u003ehydrate\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e,\r\n        }\r\n      : \u003cspan class=\"hljs-literal\"\u003eundefined\u003c/span\u003e,\r\n  );\r\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch4 id=\"new-reactsyncroot\"\u003enew ReactSyncRoot\u003c/h4\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// packages\\react-dom\\src\\client\\ReactDOM.js\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eReactSyncRoot\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\r\n  container: DOMContainer,\r\n  tag: RootTag,\r\n  options: \u003cspan class=\"hljs-keyword\"\u003evoid\u003c/span\u003e | RootOptions,\r\n\u003c/span\u003e) {\r\n  \u003cspan class=\"hljs-comment\"\u003e// 挂载fiberRoot\u003c/span\u003e\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003e_internalRoot\u003c/span\u003e = \u003cspan class=\"hljs-title function_\"\u003ecreateRootImpl\u003c/span\u003e(container, tag, options);\r\n}\r\n\r\n\u003cspan class=\"hljs-title class_\"\u003eReactRoot\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003e\u003cspan class=\"hljs-keyword\"\u003eprototype\u003c/span\u003e\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003erender\u003c/span\u003e = \u003cspan class=\"hljs-title class_\"\u003eReactSyncRoot\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003e\u003cspan class=\"hljs-keyword\"\u003eprototype\u003c/span\u003e\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003erender\u003c/span\u003e = \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\r\n  children: ReactNodeList,\r\n  callback: ?() =\u003e mixed,\r\n\u003c/span\u003e): \u003cspan class=\"hljs-title class_\"\u003eWork\u003c/span\u003e {\r\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e root = \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003e_internalRoot\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e work = \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eReactWork\u003c/span\u003e();\r\n  callback = callback === \u003cspan class=\"hljs-literal\"\u003eundefined\u003c/span\u003e ? \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e : callback;\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (callback !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n    work.\u003cspan class=\"hljs-title function_\"\u003ethen\u003c/span\u003e(callback);\r\n  }\r\n  \u003cspan class=\"hljs-title function_\"\u003eupdateContainer\u003c/span\u003e(children, root, \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e, work.\u003cspan class=\"hljs-property\"\u003e_onCommit\u003c/span\u003e);\r\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e work;\r\n};\r\n\r\n\u003cspan class=\"hljs-title class_\"\u003eReactRoot\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003e\u003cspan class=\"hljs-keyword\"\u003eprototype\u003c/span\u003e\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eunmount\u003c/span\u003e = \u003cspan class=\"hljs-title class_\"\u003eReactSyncRoot\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003e\u003cspan class=\"hljs-keyword\"\u003eprototype\u003c/span\u003e\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eunmount\u003c/span\u003e = \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\r\n  callback: ?() =\u003e mixed,\r\n\u003c/span\u003e): \u003cspan class=\"hljs-title class_\"\u003eWork\u003c/span\u003e {\r\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e root = \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003e_internalRoot\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e work = \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eReactWork\u003c/span\u003e();\r\n  callback = callback === \u003cspan class=\"hljs-literal\"\u003eundefined\u003c/span\u003e ? \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e : callback;\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (callback !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n    work.\u003cspan class=\"hljs-title function_\"\u003ethen\u003c/span\u003e(callback);\r\n  }\r\n  \u003cspan class=\"hljs-title function_\"\u003eupdateContainer\u003c/span\u003e(\u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e, root, \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e, work.\u003cspan class=\"hljs-property\"\u003e_onCommit\u003c/span\u003e);\r\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e work;\r\n};\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch4 id=\"createrootimpl\"\u003ecreateRootImpl\u003c/h4\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// packages\\react-dom\\src\\client\\ReactDOM.js\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003ecreateRootImpl\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\r\n  container: DOMContainer,\r\n  tag: RootTag,\r\n  options: \u003cspan class=\"hljs-keyword\"\u003evoid\u003c/span\u003e | RootOptions,\r\n\u003c/span\u003e) {\r\n  \u003cspan class=\"hljs-comment\"\u003e// Tag is either LegacyRoot or Concurrent Root\u003c/span\u003e\r\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e hydrate = options != \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e \u0026#x26;\u0026#x26; options.\u003cspan class=\"hljs-property\"\u003ehydrate\u003c/span\u003e === \u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e hydrationCallbacks =\r\n    (options != \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e \u0026#x26;\u0026#x26; options.\u003cspan class=\"hljs-property\"\u003ehydrationOptions\u003c/span\u003e) || \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e root = \u003cspan class=\"hljs-title function_\"\u003ecreateContainer\u003c/span\u003e(container, tag, hydrate, hydrationCallbacks);\r\n  \u003cspan class=\"hljs-title function_\"\u003emarkContainerAsRoot\u003c/span\u003e(root.\u003cspan class=\"hljs-property\"\u003ecurrent\u003c/span\u003e, container);\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (hydrate \u0026#x26;\u0026#x26; tag !== \u003cspan class=\"hljs-title class_\"\u003eLegacyRoot\u003c/span\u003e) {\r\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e doc =\r\n      container.\u003cspan class=\"hljs-property\"\u003enodeType\u003c/span\u003e === \u003cspan class=\"hljs-variable constant_\"\u003eDOCUMENT_NODE\u003c/span\u003e\r\n        ? container\r\n        : container.\u003cspan class=\"hljs-property\"\u003eownerDocument\u003c/span\u003e;\r\n    \u003cspan class=\"hljs-title function_\"\u003eeagerlyTrapReplayableEvents\u003c/span\u003e(doc);\r\n  }\r\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e root;\r\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch5 id=\"createcontainer\"\u003ecreateContainer\u003c/h5\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// packages\\react-reconciler\\src\\ReactFiberReconciler.js\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003ecreateContainer\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\r\n  containerInfo: Container,\r\n  tag: RootTag,\r\n  hydrate: boolean,\r\n  hydrationCallbacks: \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e | SuspenseHydrationCallbacks,\r\n\u003c/span\u003e): \u003cspan class=\"hljs-title class_\"\u003eOpaqueRoot\u003c/span\u003e {\r\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003ecreateFiberRoot\u003c/span\u003e(containerInfo, tag, hydrate, hydrationCallbacks);\r\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch6 id=\"createfiberroot\"\u003ecreateFiberRoot\u003c/h6\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// packages\\react-reconciler\\src\\ReactFiberRoot.js\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003ecreateFiberRoot\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\r\n  containerInfo: any,\r\n  tag: RootTag,\r\n  hydrate: boolean,\r\n  hydrationCallbacks: \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e | SuspenseHydrationCallbacks,\r\n\u003c/span\u003e): \u003cspan class=\"hljs-title class_\"\u003eFiberRoot\u003c/span\u003e {\r\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003eroot\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eFiberRoot\u003c/span\u003e = (\u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eFiberRootNode\u003c/span\u003e(containerInfo, tag, hydrate): any);\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (enableSuspenseCallback) {\r\n    root.\u003cspan class=\"hljs-property\"\u003ehydrationCallbacks\u003c/span\u003e = hydrationCallbacks;\r\n  }\r\n\r\n  \u003cspan class=\"hljs-comment\"\u003e// Cyclic construction. This cheats the type system right now because\u003c/span\u003e\r\n  \u003cspan class=\"hljs-comment\"\u003e// stateNode is any.\u003c/span\u003e\r\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e uninitializedFiber = \u003cspan class=\"hljs-title function_\"\u003ecreateHostRootFiber\u003c/span\u003e(tag);\r\n  root.\u003cspan class=\"hljs-property\"\u003ecurrent\u003c/span\u003e = uninitializedFiber;\r\n  uninitializedFiber.\u003cspan class=\"hljs-property\"\u003estateNode\u003c/span\u003e = root;\r\n\r\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e root;\r\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch6 id=\"new-fiberrootnode\"\u003enew FiberRootNode\u003c/h6\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// packages\\react-reconciler\\src\\ReactFiberRoot.js\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eFiberRootNode\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003econtainerInfo, tag, hydrate\u003c/span\u003e) {\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003etag\u003c/span\u003e = tag;\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ecurrent\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003econtainerInfo\u003c/span\u003e = containerInfo;\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ependingChildren\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003epingCache\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003efinishedExpirationTime\u003c/span\u003e = \u003cspan class=\"hljs-title class_\"\u003eNoWork\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003efinishedWork\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003etimeoutHandle\u003c/span\u003e = noTimeout;\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003econtext\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ependingContext\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ehydrate\u003c/span\u003e = hydrate;\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003efirstBatch\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ecallbackNode\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-comment\"\u003e// NoPriority 详见React类型/常量定义-SchedulerWithReactIntegration.js\u003c/span\u003e\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ecallbackPriority\u003c/span\u003e = \u003cspan class=\"hljs-title class_\"\u003eNoPriority\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-comment\"\u003e// NoWork 详见React类型/常量定义-ReactFiberExpirationTime.js\u003c/span\u003e\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003efirstPendingTime\u003c/span\u003e = \u003cspan class=\"hljs-title class_\"\u003eNoWork\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003efirstSuspendedTime\u003c/span\u003e = \u003cspan class=\"hljs-title class_\"\u003eNoWork\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003elastSuspendedTime\u003c/span\u003e = \u003cspan class=\"hljs-title class_\"\u003eNoWork\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003enextKnownPendingLevel\u003c/span\u003e = \u003cspan class=\"hljs-title class_\"\u003eNoWork\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003elastPingedTime\u003c/span\u003e = \u003cspan class=\"hljs-title class_\"\u003eNoWork\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003elastExpiredTime\u003c/span\u003e = \u003cspan class=\"hljs-title class_\"\u003eNoWork\u003c/span\u003e;\r\n\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (enableSchedulerTracing) {\r\n    \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003einteractionThreadID\u003c/span\u003e = \u003cspan class=\"hljs-title function_\"\u003eunstable_getThreadID\u003c/span\u003e();\r\n    \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ememoizedInteractions\u003c/span\u003e = \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eSet\u003c/span\u003e();\r\n    \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ependingInteractionMap\u003c/span\u003e = \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eMap\u003c/span\u003e();\r\n  }\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (enableSuspenseCallback) {\r\n    \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ehydrationCallbacks\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n  }\r\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch6 id=\"createhostrootfiber\"\u003ecreateHostRootFiber\u003c/h6\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// packages\\react-reconciler\\src\\ReactFiber.js\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003ecreateHostRootFiber\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003etag: RootTag\u003c/span\u003e): \u003cspan class=\"hljs-title class_\"\u003eFiber\u003c/span\u003e {\r\n  \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e mode;\r\n    \r\n  \u003cspan class=\"hljs-comment\"\u003e// ConcurrentMode、BatchedMode 详见React类型/常量定义-ReactTypeOfMode.js\u003c/span\u003e\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (tag === \u003cspan class=\"hljs-title class_\"\u003eConcurrentRoot\u003c/span\u003e) {\r\n    mode = \u003cspan class=\"hljs-title class_\"\u003eConcurrentMode\u003c/span\u003e | \u003cspan class=\"hljs-title class_\"\u003eBatchedMode\u003c/span\u003e | \u003cspan class=\"hljs-title class_\"\u003eStrictMode\u003c/span\u003e;\r\n  } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (tag === \u003cspan class=\"hljs-title class_\"\u003eBatchedRoot\u003c/span\u003e) {\r\n    mode = \u003cspan class=\"hljs-title class_\"\u003eBatchedMode\u003c/span\u003e | \u003cspan class=\"hljs-title class_\"\u003eStrictMode\u003c/span\u003e;\r\n  } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\r\n    mode = \u003cspan class=\"hljs-title class_\"\u003eNoMode\u003c/span\u003e;\r\n  }\r\n\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (enableProfilerTimer \u0026#x26;\u0026#x26; isDevToolsPresent) {\r\n    \u003cspan class=\"hljs-comment\"\u003e// Always collect profile timings when DevTools are present.\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// This enables DevTools to start capturing timing at any point–\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// Without some nodes in the tree having empty base times.\u003c/span\u003e\r\n    mode |= \u003cspan class=\"hljs-title class_\"\u003eProfileMode\u003c/span\u003e;\r\n  }\r\n\r\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003ecreateFiber\u003c/span\u003e(\u003cspan class=\"hljs-title class_\"\u003eHostRoot\u003c/span\u003e, \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e, \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e, mode);\r\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch6 id=\"createfiber\"\u003ecreateFiber\u003c/h6\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// packages\\react-reconciler\\src\\ReactFiber.js\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e createFiber = \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\r\n  tag: WorkTag,\r\n  pendingProps: mixed,\r\n  key: \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e | string,\r\n  mode: TypeOfMode,\r\n\u003c/span\u003e): \u003cspan class=\"hljs-title class_\"\u003eFiber\u003c/span\u003e {\r\n  \u003cspan class=\"hljs-comment\"\u003e// $FlowFixMe: the shapes are exact here but Flow doesn't like constructors\u003c/span\u003e\r\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eFiberNode\u003c/span\u003e(tag, pendingProps, key, mode);\r\n};\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch6 id=\"new-fibernode\"\u003enew FiberNode\u003c/h6\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// packages\\react-reconciler\\src\\ReactFiber.js\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eFiberNode\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\r\n  tag: WorkTag,\r\n  pendingProps: mixed,\r\n  key: \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e | string,\r\n  mode: TypeOfMode,\r\n\u003c/span\u003e) {\r\n  \u003cspan class=\"hljs-comment\"\u003e// Instance\u003c/span\u003e\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003etag\u003c/span\u003e = tag;\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ekey\u003c/span\u003e = key;\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eelementType\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003etype\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003estateNode\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n\r\n  \u003cspan class=\"hljs-comment\"\u003e// Fiber\u003c/span\u003e\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ereturn\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003echild\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003esibling\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eindex\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e;\r\n\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eref\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ependingProps\u003c/span\u003e = pendingProps;\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ememoizedProps\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eupdateQueue\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ememoizedState\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003edependencies\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003emode\u003c/span\u003e = mode;\r\n\r\n  \u003cspan class=\"hljs-comment\"\u003e// Effects\u003c/span\u003e\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eeffectTag\u003c/span\u003e = \u003cspan class=\"hljs-title class_\"\u003eNoEffect\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003enextEffect\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003efirstEffect\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003elastEffect\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eexpirationTime\u003c/span\u003e = \u003cspan class=\"hljs-title class_\"\u003eNoWork\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003echildExpirationTime\u003c/span\u003e = \u003cspan class=\"hljs-title class_\"\u003eNoWork\u003c/span\u003e;\r\n\r\n  \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ealternate\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (enableProfilerTimer) {\r\n    \u003cspan class=\"hljs-comment\"\u003e// Note: The following is done to avoid a v8 performance cliff.\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e//\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// Initializing the fields below to smis and later updating them with\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// double values will cause Fibers to end up having separate shapes.\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// This behavior/bug has something to do with Object.preventExtension().\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// Fortunately this only impacts DEV builds.\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// Unfortunately it makes React unusably slow for some applications.\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// To work around this, initialize the fields below with doubles.\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e//\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// Learn more about this here:\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// https://github.com/facebook/react/issues/14365\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// https://bugs.chromium.org/p/v8/issues/detail?id=8538\u003c/span\u003e\r\n    \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eactualDuration\u003c/span\u003e = \u003cspan class=\"hljs-title class_\"\u003eNumber\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eNaN\u003c/span\u003e;\r\n    \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eactualStartTime\u003c/span\u003e = \u003cspan class=\"hljs-title class_\"\u003eNumber\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eNaN\u003c/span\u003e;\r\n    \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eselfBaseDuration\u003c/span\u003e = \u003cspan class=\"hljs-title class_\"\u003eNumber\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eNaN\u003c/span\u003e;\r\n    \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003etreeBaseDuration\u003c/span\u003e = \u003cspan class=\"hljs-title class_\"\u003eNumber\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eNaN\u003c/span\u003e;\r\n\r\n    \u003cspan class=\"hljs-comment\"\u003e// It's okay to replace the initial doubles with smis after initialization.\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// This won't trigger the performance cliff mentioned above,\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// and it simplifies other profiler code (including DevTools).\u003c/span\u003e\r\n    \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eactualDuration\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e;\r\n    \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eactualStartTime\u003c/span\u003e = -\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e;\r\n    \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eselfBaseDuration\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e;\r\n    \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003etreeBaseDuration\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e;\r\n  }\r\n\r\n  \u003cspan class=\"hljs-comment\"\u003e// This is normally DEV-only except www when it adds listeners.\u003c/span\u003e\r\n  \u003cspan class=\"hljs-comment\"\u003e// \u003cspan class=\"hljs-doctag\"\u003eTODO:\u003c/span\u003e remove the User Timing integration in favor of Root Events.\u003c/span\u003e\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (enableUserTimingAPI) {\r\n    \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003e_debugID\u003c/span\u003e = debugCounter++;\r\n    \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003e_debugIsCurrentlyTiming\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e;\r\n  }\r\n\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (__DEV__) {\r\n    \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003e_debugSource\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n    \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003e_debugOwner\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n    \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003e_debugNeedsRemount\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e;\r\n    \u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003e_debugHookTypes\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (!hasBadMapPolyfill \u0026#x26;\u0026#x26; \u003cspan class=\"hljs-keyword\"\u003etypeof\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eObject\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003epreventExtensions\u003c/span\u003e === \u003cspan class=\"hljs-string\"\u003e'function'\u003c/span\u003e) {\r\n      \u003cspan class=\"hljs-title class_\"\u003eObject\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003epreventExtensions\u003c/span\u003e(\u003cspan class=\"hljs-variable language_\"\u003ethis\u003c/span\u003e);\r\n    }\r\n  }\r\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch5 id=\"markcontainerasroot\"\u003emarkContainerAsRoot\u003c/h5\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// packages\\react-dom\\src\\client\\ReactDOMComponentTree.js\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e randomKey = \u003cspan class=\"hljs-title class_\"\u003eMath\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003erandom\u003c/span\u003e()\r\n  .\u003cspan class=\"hljs-title function_\"\u003etoString\u003c/span\u003e(\u003cspan class=\"hljs-number\"\u003e36\u003c/span\u003e)\r\n  .\u003cspan class=\"hljs-title function_\"\u003eslice\u003c/span\u003e(\u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e);\r\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e internalInstanceKey = \u003cspan class=\"hljs-string\"\u003e'__reactInternalInstance$'\u003c/span\u003e + randomKey;\r\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e internalEventHandlersKey = \u003cspan class=\"hljs-string\"\u003e'__reactEventHandlers$'\u003c/span\u003e + randomKey;\r\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e internalContainerInstanceKey = \u003cspan class=\"hljs-string\"\u003e'__reactContainere$'\u003c/span\u003e + randomKey;\r\n\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eprecacheFiberNode\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003ehostInst, node\u003c/span\u003e) {\r\n  node[internalInstanceKey] = hostInst;\r\n}\r\n\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003emarkContainerAsRoot\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003ehostRoot, node\u003c/span\u003e) {\r\n  node[internalContainerInstanceKey] = hostRoot;\r\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"callback调用过程\"\u003ecallback调用过程\u003c/h3\u003e\n\u003ch4 id=\"getpublicrootinstance\"\u003egetPublicRootInstance\u003c/h4\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// packages\\react-reconciler\\src\\ReactFiberReconciler.js\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003egetPublicRootInstance\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\r\n  container: OpaqueRoot,\r\n\u003c/span\u003e): \u003cspan class=\"hljs-title class_\"\u003eReact\u003c/span\u003e$Component\u0026#x3C;any, any\u003e | \u003cspan class=\"hljs-title class_\"\u003ePublicInstance\u003c/span\u003e | \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e {\r\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e containerFiber = container.\u003cspan class=\"hljs-property\"\u003ecurrent\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (!containerFiber.\u003cspan class=\"hljs-property\"\u003echild\u003c/span\u003e) {\r\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n  }\r\n  \u003cspan class=\"hljs-keyword\"\u003eswitch\u003c/span\u003e (containerFiber.\u003cspan class=\"hljs-property\"\u003echild\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003etag\u003c/span\u003e) {\r\n    \u003cspan class=\"hljs-comment\"\u003e// HostComponent 详见React类型/常量定义-ReactWorkTags.js\u003c/span\u003e\r\n    \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eHostComponent\u003c/span\u003e:\r\n      \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003egetPublicInstance\u003c/span\u003e(containerFiber.\u003cspan class=\"hljs-property\"\u003echild\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003estateNode\u003c/span\u003e);\r\n    \u003cspan class=\"hljs-attr\"\u003edefault\u003c/span\u003e:\r\n      \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e containerFiber.\u003cspan class=\"hljs-property\"\u003echild\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003estateNode\u003c/span\u003e;\r\n  }\r\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"updatecontainer调用过程\"\u003eupdateContainer调用过程\u003c/h3\u003e\n\u003ch4 id=\"unbatchedupdates\"\u003eunbatchedUpdates\u003c/h4\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// packages\\react-reconciler\\src\\ReactFiberWorkLoop.js\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e unbatchedUpdates\u0026#x3C;A, R\u003e(\u003cspan class=\"hljs-attr\"\u003efn\u003c/span\u003e: \u003cspan class=\"hljs-function\"\u003e(\u003cspan class=\"hljs-params\"\u003ea: A\u003c/span\u003e) =\u003e\u003c/span\u003e R, \u003cspan class=\"hljs-attr\"\u003ea\u003c/span\u003e: A): R {\r\n  \u003cspan class=\"hljs-comment\"\u003e// executionContext、BatchedContext 详见React类型/常量定义-ReactFiberWorkLoop.js\u003c/span\u003e\r\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e prevExecutionContext = executionContext;\r\n  executionContext \u0026#x26;= ~\u003cspan class=\"hljs-title class_\"\u003eBatchedContext\u003c/span\u003e;\r\n  executionContext |= \u003cspan class=\"hljs-title class_\"\u003eLegacyUnbatchedContext\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-comment\"\u003e// executionContext now is 8\u003c/span\u003e\r\n  \u003cspan class=\"hljs-keyword\"\u003etry\u003c/span\u003e {\r\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003efn\u003c/span\u003e(a);\r\n  } \u003cspan class=\"hljs-keyword\"\u003efinally\u003c/span\u003e {\r\n    executionContext = prevExecutionContext;\r\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (executionContext === \u003cspan class=\"hljs-title class_\"\u003eNoContext\u003c/span\u003e) {\r\n      \u003cspan class=\"hljs-comment\"\u003e// Flush the immediate callbacks that were scheduled during this batch\u003c/span\u003e\r\n      \u003cspan class=\"hljs-title function_\"\u003eflushSyncCallbackQueue\u003c/span\u003e();\r\n    }\r\n  }\r\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch4 id=\"updatecontainer\"\u003eupdateContainer\u003c/h4\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// packages\\react-reconciler\\src\\ReactFiberReconciler.js\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eupdateContainer\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\r\n  element: ReactNodeList,\r\n  container: OpaqueRoot,\r\n  parentComponent: ?React$Component\u0026#x3C;any, any\u003e,\r\n  callback: ?\u003cspan class=\"hljs-built_in\"\u003eFunction\u003c/span\u003e,\r\n\u003c/span\u003e): \u003cspan class=\"hljs-title class_\"\u003eExpirationTime\u003c/span\u003e {\r\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e current = container.\u003cspan class=\"hljs-property\"\u003ecurrent\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e currentTime = \u003cspan class=\"hljs-title function_\"\u003erequestCurrentTime\u003c/span\u003e();\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (__DEV__) {\r\n    \u003cspan class=\"hljs-comment\"\u003e// $FlowExpectedError - jest isn't a global, and isn't recognized outside of tests\u003c/span\u003e\r\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (\u003cspan class=\"hljs-string\"\u003e'undefined'\u003c/span\u003e !== \u003cspan class=\"hljs-keyword\"\u003etypeof\u003c/span\u003e jest) {\r\n      \u003cspan class=\"hljs-title function_\"\u003ewarnIfUnmockedScheduler\u003c/span\u003e(current);\r\n      \u003cspan class=\"hljs-title function_\"\u003ewarnIfNotScopedWithMatchingAct\u003c/span\u003e(current);\r\n    }\r\n  }\r\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e suspenseConfig = \u003cspan class=\"hljs-title function_\"\u003erequestCurrentSuspenseConfig\u003c/span\u003e();\r\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e expirationTime = \u003cspan class=\"hljs-title function_\"\u003ecomputeExpirationForFiber\u003c/span\u003e(\r\n    currentTime,\r\n    current,\r\n    suspenseConfig,\r\n  );\r\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eupdateContainerAtExpirationTime\u003c/span\u003e(\r\n    element,\r\n    container,\r\n    parentComponent,\r\n    expirationTime,\r\n    suspenseConfig,\r\n    callback,\r\n  );\r\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch5 id=\"requestcurrenttime\"\u003erequestCurrentTime\u003c/h5\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// packages\\react-reconciler\\src\\ReactFiberWorkLoop.js\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003erequestCurrentTime\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\u003c/span\u003e) {\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e ((executionContext \u0026#x26; (\u003cspan class=\"hljs-title class_\"\u003eRenderContext\u003c/span\u003e | \u003cspan class=\"hljs-title class_\"\u003eCommitContext\u003c/span\u003e)) !== \u003cspan class=\"hljs-title class_\"\u003eNoContext\u003c/span\u003e) {\r\n    \u003cspan class=\"hljs-comment\"\u003e// We're inside React, so it's fine to read the actual time.\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// now()方法的定义：如果是浏览器支持则定义为()=\u003eperformance.now()，否则为Date.now()-react库加载执行时的Date.now()\u003c/span\u003e\r\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003emsToExpirationTime\u003c/span\u003e(\u003cspan class=\"hljs-title function_\"\u003enow\u003c/span\u003e());\r\n  }\r\n  \u003cspan class=\"hljs-comment\"\u003e// We're not inside React, so we may be in the middle of a browser event.\u003c/span\u003e\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (currentEventTime !== \u003cspan class=\"hljs-title class_\"\u003eNoWork\u003c/span\u003e) {\r\n    \u003cspan class=\"hljs-comment\"\u003e// Use the same start time for all updates until we enter React again.\u003c/span\u003e\r\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e currentEventTime;\r\n  }\r\n  \u003cspan class=\"hljs-comment\"\u003e// This is the first update since React yielded. Compute a new start time.\u003c/span\u003e\r\n  \u003cspan class=\"hljs-comment\"\u003e// 1073741823-1-1-now()\u003c/span\u003e\r\n  currentEventTime = \u003cspan class=\"hljs-title function_\"\u003emsToExpirationTime\u003c/span\u003e(\u003cspan class=\"hljs-title function_\"\u003enow\u003c/span\u003e());\r\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e currentEventTime;\r\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch5 id=\"mstoexpirationtime\"\u003emsToExpirationTime\u003c/h5\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// packages\\react-reconciler\\src\\ReactFiberExpirationTime.js\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003emsToExpirationTime\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003ems: number\u003c/span\u003e): \u003cspan class=\"hljs-title class_\"\u003eExpirationTime\u003c/span\u003e {\r\n  \u003cspan class=\"hljs-comment\"\u003e// Always add an offset so that we don't clash with the magic number for NoWork.\u003c/span\u003e\r\n  \u003cspan class=\"hljs-comment\"\u003e// MAGIC_NUMBER_OFFSET、UNIT_SIZE 详见React类型/常量定义-ReactFiberExpirationTime.js\u003c/span\u003e\r\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-variable constant_\"\u003eMAGIC_NUMBER_OFFSET\u003c/span\u003e - ((ms / \u003cspan class=\"hljs-variable constant_\"\u003eUNIT_SIZE\u003c/span\u003e) | \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e);\r\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch5 id=\"requestcurrentsuspenseconfig\"\u003erequestCurrentSuspenseConfig\u003c/h5\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// packages\\react-reconciler\\src\\ReactFiberSuspenseConfig.js\u003c/span\u003e\r\n\u003cspan class=\"hljs-comment\"\u003e/**\r\n * Copyright (c) Facebook, Inc. and its affiliates.\r\n *\r\n * This source code is licensed under the MIT license found in the\r\n * LICENSE file in the root directory of this source tree.\r\n *\r\n * \u003cspan class=\"hljs-doctag\"\u003e@flow\u003c/span\u003e\r\n */\u003c/span\u003e\r\n\r\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eReactSharedInternals\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e'shared/ReactSharedInternals'\u003c/span\u003e;\r\n\r\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e {\u003cspan class=\"hljs-title class_\"\u003eReactCurrentBatchConfig\u003c/span\u003e} = \u003cspan class=\"hljs-title class_\"\u003eReactSharedInternals\u003c/span\u003e;\r\n\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e type \u003cspan class=\"hljs-title class_\"\u003eSuspenseConfig\u003c/span\u003e = {|\r\n  \u003cspan class=\"hljs-attr\"\u003etimeoutMs\u003c/span\u003e: number,\r\n  busyDelayMs?: number,\r\n  busyMinDurationMs?: number,\r\n|};\r\n\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003erequestCurrentSuspenseConfig\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\u003c/span\u003e): \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e | \u003cspan class=\"hljs-title class_\"\u003eSuspenseConfig\u003c/span\u003e {\r\n  \u003cspan class=\"hljs-comment\"\u003e// ReactCurrentBatchConfig 详见React类型/常量定义-ReactSharedInternals.js\u003c/span\u003e\r\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eReactCurrentBatchConfig\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003esuspense\u003c/span\u003e;\r\n}\r\n\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch5 id=\"computeexpirationforfiber\"\u003ecomputeExpirationForFiber\u003c/h5\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// packages\\react-reconciler\\src\\ReactFiberWorkLoop.js\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003ecomputeExpirationForFiber\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\r\n  currentTime: ExpirationTime,\r\n  fiber: Fiber,\r\n  suspenseConfig: \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e | SuspenseConfig,\r\n\u003c/span\u003e): \u003cspan class=\"hljs-title class_\"\u003eExpirationTime\u003c/span\u003e {\r\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e mode = fiber.\u003cspan class=\"hljs-property\"\u003emode\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e ((mode \u0026#x26; \u003cspan class=\"hljs-title class_\"\u003eBatchedMode\u003c/span\u003e) === \u003cspan class=\"hljs-title class_\"\u003eNoMode\u003c/span\u003e) {\r\n    \u003cspan class=\"hljs-comment\"\u003e// Sync 详见React类型/常量定义-ReactFiberExpirationTime.js\u003c/span\u003e\r\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eSync\u003c/span\u003e;\r\n  }\r\n\r\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e priorityLevel = \u003cspan class=\"hljs-title function_\"\u003egetCurrentPriorityLevel\u003c/span\u003e();\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e ((mode \u0026#x26; \u003cspan class=\"hljs-title class_\"\u003eConcurrentMode\u003c/span\u003e) === \u003cspan class=\"hljs-title class_\"\u003eNoMode\u003c/span\u003e) {\r\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e priorityLevel === \u003cspan class=\"hljs-title class_\"\u003eImmediatePriority\u003c/span\u003e ? \u003cspan class=\"hljs-title class_\"\u003eSync\u003c/span\u003e : \u003cspan class=\"hljs-title class_\"\u003eBatched\u003c/span\u003e;\r\n  }\r\n\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e ((executionContext \u0026#x26; \u003cspan class=\"hljs-title class_\"\u003eRenderContext\u003c/span\u003e) !== \u003cspan class=\"hljs-title class_\"\u003eNoContext\u003c/span\u003e) {\r\n    \u003cspan class=\"hljs-comment\"\u003e// Use whatever time we're already rendering\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// \u003cspan class=\"hljs-doctag\"\u003eTODO:\u003c/span\u003e Should there be a way to opt out, like with `runWithPriority`?\u003c/span\u003e\r\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e renderExpirationTime;\r\n  }\r\n\r\n  \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e expirationTime;\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (suspenseConfig !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n    \u003cspan class=\"hljs-comment\"\u003e// Compute an expiration time based on the Suspense timeout.\u003c/span\u003e\r\n    expirationTime = \u003cspan class=\"hljs-title function_\"\u003ecomputeSuspenseExpiration\u003c/span\u003e(\r\n      currentTime,\r\n      suspenseConfig.\u003cspan class=\"hljs-property\"\u003etimeoutMs\u003c/span\u003e | \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e || \u003cspan class=\"hljs-variable constant_\"\u003eLOW_PRIORITY_EXPIRATION\u003c/span\u003e,\r\n    );\r\n  } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\r\n    \u003cspan class=\"hljs-comment\"\u003e// Compute an expiration time based on the Scheduler priority.\u003c/span\u003e\r\n    \u003cspan class=\"hljs-keyword\"\u003eswitch\u003c/span\u003e (priorityLevel) {\r\n      \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eImmediatePriority\u003c/span\u003e:\r\n        expirationTime = \u003cspan class=\"hljs-title class_\"\u003eSync\u003c/span\u003e;\r\n        \u003cspan class=\"hljs-keyword\"\u003ebreak\u003c/span\u003e;\r\n      \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eUserBlockingPriority\u003c/span\u003e:\r\n        \u003cspan class=\"hljs-comment\"\u003e// \u003cspan class=\"hljs-doctag\"\u003eTODO:\u003c/span\u003e Rename this to computeUserBlockingExpiration\u003c/span\u003e\r\n        expirationTime = \u003cspan class=\"hljs-title function_\"\u003ecomputeInteractiveExpiration\u003c/span\u003e(currentTime);\r\n        \u003cspan class=\"hljs-keyword\"\u003ebreak\u003c/span\u003e;\r\n      \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eNormalPriority\u003c/span\u003e:\r\n      \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eLowPriority\u003c/span\u003e: \u003cspan class=\"hljs-comment\"\u003e// \u003cspan class=\"hljs-doctag\"\u003eTODO:\u003c/span\u003e Handle LowPriority\u003c/span\u003e\r\n        \u003cspan class=\"hljs-comment\"\u003e// \u003cspan class=\"hljs-doctag\"\u003eTODO:\u003c/span\u003e Rename this to... something better.\u003c/span\u003e\r\n        expirationTime = \u003cspan class=\"hljs-title function_\"\u003ecomputeAsyncExpiration\u003c/span\u003e(currentTime);\r\n        \u003cspan class=\"hljs-keyword\"\u003ebreak\u003c/span\u003e;\r\n      \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eIdlePriority\u003c/span\u003e:\r\n        expirationTime = \u003cspan class=\"hljs-title class_\"\u003eIdle\u003c/span\u003e;\r\n        \u003cspan class=\"hljs-keyword\"\u003ebreak\u003c/span\u003e;\r\n      \u003cspan class=\"hljs-attr\"\u003edefault\u003c/span\u003e:\r\n        \u003cspan class=\"hljs-title function_\"\u003einvariant\u003c/span\u003e(\u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'Expected a valid priority level'\u003c/span\u003e);\r\n    }\r\n  }\r\n\r\n  \u003cspan class=\"hljs-comment\"\u003e// If we're in the middle of rendering a tree, do not update at the same\u003c/span\u003e\r\n  \u003cspan class=\"hljs-comment\"\u003e// expiration time that is already rendering.\u003c/span\u003e\r\n  \u003cspan class=\"hljs-comment\"\u003e// \u003cspan class=\"hljs-doctag\"\u003eTODO:\u003c/span\u003e We shouldn't have to do this if the update is on a different root.\u003c/span\u003e\r\n  \u003cspan class=\"hljs-comment\"\u003e// Refactor computeExpirationForFiber + scheduleUpdate so we have access to\u003c/span\u003e\r\n  \u003cspan class=\"hljs-comment\"\u003e// the root when we check for this condition.\u003c/span\u003e\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (workInProgressRoot !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e \u0026#x26;\u0026#x26; expirationTime === renderExpirationTime) {\r\n    \u003cspan class=\"hljs-comment\"\u003e// This is a trick to move this update into a separate batch\u003c/span\u003e\r\n    expirationTime -= \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e;\r\n  }\r\n\r\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e expirationTime;\r\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch4 id=\"updatecontaineratexpirationtime\"\u003eupdateContainerAtExpirationTime\u003c/h4\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// packages\\react-reconciler\\src\\ReactFiberReconciler.js\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eupdateContainerAtExpirationTime\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\r\n  element: ReactNodeList,\r\n  container: OpaqueRoot,\r\n  parentComponent: ?React$Component\u0026#x3C;any, any\u003e,\r\n  expirationTime: ExpirationTime,\r\n  suspenseConfig: \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e | SuspenseConfig,\r\n  callback: ?\u003cspan class=\"hljs-built_in\"\u003eFunction\u003c/span\u003e,\r\n\u003c/span\u003e) {\r\n  \u003cspan class=\"hljs-comment\"\u003e// \u003cspan class=\"hljs-doctag\"\u003eTODO:\u003c/span\u003e If this is a nested container, this won't be the root.\u003c/span\u003e\r\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e current = container.\u003cspan class=\"hljs-property\"\u003ecurrent\u003c/span\u003e;\r\n\r\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e context = \u003cspan class=\"hljs-title function_\"\u003egetContextForSubtree\u003c/span\u003e(parentComponent);\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (container.\u003cspan class=\"hljs-property\"\u003econtext\u003c/span\u003e === \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n    container.\u003cspan class=\"hljs-property\"\u003econtext\u003c/span\u003e = context;\r\n  } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\r\n    container.\u003cspan class=\"hljs-property\"\u003ependingContext\u003c/span\u003e = context;\r\n  }\r\n\r\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003escheduleRootUpdate\u003c/span\u003e(\r\n    current,\r\n    element,\r\n    expirationTime,\r\n    suspenseConfig,\r\n    callback,\r\n  );\r\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch5 id=\"getcontextforsubtree\"\u003egetContextForSubtree\u003c/h5\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// packages\\react-reconciler\\src\\ReactFiberReconciler.js\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003egetContextForSubtree\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\r\n  parentComponent: ?React$Component\u0026#x3C;any, any\u003e,\r\n\u003c/span\u003e): \u003cspan class=\"hljs-title class_\"\u003eObject\u003c/span\u003e {\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (!parentComponent) {\r\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e emptyContextObject;\r\n  }\r\n  \u003cspan class=\"hljs-comment\"\u003e// 此处取的是parentComponent._reactInternalFiber\u003c/span\u003e\r\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e fiber = \u003cspan class=\"hljs-title function_\"\u003egetInstance\u003c/span\u003e(parentComponent);\r\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e parentContext = \u003cspan class=\"hljs-title function_\"\u003efindCurrentUnmaskedContext\u003c/span\u003e(fiber);\r\n\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (fiber.\u003cspan class=\"hljs-property\"\u003etag\u003c/span\u003e === \u003cspan class=\"hljs-title class_\"\u003eClassComponent\u003c/span\u003e) {\r\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eComponent\u003c/span\u003e = fiber.\u003cspan class=\"hljs-property\"\u003etype\u003c/span\u003e;\r\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (\u003cspan class=\"hljs-title function_\"\u003eisLegacyContextProvider\u003c/span\u003e(\u003cspan class=\"hljs-title class_\"\u003eComponent\u003c/span\u003e)) {\r\n      \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eprocessChildContext\u003c/span\u003e(fiber, \u003cspan class=\"hljs-title class_\"\u003eComponent\u003c/span\u003e, parentContext);\r\n    }\r\n  }\r\n\r\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e parentContext;\r\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch5 id=\"findcurrentunmaskedcontext\"\u003efindCurrentUnmaskedContext\u003c/h5\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// packages\\react-reconciler\\src\\ReactFiberContext.js\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003efindCurrentUnmaskedContext\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003efiber: Fiber\u003c/span\u003e): \u003cspan class=\"hljs-title class_\"\u003eObject\u003c/span\u003e {\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (disableLegacyContext) {\r\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e emptyContextObject;\r\n  } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\r\n\r\n    \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e node = fiber;\r\n    \u003cspan class=\"hljs-keyword\"\u003edo\u003c/span\u003e {\r\n      \u003cspan class=\"hljs-keyword\"\u003eswitch\u003c/span\u003e (node.\u003cspan class=\"hljs-property\"\u003etag\u003c/span\u003e) {\r\n        \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eHostRoot\u003c/span\u003e:\r\n          \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e node.\u003cspan class=\"hljs-property\"\u003estateNode\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003econtext\u003c/span\u003e;\r\n        \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eClassComponent\u003c/span\u003e: {\r\n          \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eComponent\u003c/span\u003e = node.\u003cspan class=\"hljs-property\"\u003etype\u003c/span\u003e;\r\n          \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (\u003cspan class=\"hljs-title function_\"\u003eisContextProvider\u003c/span\u003e(\u003cspan class=\"hljs-title class_\"\u003eComponent\u003c/span\u003e)) {\r\n            \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e node.\u003cspan class=\"hljs-property\"\u003estateNode\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003e__reactInternalMemoizedMergedChildContext\u003c/span\u003e;\r\n          }\r\n          \u003cspan class=\"hljs-keyword\"\u003ebreak\u003c/span\u003e;\r\n        }\r\n      }\r\n      node = node.\u003cspan class=\"hljs-property\"\u003ereturn\u003c/span\u003e;\r\n    } \u003cspan class=\"hljs-keyword\"\u003ewhile\u003c/span\u003e (node !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e);\r\n  }\r\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch4 id=\"schedulerootupdate\"\u003escheduleRootUpdate\u003c/h4\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// packages\\react-reconciler\\src\\ReactFiberReconciler.js\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003escheduleRootUpdate\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\r\n  current: Fiber,\r\n  element: ReactNodeList,\r\n  expirationTime: ExpirationTime,\r\n  suspenseConfig: \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e | SuspenseConfig,\r\n  callback: ?\u003cspan class=\"hljs-built_in\"\u003eFunction\u003c/span\u003e,\r\n\u003c/span\u003e) {\r\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e update = \u003cspan class=\"hljs-title function_\"\u003ecreateUpdate\u003c/span\u003e(expirationTime, suspenseConfig);\r\n  \u003cspan class=\"hljs-comment\"\u003e// Caution: React DevTools currently depends on this property\u003c/span\u003e\r\n  \u003cspan class=\"hljs-comment\"\u003e// being called \"element\".\u003c/span\u003e\r\n  update.\u003cspan class=\"hljs-property\"\u003epayload\u003c/span\u003e = {element};\r\n\r\n  callback = callback === \u003cspan class=\"hljs-literal\"\u003eundefined\u003c/span\u003e ? \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e : callback;\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (callback !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n    \u003cspan class=\"hljs-title function_\"\u003ewarningWithoutStack\u003c/span\u003e(\r\n      \u003cspan class=\"hljs-keyword\"\u003etypeof\u003c/span\u003e callback === \u003cspan class=\"hljs-string\"\u003e'function'\u003c/span\u003e,\r\n      \u003cspan class=\"hljs-string\"\u003e'render(...): Expected the last optional `callback` argument to be a '\u003c/span\u003e +\r\n        \u003cspan class=\"hljs-string\"\u003e'function. Instead received: %s.'\u003c/span\u003e,\r\n      callback,\r\n    );\r\n    update.\u003cspan class=\"hljs-property\"\u003ecallback\u003c/span\u003e = callback;\r\n  }\r\n\r\n  \u003cspan class=\"hljs-title function_\"\u003eenqueueUpdate\u003c/span\u003e(current, update);\r\n  \u003cspan class=\"hljs-title function_\"\u003escheduleWork\u003c/span\u003e(current, expirationTime);\r\n\r\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e expirationTime;\r\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch5 id=\"createupdate\"\u003ecreateUpdate\u003c/h5\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// packages\\react-reconciler\\src\\ReactUpdateQueue.js\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003ecreateUpdate\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\r\n  expirationTime: ExpirationTime,\r\n  suspenseConfig: \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e | SuspenseConfig,\r\n\u003c/span\u003e): \u003cspan class=\"hljs-title class_\"\u003eUpdate\u003c/span\u003e\u0026#x3C;*\u003e {\r\n  \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003eupdate\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eUpdate\u003c/span\u003e\u0026#x3C;*\u003e = {\r\n    expirationTime,\r\n    suspenseConfig,\r\n\r\n    \u003cspan class=\"hljs-attr\"\u003etag\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eUpdateState\u003c/span\u003e,\r\n    \u003cspan class=\"hljs-attr\"\u003epayload\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e,\r\n    \u003cspan class=\"hljs-attr\"\u003ecallback\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e,\r\n\r\n    \u003cspan class=\"hljs-attr\"\u003enext\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e,\r\n    \u003cspan class=\"hljs-attr\"\u003enextEffect\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e,\r\n  };\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (__DEV__) {\r\n    update.\u003cspan class=\"hljs-property\"\u003epriority\u003c/span\u003e = \u003cspan class=\"hljs-title function_\"\u003egetCurrentPriorityLevel\u003c/span\u003e();\r\n  }\r\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e update;\r\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch5 id=\"enqueueupdate\"\u003eenqueueUpdate\u003c/h5\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// packages\\react-reconciler\\src\\ReactUpdateQueue.js\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e enqueueUpdate\u0026#x3C;\u003cspan class=\"hljs-title class_\"\u003eState\u003c/span\u003e\u003e(\u003cspan class=\"hljs-attr\"\u003efiber\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eFiber\u003c/span\u003e, \u003cspan class=\"hljs-attr\"\u003eupdate\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eUpdate\u003c/span\u003e\u0026#x3C;\u003cspan class=\"hljs-title class_\"\u003eState\u003c/span\u003e\u003e) {\r\n  \u003cspan class=\"hljs-comment\"\u003e// Update queues are created lazily.\u003c/span\u003e\r\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e alternate = fiber.\u003cspan class=\"hljs-property\"\u003ealternate\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e queue1;\r\n  \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e queue2;\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (alternate === \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n    \u003cspan class=\"hljs-comment\"\u003e// There's only one fiber.\u003c/span\u003e\r\n    queue1 = fiber.\u003cspan class=\"hljs-property\"\u003eupdateQueue\u003c/span\u003e;\r\n    queue2 = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (queue1 === \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n      queue1 = fiber.\u003cspan class=\"hljs-property\"\u003eupdateQueue\u003c/span\u003e = \u003cspan class=\"hljs-title function_\"\u003ecreateUpdateQueue\u003c/span\u003e(fiber.\u003cspan class=\"hljs-property\"\u003ememoizedState\u003c/span\u003e);\r\n    }\r\n  } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\r\n    \u003cspan class=\"hljs-comment\"\u003e// There are two owners.\u003c/span\u003e\r\n    queue1 = fiber.\u003cspan class=\"hljs-property\"\u003eupdateQueue\u003c/span\u003e;\r\n    queue2 = alternate.\u003cspan class=\"hljs-property\"\u003eupdateQueue\u003c/span\u003e;\r\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (queue1 === \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (queue2 === \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n        \u003cspan class=\"hljs-comment\"\u003e// Neither fiber has an update queue. Create new ones.\u003c/span\u003e\r\n        queue1 = fiber.\u003cspan class=\"hljs-property\"\u003eupdateQueue\u003c/span\u003e = \u003cspan class=\"hljs-title function_\"\u003ecreateUpdateQueue\u003c/span\u003e(fiber.\u003cspan class=\"hljs-property\"\u003ememoizedState\u003c/span\u003e);\r\n        queue2 = alternate.\u003cspan class=\"hljs-property\"\u003eupdateQueue\u003c/span\u003e = \u003cspan class=\"hljs-title function_\"\u003ecreateUpdateQueue\u003c/span\u003e(\r\n          alternate.\u003cspan class=\"hljs-property\"\u003ememoizedState\u003c/span\u003e,\r\n        );\r\n      } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\r\n        \u003cspan class=\"hljs-comment\"\u003e// Only one fiber has an update queue. Clone to create a new one.\u003c/span\u003e\r\n        queue1 = fiber.\u003cspan class=\"hljs-property\"\u003eupdateQueue\u003c/span\u003e = \u003cspan class=\"hljs-title function_\"\u003ecloneUpdateQueue\u003c/span\u003e(queue2);\r\n      }\r\n    } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\r\n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (queue2 === \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n        \u003cspan class=\"hljs-comment\"\u003e// Only one fiber has an update queue. Clone to create a new one.\u003c/span\u003e\r\n        queue2 = alternate.\u003cspan class=\"hljs-property\"\u003eupdateQueue\u003c/span\u003e = \u003cspan class=\"hljs-title function_\"\u003ecloneUpdateQueue\u003c/span\u003e(queue1);\r\n      } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\r\n        \u003cspan class=\"hljs-comment\"\u003e// Both owners have an update queue.\u003c/span\u003e\r\n      }\r\n    }\r\n  }\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (queue2 === \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e || queue1 === queue2) {\r\n    \u003cspan class=\"hljs-comment\"\u003e// There's only a single queue.\u003c/span\u003e\r\n    \u003cspan class=\"hljs-title function_\"\u003eappendUpdateToQueue\u003c/span\u003e(queue1, update);\r\n  } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\r\n    \u003cspan class=\"hljs-comment\"\u003e// There are two queues. We need to append the update to both queues,\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// while accounting for the persistent structure of the list — we don't\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// want the same update to be added multiple times.\u003c/span\u003e\r\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (queue1.\u003cspan class=\"hljs-property\"\u003elastUpdate\u003c/span\u003e === \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e || queue2.\u003cspan class=\"hljs-property\"\u003elastUpdate\u003c/span\u003e === \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n      \u003cspan class=\"hljs-comment\"\u003e// One of the queues is not empty. We must add the update to both queues.\u003c/span\u003e\r\n      \u003cspan class=\"hljs-title function_\"\u003eappendUpdateToQueue\u003c/span\u003e(queue1, update);\r\n      \u003cspan class=\"hljs-title function_\"\u003eappendUpdateToQueue\u003c/span\u003e(queue2, update);\r\n    } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\r\n      \u003cspan class=\"hljs-comment\"\u003e// Both queues are non-empty. The last update is the same in both lists,\u003c/span\u003e\r\n      \u003cspan class=\"hljs-comment\"\u003e// because of structural sharing. So, only append to one of the lists.\u003c/span\u003e\r\n      \u003cspan class=\"hljs-title function_\"\u003eappendUpdateToQueue\u003c/span\u003e(queue1, update);\r\n      \u003cspan class=\"hljs-comment\"\u003e// But we still need to update the `lastUpdate` pointer of queue2.\u003c/span\u003e\r\n      queue2.\u003cspan class=\"hljs-property\"\u003elastUpdate\u003c/span\u003e = update;\r\n    }\r\n  }\r\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch6 id=\"createupdatequeue\"\u003ecreateUpdateQueue\u003c/h6\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// packages\\react-reconciler\\src\\ReactUpdateQueue.js\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e createUpdateQueue\u0026#x3C;\u003cspan class=\"hljs-title class_\"\u003eState\u003c/span\u003e\u003e(\u003cspan class=\"hljs-attr\"\u003ebaseState\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eState\u003c/span\u003e): \u003cspan class=\"hljs-title class_\"\u003eUpdateQueue\u003c/span\u003e\u0026#x3C;\u003cspan class=\"hljs-title class_\"\u003eState\u003c/span\u003e\u003e {\r\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003equeue\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eUpdateQueue\u003c/span\u003e\u0026#x3C;\u003cspan class=\"hljs-title class_\"\u003eState\u003c/span\u003e\u003e = {\r\n    baseState,\r\n    \u003cspan class=\"hljs-attr\"\u003efirstUpdate\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e,\r\n    \u003cspan class=\"hljs-attr\"\u003elastUpdate\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e,\r\n    \u003cspan class=\"hljs-attr\"\u003efirstCapturedUpdate\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e,\r\n    \u003cspan class=\"hljs-attr\"\u003elastCapturedUpdate\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e,\r\n    \u003cspan class=\"hljs-attr\"\u003efirstEffect\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e,\r\n    \u003cspan class=\"hljs-attr\"\u003elastEffect\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e,\r\n    \u003cspan class=\"hljs-attr\"\u003efirstCapturedEffect\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e,\r\n    \u003cspan class=\"hljs-attr\"\u003elastCapturedEffect\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e,\r\n  };\r\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e queue;\r\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch6 id=\"cloneupdatequeue\"\u003ecloneUpdateQueue\u003c/h6\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// packages\\react-reconciler\\src\\ReactUpdateQueue.js\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e cloneUpdateQueue\u0026#x3C;\u003cspan class=\"hljs-title class_\"\u003eState\u003c/span\u003e\u003e(\r\n  \u003cspan class=\"hljs-attr\"\u003ecurrentQueue\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eUpdateQueue\u003c/span\u003e\u0026#x3C;\u003cspan class=\"hljs-title class_\"\u003eState\u003c/span\u003e\u003e,\r\n): \u003cspan class=\"hljs-title class_\"\u003eUpdateQueue\u003c/span\u003e\u0026#x3C;\u003cspan class=\"hljs-title class_\"\u003eState\u003c/span\u003e\u003e {\r\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003equeue\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eUpdateQueue\u003c/span\u003e\u0026#x3C;\u003cspan class=\"hljs-title class_\"\u003eState\u003c/span\u003e\u003e = {\r\n    \u003cspan class=\"hljs-attr\"\u003ebaseState\u003c/span\u003e: currentQueue.\u003cspan class=\"hljs-property\"\u003ebaseState\u003c/span\u003e,\r\n    \u003cspan class=\"hljs-attr\"\u003efirstUpdate\u003c/span\u003e: currentQueue.\u003cspan class=\"hljs-property\"\u003efirstUpdate\u003c/span\u003e,\r\n    \u003cspan class=\"hljs-attr\"\u003elastUpdate\u003c/span\u003e: currentQueue.\u003cspan class=\"hljs-property\"\u003elastUpdate\u003c/span\u003e,\r\n\r\n    \u003cspan class=\"hljs-comment\"\u003e// \u003cspan class=\"hljs-doctag\"\u003eTODO:\u003c/span\u003e With resuming, if we bail out and resuse the child tree, we should\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// keep these effects.\u003c/span\u003e\r\n    \u003cspan class=\"hljs-attr\"\u003efirstCapturedUpdate\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e,\r\n    \u003cspan class=\"hljs-attr\"\u003elastCapturedUpdate\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e,\r\n\r\n    \u003cspan class=\"hljs-attr\"\u003efirstEffect\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e,\r\n    \u003cspan class=\"hljs-attr\"\u003elastEffect\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e,\r\n\r\n    \u003cspan class=\"hljs-attr\"\u003efirstCapturedEffect\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e,\r\n    \u003cspan class=\"hljs-attr\"\u003elastCapturedEffect\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e,\r\n  };\r\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e queue;\r\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch6 id=\"appendupdatetoqueue\"\u003eappendUpdateToQueue\u003c/h6\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// packages\\react-reconciler\\src\\ReactUpdateQueue.js\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e appendUpdateToQueue\u0026#x3C;\u003cspan class=\"hljs-title class_\"\u003eState\u003c/span\u003e\u003e(\r\n  \u003cspan class=\"hljs-attr\"\u003equeue\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eUpdateQueue\u003c/span\u003e\u0026#x3C;\u003cspan class=\"hljs-title class_\"\u003eState\u003c/span\u003e\u003e,\r\n  \u003cspan class=\"hljs-attr\"\u003eupdate\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eUpdate\u003c/span\u003e\u0026#x3C;\u003cspan class=\"hljs-title class_\"\u003eState\u003c/span\u003e\u003e,\r\n) {\r\n  \u003cspan class=\"hljs-comment\"\u003e// Append the update to the end of the list.\u003c/span\u003e\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (queue.\u003cspan class=\"hljs-property\"\u003elastUpdate\u003c/span\u003e === \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n    \u003cspan class=\"hljs-comment\"\u003e// Queue is empty\u003c/span\u003e\r\n    queue.\u003cspan class=\"hljs-property\"\u003efirstUpdate\u003c/span\u003e = queue.\u003cspan class=\"hljs-property\"\u003elastUpdate\u003c/span\u003e = update;\r\n  } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\r\n    queue.\u003cspan class=\"hljs-property\"\u003elastUpdate\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003enext\u003c/span\u003e = update;\r\n    queue.\u003cspan class=\"hljs-property\"\u003elastUpdate\u003c/span\u003e = update;\r\n  }\r\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch4 id=\"schedulework\"\u003escheduleWork\u003c/h4\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// packages\\react-reconciler\\src\\ReactFiberWorkLoop.js\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003escheduleUpdateOnFiber\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\r\n  fiber: Fiber,\r\n  expirationTime: ExpirationTime,\r\n\u003c/span\u003e) {\r\n  \u003cspan class=\"hljs-title function_\"\u003echeckForNestedUpdates\u003c/span\u003e();\r\n  \u003cspan class=\"hljs-title function_\"\u003ewarnAboutInvalidUpdatesOnClassComponentsInDEV\u003c/span\u003e(fiber);\r\n\r\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e root = \u003cspan class=\"hljs-title function_\"\u003emarkUpdateTimeFromFiberToRoot\u003c/span\u003e(fiber, expirationTime);\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (root === \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n    \u003cspan class=\"hljs-title function_\"\u003ewarnAboutUpdateOnUnmountedFiberInDEV\u003c/span\u003e(fiber);\r\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e;\r\n  }\r\n\r\n  \u003cspan class=\"hljs-title function_\"\u003echeckForInterruption\u003c/span\u003e(fiber, expirationTime);\r\n  \u003cspan class=\"hljs-title function_\"\u003erecordScheduleUpdate\u003c/span\u003e();\r\n\r\n  \u003cspan class=\"hljs-comment\"\u003e// \u003cspan class=\"hljs-doctag\"\u003eTODO:\u003c/span\u003e computeExpirationForFiber also reads the priority. Pass the\u003c/span\u003e\r\n  \u003cspan class=\"hljs-comment\"\u003e// priority as an argument to that function and this one.\u003c/span\u003e\r\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e priorityLevel = \u003cspan class=\"hljs-title function_\"\u003egetCurrentPriorityLevel\u003c/span\u003e();\r\n\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (expirationTime === \u003cspan class=\"hljs-title class_\"\u003eSync\u003c/span\u003e) {\r\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (\r\n      \u003cspan class=\"hljs-comment\"\u003e// Check if we're inside unbatchedUpdates\u003c/span\u003e\r\n      (executionContext \u0026#x26; \u003cspan class=\"hljs-title class_\"\u003eLegacyUnbatchedContext\u003c/span\u003e) !== \u003cspan class=\"hljs-title class_\"\u003eNoContext\u003c/span\u003e \u0026#x26;\u0026#x26;\r\n      \u003cspan class=\"hljs-comment\"\u003e// Check if we're not already rendering\u003c/span\u003e\r\n      (executionContext \u0026#x26; (\u003cspan class=\"hljs-title class_\"\u003eRenderContext\u003c/span\u003e | \u003cspan class=\"hljs-title class_\"\u003eCommitContext\u003c/span\u003e)) === \u003cspan class=\"hljs-title class_\"\u003eNoContext\u003c/span\u003e\r\n    ) {\r\n      \u003cspan class=\"hljs-comment\"\u003e// Register pending interactions on the root to avoid losing traced interaction data.\u003c/span\u003e\r\n      \u003cspan class=\"hljs-title function_\"\u003eschedulePendingInteractions\u003c/span\u003e(root, expirationTime);\r\n\r\n      \u003cspan class=\"hljs-comment\"\u003e// This is a legacy edge case. The initial mount of a ReactDOM.render-ed\u003c/span\u003e\r\n      \u003cspan class=\"hljs-comment\"\u003e// root inside of batchedUpdates should be synchronous, but layout updates\u003c/span\u003e\r\n      \u003cspan class=\"hljs-comment\"\u003e// should be deferred until the end of the batch.\u003c/span\u003e\r\n      \u003cspan class=\"hljs-title function_\"\u003eperformSyncWorkOnRoot\u003c/span\u003e(root);\r\n    } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\r\n      \u003cspan class=\"hljs-title function_\"\u003eensureRootIsScheduled\u003c/span\u003e(root);\r\n      \u003cspan class=\"hljs-title function_\"\u003eschedulePendingInteractions\u003c/span\u003e(root, expirationTime);\r\n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (executionContext === \u003cspan class=\"hljs-title class_\"\u003eNoContext\u003c/span\u003e) {\r\n        \u003cspan class=\"hljs-comment\"\u003e// Flush the synchronous work now, unless we're already working or inside\u003c/span\u003e\r\n        \u003cspan class=\"hljs-comment\"\u003e// a batch. This is intentionally inside scheduleUpdateOnFiber instead of\u003c/span\u003e\r\n        \u003cspan class=\"hljs-comment\"\u003e// scheduleCallbackForFiber to preserve the ability to schedule a callback\u003c/span\u003e\r\n        \u003cspan class=\"hljs-comment\"\u003e// without immediately flushing it. We only do this for user-initiated\u003c/span\u003e\r\n        \u003cspan class=\"hljs-comment\"\u003e// updates, to preserve historical behavior of sync mode.\u003c/span\u003e\r\n        \u003cspan class=\"hljs-title function_\"\u003eflushSyncCallbackQueue\u003c/span\u003e();\r\n      }\r\n    }\r\n  } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\r\n    \u003cspan class=\"hljs-title function_\"\u003eensureRootIsScheduled\u003c/span\u003e(root);\r\n    \u003cspan class=\"hljs-title function_\"\u003eschedulePendingInteractions\u003c/span\u003e(root, expirationTime);\r\n  }\r\n\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (\r\n    (executionContext \u0026#x26; \u003cspan class=\"hljs-title class_\"\u003eDiscreteEventContext\u003c/span\u003e) !== \u003cspan class=\"hljs-title class_\"\u003eNoContext\u003c/span\u003e \u0026#x26;\u0026#x26;\r\n    \u003cspan class=\"hljs-comment\"\u003e// Only updates at user-blocking priority or greater are considered\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// discrete, even inside a discrete event.\u003c/span\u003e\r\n    (priorityLevel === \u003cspan class=\"hljs-title class_\"\u003eUserBlockingPriority\u003c/span\u003e ||\r\n      priorityLevel === \u003cspan class=\"hljs-title class_\"\u003eImmediatePriority\u003c/span\u003e)\r\n  ) {\r\n    \u003cspan class=\"hljs-comment\"\u003e// This is the result of a discrete event. Track the lowest priority\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// discrete update per root so we can flush them early, if needed.\u003c/span\u003e\r\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (rootsWithPendingDiscreteUpdates === \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n      rootsWithPendingDiscreteUpdates = \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eMap\u003c/span\u003e([[root, expirationTime]]);\r\n    } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\r\n      \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e lastDiscreteTime = rootsWithPendingDiscreteUpdates.\u003cspan class=\"hljs-title function_\"\u003eget\u003c/span\u003e(root);\r\n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (lastDiscreteTime === \u003cspan class=\"hljs-literal\"\u003eundefined\u003c/span\u003e || lastDiscreteTime \u003e expirationTime) {\r\n        rootsWithPendingDiscreteUpdates.\u003cspan class=\"hljs-title function_\"\u003eset\u003c/span\u003e(root, expirationTime);\r\n      }\r\n    }\r\n  }\r\n}\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e scheduleWork = scheduleUpdateOnFiber;\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch6 id=\"checkfornestedupdates\"\u003echeckForNestedUpdates\u003c/h6\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// packages\\react-reconciler\\src\\ReactFiberWorkLoop.js\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003echeckForNestedUpdates\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\u003c/span\u003e) {\r\n  \u003cspan class=\"hljs-comment\"\u003e// nestedUpdateCount默认为0\u003c/span\u003e\r\n  \u003cspan class=\"hljs-comment\"\u003e// NESTED_UPDATE_LIMIT = 50\u003c/span\u003e\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (nestedUpdateCount \u003e \u003cspan class=\"hljs-variable constant_\"\u003eNESTED_UPDATE_LIMIT\u003c/span\u003e) {\r\n    nestedUpdateCount = \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e;\r\n    rootWithNestedUpdates = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n  }\r\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch6 id=\"markupdatetimefromfibertoroot\"\u003emarkUpdateTimeFromFiberToRoot\u003c/h6\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// packages\\react-reconciler\\src\\ReactFiberWorkLoop.js\u003c/span\u003e\r\n\r\n\u003cspan class=\"hljs-comment\"\u003e// This is split into a separate function so we can mark a fiber with pending\u003c/span\u003e\r\n\u003cspan class=\"hljs-comment\"\u003e// work without treating it as a typical update that originates from an event;\u003c/span\u003e\r\n\u003cspan class=\"hljs-comment\"\u003e// e.g. retrying a Suspense boundary isn't an update, but it does schedule work\u003c/span\u003e\r\n\u003cspan class=\"hljs-comment\"\u003e// on a fiber.\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003emarkUpdateTimeFromFiberToRoot\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003efiber, expirationTime\u003c/span\u003e) {\r\n  \u003cspan class=\"hljs-comment\"\u003e// Update the source fiber's expiration time\u003c/span\u003e\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (fiber.\u003cspan class=\"hljs-property\"\u003eexpirationTime\u003c/span\u003e \u0026#x3C; expirationTime) {\r\n    fiber.\u003cspan class=\"hljs-property\"\u003eexpirationTime\u003c/span\u003e = expirationTime;\r\n  }\r\n  \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e alternate = fiber.\u003cspan class=\"hljs-property\"\u003ealternate\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (alternate !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e \u0026#x26;\u0026#x26; alternate.\u003cspan class=\"hljs-property\"\u003eexpirationTime\u003c/span\u003e \u0026#x3C; expirationTime) {\r\n    alternate.\u003cspan class=\"hljs-property\"\u003eexpirationTime\u003c/span\u003e = expirationTime;\r\n  }\r\n  \u003cspan class=\"hljs-comment\"\u003e// Walk the parent path to the root and update the child expiration time.\u003c/span\u003e\r\n  \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e node = fiber.\u003cspan class=\"hljs-property\"\u003ereturn\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e root = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (node === \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e \u0026#x26;\u0026#x26; fiber.\u003cspan class=\"hljs-property\"\u003etag\u003c/span\u003e === \u003cspan class=\"hljs-title class_\"\u003eHostRoot\u003c/span\u003e) {\r\n    root = fiber.\u003cspan class=\"hljs-property\"\u003estateNode\u003c/span\u003e;\r\n  } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\r\n    \u003cspan class=\"hljs-keyword\"\u003ewhile\u003c/span\u003e (node !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n      alternate = node.\u003cspan class=\"hljs-property\"\u003ealternate\u003c/span\u003e;\r\n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (node.\u003cspan class=\"hljs-property\"\u003echildExpirationTime\u003c/span\u003e \u0026#x3C; expirationTime) {\r\n        node.\u003cspan class=\"hljs-property\"\u003echildExpirationTime\u003c/span\u003e = expirationTime;\r\n        \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (\r\n          alternate !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e \u0026#x26;\u0026#x26;\r\n          alternate.\u003cspan class=\"hljs-property\"\u003echildExpirationTime\u003c/span\u003e \u0026#x3C; expirationTime\r\n        ) {\r\n          alternate.\u003cspan class=\"hljs-property\"\u003echildExpirationTime\u003c/span\u003e = expirationTime;\r\n        }\r\n      } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (\r\n        alternate !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e \u0026#x26;\u0026#x26;\r\n        alternate.\u003cspan class=\"hljs-property\"\u003echildExpirationTime\u003c/span\u003e \u0026#x3C; expirationTime\r\n      ) {\r\n        alternate.\u003cspan class=\"hljs-property\"\u003echildExpirationTime\u003c/span\u003e = expirationTime;\r\n      }\r\n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (node.\u003cspan class=\"hljs-property\"\u003ereturn\u003c/span\u003e === \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e \u0026#x26;\u0026#x26; node.\u003cspan class=\"hljs-property\"\u003etag\u003c/span\u003e === \u003cspan class=\"hljs-title class_\"\u003eHostRoot\u003c/span\u003e) {\r\n        root = node.\u003cspan class=\"hljs-property\"\u003estateNode\u003c/span\u003e;\r\n        \u003cspan class=\"hljs-keyword\"\u003ebreak\u003c/span\u003e;\r\n      }\r\n      node = node.\u003cspan class=\"hljs-property\"\u003ereturn\u003c/span\u003e;\r\n    }\r\n  }\r\n\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (root !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (workInProgressRoot === root) {\r\n      \u003cspan class=\"hljs-comment\"\u003e// Received an update to a tree that's in the middle of rendering. Mark\u003c/span\u003e\r\n      \u003cspan class=\"hljs-comment\"\u003e// that's unprocessed work on this root.\u003c/span\u003e\r\n      \u003cspan class=\"hljs-title function_\"\u003emarkUnprocessedUpdateTime\u003c/span\u003e(expirationTime);\r\n\r\n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (workInProgressRootExitStatus === \u003cspan class=\"hljs-title class_\"\u003eRootSuspendedWithDelay\u003c/span\u003e) {\r\n        \u003cspan class=\"hljs-comment\"\u003e// The root already suspended with a delay, which means this render\u003c/span\u003e\r\n        \u003cspan class=\"hljs-comment\"\u003e// definitely won't finish. Since we have a new update, let's mark it as\u003c/span\u003e\r\n        \u003cspan class=\"hljs-comment\"\u003e// suspended now, right before marking the incoming update. This has the\u003c/span\u003e\r\n        \u003cspan class=\"hljs-comment\"\u003e// effect of interrupting the current render and switching to the update.\u003c/span\u003e\r\n        \u003cspan class=\"hljs-comment\"\u003e// \u003cspan class=\"hljs-doctag\"\u003eTODO:\u003c/span\u003e This happens to work when receiving an update during the render\u003c/span\u003e\r\n        \u003cspan class=\"hljs-comment\"\u003e// phase, because of the trick inside computeExpirationForFiber to\u003c/span\u003e\r\n        \u003cspan class=\"hljs-comment\"\u003e// subtract 1 from `renderExpirationTime` to move it into a\u003c/span\u003e\r\n        \u003cspan class=\"hljs-comment\"\u003e// separate bucket. But we should probably model it with an exception,\u003c/span\u003e\r\n        \u003cspan class=\"hljs-comment\"\u003e// using the same mechanism we use to force hydration of a subtree.\u003c/span\u003e\r\n        \u003cspan class=\"hljs-comment\"\u003e// \u003cspan class=\"hljs-doctag\"\u003eTODO:\u003c/span\u003e This does not account for low pri updates that were already\u003c/span\u003e\r\n        \u003cspan class=\"hljs-comment\"\u003e// scheduled before the root started rendering. Need to track the next\u003c/span\u003e\r\n        \u003cspan class=\"hljs-comment\"\u003e// pending expiration time (perhaps by backtracking the return path) and\u003c/span\u003e\r\n        \u003cspan class=\"hljs-comment\"\u003e// then trigger a restart in the `renderDidSuspendDelayIfPossible` path.\u003c/span\u003e\r\n        \u003cspan class=\"hljs-title function_\"\u003emarkRootSuspendedAtTime\u003c/span\u003e(root, renderExpirationTime);\r\n      }\r\n    }\r\n    \u003cspan class=\"hljs-comment\"\u003e// Mark that the root has a pending update.\u003c/span\u003e\r\n    \u003cspan class=\"hljs-title function_\"\u003emarkRootUpdatedAtTime\u003c/span\u003e(root, expirationTime);\r\n  }\r\n\r\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e root;\r\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003emarkUnprocessedUpdateTime\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// packages\\react-reconciler\\src\\ReactFiberWorkLoop.js\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003emarkUnprocessedUpdateTime\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\r\n  expirationTime: ExpirationTime,\r\n\u003c/span\u003e): \u003cspan class=\"hljs-keyword\"\u003evoid\u003c/span\u003e {\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (expirationTime \u003e workInProgressRootNextUnprocessedUpdateTime) {\r\n    workInProgressRootNextUnprocessedUpdateTime = expirationTime;\r\n  }\r\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003emarkRootUpdatedAtTime\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// packages\\react-reconciler\\src\\ReactFiberRoot.js\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003emarkRootUpdatedAtTime\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\r\n  root: FiberRoot,\r\n  expirationTime: ExpirationTime,\r\n\u003c/span\u003e): \u003cspan class=\"hljs-keyword\"\u003evoid\u003c/span\u003e {\r\n  \u003cspan class=\"hljs-comment\"\u003e// Update the range of pending times\u003c/span\u003e\r\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e firstPendingTime = root.\u003cspan class=\"hljs-property\"\u003efirstPendingTime\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (expirationTime \u003e firstPendingTime) {\r\n    root.\u003cspan class=\"hljs-property\"\u003efirstPendingTime\u003c/span\u003e = expirationTime;\r\n  }\r\n\r\n  \u003cspan class=\"hljs-comment\"\u003e// Update the range of suspended times. Treat everything lower priority or\u003c/span\u003e\r\n  \u003cspan class=\"hljs-comment\"\u003e// equal to this update as unsuspended.\u003c/span\u003e\r\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e firstSuspendedTime = root.\u003cspan class=\"hljs-property\"\u003efirstSuspendedTime\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (firstSuspendedTime !== \u003cspan class=\"hljs-title class_\"\u003eNoWork\u003c/span\u003e) {\r\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (expirationTime \u003e= firstSuspendedTime) {\r\n      \u003cspan class=\"hljs-comment\"\u003e// The entire suspended range is now unsuspended.\u003c/span\u003e\r\n      root.\u003cspan class=\"hljs-property\"\u003efirstSuspendedTime\u003c/span\u003e = root.\u003cspan class=\"hljs-property\"\u003elastSuspendedTime\u003c/span\u003e = root.\u003cspan class=\"hljs-property\"\u003enextKnownPendingLevel\u003c/span\u003e = \u003cspan class=\"hljs-title class_\"\u003eNoWork\u003c/span\u003e;\r\n    } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (expirationTime \u003e= root.\u003cspan class=\"hljs-property\"\u003elastSuspendedTime\u003c/span\u003e) {\r\n      root.\u003cspan class=\"hljs-property\"\u003elastSuspendedTime\u003c/span\u003e = expirationTime + \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e;\r\n    }\r\n\r\n    \u003cspan class=\"hljs-comment\"\u003e// This is a pending level. Check if it's higher priority than the next\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// known pending level.\u003c/span\u003e\r\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (expirationTime \u003e root.\u003cspan class=\"hljs-property\"\u003enextKnownPendingLevel\u003c/span\u003e) {\r\n      root.\u003cspan class=\"hljs-property\"\u003enextKnownPendingLevel\u003c/span\u003e = expirationTime;\r\n    }\r\n  }\r\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch6 id=\"checkforinterruption\"\u003echeckForInterruption\u003c/h6\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// packages\\react-reconciler\\src\\ReactFiberWorkLoop.js\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003echeckForInterruption\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\r\n  fiberThatReceivedUpdate: Fiber,\r\n  updateExpirationTime: ExpirationTime,\r\n\u003c/span\u003e) {\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (\r\n    enableUserTimingAPI \u0026#x26;\u0026#x26;\r\n    workInProgressRoot !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e \u0026#x26;\u0026#x26;\r\n    updateExpirationTime \u003e renderExpirationTime\r\n  ) {\r\n    interruptedBy = fiberThatReceivedUpdate;\r\n  }\r\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch6 id=\"recordscheduleupdate\"\u003erecordScheduleUpdate\u003c/h6\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// packages\\react-reconciler\\src\\ReactDebugFiberPerf.js\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003erecordScheduleUpdate\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\u003c/span\u003e): \u003cspan class=\"hljs-keyword\"\u003evoid\u003c/span\u003e {\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (enableUserTimingAPI) {\r\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (isCommitting) {\r\n      hasScheduledUpdateInCurrentCommit = \u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e;\r\n    }\r\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (\r\n      currentPhase !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e \u0026#x26;\u0026#x26;\r\n      currentPhase !== \u003cspan class=\"hljs-string\"\u003e'componentWillMount'\u003c/span\u003e \u0026#x26;\u0026#x26;\r\n      currentPhase !== \u003cspan class=\"hljs-string\"\u003e'componentWillReceiveProps'\u003c/span\u003e\r\n    ) {\r\n      hasScheduledUpdateInCurrentPhase = \u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e;\r\n    }\r\n  }\r\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch6 id=\"getcurrentprioritylevel\"\u003egetCurrentPriorityLevel\u003c/h6\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// packages\\react-reconciler\\src\\SchedulerWithReactIntegration.js\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003egetCurrentPriorityLevel\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\u003c/span\u003e): \u003cspan class=\"hljs-title class_\"\u003eReactPriorityLevel\u003c/span\u003e {\r\n  \u003cspan class=\"hljs-keyword\"\u003eswitch\u003c/span\u003e (\u003cspan class=\"hljs-title class_\"\u003eScheduler\u003c/span\u003e_getCurrentPriorityLevel()) {\r\n    \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eScheduler\u003c/span\u003e\u003cspan class=\"hljs-attr\"\u003e_ImmediatePriority\u003c/span\u003e:\r\n      \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eImmediatePriority\u003c/span\u003e;\r\n    \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eScheduler\u003c/span\u003e\u003cspan class=\"hljs-attr\"\u003e_UserBlockingPriority\u003c/span\u003e:\r\n      \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eUserBlockingPriority\u003c/span\u003e;\r\n    \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eScheduler\u003c/span\u003e\u003cspan class=\"hljs-attr\"\u003e_NormalPriority\u003c/span\u003e:\r\n      \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eNormalPriority\u003c/span\u003e;\r\n    \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eScheduler\u003c/span\u003e\u003cspan class=\"hljs-attr\"\u003e_LowPriority\u003c/span\u003e:\r\n      \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eLowPriority\u003c/span\u003e;\r\n    \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eScheduler\u003c/span\u003e\u003cspan class=\"hljs-attr\"\u003e_IdlePriority\u003c/span\u003e:\r\n      \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eIdlePriority\u003c/span\u003e;\r\n    \u003cspan class=\"hljs-attr\"\u003edefault\u003c/span\u003e:\r\n      \u003cspan class=\"hljs-title function_\"\u003einvariant\u003c/span\u003e(\u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'Unknown priority level.'\u003c/span\u003e);\r\n  }\r\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch6 id=\"schedulependinginteractions\"\u003eschedulePendingInteractions\u003c/h6\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eschedulePendingInteractions\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003eroot, expirationTime\u003c/span\u003e) {\r\n  \u003cspan class=\"hljs-comment\"\u003e// This is called when work is scheduled on a root.\u003c/span\u003e\r\n  \u003cspan class=\"hljs-comment\"\u003e// It associates the current interactions with the newly-scheduled expiration.\u003c/span\u003e\r\n  \u003cspan class=\"hljs-comment\"\u003e// They will be restored when that expiration is later committed.\u003c/span\u003e\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (!enableSchedulerTracing) {\r\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e;\r\n  }\r\n\r\n  \u003cspan class=\"hljs-title function_\"\u003escheduleInteractions\u003c/span\u003e(root, expirationTime, __interactionsRef.\u003cspan class=\"hljs-property\"\u003ecurrent\u003c/span\u003e);\r\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003escheduleInteractions\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003escheduleInteractions\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003eroot, expirationTime, interactions\u003c/span\u003e) {\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (!enableSchedulerTracing) {\r\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e;\r\n  }\r\n\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (interactions.\u003cspan class=\"hljs-property\"\u003esize\u003c/span\u003e \u003e \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e) {\r\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e pendingInteractionMap = root.\u003cspan class=\"hljs-property\"\u003ependingInteractionMap\u003c/span\u003e;\r\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e pendingInteractions = pendingInteractionMap.\u003cspan class=\"hljs-title function_\"\u003eget\u003c/span\u003e(expirationTime);\r\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (pendingInteractions != \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n      interactions.\u003cspan class=\"hljs-title function_\"\u003eforEach\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-params\"\u003einteraction\u003c/span\u003e =\u003e\u003c/span\u003e {\r\n        \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (!pendingInteractions.\u003cspan class=\"hljs-title function_\"\u003ehas\u003c/span\u003e(interaction)) {\r\n          \u003cspan class=\"hljs-comment\"\u003e// Update the pending async work count for previously unscheduled interaction.\u003c/span\u003e\r\n          interaction.\u003cspan class=\"hljs-property\"\u003e__count\u003c/span\u003e++;\r\n        }\r\n\r\n        pendingInteractions.\u003cspan class=\"hljs-title function_\"\u003eadd\u003c/span\u003e(interaction);\r\n      });\r\n    } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\r\n      pendingInteractionMap.\u003cspan class=\"hljs-title function_\"\u003eset\u003c/span\u003e(expirationTime, \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eSet\u003c/span\u003e(interactions));\r\n\r\n      \u003cspan class=\"hljs-comment\"\u003e// Update the pending async work count for the current interactions.\u003c/span\u003e\r\n      interactions.\u003cspan class=\"hljs-title function_\"\u003eforEach\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-params\"\u003einteraction\u003c/span\u003e =\u003e\u003c/span\u003e {\r\n        interaction.\u003cspan class=\"hljs-property\"\u003e__count\u003c/span\u003e++;\r\n      });\r\n    }\r\n\r\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e subscriber = __subscriberRef.\u003cspan class=\"hljs-property\"\u003ecurrent\u003c/span\u003e;\r\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (subscriber !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n      \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e threadID = \u003cspan class=\"hljs-title function_\"\u003ecomputeThreadID\u003c/span\u003e(root, expirationTime);\r\n      subscriber.\u003cspan class=\"hljs-title function_\"\u003eonWorkScheduled\u003c/span\u003e(interactions, threadID);\r\n    }\r\n  }\r\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch6 id=\"performsyncworkonroot\"\u003eperformSyncWorkOnRoot\u003c/h6\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// packages\\react-reconciler\\src\\ReactFiberWorkLoop.js\u003c/span\u003e\r\n\r\n\u003cspan class=\"hljs-comment\"\u003e// This is the entry point for synchronous tasks that don't go\u003c/span\u003e\r\n\u003cspan class=\"hljs-comment\"\u003e// through Scheduler\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eperformSyncWorkOnRoot\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003eroot\u003c/span\u003e) {\r\n  \u003cspan class=\"hljs-comment\"\u003e// Check if there's expired work on this root. Otherwise, render at Sync.\u003c/span\u003e\r\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e lastExpiredTime = root.\u003cspan class=\"hljs-property\"\u003elastExpiredTime\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e expirationTime = lastExpiredTime !== \u003cspan class=\"hljs-title class_\"\u003eNoWork\u003c/span\u003e ? lastExpiredTime : \u003cspan class=\"hljs-title class_\"\u003eSync\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (root.\u003cspan class=\"hljs-property\"\u003efinishedExpirationTime\u003c/span\u003e === expirationTime) {\r\n    \u003cspan class=\"hljs-comment\"\u003e// There's already a pending commit at this expiration time.\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// \u003cspan class=\"hljs-doctag\"\u003eTODO:\u003c/span\u003e This is poorly factored. This case only exists for the\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// batch.commit() API.\u003c/span\u003e\r\n    \u003cspan class=\"hljs-title function_\"\u003ecommitRoot\u003c/span\u003e(root);\r\n  } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\r\n    \u003cspan class=\"hljs-title function_\"\u003einvariant\u003c/span\u003e(\r\n      (executionContext \u0026#x26; (\u003cspan class=\"hljs-title class_\"\u003eRenderContext\u003c/span\u003e | \u003cspan class=\"hljs-title class_\"\u003eCommitContext\u003c/span\u003e)) === \u003cspan class=\"hljs-title class_\"\u003eNoContext\u003c/span\u003e,\r\n      \u003cspan class=\"hljs-string\"\u003e'Should not already be working.'\u003c/span\u003e,\r\n    );\r\n\r\n    \u003cspan class=\"hljs-title function_\"\u003eflushPassiveEffects\u003c/span\u003e();\r\n\r\n    \u003cspan class=\"hljs-comment\"\u003e// If the root or expiration time have changed, throw out the existing stack\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// and prepare a fresh one. Otherwise we'll continue where we left off.\u003c/span\u003e\r\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (\r\n      root !== workInProgressRoot ||\r\n      expirationTime !== renderExpirationTime\r\n    ) {\r\n      \u003cspan class=\"hljs-title function_\"\u003eprepareFreshStack\u003c/span\u003e(root, expirationTime);\r\n      \u003cspan class=\"hljs-title function_\"\u003estartWorkOnPendingInteractions\u003c/span\u003e(root, expirationTime);\r\n    }\r\n\r\n    \u003cspan class=\"hljs-comment\"\u003e// If we have a work-in-progress fiber, it means there's still work to do\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// in this root.\u003c/span\u003e\r\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (workInProgress !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n      \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e prevExecutionContext = executionContext;\r\n      executionContext |= \u003cspan class=\"hljs-title class_\"\u003eRenderContext\u003c/span\u003e;\r\n      \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e prevDispatcher = \u003cspan class=\"hljs-title function_\"\u003epushDispatcher\u003c/span\u003e(root);\r\n      \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e prevInteractions = \u003cspan class=\"hljs-title function_\"\u003epushInteractions\u003c/span\u003e(root);\r\n      \u003cspan class=\"hljs-title function_\"\u003estartWorkLoopTimer\u003c/span\u003e(workInProgress);\r\n\r\n      \u003cspan class=\"hljs-keyword\"\u003edo\u003c/span\u003e {\r\n        \u003cspan class=\"hljs-keyword\"\u003etry\u003c/span\u003e {\r\n          \u003cspan class=\"hljs-title function_\"\u003eworkLoopSync\u003c/span\u003e();\r\n          \u003cspan class=\"hljs-keyword\"\u003ebreak\u003c/span\u003e;\r\n        } \u003cspan class=\"hljs-keyword\"\u003ecatch\u003c/span\u003e (thrownValue) {\r\n          \u003cspan class=\"hljs-title function_\"\u003ehandleError\u003c/span\u003e(root, thrownValue);\r\n        }\r\n      } \u003cspan class=\"hljs-keyword\"\u003ewhile\u003c/span\u003e (\u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e);\r\n      \u003cspan class=\"hljs-title function_\"\u003eresetContextDependencies\u003c/span\u003e();\r\n      executionContext = prevExecutionContext;\r\n      \u003cspan class=\"hljs-title function_\"\u003epopDispatcher\u003c/span\u003e(prevDispatcher);\r\n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (enableSchedulerTracing) {\r\n        \u003cspan class=\"hljs-title function_\"\u003epopInteractions\u003c/span\u003e(((\u003cspan class=\"hljs-attr\"\u003eprevInteractions\u003c/span\u003e: any): \u003cspan class=\"hljs-title class_\"\u003eSet\u003c/span\u003e\u0026#x3C;\u003cspan class=\"hljs-title class_\"\u003eInteraction\u003c/span\u003e\u003e));\r\n      }\r\n\r\n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (workInProgressRootExitStatus === \u003cspan class=\"hljs-title class_\"\u003eRootFatalErrored\u003c/span\u003e) {\r\n        \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e fatalError = workInProgressRootFatalError;\r\n        \u003cspan class=\"hljs-title function_\"\u003estopInterruptedWorkLoopTimer\u003c/span\u003e();\r\n        \u003cspan class=\"hljs-title function_\"\u003eprepareFreshStack\u003c/span\u003e(root, expirationTime);\r\n        \u003cspan class=\"hljs-title function_\"\u003emarkRootSuspendedAtTime\u003c/span\u003e(root, expirationTime);\r\n        \u003cspan class=\"hljs-title function_\"\u003eensureRootIsScheduled\u003c/span\u003e(root);\r\n        \u003cspan class=\"hljs-keyword\"\u003ethrow\u003c/span\u003e fatalError;\r\n      }\r\n\r\n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (workInProgress !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n        \u003cspan class=\"hljs-comment\"\u003e// This is a sync render, so we should have finished the whole tree.\u003c/span\u003e\r\n        \u003cspan class=\"hljs-title function_\"\u003einvariant\u003c/span\u003e(\r\n          \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e,\r\n          \u003cspan class=\"hljs-string\"\u003e'Cannot commit an incomplete root. This error is likely caused by a '\u003c/span\u003e +\r\n            \u003cspan class=\"hljs-string\"\u003e'bug in React. Please file an issue.'\u003c/span\u003e,\r\n        );\r\n      } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\r\n        \u003cspan class=\"hljs-comment\"\u003e// We now have a consistent tree. Because this is a sync render, we\u003c/span\u003e\r\n        \u003cspan class=\"hljs-comment\"\u003e// will commit it even if something suspended. The only exception is\u003c/span\u003e\r\n        \u003cspan class=\"hljs-comment\"\u003e// if the root is locked (using the unstable_createBatch API).\u003c/span\u003e\r\n        \u003cspan class=\"hljs-title function_\"\u003estopFinishedWorkLoopTimer\u003c/span\u003e();\r\n        root.\u003cspan class=\"hljs-property\"\u003efinishedWork\u003c/span\u003e = (root.\u003cspan class=\"hljs-property\"\u003ecurrent\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ealternate\u003c/span\u003e: any);\r\n        root.\u003cspan class=\"hljs-property\"\u003efinishedExpirationTime\u003c/span\u003e = expirationTime;\r\n        \u003cspan class=\"hljs-title function_\"\u003eresolveLocksOnRoot\u003c/span\u003e(root, expirationTime);\r\n        \u003cspan class=\"hljs-title function_\"\u003efinishSyncRender\u003c/span\u003e(root, workInProgressRootExitStatus, expirationTime);\r\n      }\r\n\r\n      \u003cspan class=\"hljs-comment\"\u003e// Before exiting, make sure there's a callback scheduled for the next\u003c/span\u003e\r\n      \u003cspan class=\"hljs-comment\"\u003e// pending level.\u003c/span\u003e\r\n      \u003cspan class=\"hljs-title function_\"\u003eensureRootIsScheduled\u003c/span\u003e(root);\r\n    }\r\n  }\r\n\r\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch5 id=\"preparefreshstack\"\u003eprepareFreshStack\u003c/h5\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// packages\\react-reconciler\\src\\ReactFiberWorkLoop.js\u003c/span\u003e\r\n\r\n\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eprepareFreshStack\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003eroot, expirationTime\u003c/span\u003e) {\r\n  root.\u003cspan class=\"hljs-property\"\u003efinishedWork\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n  root.\u003cspan class=\"hljs-property\"\u003efinishedExpirationTime\u003c/span\u003e = \u003cspan class=\"hljs-title class_\"\u003eNoWork\u003c/span\u003e;\r\n\r\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e timeoutHandle = root.\u003cspan class=\"hljs-property\"\u003etimeoutHandle\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (timeoutHandle !== noTimeout) {\r\n    \u003cspan class=\"hljs-comment\"\u003e// The root previous suspended and scheduled a timeout to commit a fallback\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// state. Now that we have additional work, cancel the timeout.\u003c/span\u003e\r\n    root.\u003cspan class=\"hljs-property\"\u003etimeoutHandle\u003c/span\u003e = noTimeout;\r\n    \u003cspan class=\"hljs-comment\"\u003e// $FlowFixMe Complains noTimeout is not a TimeoutID, despite the check above\u003c/span\u003e\r\n    \u003cspan class=\"hljs-title function_\"\u003ecancelTimeout\u003c/span\u003e(timeoutHandle);\r\n  }\r\n\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (workInProgress !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n    \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e interruptedWork = workInProgress.\u003cspan class=\"hljs-property\"\u003ereturn\u003c/span\u003e;\r\n    \u003cspan class=\"hljs-keyword\"\u003ewhile\u003c/span\u003e (interruptedWork !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n      \u003cspan class=\"hljs-title function_\"\u003eunwindInterruptedWork\u003c/span\u003e(interruptedWork);\r\n      interruptedWork = interruptedWork.\u003cspan class=\"hljs-property\"\u003ereturn\u003c/span\u003e;\r\n    }\r\n  }\r\n  workInProgressRoot = root;\r\n  workInProgress = \u003cspan class=\"hljs-title function_\"\u003ecreateWorkInProgress\u003c/span\u003e(root.\u003cspan class=\"hljs-property\"\u003ecurrent\u003c/span\u003e, \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e, expirationTime);\r\n  renderExpirationTime = expirationTime;\r\n  workInProgressRootExitStatus = \u003cspan class=\"hljs-title class_\"\u003eRootIncomplete\u003c/span\u003e;\r\n  workInProgressRootFatalError = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n  workInProgressRootLatestProcessedExpirationTime = \u003cspan class=\"hljs-title class_\"\u003eSync\u003c/span\u003e;\r\n  workInProgressRootLatestSuspenseTimeout = \u003cspan class=\"hljs-title class_\"\u003eSync\u003c/span\u003e;\r\n  workInProgressRootCanSuspendUsingConfig = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n  workInProgressRootNextUnprocessedUpdateTime = \u003cspan class=\"hljs-title class_\"\u003eNoWork\u003c/span\u003e;\r\n  workInProgressRootHasPendingPing = \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e;\r\n\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (enableSchedulerTracing) {\r\n    spawnedWorkDuringRender = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n  }\r\n\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (__DEV__) {\r\n    \u003cspan class=\"hljs-title class_\"\u003eReactStrictModeWarnings\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003ediscardPendingWarnings\u003c/span\u003e();\r\n    componentsThatTriggeredHighPriSuspend = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n  }\r\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch6 id=\"createworkinprogress\"\u003ecreateWorkInProgress\u003c/h6\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// packages\\react-reconciler\\src\\ReactFiber.js\u003c/span\u003e\r\n\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003ecreateWorkInProgress\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\r\n  current: Fiber,\r\n  pendingProps: any,\r\n  expirationTime: ExpirationTime,\r\n\u003c/span\u003e): \u003cspan class=\"hljs-title class_\"\u003eFiber\u003c/span\u003e {\r\n  \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e workInProgress = current.\u003cspan class=\"hljs-property\"\u003ealternate\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (workInProgress === \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n    \u003cspan class=\"hljs-comment\"\u003e// We use a double buffering pooling technique because we know that we'll\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// only ever need at most two versions of a tree. We pool the \"other\" unused\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// node that we're free to reuse. This is lazily created to avoid allocating\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// extra objects for things that are never updated. It also allow us to\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// reclaim the extra memory if needed.\u003c/span\u003e\r\n    workInProgress = \u003cspan class=\"hljs-title function_\"\u003ecreateFiber\u003c/span\u003e(\r\n      current.\u003cspan class=\"hljs-property\"\u003etag\u003c/span\u003e,\r\n      pendingProps,\r\n      current.\u003cspan class=\"hljs-property\"\u003ekey\u003c/span\u003e,\r\n      current.\u003cspan class=\"hljs-property\"\u003emode\u003c/span\u003e,\r\n    );\r\n    workInProgress.\u003cspan class=\"hljs-property\"\u003eelementType\u003c/span\u003e = current.\u003cspan class=\"hljs-property\"\u003eelementType\u003c/span\u003e;\r\n    workInProgress.\u003cspan class=\"hljs-property\"\u003etype\u003c/span\u003e = current.\u003cspan class=\"hljs-property\"\u003etype\u003c/span\u003e;\r\n    workInProgress.\u003cspan class=\"hljs-property\"\u003estateNode\u003c/span\u003e = current.\u003cspan class=\"hljs-property\"\u003estateNode\u003c/span\u003e;\r\n\r\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (__DEV__) {\r\n      \u003cspan class=\"hljs-comment\"\u003e// DEV-only fields\u003c/span\u003e\r\n      workInProgress.\u003cspan class=\"hljs-property\"\u003e_debugID\u003c/span\u003e = current.\u003cspan class=\"hljs-property\"\u003e_debugID\u003c/span\u003e;\r\n      workInProgress.\u003cspan class=\"hljs-property\"\u003e_debugSource\u003c/span\u003e = current.\u003cspan class=\"hljs-property\"\u003e_debugSource\u003c/span\u003e;\r\n      workInProgress.\u003cspan class=\"hljs-property\"\u003e_debugOwner\u003c/span\u003e = current.\u003cspan class=\"hljs-property\"\u003e_debugOwner\u003c/span\u003e;\r\n      workInProgress.\u003cspan class=\"hljs-property\"\u003e_debugHookTypes\u003c/span\u003e = current.\u003cspan class=\"hljs-property\"\u003e_debugHookTypes\u003c/span\u003e;\r\n    }\r\n\r\n    workInProgress.\u003cspan class=\"hljs-property\"\u003ealternate\u003c/span\u003e = current;\r\n    current.\u003cspan class=\"hljs-property\"\u003ealternate\u003c/span\u003e = workInProgress;\r\n  } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\r\n    workInProgress.\u003cspan class=\"hljs-property\"\u003ependingProps\u003c/span\u003e = pendingProps;\r\n\r\n    \u003cspan class=\"hljs-comment\"\u003e// We already have an alternate.\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// Reset the effect tag.\u003c/span\u003e\r\n    workInProgress.\u003cspan class=\"hljs-property\"\u003eeffectTag\u003c/span\u003e = \u003cspan class=\"hljs-title class_\"\u003eNoEffect\u003c/span\u003e;\r\n\r\n    \u003cspan class=\"hljs-comment\"\u003e// The effect list is no longer valid.\u003c/span\u003e\r\n    workInProgress.\u003cspan class=\"hljs-property\"\u003enextEffect\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n    workInProgress.\u003cspan class=\"hljs-property\"\u003efirstEffect\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n    workInProgress.\u003cspan class=\"hljs-property\"\u003elastEffect\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n\r\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (enableProfilerTimer) {\r\n      \u003cspan class=\"hljs-comment\"\u003e// We intentionally reset, rather than copy, actualDuration \u0026#x26; actualStartTime.\u003c/span\u003e\r\n      \u003cspan class=\"hljs-comment\"\u003e// This prevents time from endlessly accumulating in new commits.\u003c/span\u003e\r\n      \u003cspan class=\"hljs-comment\"\u003e// This has the downside of resetting values for different priority renders,\u003c/span\u003e\r\n      \u003cspan class=\"hljs-comment\"\u003e// But works for yielding (the common case) and should support resuming.\u003c/span\u003e\r\n      workInProgress.\u003cspan class=\"hljs-property\"\u003eactualDuration\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e;\r\n      workInProgress.\u003cspan class=\"hljs-property\"\u003eactualStartTime\u003c/span\u003e = -\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e;\r\n    }\r\n  }\r\n\r\n  workInProgress.\u003cspan class=\"hljs-property\"\u003echildExpirationTime\u003c/span\u003e = current.\u003cspan class=\"hljs-property\"\u003echildExpirationTime\u003c/span\u003e;\r\n  workInProgress.\u003cspan class=\"hljs-property\"\u003eexpirationTime\u003c/span\u003e = current.\u003cspan class=\"hljs-property\"\u003eexpirationTime\u003c/span\u003e;\r\n\r\n  workInProgress.\u003cspan class=\"hljs-property\"\u003echild\u003c/span\u003e = current.\u003cspan class=\"hljs-property\"\u003echild\u003c/span\u003e;\r\n  workInProgress.\u003cspan class=\"hljs-property\"\u003ememoizedProps\u003c/span\u003e = current.\u003cspan class=\"hljs-property\"\u003ememoizedProps\u003c/span\u003e;\r\n  workInProgress.\u003cspan class=\"hljs-property\"\u003ememoizedState\u003c/span\u003e = current.\u003cspan class=\"hljs-property\"\u003ememoizedState\u003c/span\u003e;\r\n  workInProgress.\u003cspan class=\"hljs-property\"\u003eupdateQueue\u003c/span\u003e = current.\u003cspan class=\"hljs-property\"\u003eupdateQueue\u003c/span\u003e;\r\n\r\n  \u003cspan class=\"hljs-comment\"\u003e// Clone the dependencies object. This is mutated during the render phase, so\u003c/span\u003e\r\n  \u003cspan class=\"hljs-comment\"\u003e// it cannot be shared with the current fiber.\u003c/span\u003e\r\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e currentDependencies = current.\u003cspan class=\"hljs-property\"\u003edependencies\u003c/span\u003e;\r\n  workInProgress.\u003cspan class=\"hljs-property\"\u003edependencies\u003c/span\u003e =\r\n    currentDependencies === \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e\r\n      ? \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e\r\n      : {\r\n          \u003cspan class=\"hljs-attr\"\u003eexpirationTime\u003c/span\u003e: currentDependencies.\u003cspan class=\"hljs-property\"\u003eexpirationTime\u003c/span\u003e,\r\n          \u003cspan class=\"hljs-attr\"\u003efirstContext\u003c/span\u003e: currentDependencies.\u003cspan class=\"hljs-property\"\u003efirstContext\u003c/span\u003e,\r\n          \u003cspan class=\"hljs-attr\"\u003eresponders\u003c/span\u003e: currentDependencies.\u003cspan class=\"hljs-property\"\u003eresponders\u003c/span\u003e,\r\n        };\r\n\r\n  \u003cspan class=\"hljs-comment\"\u003e// These will be overridden during the parent's reconciliation\u003c/span\u003e\r\n  workInProgress.\u003cspan class=\"hljs-property\"\u003esibling\u003c/span\u003e = current.\u003cspan class=\"hljs-property\"\u003esibling\u003c/span\u003e;\r\n  workInProgress.\u003cspan class=\"hljs-property\"\u003eindex\u003c/span\u003e = current.\u003cspan class=\"hljs-property\"\u003eindex\u003c/span\u003e;\r\n  workInProgress.\u003cspan class=\"hljs-property\"\u003eref\u003c/span\u003e = current.\u003cspan class=\"hljs-property\"\u003eref\u003c/span\u003e;\r\n\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (enableProfilerTimer) {\r\n    workInProgress.\u003cspan class=\"hljs-property\"\u003eselfBaseDuration\u003c/span\u003e = current.\u003cspan class=\"hljs-property\"\u003eselfBaseDuration\u003c/span\u003e;\r\n    workInProgress.\u003cspan class=\"hljs-property\"\u003etreeBaseDuration\u003c/span\u003e = current.\u003cspan class=\"hljs-property\"\u003etreeBaseDuration\u003c/span\u003e;\r\n  }\r\n\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (__DEV__) {\r\n    workInProgress.\u003cspan class=\"hljs-property\"\u003e_debugNeedsRemount\u003c/span\u003e = current.\u003cspan class=\"hljs-property\"\u003e_debugNeedsRemount\u003c/span\u003e;\r\n    \u003cspan class=\"hljs-keyword\"\u003eswitch\u003c/span\u003e (workInProgress.\u003cspan class=\"hljs-property\"\u003etag\u003c/span\u003e) {\r\n      \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eIndeterminateComponent\u003c/span\u003e:\r\n      \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eFunctionComponent\u003c/span\u003e:\r\n      \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eSimpleMemoComponent\u003c/span\u003e:\r\n        workInProgress.\u003cspan class=\"hljs-property\"\u003etype\u003c/span\u003e = \u003cspan class=\"hljs-title function_\"\u003eresolveFunctionForHotReloading\u003c/span\u003e(current.\u003cspan class=\"hljs-property\"\u003etype\u003c/span\u003e);\r\n        \u003cspan class=\"hljs-keyword\"\u003ebreak\u003c/span\u003e;\r\n      \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eClassComponent\u003c/span\u003e:\r\n        workInProgress.\u003cspan class=\"hljs-property\"\u003etype\u003c/span\u003e = \u003cspan class=\"hljs-title function_\"\u003eresolveClassForHotReloading\u003c/span\u003e(current.\u003cspan class=\"hljs-property\"\u003etype\u003c/span\u003e);\r\n        \u003cspan class=\"hljs-keyword\"\u003ebreak\u003c/span\u003e;\r\n      \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eForwardRef\u003c/span\u003e:\r\n        workInProgress.\u003cspan class=\"hljs-property\"\u003etype\u003c/span\u003e = \u003cspan class=\"hljs-title function_\"\u003eresolveForwardRefForHotReloading\u003c/span\u003e(current.\u003cspan class=\"hljs-property\"\u003etype\u003c/span\u003e);\r\n        \u003cspan class=\"hljs-keyword\"\u003ebreak\u003c/span\u003e;\r\n      \u003cspan class=\"hljs-attr\"\u003edefault\u003c/span\u003e:\r\n        \u003cspan class=\"hljs-keyword\"\u003ebreak\u003c/span\u003e;\r\n    }\r\n  }\r\n\r\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e workInProgress;\r\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch6 id=\"pushdispatcher\"\u003epushDispatcher\u003c/h6\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// packages\\react-reconciler\\src\\ReactFiberWorkLoop.js\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003epushDispatcher\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003eroot\u003c/span\u003e) {\r\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e prevDispatcher = \u003cspan class=\"hljs-title class_\"\u003eReactCurrentDispatcher\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ecurrent\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-title class_\"\u003eReactCurrentDispatcher\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ecurrent\u003c/span\u003e = \u003cspan class=\"hljs-title class_\"\u003eContextOnlyDispatcher\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (prevDispatcher === \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n    \u003cspan class=\"hljs-comment\"\u003e// The React isomorphic package does not include a default dispatcher.\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// Instead the first renderer will lazily attach one, in order to give\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// nicer error messages.\u003c/span\u003e\r\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eContextOnlyDispatcher\u003c/span\u003e;\r\n  } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\r\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e prevDispatcher;\r\n  }\r\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch6 id=\"workloopsync\"\u003eworkLoopSync\u003c/h6\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// packages\\react-reconciler\\src\\ReactFiberWorkLoop.js\u003c/span\u003e\r\n\r\n\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eworkLoopSync\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\u003c/span\u003e) {\r\n  \u003cspan class=\"hljs-comment\"\u003e// Already timed out, so perform work without checking if we need to yield.\u003c/span\u003e\r\n  \u003cspan class=\"hljs-keyword\"\u003ewhile\u003c/span\u003e (workInProgress !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n    workInProgress = \u003cspan class=\"hljs-title function_\"\u003eperformUnitOfWork\u003c/span\u003e(workInProgress);\r\n  }\r\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch6 id=\"performunitofwork\"\u003eperformUnitOfWork\u003c/h6\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// packages\\react-reconciler\\src\\ReactFiberWorkLoop.js\u003c/span\u003e\r\n\r\n\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eperformUnitOfWork\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003eunitOfWork: Fiber\u003c/span\u003e): \u003cspan class=\"hljs-title class_\"\u003eFiber\u003c/span\u003e | \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e {\r\n  \u003cspan class=\"hljs-comment\"\u003e// The current, flushed, state of this fiber is the alternate. Ideally\u003c/span\u003e\r\n  \u003cspan class=\"hljs-comment\"\u003e// nothing should rely on this, but relying on it here means that we don't\u003c/span\u003e\r\n  \u003cspan class=\"hljs-comment\"\u003e// need an additional field on the work in progress.\u003c/span\u003e\r\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e current = unitOfWork.\u003cspan class=\"hljs-property\"\u003ealternate\u003c/span\u003e;\r\n\r\n  \u003cspan class=\"hljs-title function_\"\u003estartWorkTimer\u003c/span\u003e(unitOfWork);\r\n  \u003cspan class=\"hljs-title function_\"\u003esetCurrentDebugFiberInDEV\u003c/span\u003e(unitOfWork);\r\n\r\n  \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e next;\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (enableProfilerTimer \u0026#x26;\u0026#x26; (unitOfWork.\u003cspan class=\"hljs-property\"\u003emode\u003c/span\u003e \u0026#x26; \u003cspan class=\"hljs-title class_\"\u003eProfileMode\u003c/span\u003e) !== \u003cspan class=\"hljs-title class_\"\u003eNoMode\u003c/span\u003e) {\r\n    \u003cspan class=\"hljs-title function_\"\u003estartProfilerTimer\u003c/span\u003e(unitOfWork);\r\n    next = \u003cspan class=\"hljs-title function_\"\u003ebeginWork\u003c/span\u003e(current, unitOfWork, renderExpirationTime);\r\n    \u003cspan class=\"hljs-title function_\"\u003estopProfilerTimerIfRunningAndRecordDelta\u003c/span\u003e(unitOfWork, \u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e);\r\n  } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\r\n    next = \u003cspan class=\"hljs-title function_\"\u003ebeginWork\u003c/span\u003e(current, unitOfWork, renderExpirationTime);\r\n  }\r\n\r\n  \u003cspan class=\"hljs-title function_\"\u003eresetCurrentDebugFiberInDEV\u003c/span\u003e();\r\n  unitOfWork.\u003cspan class=\"hljs-property\"\u003ememoizedProps\u003c/span\u003e = unitOfWork.\u003cspan class=\"hljs-property\"\u003ependingProps\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (next === \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n    \u003cspan class=\"hljs-comment\"\u003e// If this doesn't spawn new work, complete the current work.\u003c/span\u003e\r\n    next = \u003cspan class=\"hljs-title function_\"\u003ecompleteUnitOfWork\u003c/span\u003e(unitOfWork);\r\n  }\r\n\r\n  \u003cspan class=\"hljs-title class_\"\u003eReactCurrentOwner\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ecurrent\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e next;\r\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch4 id=\"beginwork\"\u003ebeginWork\u003c/h4\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// packages\\react-reconciler\\src\\ReactFiberBeginWork.js\u003c/span\u003e\r\n\r\n\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003ebeginWork\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\r\n  current: Fiber | \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e,\r\n  workInProgress: Fiber,\r\n  renderExpirationTime: ExpirationTime,\r\n\u003c/span\u003e): \u003cspan class=\"hljs-title class_\"\u003eFiber\u003c/span\u003e | \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e {\r\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e updateExpirationTime = workInProgress.\u003cspan class=\"hljs-property\"\u003eexpirationTime\u003c/span\u003e;\r\n\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (__DEV__) {\r\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (workInProgress.\u003cspan class=\"hljs-property\"\u003e_debugNeedsRemount\u003c/span\u003e \u0026#x26;\u0026#x26; current !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n      \u003cspan class=\"hljs-comment\"\u003e// This will restart the begin phase with a new fiber.\u003c/span\u003e\r\n      \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eremountFiber\u003c/span\u003e(\r\n        current,\r\n        workInProgress,\r\n        \u003cspan class=\"hljs-title function_\"\u003ecreateFiberFromTypeAndProps\u003c/span\u003e(\r\n          workInProgress.\u003cspan class=\"hljs-property\"\u003etype\u003c/span\u003e,\r\n          workInProgress.\u003cspan class=\"hljs-property\"\u003ekey\u003c/span\u003e,\r\n          workInProgress.\u003cspan class=\"hljs-property\"\u003ependingProps\u003c/span\u003e,\r\n          workInProgress.\u003cspan class=\"hljs-property\"\u003e_debugOwner\u003c/span\u003e || \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e,\r\n          workInProgress.\u003cspan class=\"hljs-property\"\u003emode\u003c/span\u003e,\r\n          workInProgress.\u003cspan class=\"hljs-property\"\u003eexpirationTime\u003c/span\u003e,\r\n        ),\r\n      );\r\n    }\r\n  }\r\n\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (current !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e oldProps = current.\u003cspan class=\"hljs-property\"\u003ememoizedProps\u003c/span\u003e;\r\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e newProps = workInProgress.\u003cspan class=\"hljs-property\"\u003ependingProps\u003c/span\u003e;\r\n\r\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (\r\n      oldProps !== newProps ||\r\n      \u003cspan class=\"hljs-title function_\"\u003ehasLegacyContextChanged\u003c/span\u003e() ||\r\n      \u003cspan class=\"hljs-comment\"\u003e// Force a re-render if the implementation changed due to hot reload:\u003c/span\u003e\r\n      (__DEV__ ? workInProgress.\u003cspan class=\"hljs-property\"\u003etype\u003c/span\u003e !== current.\u003cspan class=\"hljs-property\"\u003etype\u003c/span\u003e : \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e)\r\n    ) {\r\n      \u003cspan class=\"hljs-comment\"\u003e// If props or context changed, mark the fiber as having performed work.\u003c/span\u003e\r\n      \u003cspan class=\"hljs-comment\"\u003e// This may be unset if the props are determined to be equal later (memo).\u003c/span\u003e\r\n      didReceiveUpdate = \u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e;\r\n    } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (updateExpirationTime \u0026#x3C; renderExpirationTime) {\r\n      didReceiveUpdate = \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e;\r\n      \u003cspan class=\"hljs-comment\"\u003e// This fiber does not have any pending work. Bailout without entering\u003c/span\u003e\r\n      \u003cspan class=\"hljs-comment\"\u003e// the begin phase. There's still some bookkeeping we that needs to be done\u003c/span\u003e\r\n      \u003cspan class=\"hljs-comment\"\u003e// in this optimized path, mostly pushing stuff onto the stack.\u003c/span\u003e\r\n      \u003cspan class=\"hljs-keyword\"\u003eswitch\u003c/span\u003e (workInProgress.\u003cspan class=\"hljs-property\"\u003etag\u003c/span\u003e) {\r\n        \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eHostRoot\u003c/span\u003e:\r\n          \u003cspan class=\"hljs-title function_\"\u003epushHostRootContext\u003c/span\u003e(workInProgress);\r\n          \u003cspan class=\"hljs-title function_\"\u003eresetHydrationState\u003c/span\u003e();\r\n          \u003cspan class=\"hljs-keyword\"\u003ebreak\u003c/span\u003e;\r\n        \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eHostComponent\u003c/span\u003e:\r\n          \u003cspan class=\"hljs-title function_\"\u003epushHostContext\u003c/span\u003e(workInProgress);\r\n          \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (\r\n            workInProgress.\u003cspan class=\"hljs-property\"\u003emode\u003c/span\u003e \u0026#x26; \u003cspan class=\"hljs-title class_\"\u003eConcurrentMode\u003c/span\u003e \u0026#x26;\u0026#x26;\r\n            renderExpirationTime !== \u003cspan class=\"hljs-title class_\"\u003eNever\u003c/span\u003e \u0026#x26;\u0026#x26;\r\n            \u003cspan class=\"hljs-title function_\"\u003eshouldDeprioritizeSubtree\u003c/span\u003e(workInProgress.\u003cspan class=\"hljs-property\"\u003etype\u003c/span\u003e, newProps)\r\n          ) {\r\n            \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (enableSchedulerTracing) {\r\n              \u003cspan class=\"hljs-title function_\"\u003emarkSpawnedWork\u003c/span\u003e(\u003cspan class=\"hljs-title class_\"\u003eNever\u003c/span\u003e);\r\n            }\r\n            \u003cspan class=\"hljs-comment\"\u003e// Schedule this fiber to re-render at offscreen priority. Then bailout.\u003c/span\u003e\r\n            workInProgress.\u003cspan class=\"hljs-property\"\u003eexpirationTime\u003c/span\u003e = workInProgress.\u003cspan class=\"hljs-property\"\u003echildExpirationTime\u003c/span\u003e = \u003cspan class=\"hljs-title class_\"\u003eNever\u003c/span\u003e;\r\n            \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n          }\r\n          \u003cspan class=\"hljs-keyword\"\u003ebreak\u003c/span\u003e;\r\n        \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eClassComponent\u003c/span\u003e: {\r\n          \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eComponent\u003c/span\u003e = workInProgress.\u003cspan class=\"hljs-property\"\u003etype\u003c/span\u003e;\r\n          \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (\u003cspan class=\"hljs-title function_\"\u003eisLegacyContextProvider\u003c/span\u003e(\u003cspan class=\"hljs-title class_\"\u003eComponent\u003c/span\u003e)) {\r\n            \u003cspan class=\"hljs-title function_\"\u003epushLegacyContextProvider\u003c/span\u003e(workInProgress);\r\n          }\r\n          \u003cspan class=\"hljs-keyword\"\u003ebreak\u003c/span\u003e;\r\n        }\r\n        \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eHostPortal\u003c/span\u003e:\r\n          \u003cspan class=\"hljs-title function_\"\u003epushHostContainer\u003c/span\u003e(\r\n            workInProgress,\r\n            workInProgress.\u003cspan class=\"hljs-property\"\u003estateNode\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003econtainerInfo\u003c/span\u003e,\r\n          );\r\n          \u003cspan class=\"hljs-keyword\"\u003ebreak\u003c/span\u003e;\r\n        \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eContextProvider\u003c/span\u003e: {\r\n          \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e newValue = workInProgress.\u003cspan class=\"hljs-property\"\u003ememoizedProps\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003evalue\u003c/span\u003e;\r\n          \u003cspan class=\"hljs-title function_\"\u003epushProvider\u003c/span\u003e(workInProgress, newValue);\r\n          \u003cspan class=\"hljs-keyword\"\u003ebreak\u003c/span\u003e;\r\n        }\r\n        \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eProfiler\u003c/span\u003e:\r\n          \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (enableProfilerTimer) {\r\n            workInProgress.\u003cspan class=\"hljs-property\"\u003eeffectTag\u003c/span\u003e |= \u003cspan class=\"hljs-title class_\"\u003eUpdate\u003c/span\u003e;\r\n          }\r\n          \u003cspan class=\"hljs-keyword\"\u003ebreak\u003c/span\u003e;\r\n        \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eSuspenseComponent\u003c/span\u003e: {\r\n          \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003estate\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eSuspenseState\u003c/span\u003e | \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e = workInProgress.\u003cspan class=\"hljs-property\"\u003ememoizedState\u003c/span\u003e;\r\n          \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (state !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n            \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (enableSuspenseServerRenderer) {\r\n              \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (state.\u003cspan class=\"hljs-property\"\u003edehydrated\u003c/span\u003e !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n                \u003cspan class=\"hljs-title function_\"\u003epushSuspenseContext\u003c/span\u003e(\r\n                  workInProgress,\r\n                  \u003cspan class=\"hljs-title function_\"\u003esetDefaultShallowSuspenseContext\u003c/span\u003e(suspenseStackCursor.\u003cspan class=\"hljs-property\"\u003ecurrent\u003c/span\u003e),\r\n                );\r\n                \u003cspan class=\"hljs-comment\"\u003e// We know that this component will suspend again because if it has\u003c/span\u003e\r\n                \u003cspan class=\"hljs-comment\"\u003e// been unsuspended it has committed as a resolved Suspense component.\u003c/span\u003e\r\n                \u003cspan class=\"hljs-comment\"\u003e// If it needs to be retried, it should have work scheduled on it.\u003c/span\u003e\r\n                workInProgress.\u003cspan class=\"hljs-property\"\u003eeffectTag\u003c/span\u003e |= \u003cspan class=\"hljs-title class_\"\u003eDidCapture\u003c/span\u003e;\r\n                \u003cspan class=\"hljs-keyword\"\u003ebreak\u003c/span\u003e;\r\n              }\r\n            }\r\n\r\n            \u003cspan class=\"hljs-comment\"\u003e// If this boundary is currently timed out, we need to decide\u003c/span\u003e\r\n            \u003cspan class=\"hljs-comment\"\u003e// whether to retry the primary children, or to skip over it and\u003c/span\u003e\r\n            \u003cspan class=\"hljs-comment\"\u003e// go straight to the fallback. Check the priority of the primary\u003c/span\u003e\r\n            \u003cspan class=\"hljs-comment\"\u003e// child fragment.\u003c/span\u003e\r\n            \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003eprimaryChildFragment\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eFiber\u003c/span\u003e = (workInProgress.\u003cspan class=\"hljs-property\"\u003echild\u003c/span\u003e: any);\r\n            \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e primaryChildExpirationTime =\r\n              primaryChildFragment.\u003cspan class=\"hljs-property\"\u003echildExpirationTime\u003c/span\u003e;\r\n            \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (\r\n              primaryChildExpirationTime !== \u003cspan class=\"hljs-title class_\"\u003eNoWork\u003c/span\u003e \u0026#x26;\u0026#x26;\r\n              primaryChildExpirationTime \u003e= renderExpirationTime\r\n            ) {\r\n              \u003cspan class=\"hljs-comment\"\u003e// The primary children have pending work. Use the normal path\u003c/span\u003e\r\n              \u003cspan class=\"hljs-comment\"\u003e// to attempt to render the primary children again.\u003c/span\u003e\r\n              \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eupdateSuspenseComponent\u003c/span\u003e(\r\n                current,\r\n                workInProgress,\r\n                renderExpirationTime,\r\n              );\r\n            } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\r\n              \u003cspan class=\"hljs-title function_\"\u003epushSuspenseContext\u003c/span\u003e(\r\n                workInProgress,\r\n                \u003cspan class=\"hljs-title function_\"\u003esetDefaultShallowSuspenseContext\u003c/span\u003e(suspenseStackCursor.\u003cspan class=\"hljs-property\"\u003ecurrent\u003c/span\u003e),\r\n              );\r\n              \u003cspan class=\"hljs-comment\"\u003e// The primary children do not have pending work with sufficient\u003c/span\u003e\r\n              \u003cspan class=\"hljs-comment\"\u003e// priority. Bailout.\u003c/span\u003e\r\n              \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e child = \u003cspan class=\"hljs-title function_\"\u003ebailoutOnAlreadyFinishedWork\u003c/span\u003e(\r\n                current,\r\n                workInProgress,\r\n                renderExpirationTime,\r\n              );\r\n              \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (child !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n                \u003cspan class=\"hljs-comment\"\u003e// The fallback children have pending work. Skip over the\u003c/span\u003e\r\n                \u003cspan class=\"hljs-comment\"\u003e// primary children and work on the fallback.\u003c/span\u003e\r\n                \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e child.\u003cspan class=\"hljs-property\"\u003esibling\u003c/span\u003e;\r\n              } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\r\n                \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n              }\r\n            }\r\n          } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\r\n            \u003cspan class=\"hljs-title function_\"\u003epushSuspenseContext\u003c/span\u003e(\r\n              workInProgress,\r\n              \u003cspan class=\"hljs-title function_\"\u003esetDefaultShallowSuspenseContext\u003c/span\u003e(suspenseStackCursor.\u003cspan class=\"hljs-property\"\u003ecurrent\u003c/span\u003e),\r\n            );\r\n          }\r\n          \u003cspan class=\"hljs-keyword\"\u003ebreak\u003c/span\u003e;\r\n        }\r\n        \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eSuspenseListComponent\u003c/span\u003e: {\r\n          \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e didSuspendBefore =\r\n            (current.\u003cspan class=\"hljs-property\"\u003eeffectTag\u003c/span\u003e \u0026#x26; \u003cspan class=\"hljs-title class_\"\u003eDidCapture\u003c/span\u003e) !== \u003cspan class=\"hljs-title class_\"\u003eNoEffect\u003c/span\u003e;\r\n\r\n          \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e hasChildWork =\r\n            workInProgress.\u003cspan class=\"hljs-property\"\u003echildExpirationTime\u003c/span\u003e \u003e= renderExpirationTime;\r\n\r\n          \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (didSuspendBefore) {\r\n            \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (hasChildWork) {\r\n              \u003cspan class=\"hljs-comment\"\u003e// If something was in fallback state last time, and we have all the\u003c/span\u003e\r\n              \u003cspan class=\"hljs-comment\"\u003e// same children then we're still in progressive loading state.\u003c/span\u003e\r\n              \u003cspan class=\"hljs-comment\"\u003e// Something might get unblocked by state updates or retries in the\u003c/span\u003e\r\n              \u003cspan class=\"hljs-comment\"\u003e// tree which will affect the tail. So we need to use the normal\u003c/span\u003e\r\n              \u003cspan class=\"hljs-comment\"\u003e// path to compute the correct tail.\u003c/span\u003e\r\n              \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eupdateSuspenseListComponent\u003c/span\u003e(\r\n                current,\r\n                workInProgress,\r\n                renderExpirationTime,\r\n              );\r\n            }\r\n            \u003cspan class=\"hljs-comment\"\u003e// If none of the children had any work, that means that none of\u003c/span\u003e\r\n            \u003cspan class=\"hljs-comment\"\u003e// them got retried so they'll still be blocked in the same way\u003c/span\u003e\r\n            \u003cspan class=\"hljs-comment\"\u003e// as before. We can fast bail out.\u003c/span\u003e\r\n            workInProgress.\u003cspan class=\"hljs-property\"\u003eeffectTag\u003c/span\u003e |= \u003cspan class=\"hljs-title class_\"\u003eDidCapture\u003c/span\u003e;\r\n          }\r\n\r\n          \u003cspan class=\"hljs-comment\"\u003e// If nothing suspended before and we're rendering the same children,\u003c/span\u003e\r\n          \u003cspan class=\"hljs-comment\"\u003e// then the tail doesn't matter. Anything new that suspends will work\u003c/span\u003e\r\n          \u003cspan class=\"hljs-comment\"\u003e// in the \"together\" mode, so we can continue from the state we had.\u003c/span\u003e\r\n          \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e renderState = workInProgress.\u003cspan class=\"hljs-property\"\u003ememoizedState\u003c/span\u003e;\r\n          \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (renderState !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n            \u003cspan class=\"hljs-comment\"\u003e// Reset to the \"together\" mode in case we've started a different\u003c/span\u003e\r\n            \u003cspan class=\"hljs-comment\"\u003e// update in the past but didn't complete it.\u003c/span\u003e\r\n            renderState.\u003cspan class=\"hljs-property\"\u003erendering\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n            renderState.\u003cspan class=\"hljs-property\"\u003etail\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n          }\r\n          \u003cspan class=\"hljs-title function_\"\u003epushSuspenseContext\u003c/span\u003e(workInProgress, suspenseStackCursor.\u003cspan class=\"hljs-property\"\u003ecurrent\u003c/span\u003e);\r\n\r\n          \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (hasChildWork) {\r\n            \u003cspan class=\"hljs-keyword\"\u003ebreak\u003c/span\u003e;\r\n          } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\r\n            \u003cspan class=\"hljs-comment\"\u003e// If none of the children had any work, that means that none of\u003c/span\u003e\r\n            \u003cspan class=\"hljs-comment\"\u003e// them got retried so they'll still be blocked in the same way\u003c/span\u003e\r\n            \u003cspan class=\"hljs-comment\"\u003e// as before. We can fast bail out.\u003c/span\u003e\r\n            \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n          }\r\n        }\r\n      }\r\n      \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003ebailoutOnAlreadyFinishedWork\u003c/span\u003e(\r\n        current,\r\n        workInProgress,\r\n        renderExpirationTime,\r\n      );\r\n    } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\r\n      \u003cspan class=\"hljs-comment\"\u003e// An update was scheduled on this fiber, but there are no new props\u003c/span\u003e\r\n      \u003cspan class=\"hljs-comment\"\u003e// nor legacy context. Set this to false. If an update queue or context\u003c/span\u003e\r\n      \u003cspan class=\"hljs-comment\"\u003e// consumer produces a changed value, it will set this to true. Otherwise,\u003c/span\u003e\r\n      \u003cspan class=\"hljs-comment\"\u003e// the component will assume the children have not changed and bail out.\u003c/span\u003e\r\n      didReceiveUpdate = \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e;\r\n    }\r\n  } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\r\n    didReceiveUpdate = \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e;\r\n  }\r\n\r\n  \u003cspan class=\"hljs-comment\"\u003e// Before entering the begin phase, clear the expiration time.\u003c/span\u003e\r\n  workInProgress.\u003cspan class=\"hljs-property\"\u003eexpirationTime\u003c/span\u003e = \u003cspan class=\"hljs-title class_\"\u003eNoWork\u003c/span\u003e;\r\n\r\n  \u003cspan class=\"hljs-keyword\"\u003eswitch\u003c/span\u003e (workInProgress.\u003cspan class=\"hljs-property\"\u003etag\u003c/span\u003e) {\r\n    \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eIndeterminateComponent\u003c/span\u003e: {\r\n      \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003emountIndeterminateComponent\u003c/span\u003e(\r\n        current,\r\n        workInProgress,\r\n        workInProgress.\u003cspan class=\"hljs-property\"\u003etype\u003c/span\u003e,\r\n        renderExpirationTime,\r\n      );\r\n    }\r\n    \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eLazyComponent\u003c/span\u003e: {\r\n      \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e elementType = workInProgress.\u003cspan class=\"hljs-property\"\u003eelementType\u003c/span\u003e;\r\n      \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003emountLazyComponent\u003c/span\u003e(\r\n        current,\r\n        workInProgress,\r\n        elementType,\r\n        updateExpirationTime,\r\n        renderExpirationTime,\r\n      );\r\n    }\r\n    \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eFunctionComponent\u003c/span\u003e: {\r\n      \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eComponent\u003c/span\u003e = workInProgress.\u003cspan class=\"hljs-property\"\u003etype\u003c/span\u003e;\r\n      \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e unresolvedProps = workInProgress.\u003cspan class=\"hljs-property\"\u003ependingProps\u003c/span\u003e;\r\n      \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e resolvedProps =\r\n        workInProgress.\u003cspan class=\"hljs-property\"\u003eelementType\u003c/span\u003e === \u003cspan class=\"hljs-title class_\"\u003eComponent\u003c/span\u003e\r\n          ? unresolvedProps\r\n          : \u003cspan class=\"hljs-title function_\"\u003eresolveDefaultProps\u003c/span\u003e(\u003cspan class=\"hljs-title class_\"\u003eComponent\u003c/span\u003e, unresolvedProps);\r\n      \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eupdateFunctionComponent\u003c/span\u003e(\r\n        current,\r\n        workInProgress,\r\n        \u003cspan class=\"hljs-title class_\"\u003eComponent\u003c/span\u003e,\r\n        resolvedProps,\r\n        renderExpirationTime,\r\n      );\r\n    }\r\n    \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eClassComponent\u003c/span\u003e: {\r\n      \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eComponent\u003c/span\u003e = workInProgress.\u003cspan class=\"hljs-property\"\u003etype\u003c/span\u003e;\r\n      \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e unresolvedProps = workInProgress.\u003cspan class=\"hljs-property\"\u003ependingProps\u003c/span\u003e;\r\n      \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e resolvedProps =\r\n        workInProgress.\u003cspan class=\"hljs-property\"\u003eelementType\u003c/span\u003e === \u003cspan class=\"hljs-title class_\"\u003eComponent\u003c/span\u003e\r\n          ? unresolvedProps\r\n          : \u003cspan class=\"hljs-title function_\"\u003eresolveDefaultProps\u003c/span\u003e(\u003cspan class=\"hljs-title class_\"\u003eComponent\u003c/span\u003e, unresolvedProps);\r\n      \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eupdateClassComponent\u003c/span\u003e(\r\n        current,\r\n        workInProgress,\r\n        \u003cspan class=\"hljs-title class_\"\u003eComponent\u003c/span\u003e,\r\n        resolvedProps,\r\n        renderExpirationTime,\r\n      );\r\n    }\r\n    \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eHostRoot\u003c/span\u003e:\r\n      \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eupdateHostRoot\u003c/span\u003e(current, workInProgress, renderExpirationTime);\r\n    \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eHostComponent\u003c/span\u003e:\r\n      \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eupdateHostComponent\u003c/span\u003e(current, workInProgress, renderExpirationTime);\r\n    \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eHostText\u003c/span\u003e:\r\n      \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eupdateHostText\u003c/span\u003e(current, workInProgress);\r\n    \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eSuspenseComponent\u003c/span\u003e:\r\n      \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eupdateSuspenseComponent\u003c/span\u003e(\r\n        current,\r\n        workInProgress,\r\n        renderExpirationTime,\r\n      );\r\n    \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eHostPortal\u003c/span\u003e:\r\n      \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eupdatePortalComponent\u003c/span\u003e(\r\n        current,\r\n        workInProgress,\r\n        renderExpirationTime,\r\n      );\r\n    \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eForwardRef\u003c/span\u003e: {\r\n      \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e type = workInProgress.\u003cspan class=\"hljs-property\"\u003etype\u003c/span\u003e;\r\n      \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e unresolvedProps = workInProgress.\u003cspan class=\"hljs-property\"\u003ependingProps\u003c/span\u003e;\r\n      \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e resolvedProps =\r\n        workInProgress.\u003cspan class=\"hljs-property\"\u003eelementType\u003c/span\u003e === type\r\n          ? unresolvedProps\r\n          : \u003cspan class=\"hljs-title function_\"\u003eresolveDefaultProps\u003c/span\u003e(type, unresolvedProps);\r\n      \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eupdateForwardRef\u003c/span\u003e(\r\n        current,\r\n        workInProgress,\r\n        type,\r\n        resolvedProps,\r\n        renderExpirationTime,\r\n      );\r\n    }\r\n    \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eFragment\u003c/span\u003e:\r\n      \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eupdateFragment\u003c/span\u003e(current, workInProgress, renderExpirationTime);\r\n    \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eMode\u003c/span\u003e:\r\n      \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eupdateMode\u003c/span\u003e(current, workInProgress, renderExpirationTime);\r\n    \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eProfiler\u003c/span\u003e:\r\n      \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eupdateProfiler\u003c/span\u003e(current, workInProgress, renderExpirationTime);\r\n    \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eContextProvider\u003c/span\u003e:\r\n      \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eupdateContextProvider\u003c/span\u003e(\r\n        current,\r\n        workInProgress,\r\n        renderExpirationTime,\r\n      );\r\n    \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eContextConsumer\u003c/span\u003e:\r\n      \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eupdateContextConsumer\u003c/span\u003e(\r\n        current,\r\n        workInProgress,\r\n        renderExpirationTime,\r\n      );\r\n    \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eMemoComponent\u003c/span\u003e: {\r\n      \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e type = workInProgress.\u003cspan class=\"hljs-property\"\u003etype\u003c/span\u003e;\r\n      \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e unresolvedProps = workInProgress.\u003cspan class=\"hljs-property\"\u003ependingProps\u003c/span\u003e;\r\n      \u003cspan class=\"hljs-comment\"\u003e// Resolve outer props first, then resolve inner props.\u003c/span\u003e\r\n      \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e resolvedProps = \u003cspan class=\"hljs-title function_\"\u003eresolveDefaultProps\u003c/span\u003e(type, unresolvedProps);\r\n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (__DEV__) {\r\n        \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (workInProgress.\u003cspan class=\"hljs-property\"\u003etype\u003c/span\u003e !== workInProgress.\u003cspan class=\"hljs-property\"\u003eelementType\u003c/span\u003e) {\r\n          \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e outerPropTypes = type.\u003cspan class=\"hljs-property\"\u003epropTypes\u003c/span\u003e;\r\n          \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (outerPropTypes) {\r\n            \u003cspan class=\"hljs-title function_\"\u003echeckPropTypes\u003c/span\u003e(\r\n              outerPropTypes,\r\n              resolvedProps, \u003cspan class=\"hljs-comment\"\u003e// Resolved for outer only\u003c/span\u003e\r\n              \u003cspan class=\"hljs-string\"\u003e'prop'\u003c/span\u003e,\r\n              \u003cspan class=\"hljs-title function_\"\u003egetComponentName\u003c/span\u003e(type),\r\n              getCurrentFiberStackInDev,\r\n            );\r\n          }\r\n        }\r\n      }\r\n      resolvedProps = \u003cspan class=\"hljs-title function_\"\u003eresolveDefaultProps\u003c/span\u003e(type.\u003cspan class=\"hljs-property\"\u003etype\u003c/span\u003e, resolvedProps);\r\n      \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eupdateMemoComponent\u003c/span\u003e(\r\n        current,\r\n        workInProgress,\r\n        type,\r\n        resolvedProps,\r\n        updateExpirationTime,\r\n        renderExpirationTime,\r\n      );\r\n    }\r\n    \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eSimpleMemoComponent\u003c/span\u003e: {\r\n      \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eupdateSimpleMemoComponent\u003c/span\u003e(\r\n        current,\r\n        workInProgress,\r\n        workInProgress.\u003cspan class=\"hljs-property\"\u003etype\u003c/span\u003e,\r\n        workInProgress.\u003cspan class=\"hljs-property\"\u003ependingProps\u003c/span\u003e,\r\n        updateExpirationTime,\r\n        renderExpirationTime,\r\n      );\r\n    }\r\n    \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eIncompleteClassComponent\u003c/span\u003e: {\r\n      \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eComponent\u003c/span\u003e = workInProgress.\u003cspan class=\"hljs-property\"\u003etype\u003c/span\u003e;\r\n      \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e unresolvedProps = workInProgress.\u003cspan class=\"hljs-property\"\u003ependingProps\u003c/span\u003e;\r\n      \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e resolvedProps =\r\n        workInProgress.\u003cspan class=\"hljs-property\"\u003eelementType\u003c/span\u003e === \u003cspan class=\"hljs-title class_\"\u003eComponent\u003c/span\u003e\r\n          ? unresolvedProps\r\n          : \u003cspan class=\"hljs-title function_\"\u003eresolveDefaultProps\u003c/span\u003e(\u003cspan class=\"hljs-title class_\"\u003eComponent\u003c/span\u003e, unresolvedProps);\r\n      \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003emountIncompleteClassComponent\u003c/span\u003e(\r\n        current,\r\n        workInProgress,\r\n        \u003cspan class=\"hljs-title class_\"\u003eComponent\u003c/span\u003e,\r\n        resolvedProps,\r\n        renderExpirationTime,\r\n      );\r\n    }\r\n    \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eSuspenseListComponent\u003c/span\u003e: {\r\n      \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eupdateSuspenseListComponent\u003c/span\u003e(\r\n        current,\r\n        workInProgress,\r\n        renderExpirationTime,\r\n      );\r\n    }\r\n    \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eFundamentalComponent\u003c/span\u003e: {\r\n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (enableFundamentalAPI) {\r\n        \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eupdateFundamentalComponent\u003c/span\u003e(\r\n          current,\r\n          workInProgress,\r\n          renderExpirationTime,\r\n        );\r\n      }\r\n      \u003cspan class=\"hljs-keyword\"\u003ebreak\u003c/span\u003e;\r\n    }\r\n    \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eScopeComponent\u003c/span\u003e: {\r\n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (enableScopeAPI) {\r\n        \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eupdateScopeComponent\u003c/span\u003e(\r\n          current,\r\n          workInProgress,\r\n          renderExpirationTime,\r\n        );\r\n      }\r\n      \u003cspan class=\"hljs-keyword\"\u003ebreak\u003c/span\u003e;\r\n    }\r\n  }\r\n  \u003cspan class=\"hljs-title function_\"\u003einvariant\u003c/span\u003e(\r\n    \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e,\r\n    \u003cspan class=\"hljs-string\"\u003e'Unknown unit of work tag (%s). This error is likely caused by a bug in '\u003c/span\u003e +\r\n      \u003cspan class=\"hljs-string\"\u003e'React. Please file an issue.'\u003c/span\u003e,\r\n    workInProgress.\u003cspan class=\"hljs-property\"\u003etag\u003c/span\u003e,\r\n  );\r\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch5 id=\"updatehostroot\"\u003eupdateHostRoot\u003c/h5\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// packages\\react-reconciler\\src\\ReactFiberBeginWork.js\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eupdateHostRoot\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003ecurrent, workInProgress, renderExpirationTime\u003c/span\u003e) {\r\n  \u003cspan class=\"hljs-title function_\"\u003epushHostRootContext\u003c/span\u003e(workInProgress);\r\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e updateQueue = workInProgress.\u003cspan class=\"hljs-property\"\u003eupdateQueue\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-title function_\"\u003einvariant\u003c/span\u003e(\r\n    updateQueue !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e,\r\n    \u003cspan class=\"hljs-string\"\u003e'If the root does not have an updateQueue, we should have already '\u003c/span\u003e +\r\n      \u003cspan class=\"hljs-string\"\u003e'bailed out. This error is likely caused by a bug in React. Please '\u003c/span\u003e +\r\n      \u003cspan class=\"hljs-string\"\u003e'file an issue.'\u003c/span\u003e,\r\n  );\r\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e nextProps = workInProgress.\u003cspan class=\"hljs-property\"\u003ependingProps\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e prevState = workInProgress.\u003cspan class=\"hljs-property\"\u003ememoizedState\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e prevChildren = prevState !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e ? prevState.\u003cspan class=\"hljs-property\"\u003eelement\u003c/span\u003e : \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-title function_\"\u003eprocessUpdateQueue\u003c/span\u003e(\r\n    workInProgress,\r\n    updateQueue,\r\n    nextProps,\r\n    \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e,\r\n    renderExpirationTime,\r\n  );\r\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e nextState = workInProgress.\u003cspan class=\"hljs-property\"\u003ememoizedState\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-comment\"\u003e// Caution: React DevTools currently depends on this property\u003c/span\u003e\r\n  \u003cspan class=\"hljs-comment\"\u003e// being called \"element\".\u003c/span\u003e\r\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e nextChildren = nextState.\u003cspan class=\"hljs-property\"\u003eelement\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (nextChildren === prevChildren) {\r\n    \u003cspan class=\"hljs-comment\"\u003e// If the state is the same as before, that's a bailout because we had\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// no work that expires at this time.\u003c/span\u003e\r\n    \u003cspan class=\"hljs-title function_\"\u003eresetHydrationState\u003c/span\u003e();\r\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003ebailoutOnAlreadyFinishedWork\u003c/span\u003e(\r\n      current,\r\n      workInProgress,\r\n      renderExpirationTime,\r\n    );\r\n  }\r\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003eroot\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eFiberRoot\u003c/span\u003e = workInProgress.\u003cspan class=\"hljs-property\"\u003estateNode\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (root.\u003cspan class=\"hljs-property\"\u003ehydrate\u003c/span\u003e \u0026#x26;\u0026#x26; \u003cspan class=\"hljs-title function_\"\u003eenterHydrationState\u003c/span\u003e(workInProgress)) {\r\n    \u003cspan class=\"hljs-comment\"\u003e// If we don't have any current children this might be the first pass.\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// We always try to hydrate. If this isn't a hydration pass there won't\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// be any children to hydrate which is effectively the same thing as\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// not hydrating.\u003c/span\u003e\r\n\r\n    \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e child = \u003cspan class=\"hljs-title function_\"\u003emountChildFibers\u003c/span\u003e(\r\n      workInProgress,\r\n      \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e,\r\n      nextChildren,\r\n      renderExpirationTime,\r\n    );\r\n    workInProgress.\u003cspan class=\"hljs-property\"\u003echild\u003c/span\u003e = child;\r\n\r\n    \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e node = child;\r\n    \u003cspan class=\"hljs-keyword\"\u003ewhile\u003c/span\u003e (node) {\r\n      \u003cspan class=\"hljs-comment\"\u003e// Mark each child as hydrating. This is a fast path to know whether this\u003c/span\u003e\r\n      \u003cspan class=\"hljs-comment\"\u003e// tree is part of a hydrating tree. This is used to determine if a child\u003c/span\u003e\r\n      \u003cspan class=\"hljs-comment\"\u003e// node has fully mounted yet, and for scheduling event replaying.\u003c/span\u003e\r\n      \u003cspan class=\"hljs-comment\"\u003e// Conceptually this is similar to Placement in that a new subtree is\u003c/span\u003e\r\n      \u003cspan class=\"hljs-comment\"\u003e// inserted into the React tree here. It just happens to not need DOM\u003c/span\u003e\r\n      \u003cspan class=\"hljs-comment\"\u003e// mutations because it already exists.\u003c/span\u003e\r\n      node.\u003cspan class=\"hljs-property\"\u003eeffectTag\u003c/span\u003e = (node.\u003cspan class=\"hljs-property\"\u003eeffectTag\u003c/span\u003e \u0026#x26; ~\u003cspan class=\"hljs-title class_\"\u003ePlacement\u003c/span\u003e) | \u003cspan class=\"hljs-title class_\"\u003eHydrating\u003c/span\u003e;\r\n      node = node.\u003cspan class=\"hljs-property\"\u003esibling\u003c/span\u003e;\r\n    }\r\n  } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\r\n    \u003cspan class=\"hljs-comment\"\u003e// Otherwise reset hydration state in case we aborted and resumed another\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// root.\u003c/span\u003e\r\n    \u003cspan class=\"hljs-title function_\"\u003ereconcileChildren\u003c/span\u003e(\r\n      current,\r\n      workInProgress,\r\n      nextChildren,\r\n      renderExpirationTime,\r\n    );\r\n    \u003cspan class=\"hljs-title function_\"\u003eresetHydrationState\u003c/span\u003e();\r\n  }\r\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e workInProgress.\u003cspan class=\"hljs-property\"\u003echild\u003c/span\u003e;\r\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch6 id=\"pushhostrootcontext\"\u003epushHostRootContext\u003c/h6\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// packages\\react-reconciler\\src\\ReactFiberBeginWork.js\u003c/span\u003e\r\n\r\n\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003epushHostRootContext\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003eworkInProgress\u003c/span\u003e) {\r\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e root = (workInProgress.\u003cspan class=\"hljs-property\"\u003estateNode\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eFiberRoot\u003c/span\u003e);\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (root.\u003cspan class=\"hljs-property\"\u003ependingContext\u003c/span\u003e) {\r\n    \u003cspan class=\"hljs-title function_\"\u003epushTopLevelContextObject\u003c/span\u003e(\r\n      workInProgress,\r\n      root.\u003cspan class=\"hljs-property\"\u003ependingContext\u003c/span\u003e,\r\n      root.\u003cspan class=\"hljs-property\"\u003ependingContext\u003c/span\u003e !== root.\u003cspan class=\"hljs-property\"\u003econtext\u003c/span\u003e,\r\n    );\r\n  } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (root.\u003cspan class=\"hljs-property\"\u003econtext\u003c/span\u003e) {\r\n    \u003cspan class=\"hljs-comment\"\u003e// Should always be set\u003c/span\u003e\r\n    \u003cspan class=\"hljs-title function_\"\u003epushTopLevelContextObject\u003c/span\u003e(workInProgress, root.\u003cspan class=\"hljs-property\"\u003econtext\u003c/span\u003e, \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e);\r\n  }\r\n  \u003cspan class=\"hljs-title function_\"\u003epushHostContainer\u003c/span\u003e(workInProgress, root.\u003cspan class=\"hljs-property\"\u003econtainerInfo\u003c/span\u003e);\r\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch6 id=\"pushtoplevelcontextobject\"\u003epushTopLevelContextObject\u003c/h6\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// packages\\react-reconciler\\src\\ReactFiberContext.js\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003epushTopLevelContextObject\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\r\n  fiber: Fiber,\r\n  context: \u003cspan class=\"hljs-built_in\"\u003eObject\u003c/span\u003e,\r\n  didChange: boolean,\r\n\u003c/span\u003e): \u003cspan class=\"hljs-keyword\"\u003evoid\u003c/span\u003e {\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (disableLegacyContext) {\r\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e;\r\n  } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\r\n    \u003cspan class=\"hljs-title function_\"\u003einvariant\u003c/span\u003e(\r\n      contextStackCursor.\u003cspan class=\"hljs-property\"\u003ecurrent\u003c/span\u003e === emptyContextObject,\r\n      \u003cspan class=\"hljs-string\"\u003e'Unexpected context found on stack. '\u003c/span\u003e +\r\n        \u003cspan class=\"hljs-string\"\u003e'This error is likely caused by a bug in React. Please file an issue.'\u003c/span\u003e,\r\n    );\r\n\t\u003cspan class=\"hljs-comment\"\u003e// contextStackCursor默认为createCursor(emptyContextObject)，其中emptyContextObject = {}\u003c/span\u003e\r\n\t\u003cspan class=\"hljs-comment\"\u003e// function createCursor\u0026#x3C;T\u003e(defaultValue: T): StackCursor\u0026#x3C;T\u003e {\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e//   return {\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e//     current: defaultValue,\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e//   };\u003c/span\u003e\r\n\t\u003cspan class=\"hljs-comment\"\u003e// }\u003c/span\u003e\r\n    \u003cspan class=\"hljs-title function_\"\u003epush\u003c/span\u003e(contextStackCursor, context, fiber);\r\n    \u003cspan class=\"hljs-title function_\"\u003epush\u003c/span\u003e(didPerformWorkStackCursor, didChange, fiber);\r\n  }\r\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch6 id=\"push\"\u003epush\u003c/h6\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// packages\\react-reconciler\\src\\ReactFiberStack.js\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e push\u0026#x3C;T\u003e(\u003cspan class=\"hljs-attr\"\u003ecursor\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eStackCursor\u003c/span\u003e\u0026#x3C;T\u003e, \u003cspan class=\"hljs-attr\"\u003evalue\u003c/span\u003e: T, \u003cspan class=\"hljs-attr\"\u003efiber\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eFiber\u003c/span\u003e): \u003cspan class=\"hljs-keyword\"\u003evoid\u003c/span\u003e {\r\n  \u003cspan class=\"hljs-comment\"\u003e// 默认index = -1\u003c/span\u003e\r\n  index++;\r\n  \u003cspan class=\"hljs-comment\"\u003e// 默认valueStack = []\u003c/span\u003e\r\n  valueStack[index] = cursor.\u003cspan class=\"hljs-property\"\u003ecurrent\u003c/span\u003e;\r\n\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (__DEV__) {\r\n    fiberStack[index] = fiber;\r\n  }\r\n\r\n  cursor.\u003cspan class=\"hljs-property\"\u003ecurrent\u003c/span\u003e = value;\r\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch6 id=\"pushhostcontainer\"\u003epushHostContainer\u003c/h6\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// packages\\react-reconciler\\src\\ReactFiberHostContext.js\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003epushHostContainer\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003efiber: Fiber, nextRootInstance: Container\u003c/span\u003e) {\r\n  \u003cspan class=\"hljs-comment\"\u003e// Push current root instance onto the stack;\u003c/span\u003e\r\n  \u003cspan class=\"hljs-comment\"\u003e// This allows us to reset root when portals are popped.\u003c/span\u003e\r\n  \u003cspan class=\"hljs-title function_\"\u003epush\u003c/span\u003e(rootInstanceStackCursor, nextRootInstance, fiber);\r\n  \u003cspan class=\"hljs-comment\"\u003e// Track the context and the Fiber that provided it.\u003c/span\u003e\r\n  \u003cspan class=\"hljs-comment\"\u003e// This enables us to pop only Fibers that provide unique contexts.\u003c/span\u003e\r\n  \u003cspan class=\"hljs-title function_\"\u003epush\u003c/span\u003e(contextFiberStackCursor, fiber, fiber);\r\n\r\n  \u003cspan class=\"hljs-comment\"\u003e// Finally, we need to push the host context to the stack.\u003c/span\u003e\r\n  \u003cspan class=\"hljs-comment\"\u003e// However, we can't just call getRootHostContext() and push it because\u003c/span\u003e\r\n  \u003cspan class=\"hljs-comment\"\u003e// we'd have a different number of entries on the stack depending on\u003c/span\u003e\r\n  \u003cspan class=\"hljs-comment\"\u003e// whether getRootHostContext() throws somewhere in renderer code or not.\u003c/span\u003e\r\n  \u003cspan class=\"hljs-comment\"\u003e// So we push an empty value first. This lets us safely unwind on errors.\u003c/span\u003e\r\n  \u003cspan class=\"hljs-title function_\"\u003epush\u003c/span\u003e(contextStackCursor, \u003cspan class=\"hljs-variable constant_\"\u003eNO_CONTEXT\u003c/span\u003e, fiber);\r\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e nextRootContext = \u003cspan class=\"hljs-title function_\"\u003egetRootHostContext\u003c/span\u003e(nextRootInstance);\r\n  \u003cspan class=\"hljs-comment\"\u003e// Now that we know this function doesn't throw, replace it.\u003c/span\u003e\r\n  \u003cspan class=\"hljs-title function_\"\u003epop\u003c/span\u003e(contextStackCursor, fiber);\r\n  \u003cspan class=\"hljs-title function_\"\u003epush\u003c/span\u003e(contextStackCursor, nextRootContext, fiber);\r\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch5 id=\"processupdatequeue\"\u003eprocessUpdateQueue\u003c/h5\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// packages\\react-reconciler\\src\\ReactUpdateQueue.js\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e processUpdateQueue\u0026#x3C;\u003cspan class=\"hljs-title class_\"\u003eState\u003c/span\u003e\u003e(\r\n  \u003cspan class=\"hljs-attr\"\u003eworkInProgress\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eFiber\u003c/span\u003e,\r\n  \u003cspan class=\"hljs-attr\"\u003equeue\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eUpdateQueue\u003c/span\u003e\u0026#x3C;\u003cspan class=\"hljs-title class_\"\u003eState\u003c/span\u003e\u003e,\r\n  \u003cspan class=\"hljs-attr\"\u003eprops\u003c/span\u003e: any,\r\n  \u003cspan class=\"hljs-attr\"\u003einstance\u003c/span\u003e: any,\r\n  \u003cspan class=\"hljs-attr\"\u003erenderExpirationTime\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eExpirationTime\u003c/span\u003e,\r\n): \u003cspan class=\"hljs-keyword\"\u003evoid\u003c/span\u003e {\r\n  hasForceUpdate = \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e;\r\n\r\n  queue = \u003cspan class=\"hljs-title function_\"\u003eensureWorkInProgressQueueIsAClone\u003c/span\u003e(workInProgress, queue);\r\n\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (__DEV__) {\r\n    currentlyProcessingQueue = queue;\r\n  }\r\n\r\n  \u003cspan class=\"hljs-comment\"\u003e// These values may change as we process the queue.\u003c/span\u003e\r\n  \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e newBaseState = queue.\u003cspan class=\"hljs-property\"\u003ebaseState\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e newFirstUpdate = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e newExpirationTime = \u003cspan class=\"hljs-title class_\"\u003eNoWork\u003c/span\u003e;\r\n\r\n  \u003cspan class=\"hljs-comment\"\u003e// Iterate through the list of updates to compute the result.\u003c/span\u003e\r\n  \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e update = queue.\u003cspan class=\"hljs-property\"\u003efirstUpdate\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e resultState = newBaseState;\r\n  \u003cspan class=\"hljs-keyword\"\u003ewhile\u003c/span\u003e (update !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e updateExpirationTime = update.\u003cspan class=\"hljs-property\"\u003eexpirationTime\u003c/span\u003e;\r\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (updateExpirationTime \u0026#x3C; renderExpirationTime) {\r\n      \u003cspan class=\"hljs-comment\"\u003e// This update does not have sufficient priority. Skip it.\u003c/span\u003e\r\n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (newFirstUpdate === \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n        \u003cspan class=\"hljs-comment\"\u003e// This is the first skipped update. It will be the first update in\u003c/span\u003e\r\n        \u003cspan class=\"hljs-comment\"\u003e// the new list.\u003c/span\u003e\r\n        newFirstUpdate = update;\r\n        \u003cspan class=\"hljs-comment\"\u003e// Since this is the first update that was skipped, the current result\u003c/span\u003e\r\n        \u003cspan class=\"hljs-comment\"\u003e// is the new base state.\u003c/span\u003e\r\n        newBaseState = resultState;\r\n      }\r\n      \u003cspan class=\"hljs-comment\"\u003e// Since this update will remain in the list, update the remaining\u003c/span\u003e\r\n      \u003cspan class=\"hljs-comment\"\u003e// expiration time.\u003c/span\u003e\r\n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (newExpirationTime \u0026#x3C; updateExpirationTime) {\r\n        newExpirationTime = updateExpirationTime;\r\n      }\r\n    } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\r\n      \u003cspan class=\"hljs-comment\"\u003e// This update does have sufficient priority.\u003c/span\u003e\r\n\r\n      \u003cspan class=\"hljs-comment\"\u003e// Mark the event time of this update as relevant to this render pass.\u003c/span\u003e\r\n      \u003cspan class=\"hljs-comment\"\u003e// \u003cspan class=\"hljs-doctag\"\u003eTODO:\u003c/span\u003e This should ideally use the true event time of this update rather than\u003c/span\u003e\r\n      \u003cspan class=\"hljs-comment\"\u003e// its priority which is a derived and not reverseable value.\u003c/span\u003e\r\n      \u003cspan class=\"hljs-comment\"\u003e// \u003cspan class=\"hljs-doctag\"\u003eTODO:\u003c/span\u003e We should skip this update if it was already committed but currently\u003c/span\u003e\r\n      \u003cspan class=\"hljs-comment\"\u003e// we have no way of detecting the difference between a committed and suspended\u003c/span\u003e\r\n      \u003cspan class=\"hljs-comment\"\u003e// update here.\u003c/span\u003e\r\n      \u003cspan class=\"hljs-title function_\"\u003emarkRenderEventTimeAndConfig\u003c/span\u003e(updateExpirationTime, update.\u003cspan class=\"hljs-property\"\u003esuspenseConfig\u003c/span\u003e);\r\n\r\n      \u003cspan class=\"hljs-comment\"\u003e// Process it and compute a new result.\u003c/span\u003e\r\n      resultState = \u003cspan class=\"hljs-title function_\"\u003egetStateFromUpdate\u003c/span\u003e(\r\n        workInProgress,\r\n        queue,\r\n        update,\r\n        resultState,\r\n        props,\r\n        instance,\r\n      );\r\n      \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e callback = update.\u003cspan class=\"hljs-property\"\u003ecallback\u003c/span\u003e;\r\n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (callback !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n        workInProgress.\u003cspan class=\"hljs-property\"\u003eeffectTag\u003c/span\u003e |= \u003cspan class=\"hljs-title class_\"\u003eCallback\u003c/span\u003e;\r\n        \u003cspan class=\"hljs-comment\"\u003e// Set this to null, in case it was mutated during an aborted render.\u003c/span\u003e\r\n        update.\u003cspan class=\"hljs-property\"\u003enextEffect\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n        \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (queue.\u003cspan class=\"hljs-property\"\u003elastEffect\u003c/span\u003e === \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n          queue.\u003cspan class=\"hljs-property\"\u003efirstEffect\u003c/span\u003e = queue.\u003cspan class=\"hljs-property\"\u003elastEffect\u003c/span\u003e = update;\r\n        } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\r\n          queue.\u003cspan class=\"hljs-property\"\u003elastEffect\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003enextEffect\u003c/span\u003e = update;\r\n          queue.\u003cspan class=\"hljs-property\"\u003elastEffect\u003c/span\u003e = update;\r\n        }\r\n      }\r\n    }\r\n    \u003cspan class=\"hljs-comment\"\u003e// Continue to the next update.\u003c/span\u003e\r\n    update = update.\u003cspan class=\"hljs-property\"\u003enext\u003c/span\u003e;\r\n  }\r\n\r\n  \u003cspan class=\"hljs-comment\"\u003e// Separately, iterate though the list of captured updates.\u003c/span\u003e\r\n  \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e newFirstCapturedUpdate = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n  update = queue.\u003cspan class=\"hljs-property\"\u003efirstCapturedUpdate\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-keyword\"\u003ewhile\u003c/span\u003e (update !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e updateExpirationTime = update.\u003cspan class=\"hljs-property\"\u003eexpirationTime\u003c/span\u003e;\r\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (updateExpirationTime \u0026#x3C; renderExpirationTime) {\r\n      \u003cspan class=\"hljs-comment\"\u003e// This update does not have sufficient priority. Skip it.\u003c/span\u003e\r\n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (newFirstCapturedUpdate === \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n        \u003cspan class=\"hljs-comment\"\u003e// This is the first skipped captured update. It will be the first\u003c/span\u003e\r\n        \u003cspan class=\"hljs-comment\"\u003e// update in the new list.\u003c/span\u003e\r\n        newFirstCapturedUpdate = update;\r\n        \u003cspan class=\"hljs-comment\"\u003e// If this is the first update that was skipped, the current result is\u003c/span\u003e\r\n        \u003cspan class=\"hljs-comment\"\u003e// the new base state.\u003c/span\u003e\r\n        \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (newFirstUpdate === \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n          newBaseState = resultState;\r\n        }\r\n      }\r\n      \u003cspan class=\"hljs-comment\"\u003e// Since this update will remain in the list, update the remaining\u003c/span\u003e\r\n      \u003cspan class=\"hljs-comment\"\u003e// expiration time.\u003c/span\u003e\r\n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (newExpirationTime \u0026#x3C; updateExpirationTime) {\r\n        newExpirationTime = updateExpirationTime;\r\n      }\r\n    } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\r\n      \u003cspan class=\"hljs-comment\"\u003e// This update does have sufficient priority. Process it and compute\u003c/span\u003e\r\n      \u003cspan class=\"hljs-comment\"\u003e// a new result.\u003c/span\u003e\r\n      resultState = \u003cspan class=\"hljs-title function_\"\u003egetStateFromUpdate\u003c/span\u003e(\r\n        workInProgress,\r\n        queue,\r\n        update,\r\n        resultState,\r\n        props,\r\n        instance,\r\n      );\r\n      \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e callback = update.\u003cspan class=\"hljs-property\"\u003ecallback\u003c/span\u003e;\r\n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (callback !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n        workInProgress.\u003cspan class=\"hljs-property\"\u003eeffectTag\u003c/span\u003e |= \u003cspan class=\"hljs-title class_\"\u003eCallback\u003c/span\u003e;\r\n        \u003cspan class=\"hljs-comment\"\u003e// Set this to null, in case it was mutated during an aborted render.\u003c/span\u003e\r\n        update.\u003cspan class=\"hljs-property\"\u003enextEffect\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n        \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (queue.\u003cspan class=\"hljs-property\"\u003elastCapturedEffect\u003c/span\u003e === \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n          queue.\u003cspan class=\"hljs-property\"\u003efirstCapturedEffect\u003c/span\u003e = queue.\u003cspan class=\"hljs-property\"\u003elastCapturedEffect\u003c/span\u003e = update;\r\n        } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\r\n          queue.\u003cspan class=\"hljs-property\"\u003elastCapturedEffect\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003enextEffect\u003c/span\u003e = update;\r\n          queue.\u003cspan class=\"hljs-property\"\u003elastCapturedEffect\u003c/span\u003e = update;\r\n        }\r\n      }\r\n    }\r\n    update = update.\u003cspan class=\"hljs-property\"\u003enext\u003c/span\u003e;\r\n  }\r\n\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (newFirstUpdate === \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n    queue.\u003cspan class=\"hljs-property\"\u003elastUpdate\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n  }\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (newFirstCapturedUpdate === \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n    queue.\u003cspan class=\"hljs-property\"\u003elastCapturedUpdate\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n  } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\r\n    workInProgress.\u003cspan class=\"hljs-property\"\u003eeffectTag\u003c/span\u003e |= \u003cspan class=\"hljs-title class_\"\u003eCallback\u003c/span\u003e;\r\n  }\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (newFirstUpdate === \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e \u0026#x26;\u0026#x26; newFirstCapturedUpdate === \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n    \u003cspan class=\"hljs-comment\"\u003e// We processed every update, without skipping. That means the new base\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// state is the same as the result state.\u003c/span\u003e\r\n    newBaseState = resultState;\r\n  }\r\n\r\n  queue.\u003cspan class=\"hljs-property\"\u003ebaseState\u003c/span\u003e = newBaseState;\r\n  queue.\u003cspan class=\"hljs-property\"\u003efirstUpdate\u003c/span\u003e = newFirstUpdate;\r\n  queue.\u003cspan class=\"hljs-property\"\u003efirstCapturedUpdate\u003c/span\u003e = newFirstCapturedUpdate;\r\n\r\n  \u003cspan class=\"hljs-comment\"\u003e// Set the remaining expiration time to be whatever is remaining in the queue.\u003c/span\u003e\r\n  \u003cspan class=\"hljs-comment\"\u003e// This should be fine because the only two other things that contribute to\u003c/span\u003e\r\n  \u003cspan class=\"hljs-comment\"\u003e// expiration time are props and context. We're already in the middle of the\u003c/span\u003e\r\n  \u003cspan class=\"hljs-comment\"\u003e// begin phase by the time we start processing the queue, so we've already\u003c/span\u003e\r\n  \u003cspan class=\"hljs-comment\"\u003e// dealt with the props. Context in components that specify\u003c/span\u003e\r\n  \u003cspan class=\"hljs-comment\"\u003e// shouldComponentUpdate is tricky; but we'll have to account for\u003c/span\u003e\r\n  \u003cspan class=\"hljs-comment\"\u003e// that regardless.\u003c/span\u003e\r\n  \u003cspan class=\"hljs-title function_\"\u003emarkUnprocessedUpdateTime\u003c/span\u003e(newExpirationTime);\r\n  workInProgress.\u003cspan class=\"hljs-property\"\u003eexpirationTime\u003c/span\u003e = newExpirationTime;\r\n  workInProgress.\u003cspan class=\"hljs-property\"\u003ememoizedState\u003c/span\u003e = resultState;\r\n\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (__DEV__) {\r\n    currentlyProcessingQueue = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n  }\r\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch6 id=\"getstatefromupdate\"\u003egetStateFromUpdate\u003c/h6\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// packages\\react-reconciler\\src\\ReactUpdateQueue.js\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e getStateFromUpdate\u0026#x3C;\u003cspan class=\"hljs-title class_\"\u003eState\u003c/span\u003e\u003e(\r\n  \u003cspan class=\"hljs-attr\"\u003eworkInProgress\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eFiber\u003c/span\u003e,\r\n  \u003cspan class=\"hljs-attr\"\u003equeue\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eUpdateQueue\u003c/span\u003e\u0026#x3C;\u003cspan class=\"hljs-title class_\"\u003eState\u003c/span\u003e\u003e,\r\n  \u003cspan class=\"hljs-attr\"\u003eupdate\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eUpdate\u003c/span\u003e\u0026#x3C;\u003cspan class=\"hljs-title class_\"\u003eState\u003c/span\u003e\u003e,\r\n  \u003cspan class=\"hljs-attr\"\u003eprevState\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eState\u003c/span\u003e,\r\n  \u003cspan class=\"hljs-attr\"\u003enextProps\u003c/span\u003e: any,\r\n  \u003cspan class=\"hljs-attr\"\u003einstance\u003c/span\u003e: any,\r\n): any {\r\n  \u003cspan class=\"hljs-keyword\"\u003eswitch\u003c/span\u003e (update.\u003cspan class=\"hljs-property\"\u003etag\u003c/span\u003e) {\r\n    \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eReplaceState\u003c/span\u003e: {\r\n      \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e payload = update.\u003cspan class=\"hljs-property\"\u003epayload\u003c/span\u003e;\r\n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (\u003cspan class=\"hljs-keyword\"\u003etypeof\u003c/span\u003e payload === \u003cspan class=\"hljs-string\"\u003e'function'\u003c/span\u003e) {\r\n        \u003cspan class=\"hljs-comment\"\u003e// Updater function\u003c/span\u003e\r\n        \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (__DEV__) {\r\n          \u003cspan class=\"hljs-title function_\"\u003eenterDisallowedContextReadInDEV\u003c/span\u003e();\r\n          \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (\r\n            debugRenderPhaseSideEffects ||\r\n            (debugRenderPhaseSideEffectsForStrictMode \u0026#x26;\u0026#x26;\r\n              workInProgress.\u003cspan class=\"hljs-property\"\u003emode\u003c/span\u003e \u0026#x26; \u003cspan class=\"hljs-title class_\"\u003eStrictMode\u003c/span\u003e)\r\n          ) {\r\n            payload.\u003cspan class=\"hljs-title function_\"\u003ecall\u003c/span\u003e(instance, prevState, nextProps);\r\n          }\r\n        }\r\n        \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e nextState = payload.\u003cspan class=\"hljs-title function_\"\u003ecall\u003c/span\u003e(instance, prevState, nextProps);\r\n        \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (__DEV__) {\r\n          \u003cspan class=\"hljs-title function_\"\u003eexitDisallowedContextReadInDEV\u003c/span\u003e();\r\n        }\r\n        \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e nextState;\r\n      }\r\n      \u003cspan class=\"hljs-comment\"\u003e// State object\u003c/span\u003e\r\n      \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e payload;\r\n    }\r\n    \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eCaptureUpdate\u003c/span\u003e: {\r\n      workInProgress.\u003cspan class=\"hljs-property\"\u003eeffectTag\u003c/span\u003e =\r\n        (workInProgress.\u003cspan class=\"hljs-property\"\u003eeffectTag\u003c/span\u003e \u0026#x26; ~\u003cspan class=\"hljs-title class_\"\u003eShouldCapture\u003c/span\u003e) | \u003cspan class=\"hljs-title class_\"\u003eDidCapture\u003c/span\u003e;\r\n    }\r\n    \u003cspan class=\"hljs-comment\"\u003e// Intentional fallthrough\u003c/span\u003e\r\n    \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eUpdateState\u003c/span\u003e: {\r\n      \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e payload = update.\u003cspan class=\"hljs-property\"\u003epayload\u003c/span\u003e;\r\n      \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e partialState;\r\n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (\u003cspan class=\"hljs-keyword\"\u003etypeof\u003c/span\u003e payload === \u003cspan class=\"hljs-string\"\u003e'function'\u003c/span\u003e) {\r\n        \u003cspan class=\"hljs-comment\"\u003e// Updater function\u003c/span\u003e\r\n        \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (__DEV__) {\r\n          \u003cspan class=\"hljs-title function_\"\u003eenterDisallowedContextReadInDEV\u003c/span\u003e();\r\n          \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (\r\n            debugRenderPhaseSideEffects ||\r\n            (debugRenderPhaseSideEffectsForStrictMode \u0026#x26;\u0026#x26;\r\n              workInProgress.\u003cspan class=\"hljs-property\"\u003emode\u003c/span\u003e \u0026#x26; \u003cspan class=\"hljs-title class_\"\u003eStrictMode\u003c/span\u003e)\r\n          ) {\r\n            payload.\u003cspan class=\"hljs-title function_\"\u003ecall\u003c/span\u003e(instance, prevState, nextProps);\r\n          }\r\n        }\r\n        partialState = payload.\u003cspan class=\"hljs-title function_\"\u003ecall\u003c/span\u003e(instance, prevState, nextProps);\r\n        \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (__DEV__) {\r\n          \u003cspan class=\"hljs-title function_\"\u003eexitDisallowedContextReadInDEV\u003c/span\u003e();\r\n        }\r\n      } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\r\n        \u003cspan class=\"hljs-comment\"\u003e// Partial state object\u003c/span\u003e\r\n        partialState = payload;\r\n      }\r\n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (partialState === \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e || partialState === \u003cspan class=\"hljs-literal\"\u003eundefined\u003c/span\u003e) {\r\n        \u003cspan class=\"hljs-comment\"\u003e// Null and undefined are treated as no-ops.\u003c/span\u003e\r\n        \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e prevState;\r\n      }\r\n      \u003cspan class=\"hljs-comment\"\u003e// Merge the partial state and the previous state.\u003c/span\u003e\r\n      \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eObject\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003eassign\u003c/span\u003e({}, prevState, partialState);\r\n    }\r\n    \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eForceUpdate\u003c/span\u003e: {\r\n      hasForceUpdate = \u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e;\r\n      \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e prevState;\r\n    }\r\n  }\r\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e prevState;\r\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch5 id=\"reconcilechildren\"\u003ereconcileChildren\u003c/h5\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// packages\\react-reconciler\\src\\ReactFiberBeginWork.js\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003ereconcileChildren\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\r\n  current: Fiber | \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e,\r\n  workInProgress: Fiber,\r\n  nextChildren: any,\r\n  renderExpirationTime: ExpirationTime,\r\n\u003c/span\u003e) {\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (current === \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n    \u003cspan class=\"hljs-comment\"\u003e// If this is a fresh new component that hasn't been rendered yet, we\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// won't update its child set by applying minimal side-effects. Instead,\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// we will add them all to the child before it gets rendered. That means\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// we can optimize this reconciliation pass by not tracking side-effects.\u003c/span\u003e\r\n    workInProgress.\u003cspan class=\"hljs-property\"\u003echild\u003c/span\u003e = \u003cspan class=\"hljs-title function_\"\u003emountChildFibers\u003c/span\u003e(\r\n      workInProgress,\r\n      \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e,\r\n      nextChildren,\r\n      renderExpirationTime,\r\n    );\r\n  } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\r\n    \u003cspan class=\"hljs-comment\"\u003e// If the current child is the same as the work in progress, it means that\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// we haven't yet started any work on these children. Therefore, we use\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// the clone algorithm to create a copy of all the current children.\u003c/span\u003e\r\n\r\n    \u003cspan class=\"hljs-comment\"\u003e// If we had any progressed work already, that is invalid at this point so\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// let's throw it out.\u003c/span\u003e\r\n    workInProgress.\u003cspan class=\"hljs-property\"\u003echild\u003c/span\u003e = \u003cspan class=\"hljs-title function_\"\u003ereconcileChildFibers\u003c/span\u003e(\r\n      workInProgress,\r\n      current.\u003cspan class=\"hljs-property\"\u003echild\u003c/span\u003e,\r\n      nextChildren,\r\n      renderExpirationTime,\r\n    );\r\n  }\r\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch5 id=\"reconcilechildfibers\"\u003ereconcileChildFibers\u003c/h5\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// packages\\react-reconciler\\src\\ReactChildFiber.js\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003ereconcileChildFibers\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\r\n    returnFiber: Fiber,\r\n    currentFirstChild: Fiber | \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e,\r\n    newChild: any,\r\n    expirationTime: ExpirationTime,\r\n  \u003c/span\u003e): \u003cspan class=\"hljs-title class_\"\u003eFiber\u003c/span\u003e | \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e {\r\n    \u003cspan class=\"hljs-comment\"\u003e// This function is not recursive.\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// If the top level item is an array, we treat it as a set of children,\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// not as a fragment. Nested arrays on the other hand will be treated as\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// fragment nodes. Recursion happens at the normal flow.\u003c/span\u003e\r\n\r\n    \u003cspan class=\"hljs-comment\"\u003e// Handle top level unkeyed fragments as if they were arrays.\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// This leads to an ambiguity between \u0026#x3C;\u003e{[...]}\u0026#x3C;/\u003e and \u0026#x3C;\u003e...\u0026#x3C;/\u003e.\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// We treat the ambiguous cases above the same.\u003c/span\u003e\r\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e isUnkeyedTopLevelFragment =\r\n      \u003cspan class=\"hljs-keyword\"\u003etypeof\u003c/span\u003e newChild === \u003cspan class=\"hljs-string\"\u003e'object'\u003c/span\u003e \u0026#x26;\u0026#x26;\r\n      newChild !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e \u0026#x26;\u0026#x26;\r\n      newChild.\u003cspan class=\"hljs-property\"\u003etype\u003c/span\u003e === \u003cspan class=\"hljs-variable constant_\"\u003eREACT_FRAGMENT_TYPE\u003c/span\u003e \u0026#x26;\u0026#x26;\r\n      newChild.\u003cspan class=\"hljs-property\"\u003ekey\u003c/span\u003e === \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (isUnkeyedTopLevelFragment) {\r\n      newChild = newChild.\u003cspan class=\"hljs-property\"\u003eprops\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003echildren\u003c/span\u003e;\r\n    }\r\n\r\n    \u003cspan class=\"hljs-comment\"\u003e// Handle object types\u003c/span\u003e\r\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e isObject = \u003cspan class=\"hljs-keyword\"\u003etypeof\u003c/span\u003e newChild === \u003cspan class=\"hljs-string\"\u003e'object'\u003c/span\u003e \u0026#x26;\u0026#x26; newChild !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n\r\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (isObject) {\r\n      \u003cspan class=\"hljs-keyword\"\u003eswitch\u003c/span\u003e (newChild.\u003cspan class=\"hljs-property\"\u003e$$typeof\u003c/span\u003e) {\r\n        \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003eREACT_ELEMENT_TYPE\u003c/span\u003e:\r\n          \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eplaceSingleChild\u003c/span\u003e(\r\n            \u003cspan class=\"hljs-title function_\"\u003ereconcileSingleElement\u003c/span\u003e(\r\n              returnFiber,\r\n              currentFirstChild,\r\n              newChild,\r\n              expirationTime,\r\n            ),\r\n          );\r\n        \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003eREACT_PORTAL_TYPE\u003c/span\u003e:\r\n          \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eplaceSingleChild\u003c/span\u003e(\r\n            \u003cspan class=\"hljs-title function_\"\u003ereconcileSinglePortal\u003c/span\u003e(\r\n              returnFiber,\r\n              currentFirstChild,\r\n              newChild,\r\n              expirationTime,\r\n            ),\r\n          );\r\n      }\r\n    }\r\n\r\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (\u003cspan class=\"hljs-keyword\"\u003etypeof\u003c/span\u003e newChild === \u003cspan class=\"hljs-string\"\u003e'string'\u003c/span\u003e || \u003cspan class=\"hljs-keyword\"\u003etypeof\u003c/span\u003e newChild === \u003cspan class=\"hljs-string\"\u003e'number'\u003c/span\u003e) {\r\n      \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eplaceSingleChild\u003c/span\u003e(\r\n        \u003cspan class=\"hljs-title function_\"\u003ereconcileSingleTextNode\u003c/span\u003e(\r\n          returnFiber,\r\n          currentFirstChild,\r\n          \u003cspan class=\"hljs-string\"\u003e''\u003c/span\u003e + newChild,\r\n          expirationTime,\r\n        ),\r\n      );\r\n    }\r\n\r\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (\u003cspan class=\"hljs-title function_\"\u003eisArray\u003c/span\u003e(newChild)) {\r\n      \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003ereconcileChildrenArray\u003c/span\u003e(\r\n        returnFiber,\r\n        currentFirstChild,\r\n        newChild,\r\n        expirationTime,\r\n      );\r\n    }\r\n\r\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (\u003cspan class=\"hljs-title function_\"\u003egetIteratorFn\u003c/span\u003e(newChild)) {\r\n      \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003ereconcileChildrenIterator\u003c/span\u003e(\r\n        returnFiber,\r\n        currentFirstChild,\r\n        newChild,\r\n        expirationTime,\r\n      );\r\n    }\r\n\r\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (isObject) {\r\n      \u003cspan class=\"hljs-title function_\"\u003ethrowOnInvalidObjectType\u003c/span\u003e(returnFiber, newChild);\r\n    }\r\n\r\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (__DEV__) {\r\n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (\u003cspan class=\"hljs-keyword\"\u003etypeof\u003c/span\u003e newChild === \u003cspan class=\"hljs-string\"\u003e'function'\u003c/span\u003e) {\r\n        \u003cspan class=\"hljs-title function_\"\u003ewarnOnFunctionType\u003c/span\u003e();\r\n      }\r\n    }\r\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (\u003cspan class=\"hljs-keyword\"\u003etypeof\u003c/span\u003e newChild === \u003cspan class=\"hljs-string\"\u003e'undefined'\u003c/span\u003e \u0026#x26;\u0026#x26; !isUnkeyedTopLevelFragment) {\r\n      \u003cspan class=\"hljs-comment\"\u003e// If the new child is undefined, and the return fiber is a composite\u003c/span\u003e\r\n      \u003cspan class=\"hljs-comment\"\u003e// component, throw an error. If Fiber return types are disabled,\u003c/span\u003e\r\n      \u003cspan class=\"hljs-comment\"\u003e// we already threw above.\u003c/span\u003e\r\n      \u003cspan class=\"hljs-keyword\"\u003eswitch\u003c/span\u003e (returnFiber.\u003cspan class=\"hljs-property\"\u003etag\u003c/span\u003e) {\r\n        \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eClassComponent\u003c/span\u003e: {\r\n          \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (__DEV__) {\r\n            \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e instance = returnFiber.\u003cspan class=\"hljs-property\"\u003estateNode\u003c/span\u003e;\r\n            \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (instance.\u003cspan class=\"hljs-property\"\u003erender\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003e_isMockFunction\u003c/span\u003e) {\r\n              \u003cspan class=\"hljs-comment\"\u003e// We allow auto-mocks to proceed as if they're returning null.\u003c/span\u003e\r\n              \u003cspan class=\"hljs-keyword\"\u003ebreak\u003c/span\u003e;\r\n            }\r\n          }\r\n        }\r\n        \u003cspan class=\"hljs-comment\"\u003e// Intentionally fall through to the next case, which handles both\u003c/span\u003e\r\n        \u003cspan class=\"hljs-comment\"\u003e// functions and classes\u003c/span\u003e\r\n        \u003cspan class=\"hljs-comment\"\u003e// eslint-disable-next-lined no-fallthrough\u003c/span\u003e\r\n        \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eFunctionComponent\u003c/span\u003e: {\r\n          \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eComponent\u003c/span\u003e = returnFiber.\u003cspan class=\"hljs-property\"\u003etype\u003c/span\u003e;\r\n          \u003cspan class=\"hljs-title function_\"\u003einvariant\u003c/span\u003e(\r\n            \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e,\r\n            \u003cspan class=\"hljs-string\"\u003e'%s(...): Nothing was returned from render. This usually means a '\u003c/span\u003e +\r\n              \u003cspan class=\"hljs-string\"\u003e'return statement is missing. Or, to render nothing, '\u003c/span\u003e +\r\n              \u003cspan class=\"hljs-string\"\u003e'return null.'\u003c/span\u003e,\r\n            \u003cspan class=\"hljs-title class_\"\u003eComponent\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003edisplayName\u003c/span\u003e || \u003cspan class=\"hljs-title class_\"\u003eComponent\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ename\u003c/span\u003e || \u003cspan class=\"hljs-string\"\u003e'Component'\u003c/span\u003e,\r\n          );\r\n        }\r\n      }\r\n    }\r\n\r\n    \u003cspan class=\"hljs-comment\"\u003e// Remaining cases are all treated as empty.\u003c/span\u003e\r\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003edeleteRemainingChildren\u003c/span\u003e(returnFiber, currentFirstChild);\r\n  }\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch5 id=\"reconcilesingleelement\"\u003ereconcileSingleElement\u003c/h5\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// packages\\react-reconciler\\src\\ReactChildFiber.js\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003ereconcileSingleElement\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\r\n    returnFiber: Fiber,\r\n    currentFirstChild: Fiber | \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e,\r\n    element: ReactElement,\r\n    expirationTime: ExpirationTime,\r\n  \u003c/span\u003e): \u003cspan class=\"hljs-title class_\"\u003eFiber\u003c/span\u003e {\r\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e key = element.\u003cspan class=\"hljs-property\"\u003ekey\u003c/span\u003e;\r\n    \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e child = currentFirstChild;\r\n    \u003cspan class=\"hljs-keyword\"\u003ewhile\u003c/span\u003e (child !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n      \u003cspan class=\"hljs-comment\"\u003e// \u003cspan class=\"hljs-doctag\"\u003eTODO:\u003c/span\u003e If key === null and child.key === null, then this only applies to\u003c/span\u003e\r\n      \u003cspan class=\"hljs-comment\"\u003e// the first item in the list.\u003c/span\u003e\r\n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (child.\u003cspan class=\"hljs-property\"\u003ekey\u003c/span\u003e === key) {\r\n        \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (\r\n          child.\u003cspan class=\"hljs-property\"\u003etag\u003c/span\u003e === \u003cspan class=\"hljs-title class_\"\u003eFragment\u003c/span\u003e\r\n            ? element.\u003cspan class=\"hljs-property\"\u003etype\u003c/span\u003e === \u003cspan class=\"hljs-variable constant_\"\u003eREACT_FRAGMENT_TYPE\u003c/span\u003e\r\n            : child.\u003cspan class=\"hljs-property\"\u003eelementType\u003c/span\u003e === element.\u003cspan class=\"hljs-property\"\u003etype\u003c/span\u003e ||\r\n              \u003cspan class=\"hljs-comment\"\u003e// Keep this check inline so it only runs on the false path:\u003c/span\u003e\r\n              (__DEV__\r\n                ? \u003cspan class=\"hljs-title function_\"\u003eisCompatibleFamilyForHotReloading\u003c/span\u003e(child, element)\r\n                : \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e)\r\n        ) {\r\n          \u003cspan class=\"hljs-title function_\"\u003edeleteRemainingChildren\u003c/span\u003e(returnFiber, child.\u003cspan class=\"hljs-property\"\u003esibling\u003c/span\u003e);\r\n          \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e existing = \u003cspan class=\"hljs-title function_\"\u003euseFiber\u003c/span\u003e(\r\n            child,\r\n            element.\u003cspan class=\"hljs-property\"\u003etype\u003c/span\u003e === \u003cspan class=\"hljs-variable constant_\"\u003eREACT_FRAGMENT_TYPE\u003c/span\u003e\r\n              ? element.\u003cspan class=\"hljs-property\"\u003eprops\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003echildren\u003c/span\u003e\r\n              : element.\u003cspan class=\"hljs-property\"\u003eprops\u003c/span\u003e,\r\n            expirationTime,\r\n          );\r\n          existing.\u003cspan class=\"hljs-property\"\u003eref\u003c/span\u003e = \u003cspan class=\"hljs-title function_\"\u003ecoerceRef\u003c/span\u003e(returnFiber, child, element);\r\n          existing.\u003cspan class=\"hljs-property\"\u003ereturn\u003c/span\u003e = returnFiber;\r\n          \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (__DEV__) {\r\n            existing.\u003cspan class=\"hljs-property\"\u003e_debugSource\u003c/span\u003e = element.\u003cspan class=\"hljs-property\"\u003e_source\u003c/span\u003e;\r\n            existing.\u003cspan class=\"hljs-property\"\u003e_debugOwner\u003c/span\u003e = element.\u003cspan class=\"hljs-property\"\u003e_owner\u003c/span\u003e;\r\n          }\r\n          \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e existing;\r\n        } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\r\n          \u003cspan class=\"hljs-title function_\"\u003edeleteRemainingChildren\u003c/span\u003e(returnFiber, child);\r\n          \u003cspan class=\"hljs-keyword\"\u003ebreak\u003c/span\u003e;\r\n        }\r\n      } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\r\n        \u003cspan class=\"hljs-title function_\"\u003edeleteChild\u003c/span\u003e(returnFiber, child);\r\n      }\r\n      child = child.\u003cspan class=\"hljs-property\"\u003esibling\u003c/span\u003e;\r\n    }\r\n\r\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (element.\u003cspan class=\"hljs-property\"\u003etype\u003c/span\u003e === \u003cspan class=\"hljs-variable constant_\"\u003eREACT_FRAGMENT_TYPE\u003c/span\u003e) {\r\n      \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e created = \u003cspan class=\"hljs-title function_\"\u003ecreateFiberFromFragment\u003c/span\u003e(\r\n        element.\u003cspan class=\"hljs-property\"\u003eprops\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003echildren\u003c/span\u003e,\r\n        returnFiber.\u003cspan class=\"hljs-property\"\u003emode\u003c/span\u003e,\r\n        expirationTime,\r\n        element.\u003cspan class=\"hljs-property\"\u003ekey\u003c/span\u003e,\r\n      );\r\n      created.\u003cspan class=\"hljs-property\"\u003ereturn\u003c/span\u003e = returnFiber;\r\n      \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e created;\r\n    } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\r\n      \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e created = \u003cspan class=\"hljs-title function_\"\u003ecreateFiberFromElement\u003c/span\u003e(\r\n        element,\r\n        returnFiber.\u003cspan class=\"hljs-property\"\u003emode\u003c/span\u003e,\r\n        expirationTime,\r\n      );\r\n      created.\u003cspan class=\"hljs-property\"\u003eref\u003c/span\u003e = \u003cspan class=\"hljs-title function_\"\u003ecoerceRef\u003c/span\u003e(returnFiber, currentFirstChild, element);\r\n      created.\u003cspan class=\"hljs-property\"\u003ereturn\u003c/span\u003e = returnFiber;\r\n      \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e created;\r\n    }\r\n  }\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch6 id=\"createfiberfromelement\"\u003ecreateFiberFromElement\u003c/h6\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// packages\\react-reconciler\\src\\ReactFiber.js\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003ecreateFiberFromElement\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\r\n  element: ReactElement,\r\n  mode: TypeOfMode,\r\n  expirationTime: ExpirationTime,\r\n\u003c/span\u003e): \u003cspan class=\"hljs-title class_\"\u003eFiber\u003c/span\u003e {\r\n  \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e owner = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (__DEV__) {\r\n    owner = element.\u003cspan class=\"hljs-property\"\u003e_owner\u003c/span\u003e;\r\n  }\r\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e type = element.\u003cspan class=\"hljs-property\"\u003etype\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e key = element.\u003cspan class=\"hljs-property\"\u003ekey\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e pendingProps = element.\u003cspan class=\"hljs-property\"\u003eprops\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e fiber = \u003cspan class=\"hljs-title function_\"\u003ecreateFiberFromTypeAndProps\u003c/span\u003e(\r\n    type,\r\n    key,\r\n    pendingProps,\r\n    owner,\r\n    mode,\r\n    expirationTime,\r\n  );\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (__DEV__) {\r\n    fiber.\u003cspan class=\"hljs-property\"\u003e_debugSource\u003c/span\u003e = element.\u003cspan class=\"hljs-property\"\u003e_source\u003c/span\u003e;\r\n    fiber.\u003cspan class=\"hljs-property\"\u003e_debugOwner\u003c/span\u003e = element.\u003cspan class=\"hljs-property\"\u003e_owner\u003c/span\u003e;\r\n  }\r\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e fiber;\r\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch6 id=\"\"\u003e\u003c/h6\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// packages\\react-reconciler\\src\\ReactChildFiber.js\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003ecoerceRef\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\r\n  returnFiber: Fiber,\r\n  current: Fiber | \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e,\r\n  element: ReactElement,\r\n\u003c/span\u003e) {\r\n  \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e mixedRef = element.\u003cspan class=\"hljs-property\"\u003eref\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (\r\n    mixedRef !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e \u0026#x26;\u0026#x26;\r\n    \u003cspan class=\"hljs-keyword\"\u003etypeof\u003c/span\u003e mixedRef !== \u003cspan class=\"hljs-string\"\u003e'function'\u003c/span\u003e \u0026#x26;\u0026#x26;\r\n    \u003cspan class=\"hljs-keyword\"\u003etypeof\u003c/span\u003e mixedRef !== \u003cspan class=\"hljs-string\"\u003e'object'\u003c/span\u003e\r\n  ) {\r\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (__DEV__) {\r\n      \u003cspan class=\"hljs-comment\"\u003e// \u003cspan class=\"hljs-doctag\"\u003eTODO:\u003c/span\u003e Clean this up once we turn on the string ref warning for\u003c/span\u003e\r\n      \u003cspan class=\"hljs-comment\"\u003e// everyone, because the strict mode case will no longer be relevant\u003c/span\u003e\r\n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (returnFiber.\u003cspan class=\"hljs-property\"\u003emode\u003c/span\u003e \u0026#x26; \u003cspan class=\"hljs-title class_\"\u003eStrictMode\u003c/span\u003e || warnAboutStringRefs) {\r\n        \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e componentName = \u003cspan class=\"hljs-title function_\"\u003egetComponentName\u003c/span\u003e(returnFiber.\u003cspan class=\"hljs-property\"\u003etype\u003c/span\u003e) || \u003cspan class=\"hljs-string\"\u003e'Component'\u003c/span\u003e;\r\n        \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (!didWarnAboutStringRefs[componentName]) {\r\n          \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (warnAboutStringRefs) {\r\n            \u003cspan class=\"hljs-title function_\"\u003ewarningWithoutStack\u003c/span\u003e(\r\n              \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e,\r\n              \u003cspan class=\"hljs-string\"\u003e'Component \"%s\" contains the string ref \"%s\". Support for string refs '\u003c/span\u003e +\r\n                \u003cspan class=\"hljs-string\"\u003e'will be removed in a future major release. We recommend using '\u003c/span\u003e +\r\n                \u003cspan class=\"hljs-string\"\u003e'useRef() or createRef() instead. '\u003c/span\u003e +\r\n                \u003cspan class=\"hljs-string\"\u003e'Learn more about using refs safely here: '\u003c/span\u003e +\r\n                \u003cspan class=\"hljs-string\"\u003e'https://fb.me/react-strict-mode-string-ref%s'\u003c/span\u003e,\r\n              componentName,\r\n              mixedRef,\r\n              \u003cspan class=\"hljs-title function_\"\u003egetStackByFiberInDevAndProd\u003c/span\u003e(returnFiber),\r\n            );\r\n          } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\r\n            \u003cspan class=\"hljs-title function_\"\u003ewarningWithoutStack\u003c/span\u003e(\r\n              \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e,\r\n              \u003cspan class=\"hljs-string\"\u003e'A string ref, \"%s\", has been found within a strict mode tree. '\u003c/span\u003e +\r\n                \u003cspan class=\"hljs-string\"\u003e'String refs are a source of potential bugs and should be avoided. '\u003c/span\u003e +\r\n                \u003cspan class=\"hljs-string\"\u003e'We recommend using useRef() or createRef() instead. '\u003c/span\u003e +\r\n                \u003cspan class=\"hljs-string\"\u003e'Learn more about using refs safely here: '\u003c/span\u003e +\r\n                \u003cspan class=\"hljs-string\"\u003e'https://fb.me/react-strict-mode-string-ref%s'\u003c/span\u003e,\r\n              mixedRef,\r\n              \u003cspan class=\"hljs-title function_\"\u003egetStackByFiberInDevAndProd\u003c/span\u003e(returnFiber),\r\n            );\r\n          }\r\n          didWarnAboutStringRefs[componentName] = \u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e;\r\n        }\r\n      }\r\n    }\r\n\r\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (element.\u003cspan class=\"hljs-property\"\u003e_owner\u003c/span\u003e) {\r\n      \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003eowner\u003c/span\u003e: ?\u003cspan class=\"hljs-title class_\"\u003eFiber\u003c/span\u003e = (element.\u003cspan class=\"hljs-property\"\u003e_owner\u003c/span\u003e: any);\r\n      \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e inst;\r\n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (owner) {\r\n        \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e ownerFiber = ((\u003cspan class=\"hljs-attr\"\u003eowner\u003c/span\u003e: any): \u003cspan class=\"hljs-title class_\"\u003eFiber\u003c/span\u003e);\r\n        \u003cspan class=\"hljs-title function_\"\u003einvariant\u003c/span\u003e(\r\n          ownerFiber.\u003cspan class=\"hljs-property\"\u003etag\u003c/span\u003e === \u003cspan class=\"hljs-title class_\"\u003eClassComponent\u003c/span\u003e,\r\n          \u003cspan class=\"hljs-string\"\u003e'Function components cannot have refs. '\u003c/span\u003e +\r\n            \u003cspan class=\"hljs-string\"\u003e'Did you mean to use React.forwardRef()?'\u003c/span\u003e,\r\n        );\r\n        inst = ownerFiber.\u003cspan class=\"hljs-property\"\u003estateNode\u003c/span\u003e;\r\n      }\r\n      \u003cspan class=\"hljs-title function_\"\u003einvariant\u003c/span\u003e(\r\n        inst,\r\n        \u003cspan class=\"hljs-string\"\u003e'Missing owner for string ref %s. This error is likely caused by a '\u003c/span\u003e +\r\n          \u003cspan class=\"hljs-string\"\u003e'bug in React. Please file an issue.'\u003c/span\u003e,\r\n        mixedRef,\r\n      );\r\n      \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e stringRef = \u003cspan class=\"hljs-string\"\u003e''\u003c/span\u003e + mixedRef;\r\n      \u003cspan class=\"hljs-comment\"\u003e// Check if previous string ref matches new string ref\u003c/span\u003e\r\n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (\r\n        current !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e \u0026#x26;\u0026#x26;\r\n        current.\u003cspan class=\"hljs-property\"\u003eref\u003c/span\u003e !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e \u0026#x26;\u0026#x26;\r\n        \u003cspan class=\"hljs-keyword\"\u003etypeof\u003c/span\u003e current.\u003cspan class=\"hljs-property\"\u003eref\u003c/span\u003e === \u003cspan class=\"hljs-string\"\u003e'function'\u003c/span\u003e \u0026#x26;\u0026#x26;\r\n        current.\u003cspan class=\"hljs-property\"\u003eref\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003e_stringRef\u003c/span\u003e === stringRef\r\n      ) {\r\n        \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e current.\u003cspan class=\"hljs-property\"\u003eref\u003c/span\u003e;\r\n      }\r\n      \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e ref = \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003evalue\u003c/span\u003e) {\r\n        \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e refs = inst.\u003cspan class=\"hljs-property\"\u003erefs\u003c/span\u003e;\r\n        \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (refs === emptyRefsObject) {\r\n          \u003cspan class=\"hljs-comment\"\u003e// This is a lazy pooled frozen object, so we need to initialize.\u003c/span\u003e\r\n          refs = inst.\u003cspan class=\"hljs-property\"\u003erefs\u003c/span\u003e = {};\r\n        }\r\n        \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (value === \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n          \u003cspan class=\"hljs-keyword\"\u003edelete\u003c/span\u003e refs[stringRef];\r\n        } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\r\n          refs[stringRef] = value;\r\n        }\r\n      };\r\n      ref.\u003cspan class=\"hljs-property\"\u003e_stringRef\u003c/span\u003e = stringRef;\r\n      \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e ref;\r\n    } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\r\n      \u003cspan class=\"hljs-title function_\"\u003einvariant\u003c/span\u003e(\r\n        \u003cspan class=\"hljs-keyword\"\u003etypeof\u003c/span\u003e mixedRef === \u003cspan class=\"hljs-string\"\u003e'string'\u003c/span\u003e,\r\n        \u003cspan class=\"hljs-string\"\u003e'Expected ref to be a function, a string, an object returned by React.createRef(), or null.'\u003c/span\u003e,\r\n      );\r\n      \u003cspan class=\"hljs-title function_\"\u003einvariant\u003c/span\u003e(\r\n        element.\u003cspan class=\"hljs-property\"\u003e_owner\u003c/span\u003e,\r\n        \u003cspan class=\"hljs-string\"\u003e'Element ref was specified as a string (%s) but no owner was set. This could happen for one of'\u003c/span\u003e +\r\n          \u003cspan class=\"hljs-string\"\u003e' the following reasons:\\n'\u003c/span\u003e +\r\n          \u003cspan class=\"hljs-string\"\u003e'1. You may be adding a ref to a function component\\n'\u003c/span\u003e +\r\n          \u003cspan class=\"hljs-string\"\u003e\"2. You may be adding a ref to a component that was not created inside a component's render method\\n\"\u003c/span\u003e +\r\n          \u003cspan class=\"hljs-string\"\u003e'3. You have multiple copies of React loaded\\n'\u003c/span\u003e +\r\n          \u003cspan class=\"hljs-string\"\u003e'See https://fb.me/react-refs-must-have-owner for more information.'\u003c/span\u003e,\r\n        mixedRef,\r\n      );\r\n    }\r\n  }\r\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e mixedRef;\r\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch5 id=\"placesinglechild\"\u003eplaceSingleChild\u003c/h5\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// packages\\react-reconciler\\src\\ReactChildFiber.js\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eplaceSingleChild\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003enewFiber: Fiber\u003c/span\u003e): \u003cspan class=\"hljs-title class_\"\u003eFiber\u003c/span\u003e {\r\n    \u003cspan class=\"hljs-comment\"\u003e// This is simpler for the single child case. We only need to do a\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// placement for inserting new children.\u003c/span\u003e\r\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (shouldTrackSideEffects \u0026#x26;\u0026#x26; newFiber.\u003cspan class=\"hljs-property\"\u003ealternate\u003c/span\u003e === \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n      newFiber.\u003cspan class=\"hljs-property\"\u003eeffectTag\u003c/span\u003e = \u003cspan class=\"hljs-title class_\"\u003ePlacement\u003c/span\u003e;\r\n    }\r\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e newFiber;\r\n  }\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch5 id=\"completeunitofwork\"\u003ecompleteUnitOfWork\u003c/h5\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// packages\\react-reconciler\\src\\ReactFiberWorkLoop.js\u003c/span\u003e\r\n\r\n\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003ecompleteUnitOfWork\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003eunitOfWork: Fiber\u003c/span\u003e): \u003cspan class=\"hljs-title class_\"\u003eFiber\u003c/span\u003e | \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e {\r\n  \u003cspan class=\"hljs-comment\"\u003e// Attempt to complete the current unit of work, then move to the next\u003c/span\u003e\r\n  \u003cspan class=\"hljs-comment\"\u003e// sibling. If there are no more siblings, return to the parent fiber.\u003c/span\u003e\r\n  workInProgress = unitOfWork;\r\n  \u003cspan class=\"hljs-keyword\"\u003edo\u003c/span\u003e {\r\n    \u003cspan class=\"hljs-comment\"\u003e// The current, flushed, state of this fiber is the alternate. Ideally\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// nothing should rely on this, but relying on it here means that we don't\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// need an additional field on the work in progress.\u003c/span\u003e\r\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e current = workInProgress.\u003cspan class=\"hljs-property\"\u003ealternate\u003c/span\u003e;\r\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e returnFiber = workInProgress.\u003cspan class=\"hljs-property\"\u003ereturn\u003c/span\u003e;\r\n\r\n    \u003cspan class=\"hljs-comment\"\u003e// Check if the work completed or if something threw.\u003c/span\u003e\r\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e ((workInProgress.\u003cspan class=\"hljs-property\"\u003eeffectTag\u003c/span\u003e \u0026#x26; \u003cspan class=\"hljs-title class_\"\u003eIncomplete\u003c/span\u003e) === \u003cspan class=\"hljs-title class_\"\u003eNoEffect\u003c/span\u003e) {\r\n      \u003cspan class=\"hljs-title function_\"\u003esetCurrentDebugFiberInDEV\u003c/span\u003e(workInProgress);\r\n      \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e next;\r\n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (\r\n        !enableProfilerTimer ||\r\n        (workInProgress.\u003cspan class=\"hljs-property\"\u003emode\u003c/span\u003e \u0026#x26; \u003cspan class=\"hljs-title class_\"\u003eProfileMode\u003c/span\u003e) === \u003cspan class=\"hljs-title class_\"\u003eNoMode\u003c/span\u003e\r\n      ) {\r\n        next = \u003cspan class=\"hljs-title function_\"\u003ecompleteWork\u003c/span\u003e(current, workInProgress, renderExpirationTime);\r\n      } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\r\n        \u003cspan class=\"hljs-title function_\"\u003estartProfilerTimer\u003c/span\u003e(workInProgress);\r\n        next = \u003cspan class=\"hljs-title function_\"\u003ecompleteWork\u003c/span\u003e(current, workInProgress, renderExpirationTime);\r\n        \u003cspan class=\"hljs-comment\"\u003e// Update render duration assuming we didn't error.\u003c/span\u003e\r\n        \u003cspan class=\"hljs-title function_\"\u003estopProfilerTimerIfRunningAndRecordDelta\u003c/span\u003e(workInProgress, \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e);\r\n      }\r\n      \u003cspan class=\"hljs-title function_\"\u003estopWorkTimer\u003c/span\u003e(workInProgress);\r\n      \u003cspan class=\"hljs-title function_\"\u003eresetCurrentDebugFiberInDEV\u003c/span\u003e();\r\n      \u003cspan class=\"hljs-title function_\"\u003eresetChildExpirationTime\u003c/span\u003e(workInProgress);\r\n\r\n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (next !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n        \u003cspan class=\"hljs-comment\"\u003e// Completing this fiber spawned new work. Work on that next.\u003c/span\u003e\r\n        \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e next;\r\n      }\r\n\r\n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (\r\n        returnFiber !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e \u0026#x26;\u0026#x26;\r\n        \u003cspan class=\"hljs-comment\"\u003e// Do not append effects to parents if a sibling failed to complete\u003c/span\u003e\r\n        (returnFiber.\u003cspan class=\"hljs-property\"\u003eeffectTag\u003c/span\u003e \u0026#x26; \u003cspan class=\"hljs-title class_\"\u003eIncomplete\u003c/span\u003e) === \u003cspan class=\"hljs-title class_\"\u003eNoEffect\u003c/span\u003e\r\n      ) {\r\n        \u003cspan class=\"hljs-comment\"\u003e// Append all the effects of the subtree and this fiber onto the effect\u003c/span\u003e\r\n        \u003cspan class=\"hljs-comment\"\u003e// list of the parent. The completion order of the children affects the\u003c/span\u003e\r\n        \u003cspan class=\"hljs-comment\"\u003e// side-effect order.\u003c/span\u003e\r\n        \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (returnFiber.\u003cspan class=\"hljs-property\"\u003efirstEffect\u003c/span\u003e === \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n          returnFiber.\u003cspan class=\"hljs-property\"\u003efirstEffect\u003c/span\u003e = workInProgress.\u003cspan class=\"hljs-property\"\u003efirstEffect\u003c/span\u003e;\r\n        }\r\n        \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (workInProgress.\u003cspan class=\"hljs-property\"\u003elastEffect\u003c/span\u003e !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n          \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (returnFiber.\u003cspan class=\"hljs-property\"\u003elastEffect\u003c/span\u003e !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n            returnFiber.\u003cspan class=\"hljs-property\"\u003elastEffect\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003enextEffect\u003c/span\u003e = workInProgress.\u003cspan class=\"hljs-property\"\u003efirstEffect\u003c/span\u003e;\r\n          }\r\n          returnFiber.\u003cspan class=\"hljs-property\"\u003elastEffect\u003c/span\u003e = workInProgress.\u003cspan class=\"hljs-property\"\u003elastEffect\u003c/span\u003e;\r\n        }\r\n\r\n        \u003cspan class=\"hljs-comment\"\u003e// If this fiber had side-effects, we append it AFTER the children's\u003c/span\u003e\r\n        \u003cspan class=\"hljs-comment\"\u003e// side-effects. We can perform certain side-effects earlier if needed,\u003c/span\u003e\r\n        \u003cspan class=\"hljs-comment\"\u003e// by doing multiple passes over the effect list. We don't want to\u003c/span\u003e\r\n        \u003cspan class=\"hljs-comment\"\u003e// schedule our own side-effect on our own list because if end up\u003c/span\u003e\r\n        \u003cspan class=\"hljs-comment\"\u003e// reusing children we'll schedule this effect onto itself since we're\u003c/span\u003e\r\n        \u003cspan class=\"hljs-comment\"\u003e// at the end.\u003c/span\u003e\r\n        \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e effectTag = workInProgress.\u003cspan class=\"hljs-property\"\u003eeffectTag\u003c/span\u003e;\r\n\r\n        \u003cspan class=\"hljs-comment\"\u003e// Skip both NoWork and PerformedWork tags when creating the effect\u003c/span\u003e\r\n        \u003cspan class=\"hljs-comment\"\u003e// list. PerformedWork effect is read by React DevTools but shouldn't be\u003c/span\u003e\r\n        \u003cspan class=\"hljs-comment\"\u003e// committed.\u003c/span\u003e\r\n        \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (effectTag \u003e \u003cspan class=\"hljs-title class_\"\u003ePerformedWork\u003c/span\u003e) {\r\n          \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (returnFiber.\u003cspan class=\"hljs-property\"\u003elastEffect\u003c/span\u003e !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n            returnFiber.\u003cspan class=\"hljs-property\"\u003elastEffect\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003enextEffect\u003c/span\u003e = workInProgress;\r\n          } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\r\n            returnFiber.\u003cspan class=\"hljs-property\"\u003efirstEffect\u003c/span\u003e = workInProgress;\r\n          }\r\n          returnFiber.\u003cspan class=\"hljs-property\"\u003elastEffect\u003c/span\u003e = workInProgress;\r\n        }\r\n      }\r\n    } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\r\n      \u003cspan class=\"hljs-comment\"\u003e// This fiber did not complete because something threw. Pop values off\u003c/span\u003e\r\n      \u003cspan class=\"hljs-comment\"\u003e// the stack without entering the complete phase. If this is a boundary,\u003c/span\u003e\r\n      \u003cspan class=\"hljs-comment\"\u003e// capture values if possible.\u003c/span\u003e\r\n      \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e next = \u003cspan class=\"hljs-title function_\"\u003eunwindWork\u003c/span\u003e(workInProgress, renderExpirationTime);\r\n\r\n      \u003cspan class=\"hljs-comment\"\u003e// Because this fiber did not complete, don't reset its expiration time.\u003c/span\u003e\r\n\r\n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (\r\n        enableProfilerTimer \u0026#x26;\u0026#x26;\r\n        (workInProgress.\u003cspan class=\"hljs-property\"\u003emode\u003c/span\u003e \u0026#x26; \u003cspan class=\"hljs-title class_\"\u003eProfileMode\u003c/span\u003e) !== \u003cspan class=\"hljs-title class_\"\u003eNoMode\u003c/span\u003e\r\n      ) {\r\n        \u003cspan class=\"hljs-comment\"\u003e// Record the render duration for the fiber that errored.\u003c/span\u003e\r\n        \u003cspan class=\"hljs-title function_\"\u003estopProfilerTimerIfRunningAndRecordDelta\u003c/span\u003e(workInProgress, \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e);\r\n\r\n        \u003cspan class=\"hljs-comment\"\u003e// Include the time spent working on failed children before continuing.\u003c/span\u003e\r\n        \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e actualDuration = workInProgress.\u003cspan class=\"hljs-property\"\u003eactualDuration\u003c/span\u003e;\r\n        \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e child = workInProgress.\u003cspan class=\"hljs-property\"\u003echild\u003c/span\u003e;\r\n        \u003cspan class=\"hljs-keyword\"\u003ewhile\u003c/span\u003e (child !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n          actualDuration += child.\u003cspan class=\"hljs-property\"\u003eactualDuration\u003c/span\u003e;\r\n          child = child.\u003cspan class=\"hljs-property\"\u003esibling\u003c/span\u003e;\r\n        }\r\n        workInProgress.\u003cspan class=\"hljs-property\"\u003eactualDuration\u003c/span\u003e = actualDuration;\r\n      }\r\n\r\n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (next !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n        \u003cspan class=\"hljs-comment\"\u003e// If completing this work spawned new work, do that next. We'll come\u003c/span\u003e\r\n        \u003cspan class=\"hljs-comment\"\u003e// back here again.\u003c/span\u003e\r\n        \u003cspan class=\"hljs-comment\"\u003e// Since we're restarting, remove anything that is not a host effect\u003c/span\u003e\r\n        \u003cspan class=\"hljs-comment\"\u003e// from the effect tag.\u003c/span\u003e\r\n        \u003cspan class=\"hljs-comment\"\u003e// \u003cspan class=\"hljs-doctag\"\u003eTODO:\u003c/span\u003e The name stopFailedWorkTimer is misleading because Suspense\u003c/span\u003e\r\n        \u003cspan class=\"hljs-comment\"\u003e// also captures and restarts.\u003c/span\u003e\r\n        \u003cspan class=\"hljs-title function_\"\u003estopFailedWorkTimer\u003c/span\u003e(workInProgress);\r\n        next.\u003cspan class=\"hljs-property\"\u003eeffectTag\u003c/span\u003e \u0026#x26;= \u003cspan class=\"hljs-title class_\"\u003eHostEffectMask\u003c/span\u003e;\r\n        \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e next;\r\n      }\r\n      \u003cspan class=\"hljs-title function_\"\u003estopWorkTimer\u003c/span\u003e(workInProgress);\r\n\r\n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (returnFiber !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n        \u003cspan class=\"hljs-comment\"\u003e// Mark the parent fiber as incomplete and clear its effect list.\u003c/span\u003e\r\n        returnFiber.\u003cspan class=\"hljs-property\"\u003efirstEffect\u003c/span\u003e = returnFiber.\u003cspan class=\"hljs-property\"\u003elastEffect\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n        returnFiber.\u003cspan class=\"hljs-property\"\u003eeffectTag\u003c/span\u003e |= \u003cspan class=\"hljs-title class_\"\u003eIncomplete\u003c/span\u003e;\r\n      }\r\n    }\r\n\r\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e siblingFiber = workInProgress.\u003cspan class=\"hljs-property\"\u003esibling\u003c/span\u003e;\r\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (siblingFiber !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n      \u003cspan class=\"hljs-comment\"\u003e// If there is more work to do in this returnFiber, do that next.\u003c/span\u003e\r\n      \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e siblingFiber;\r\n    }\r\n    \u003cspan class=\"hljs-comment\"\u003e// Otherwise, return to the parent\u003c/span\u003e\r\n    workInProgress = returnFiber;\r\n  } \u003cspan class=\"hljs-keyword\"\u003ewhile\u003c/span\u003e (workInProgress !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e);\r\n\r\n  \u003cspan class=\"hljs-comment\"\u003e// We've reached the root.\u003c/span\u003e\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (workInProgressRootExitStatus === \u003cspan class=\"hljs-title class_\"\u003eRootIncomplete\u003c/span\u003e) {\r\n    workInProgressRootExitStatus = \u003cspan class=\"hljs-title class_\"\u003eRootCompleted\u003c/span\u003e;\r\n  }\r\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch4 id=\"completework\"\u003ecompleteWork\u003c/h4\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// packages\\react-reconciler\\src\\ReactFiberCompleteWork.js\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003ecompleteWork\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\r\n  current: Fiber | \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e,\r\n  workInProgress: Fiber,\r\n  renderExpirationTime: ExpirationTime,\r\n\u003c/span\u003e): \u003cspan class=\"hljs-title class_\"\u003eFiber\u003c/span\u003e | \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e {\r\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e newProps = workInProgress.\u003cspan class=\"hljs-property\"\u003ependingProps\u003c/span\u003e;\r\n\r\n  \u003cspan class=\"hljs-keyword\"\u003eswitch\u003c/span\u003e (workInProgress.\u003cspan class=\"hljs-property\"\u003etag\u003c/span\u003e) {\r\n    \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eIndeterminateComponent\u003c/span\u003e:\r\n      \u003cspan class=\"hljs-keyword\"\u003ebreak\u003c/span\u003e;\r\n    \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eLazyComponent\u003c/span\u003e:\r\n      \u003cspan class=\"hljs-keyword\"\u003ebreak\u003c/span\u003e;\r\n    \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eSimpleMemoComponent\u003c/span\u003e:\r\n    \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eFunctionComponent\u003c/span\u003e:\r\n      \u003cspan class=\"hljs-keyword\"\u003ebreak\u003c/span\u003e;\r\n    \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eClassComponent\u003c/span\u003e: {\r\n      \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eComponent\u003c/span\u003e = workInProgress.\u003cspan class=\"hljs-property\"\u003etype\u003c/span\u003e;\r\n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (\u003cspan class=\"hljs-title function_\"\u003eisLegacyContextProvider\u003c/span\u003e(\u003cspan class=\"hljs-title class_\"\u003eComponent\u003c/span\u003e)) {\r\n        \u003cspan class=\"hljs-title function_\"\u003epopLegacyContext\u003c/span\u003e(workInProgress);\r\n      }\r\n      \u003cspan class=\"hljs-keyword\"\u003ebreak\u003c/span\u003e;\r\n    }\r\n    \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eHostRoot\u003c/span\u003e: {\r\n      \u003cspan class=\"hljs-title function_\"\u003epopHostContainer\u003c/span\u003e(workInProgress);\r\n      \u003cspan class=\"hljs-title function_\"\u003epopTopLevelLegacyContextObject\u003c/span\u003e(workInProgress);\r\n      \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e fiberRoot = (workInProgress.\u003cspan class=\"hljs-property\"\u003estateNode\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eFiberRoot\u003c/span\u003e);\r\n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (fiberRoot.\u003cspan class=\"hljs-property\"\u003ependingContext\u003c/span\u003e) {\r\n        fiberRoot.\u003cspan class=\"hljs-property\"\u003econtext\u003c/span\u003e = fiberRoot.\u003cspan class=\"hljs-property\"\u003ependingContext\u003c/span\u003e;\r\n        fiberRoot.\u003cspan class=\"hljs-property\"\u003ependingContext\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n      }\r\n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (current === \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e || current.\u003cspan class=\"hljs-property\"\u003echild\u003c/span\u003e === \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n        \u003cspan class=\"hljs-comment\"\u003e// If we hydrated, pop so that we can delete any remaining children\u003c/span\u003e\r\n        \u003cspan class=\"hljs-comment\"\u003e// that weren't hydrated.\u003c/span\u003e\r\n        \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e wasHydrated = \u003cspan class=\"hljs-title function_\"\u003epopHydrationState\u003c/span\u003e(workInProgress);\r\n        \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (wasHydrated) {\r\n          \u003cspan class=\"hljs-comment\"\u003e// If we hydrated, then we'll need to schedule an update for\u003c/span\u003e\r\n          \u003cspan class=\"hljs-comment\"\u003e// the commit side-effects on the root.\u003c/span\u003e\r\n          \u003cspan class=\"hljs-title function_\"\u003emarkUpdate\u003c/span\u003e(workInProgress);\r\n        }\r\n      }\r\n      \u003cspan class=\"hljs-title function_\"\u003eupdateHostContainer\u003c/span\u003e(workInProgress);\r\n      \u003cspan class=\"hljs-keyword\"\u003ebreak\u003c/span\u003e;\r\n    }\r\n    \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eHostComponent\u003c/span\u003e: {\r\n      \u003cspan class=\"hljs-title function_\"\u003epopHostContext\u003c/span\u003e(workInProgress);\r\n      \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e rootContainerInstance = \u003cspan class=\"hljs-title function_\"\u003egetRootHostContainer\u003c/span\u003e();\r\n      \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e type = workInProgress.\u003cspan class=\"hljs-property\"\u003etype\u003c/span\u003e;\r\n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (current !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e \u0026#x26;\u0026#x26; workInProgress.\u003cspan class=\"hljs-property\"\u003estateNode\u003c/span\u003e != \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n        \u003cspan class=\"hljs-title function_\"\u003eupdateHostComponent\u003c/span\u003e(\r\n          current,\r\n          workInProgress,\r\n          type,\r\n          newProps,\r\n          rootContainerInstance,\r\n        );\r\n\r\n        \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (enableFlareAPI) {\r\n          \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e prevListeners = current.\u003cspan class=\"hljs-property\"\u003ememoizedProps\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003elisteners\u003c/span\u003e;\r\n          \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e nextListeners = newProps.\u003cspan class=\"hljs-property\"\u003elisteners\u003c/span\u003e;\r\n          \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (prevListeners !== nextListeners) {\r\n            \u003cspan class=\"hljs-title function_\"\u003emarkUpdate\u003c/span\u003e(workInProgress);\r\n          }\r\n        }\r\n\r\n        \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (current.\u003cspan class=\"hljs-property\"\u003eref\u003c/span\u003e !== workInProgress.\u003cspan class=\"hljs-property\"\u003eref\u003c/span\u003e) {\r\n          \u003cspan class=\"hljs-title function_\"\u003emarkRef\u003c/span\u003e(workInProgress);\r\n        }\r\n      } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\r\n        \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (!newProps) {\r\n          \u003cspan class=\"hljs-title function_\"\u003einvariant\u003c/span\u003e(\r\n            workInProgress.\u003cspan class=\"hljs-property\"\u003estateNode\u003c/span\u003e !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e,\r\n            \u003cspan class=\"hljs-string\"\u003e'We must have new props for new mounts. This error is likely '\u003c/span\u003e +\r\n              \u003cspan class=\"hljs-string\"\u003e'caused by a bug in React. Please file an issue.'\u003c/span\u003e,\r\n          );\r\n          \u003cspan class=\"hljs-comment\"\u003e// This can happen when we abort work.\u003c/span\u003e\r\n          \u003cspan class=\"hljs-keyword\"\u003ebreak\u003c/span\u003e;\r\n        }\r\n\r\n        \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e currentHostContext = \u003cspan class=\"hljs-title function_\"\u003egetHostContext\u003c/span\u003e();\r\n        \u003cspan class=\"hljs-comment\"\u003e// \u003cspan class=\"hljs-doctag\"\u003eTODO:\u003c/span\u003e Move createInstance to beginWork and keep it on a context\u003c/span\u003e\r\n        \u003cspan class=\"hljs-comment\"\u003e// \"stack\" as the parent. Then append children as we go in beginWork\u003c/span\u003e\r\n        \u003cspan class=\"hljs-comment\"\u003e// or completeWork depending on we want to add then top-\u003edown or\u003c/span\u003e\r\n        \u003cspan class=\"hljs-comment\"\u003e// bottom-\u003eup. Top-\u003edown is faster in IE11.\u003c/span\u003e\r\n        \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e wasHydrated = \u003cspan class=\"hljs-title function_\"\u003epopHydrationState\u003c/span\u003e(workInProgress);\r\n        \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (wasHydrated) {\r\n          \u003cspan class=\"hljs-comment\"\u003e// \u003cspan class=\"hljs-doctag\"\u003eTODO:\u003c/span\u003e Move this and createInstance step into the beginPhase\u003c/span\u003e\r\n          \u003cspan class=\"hljs-comment\"\u003e// to consolidate.\u003c/span\u003e\r\n          \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (\r\n            \u003cspan class=\"hljs-title function_\"\u003eprepareToHydrateHostInstance\u003c/span\u003e(\r\n              workInProgress,\r\n              rootContainerInstance,\r\n              currentHostContext,\r\n            )\r\n          ) {\r\n            \u003cspan class=\"hljs-comment\"\u003e// If changes to the hydrated node needs to be applied at the\u003c/span\u003e\r\n            \u003cspan class=\"hljs-comment\"\u003e// commit-phase we mark this as such.\u003c/span\u003e\r\n            \u003cspan class=\"hljs-title function_\"\u003emarkUpdate\u003c/span\u003e(workInProgress);\r\n          }\r\n          \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (enableFlareAPI) {\r\n            \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e listeners = newProps.\u003cspan class=\"hljs-property\"\u003elisteners\u003c/span\u003e;\r\n            \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (listeners != \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n              \u003cspan class=\"hljs-title function_\"\u003eupdateEventListeners\u003c/span\u003e(\r\n                listeners,\r\n                workInProgress,\r\n                rootContainerInstance,\r\n              );\r\n            }\r\n          }\r\n        } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\r\n          \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e instance = \u003cspan class=\"hljs-title function_\"\u003ecreateInstance\u003c/span\u003e(\r\n            type,\r\n            newProps,\r\n            rootContainerInstance,\r\n            currentHostContext,\r\n            workInProgress,\r\n          );\r\n\r\n          \u003cspan class=\"hljs-title function_\"\u003eappendAllChildren\u003c/span\u003e(instance, workInProgress, \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e, \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e);\r\n\r\n          \u003cspan class=\"hljs-comment\"\u003e// This needs to be set before we mount Flare event listeners\u003c/span\u003e\r\n          workInProgress.\u003cspan class=\"hljs-property\"\u003estateNode\u003c/span\u003e = instance;\r\n\r\n          \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (enableFlareAPI) {\r\n            \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e listeners = newProps.\u003cspan class=\"hljs-property\"\u003elisteners\u003c/span\u003e;\r\n            \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (listeners != \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n              \u003cspan class=\"hljs-title function_\"\u003eupdateEventListeners\u003c/span\u003e(\r\n                listeners,\r\n                workInProgress,\r\n                rootContainerInstance,\r\n              );\r\n            }\r\n          }\r\n\r\n          \u003cspan class=\"hljs-comment\"\u003e// Certain renderers require commit-time effects for initial mount.\u003c/span\u003e\r\n          \u003cspan class=\"hljs-comment\"\u003e// (eg DOM renderer supports auto-focus for certain elements).\u003c/span\u003e\r\n          \u003cspan class=\"hljs-comment\"\u003e// Make sure such renderers get scheduled for later work.\u003c/span\u003e\r\n          \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (\r\n            \u003cspan class=\"hljs-title function_\"\u003efinalizeInitialChildren\u003c/span\u003e(\r\n              instance,\r\n              type,\r\n              newProps,\r\n              rootContainerInstance,\r\n              currentHostContext,\r\n            )\r\n          ) {\r\n            \u003cspan class=\"hljs-title function_\"\u003emarkUpdate\u003c/span\u003e(workInProgress);\r\n          }\r\n        }\r\n\r\n        \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (workInProgress.\u003cspan class=\"hljs-property\"\u003eref\u003c/span\u003e !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n          \u003cspan class=\"hljs-comment\"\u003e// If there is a ref on a host node we need to schedule a callback\u003c/span\u003e\r\n          \u003cspan class=\"hljs-title function_\"\u003emarkRef\u003c/span\u003e(workInProgress);\r\n        }\r\n      }\r\n      \u003cspan class=\"hljs-keyword\"\u003ebreak\u003c/span\u003e;\r\n    }\r\n    \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eHostText\u003c/span\u003e: {\r\n      \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e newText = newProps;\r\n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (current \u0026#x26;\u0026#x26; workInProgress.\u003cspan class=\"hljs-property\"\u003estateNode\u003c/span\u003e != \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n        \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e oldText = current.\u003cspan class=\"hljs-property\"\u003ememoizedProps\u003c/span\u003e;\r\n        \u003cspan class=\"hljs-comment\"\u003e// If we have an alternate, that means this is an update and we need\u003c/span\u003e\r\n        \u003cspan class=\"hljs-comment\"\u003e// to schedule a side-effect to do the updates.\u003c/span\u003e\r\n        \u003cspan class=\"hljs-title function_\"\u003eupdateHostText\u003c/span\u003e(current, workInProgress, oldText, newText);\r\n      } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\r\n        \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (\u003cspan class=\"hljs-keyword\"\u003etypeof\u003c/span\u003e newText !== \u003cspan class=\"hljs-string\"\u003e'string'\u003c/span\u003e) {\r\n          \u003cspan class=\"hljs-title function_\"\u003einvariant\u003c/span\u003e(\r\n            workInProgress.\u003cspan class=\"hljs-property\"\u003estateNode\u003c/span\u003e !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e,\r\n            \u003cspan class=\"hljs-string\"\u003e'We must have new props for new mounts. This error is likely '\u003c/span\u003e +\r\n              \u003cspan class=\"hljs-string\"\u003e'caused by a bug in React. Please file an issue.'\u003c/span\u003e,\r\n          );\r\n          \u003cspan class=\"hljs-comment\"\u003e// This can happen when we abort work.\u003c/span\u003e\r\n        }\r\n        \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e rootContainerInstance = \u003cspan class=\"hljs-title function_\"\u003egetRootHostContainer\u003c/span\u003e();\r\n        \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e currentHostContext = \u003cspan class=\"hljs-title function_\"\u003egetHostContext\u003c/span\u003e();\r\n        \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e wasHydrated = \u003cspan class=\"hljs-title function_\"\u003epopHydrationState\u003c/span\u003e(workInProgress);\r\n        \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (wasHydrated) {\r\n          \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (\u003cspan class=\"hljs-title function_\"\u003eprepareToHydrateHostTextInstance\u003c/span\u003e(workInProgress)) {\r\n            \u003cspan class=\"hljs-title function_\"\u003emarkUpdate\u003c/span\u003e(workInProgress);\r\n          }\r\n        } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\r\n          workInProgress.\u003cspan class=\"hljs-property\"\u003estateNode\u003c/span\u003e = \u003cspan class=\"hljs-title function_\"\u003ecreateTextInstance\u003c/span\u003e(\r\n            newText,\r\n            rootContainerInstance,\r\n            currentHostContext,\r\n            workInProgress,\r\n          );\r\n        }\r\n      }\r\n      \u003cspan class=\"hljs-keyword\"\u003ebreak\u003c/span\u003e;\r\n    }\r\n    \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eForwardRef\u003c/span\u003e:\r\n      \u003cspan class=\"hljs-keyword\"\u003ebreak\u003c/span\u003e;\r\n    \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eSuspenseComponent\u003c/span\u003e: {\r\n      \u003cspan class=\"hljs-title function_\"\u003epopSuspenseContext\u003c/span\u003e(workInProgress);\r\n      \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003enextState\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e | \u003cspan class=\"hljs-title class_\"\u003eSuspenseState\u003c/span\u003e = workInProgress.\u003cspan class=\"hljs-property\"\u003ememoizedState\u003c/span\u003e;\r\n\r\n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (enableSuspenseServerRenderer) {\r\n        \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (nextState !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e \u0026#x26;\u0026#x26; nextState.\u003cspan class=\"hljs-property\"\u003edehydrated\u003c/span\u003e !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n          \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (current === \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n            \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e wasHydrated = \u003cspan class=\"hljs-title function_\"\u003epopHydrationState\u003c/span\u003e(workInProgress);\r\n            \u003cspan class=\"hljs-title function_\"\u003einvariant\u003c/span\u003e(\r\n              wasHydrated,\r\n              \u003cspan class=\"hljs-string\"\u003e'A dehydrated suspense component was completed without a hydrated node. '\u003c/span\u003e +\r\n                \u003cspan class=\"hljs-string\"\u003e'This is probably a bug in React.'\u003c/span\u003e,\r\n            );\r\n            \u003cspan class=\"hljs-title function_\"\u003eprepareToHydrateHostSuspenseInstance\u003c/span\u003e(workInProgress);\r\n            \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (enableSchedulerTracing) {\r\n              \u003cspan class=\"hljs-title function_\"\u003emarkSpawnedWork\u003c/span\u003e(\u003cspan class=\"hljs-title class_\"\u003eNever\u003c/span\u003e);\r\n            }\r\n            \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n          } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\r\n            \u003cspan class=\"hljs-comment\"\u003e// We should never have been in a hydration state if we didn't have a current.\u003c/span\u003e\r\n            \u003cspan class=\"hljs-comment\"\u003e// However, in some of those paths, we might have reentered a hydration state\u003c/span\u003e\r\n            \u003cspan class=\"hljs-comment\"\u003e// and then we might be inside a hydration state. In that case, we'll need to\u003c/span\u003e\r\n            \u003cspan class=\"hljs-comment\"\u003e// exit out of it.\u003c/span\u003e\r\n            \u003cspan class=\"hljs-title function_\"\u003eresetHydrationState\u003c/span\u003e();\r\n            \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e ((workInProgress.\u003cspan class=\"hljs-property\"\u003eeffectTag\u003c/span\u003e \u0026#x26; \u003cspan class=\"hljs-title class_\"\u003eDidCapture\u003c/span\u003e) === \u003cspan class=\"hljs-title class_\"\u003eNoEffect\u003c/span\u003e) {\r\n              \u003cspan class=\"hljs-comment\"\u003e// This boundary did not suspend so it's now hydrated and unsuspended.\u003c/span\u003e\r\n              workInProgress.\u003cspan class=\"hljs-property\"\u003ememoizedState\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n            }\r\n            \u003cspan class=\"hljs-comment\"\u003e// If nothing suspended, we need to schedule an effect to mark this boundary\u003c/span\u003e\r\n            \u003cspan class=\"hljs-comment\"\u003e// as having hydrated so events know that they're free be invoked.\u003c/span\u003e\r\n            \u003cspan class=\"hljs-comment\"\u003e// It's also a signal to replay events and the suspense callback.\u003c/span\u003e\r\n            \u003cspan class=\"hljs-comment\"\u003e// If something suspended, schedule an effect to attach retry listeners.\u003c/span\u003e\r\n            \u003cspan class=\"hljs-comment\"\u003e// So we might as well always mark this.\u003c/span\u003e\r\n            workInProgress.\u003cspan class=\"hljs-property\"\u003eeffectTag\u003c/span\u003e |= \u003cspan class=\"hljs-title class_\"\u003eUpdate\u003c/span\u003e;\r\n            \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n          }\r\n        }\r\n      }\r\n\r\n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e ((workInProgress.\u003cspan class=\"hljs-property\"\u003eeffectTag\u003c/span\u003e \u0026#x26; \u003cspan class=\"hljs-title class_\"\u003eDidCapture\u003c/span\u003e) !== \u003cspan class=\"hljs-title class_\"\u003eNoEffect\u003c/span\u003e) {\r\n        \u003cspan class=\"hljs-comment\"\u003e// Something suspended. Re-render with the fallback children.\u003c/span\u003e\r\n        workInProgress.\u003cspan class=\"hljs-property\"\u003eexpirationTime\u003c/span\u003e = renderExpirationTime;\r\n        \u003cspan class=\"hljs-comment\"\u003e// Do not reset the effect list.\u003c/span\u003e\r\n        \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e workInProgress;\r\n      }\r\n\r\n      \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e nextDidTimeout = nextState !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n      \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e prevDidTimeout = \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e;\r\n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (current === \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n        \u003cspan class=\"hljs-comment\"\u003e// In cases where we didn't find a suitable hydration boundary we never\u003c/span\u003e\r\n        \u003cspan class=\"hljs-comment\"\u003e// put this in dehydrated mode, but we still need to pop the hydration\u003c/span\u003e\r\n        \u003cspan class=\"hljs-comment\"\u003e// state since we might be inside the insertion tree.\u003c/span\u003e\r\n        \u003cspan class=\"hljs-title function_\"\u003epopHydrationState\u003c/span\u003e(workInProgress);\r\n      } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\r\n        \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003eprevState\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e | \u003cspan class=\"hljs-title class_\"\u003eSuspenseState\u003c/span\u003e = current.\u003cspan class=\"hljs-property\"\u003ememoizedState\u003c/span\u003e;\r\n        prevDidTimeout = prevState !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n        \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (!nextDidTimeout \u0026#x26;\u0026#x26; prevState !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n          \u003cspan class=\"hljs-comment\"\u003e// We just switched from the fallback to the normal children.\u003c/span\u003e\r\n          \u003cspan class=\"hljs-comment\"\u003e// Delete the fallback.\u003c/span\u003e\r\n          \u003cspan class=\"hljs-comment\"\u003e// \u003cspan class=\"hljs-doctag\"\u003eTODO:\u003c/span\u003e Would it be better to store the fallback fragment on\u003c/span\u003e\r\n          \u003cspan class=\"hljs-comment\"\u003e// the stateNode during the begin phase?\u003c/span\u003e\r\n          \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003ecurrentFallbackChild\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eFiber\u003c/span\u003e | \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e = (current.\u003cspan class=\"hljs-property\"\u003echild\u003c/span\u003e: any)\r\n            .\u003cspan class=\"hljs-property\"\u003esibling\u003c/span\u003e;\r\n          \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (currentFallbackChild !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n            \u003cspan class=\"hljs-comment\"\u003e// Deletions go at the beginning of the return fiber's effect list\u003c/span\u003e\r\n            \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e first = workInProgress.\u003cspan class=\"hljs-property\"\u003efirstEffect\u003c/span\u003e;\r\n            \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (first !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n              workInProgress.\u003cspan class=\"hljs-property\"\u003efirstEffect\u003c/span\u003e = currentFallbackChild;\r\n              currentFallbackChild.\u003cspan class=\"hljs-property\"\u003enextEffect\u003c/span\u003e = first;\r\n            } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\r\n              workInProgress.\u003cspan class=\"hljs-property\"\u003efirstEffect\u003c/span\u003e = workInProgress.\u003cspan class=\"hljs-property\"\u003elastEffect\u003c/span\u003e = currentFallbackChild;\r\n              currentFallbackChild.\u003cspan class=\"hljs-property\"\u003enextEffect\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n            }\r\n            currentFallbackChild.\u003cspan class=\"hljs-property\"\u003eeffectTag\u003c/span\u003e = \u003cspan class=\"hljs-title class_\"\u003eDeletion\u003c/span\u003e;\r\n          }\r\n        }\r\n      }\r\n\r\n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (nextDidTimeout \u0026#x26;\u0026#x26; !prevDidTimeout) {\r\n        \u003cspan class=\"hljs-comment\"\u003e// If this subtreee is running in batched mode we can suspend,\u003c/span\u003e\r\n        \u003cspan class=\"hljs-comment\"\u003e// otherwise we won't suspend.\u003c/span\u003e\r\n        \u003cspan class=\"hljs-comment\"\u003e// \u003cspan class=\"hljs-doctag\"\u003eTODO:\u003c/span\u003e This will still suspend a synchronous tree if anything\u003c/span\u003e\r\n        \u003cspan class=\"hljs-comment\"\u003e// in the concurrent tree already suspended during this render.\u003c/span\u003e\r\n        \u003cspan class=\"hljs-comment\"\u003e// This is a known bug.\u003c/span\u003e\r\n        \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e ((workInProgress.\u003cspan class=\"hljs-property\"\u003emode\u003c/span\u003e \u0026#x26; \u003cspan class=\"hljs-title class_\"\u003eBatchedMode\u003c/span\u003e) !== \u003cspan class=\"hljs-title class_\"\u003eNoMode\u003c/span\u003e) {\r\n          \u003cspan class=\"hljs-comment\"\u003e// \u003cspan class=\"hljs-doctag\"\u003eTODO:\u003c/span\u003e Move this back to throwException because this is too late\u003c/span\u003e\r\n          \u003cspan class=\"hljs-comment\"\u003e// if this is a large tree which is common for initial loads. We\u003c/span\u003e\r\n          \u003cspan class=\"hljs-comment\"\u003e// don't know if we should restart a render or not until we get\u003c/span\u003e\r\n          \u003cspan class=\"hljs-comment\"\u003e// this marker, and this is too late.\u003c/span\u003e\r\n          \u003cspan class=\"hljs-comment\"\u003e// If this render already had a ping or lower pri updates,\u003c/span\u003e\r\n          \u003cspan class=\"hljs-comment\"\u003e// and this is the first time we know we're going to suspend we\u003c/span\u003e\r\n          \u003cspan class=\"hljs-comment\"\u003e// should be able to immediately restart from within throwException.\u003c/span\u003e\r\n          \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e hasInvisibleChildContext =\r\n            current === \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e \u0026#x26;\u0026#x26;\r\n            workInProgress.\u003cspan class=\"hljs-property\"\u003ememoizedProps\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eunstable_avoidThisFallback\u003c/span\u003e !== \u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e;\r\n          \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (\r\n            hasInvisibleChildContext ||\r\n            \u003cspan class=\"hljs-title function_\"\u003ehasSuspenseContext\u003c/span\u003e(\r\n              suspenseStackCursor.\u003cspan class=\"hljs-property\"\u003ecurrent\u003c/span\u003e,\r\n              (\u003cspan class=\"hljs-title class_\"\u003eInvisibleParentSuspenseContext\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eSuspenseContext\u003c/span\u003e),\r\n            )\r\n          ) {\r\n            \u003cspan class=\"hljs-comment\"\u003e// If this was in an invisible tree or a new render, then showing\u003c/span\u003e\r\n            \u003cspan class=\"hljs-comment\"\u003e// this boundary is ok.\u003c/span\u003e\r\n            \u003cspan class=\"hljs-title function_\"\u003erenderDidSuspend\u003c/span\u003e();\r\n          } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\r\n            \u003cspan class=\"hljs-comment\"\u003e// Otherwise, we're going to have to hide content so we should\u003c/span\u003e\r\n            \u003cspan class=\"hljs-comment\"\u003e// suspend for longer if possible.\u003c/span\u003e\r\n            \u003cspan class=\"hljs-title function_\"\u003erenderDidSuspendDelayIfPossible\u003c/span\u003e();\r\n          }\r\n        }\r\n      }\r\n\r\n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (supportsPersistence) {\r\n        \u003cspan class=\"hljs-comment\"\u003e// \u003cspan class=\"hljs-doctag\"\u003eTODO:\u003c/span\u003e Only schedule updates if not prevDidTimeout.\u003c/span\u003e\r\n        \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (nextDidTimeout) {\r\n          \u003cspan class=\"hljs-comment\"\u003e// If this boundary just timed out, schedule an effect to attach a\u003c/span\u003e\r\n          \u003cspan class=\"hljs-comment\"\u003e// retry listener to the proimse. This flag is also used to hide the\u003c/span\u003e\r\n          \u003cspan class=\"hljs-comment\"\u003e// primary children.\u003c/span\u003e\r\n          workInProgress.\u003cspan class=\"hljs-property\"\u003eeffectTag\u003c/span\u003e |= \u003cspan class=\"hljs-title class_\"\u003eUpdate\u003c/span\u003e;\r\n        }\r\n      }\r\n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (supportsMutation) {\r\n        \u003cspan class=\"hljs-comment\"\u003e// \u003cspan class=\"hljs-doctag\"\u003eTODO:\u003c/span\u003e Only schedule updates if these values are non equal, i.e. it changed.\u003c/span\u003e\r\n        \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (nextDidTimeout || prevDidTimeout) {\r\n          \u003cspan class=\"hljs-comment\"\u003e// If this boundary just timed out, schedule an effect to attach a\u003c/span\u003e\r\n          \u003cspan class=\"hljs-comment\"\u003e// retry listener to the proimse. This flag is also used to hide the\u003c/span\u003e\r\n          \u003cspan class=\"hljs-comment\"\u003e// primary children. In mutation mode, we also need the flag to\u003c/span\u003e\r\n          \u003cspan class=\"hljs-comment\"\u003e// *unhide* children that were previously hidden, so check if the\u003c/span\u003e\r\n          \u003cspan class=\"hljs-comment\"\u003e// is currently timed out, too.\u003c/span\u003e\r\n          workInProgress.\u003cspan class=\"hljs-property\"\u003eeffectTag\u003c/span\u003e |= \u003cspan class=\"hljs-title class_\"\u003eUpdate\u003c/span\u003e;\r\n        }\r\n      }\r\n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (\r\n        enableSuspenseCallback \u0026#x26;\u0026#x26;\r\n        workInProgress.\u003cspan class=\"hljs-property\"\u003eupdateQueue\u003c/span\u003e !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e \u0026#x26;\u0026#x26;\r\n        workInProgress.\u003cspan class=\"hljs-property\"\u003ememoizedProps\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003esuspenseCallback\u003c/span\u003e != \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e\r\n      ) {\r\n        \u003cspan class=\"hljs-comment\"\u003e// Always notify the callback\u003c/span\u003e\r\n        workInProgress.\u003cspan class=\"hljs-property\"\u003eeffectTag\u003c/span\u003e |= \u003cspan class=\"hljs-title class_\"\u003eUpdate\u003c/span\u003e;\r\n      }\r\n      \u003cspan class=\"hljs-keyword\"\u003ebreak\u003c/span\u003e;\r\n    }\r\n    \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eFragment\u003c/span\u003e:\r\n      \u003cspan class=\"hljs-keyword\"\u003ebreak\u003c/span\u003e;\r\n    \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eMode\u003c/span\u003e:\r\n      \u003cspan class=\"hljs-keyword\"\u003ebreak\u003c/span\u003e;\r\n    \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eProfiler\u003c/span\u003e:\r\n      \u003cspan class=\"hljs-keyword\"\u003ebreak\u003c/span\u003e;\r\n    \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eHostPortal\u003c/span\u003e:\r\n      \u003cspan class=\"hljs-title function_\"\u003epopHostContainer\u003c/span\u003e(workInProgress);\r\n      \u003cspan class=\"hljs-title function_\"\u003eupdateHostContainer\u003c/span\u003e(workInProgress);\r\n      \u003cspan class=\"hljs-keyword\"\u003ebreak\u003c/span\u003e;\r\n    \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eContextProvider\u003c/span\u003e:\r\n      \u003cspan class=\"hljs-comment\"\u003e// Pop provider fiber\u003c/span\u003e\r\n      \u003cspan class=\"hljs-title function_\"\u003epopProvider\u003c/span\u003e(workInProgress);\r\n      \u003cspan class=\"hljs-keyword\"\u003ebreak\u003c/span\u003e;\r\n    \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eContextConsumer\u003c/span\u003e:\r\n      \u003cspan class=\"hljs-keyword\"\u003ebreak\u003c/span\u003e;\r\n    \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eMemoComponent\u003c/span\u003e:\r\n      \u003cspan class=\"hljs-keyword\"\u003ebreak\u003c/span\u003e;\r\n    \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eIncompleteClassComponent\u003c/span\u003e: {\r\n      \u003cspan class=\"hljs-comment\"\u003e// Same as class component case. I put it down here so that the tags are\u003c/span\u003e\r\n      \u003cspan class=\"hljs-comment\"\u003e// sequential to ensure this switch is compiled to a jump table.\u003c/span\u003e\r\n      \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eComponent\u003c/span\u003e = workInProgress.\u003cspan class=\"hljs-property\"\u003etype\u003c/span\u003e;\r\n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (\u003cspan class=\"hljs-title function_\"\u003eisLegacyContextProvider\u003c/span\u003e(\u003cspan class=\"hljs-title class_\"\u003eComponent\u003c/span\u003e)) {\r\n        \u003cspan class=\"hljs-title function_\"\u003epopLegacyContext\u003c/span\u003e(workInProgress);\r\n      }\r\n      \u003cspan class=\"hljs-keyword\"\u003ebreak\u003c/span\u003e;\r\n    }\r\n    \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eSuspenseListComponent\u003c/span\u003e: {\r\n      \u003cspan class=\"hljs-title function_\"\u003epopSuspenseContext\u003c/span\u003e(workInProgress);\r\n\r\n      \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003erenderState\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e | \u003cspan class=\"hljs-title class_\"\u003eSuspenseListRenderState\u003c/span\u003e =\r\n        workInProgress.\u003cspan class=\"hljs-property\"\u003ememoizedState\u003c/span\u003e;\r\n\r\n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (renderState === \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n        \u003cspan class=\"hljs-comment\"\u003e// We're running in the default, \"independent\" mode. We don't do anything\u003c/span\u003e\r\n        \u003cspan class=\"hljs-comment\"\u003e// in this mode.\u003c/span\u003e\r\n        \u003cspan class=\"hljs-keyword\"\u003ebreak\u003c/span\u003e;\r\n      }\r\n\r\n      \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e didSuspendAlready =\r\n        (workInProgress.\u003cspan class=\"hljs-property\"\u003eeffectTag\u003c/span\u003e \u0026#x26; \u003cspan class=\"hljs-title class_\"\u003eDidCapture\u003c/span\u003e) !== \u003cspan class=\"hljs-title class_\"\u003eNoEffect\u003c/span\u003e;\r\n\r\n      \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e renderedTail = renderState.\u003cspan class=\"hljs-property\"\u003erendering\u003c/span\u003e;\r\n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (renderedTail === \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n        \u003cspan class=\"hljs-comment\"\u003e// We just rendered the head.\u003c/span\u003e\r\n        \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (!didSuspendAlready) {\r\n          \u003cspan class=\"hljs-comment\"\u003e// This is the first pass. We need to figure out if anything is still\u003c/span\u003e\r\n          \u003cspan class=\"hljs-comment\"\u003e// suspended in the rendered set.\u003c/span\u003e\r\n\r\n          \u003cspan class=\"hljs-comment\"\u003e// If new content unsuspended, but there's still some content that\u003c/span\u003e\r\n          \u003cspan class=\"hljs-comment\"\u003e// didn't. Then we need to do a second pass that forces everything\u003c/span\u003e\r\n          \u003cspan class=\"hljs-comment\"\u003e// to keep showing their fallbacks.\u003c/span\u003e\r\n\r\n          \u003cspan class=\"hljs-comment\"\u003e// We might be suspended if something in this render pass suspended, or\u003c/span\u003e\r\n          \u003cspan class=\"hljs-comment\"\u003e// something in the previous committed pass suspended. Otherwise,\u003c/span\u003e\r\n          \u003cspan class=\"hljs-comment\"\u003e// there's no chance so we can skip the expensive call to\u003c/span\u003e\r\n          \u003cspan class=\"hljs-comment\"\u003e// findFirstSuspended.\u003c/span\u003e\r\n          \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e cannotBeSuspended =\r\n            \u003cspan class=\"hljs-title function_\"\u003erenderHasNotSuspendedYet\u003c/span\u003e() \u0026#x26;\u0026#x26;\r\n            (current === \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e || (current.\u003cspan class=\"hljs-property\"\u003eeffectTag\u003c/span\u003e \u0026#x26; \u003cspan class=\"hljs-title class_\"\u003eDidCapture\u003c/span\u003e) === \u003cspan class=\"hljs-title class_\"\u003eNoEffect\u003c/span\u003e);\r\n          \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (!cannotBeSuspended) {\r\n            \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e row = workInProgress.\u003cspan class=\"hljs-property\"\u003echild\u003c/span\u003e;\r\n            \u003cspan class=\"hljs-keyword\"\u003ewhile\u003c/span\u003e (row !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n              \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e suspended = \u003cspan class=\"hljs-title function_\"\u003efindFirstSuspended\u003c/span\u003e(row);\r\n              \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (suspended !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n                didSuspendAlready = \u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e;\r\n                workInProgress.\u003cspan class=\"hljs-property\"\u003eeffectTag\u003c/span\u003e |= \u003cspan class=\"hljs-title class_\"\u003eDidCapture\u003c/span\u003e;\r\n                \u003cspan class=\"hljs-title function_\"\u003ecutOffTailIfNeeded\u003c/span\u003e(renderState, \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e);\r\n\r\n                \u003cspan class=\"hljs-comment\"\u003e// If this is a newly suspended tree, it might not get committed as\u003c/span\u003e\r\n                \u003cspan class=\"hljs-comment\"\u003e// part of the second pass. In that case nothing will subscribe to\u003c/span\u003e\r\n                \u003cspan class=\"hljs-comment\"\u003e// its thennables. Instead, we'll transfer its thennables to the\u003c/span\u003e\r\n                \u003cspan class=\"hljs-comment\"\u003e// SuspenseList so that it can retry if they resolve.\u003c/span\u003e\r\n                \u003cspan class=\"hljs-comment\"\u003e// There might be multiple of these in the list but since we're\u003c/span\u003e\r\n                \u003cspan class=\"hljs-comment\"\u003e// going to wait for all of them anyway, it doesn't really matter\u003c/span\u003e\r\n                \u003cspan class=\"hljs-comment\"\u003e// which ones gets to ping. In theory we could get clever and keep\u003c/span\u003e\r\n                \u003cspan class=\"hljs-comment\"\u003e// track of how many dependencies remain but it gets tricky because\u003c/span\u003e\r\n                \u003cspan class=\"hljs-comment\"\u003e// in the meantime, we can add/remove/change items and dependencies.\u003c/span\u003e\r\n                \u003cspan class=\"hljs-comment\"\u003e// We might bail out of the loop before finding any but that\u003c/span\u003e\r\n                \u003cspan class=\"hljs-comment\"\u003e// doesn't matter since that means that the other boundaries that\u003c/span\u003e\r\n                \u003cspan class=\"hljs-comment\"\u003e// we did find already has their listeners attached.\u003c/span\u003e\r\n                \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e newThennables = suspended.\u003cspan class=\"hljs-property\"\u003eupdateQueue\u003c/span\u003e;\r\n                \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (newThennables !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n                  workInProgress.\u003cspan class=\"hljs-property\"\u003eupdateQueue\u003c/span\u003e = newThennables;\r\n                  workInProgress.\u003cspan class=\"hljs-property\"\u003eeffectTag\u003c/span\u003e |= \u003cspan class=\"hljs-title class_\"\u003eUpdate\u003c/span\u003e;\r\n                }\r\n\r\n                \u003cspan class=\"hljs-comment\"\u003e// Rerender the whole list, but this time, we'll force fallbacks\u003c/span\u003e\r\n                \u003cspan class=\"hljs-comment\"\u003e// to stay in place.\u003c/span\u003e\r\n                \u003cspan class=\"hljs-comment\"\u003e// Reset the effect list before doing the second pass since that's now invalid.\u003c/span\u003e\r\n                workInProgress.\u003cspan class=\"hljs-property\"\u003efirstEffect\u003c/span\u003e = workInProgress.\u003cspan class=\"hljs-property\"\u003elastEffect\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n                \u003cspan class=\"hljs-comment\"\u003e// Reset the child fibers to their original state.\u003c/span\u003e\r\n                \u003cspan class=\"hljs-title function_\"\u003eresetChildFibers\u003c/span\u003e(workInProgress, renderExpirationTime);\r\n\r\n                \u003cspan class=\"hljs-comment\"\u003e// Set up the Suspense Context to force suspense and immediately\u003c/span\u003e\r\n                \u003cspan class=\"hljs-comment\"\u003e// rerender the children.\u003c/span\u003e\r\n                \u003cspan class=\"hljs-title function_\"\u003epushSuspenseContext\u003c/span\u003e(\r\n                  workInProgress,\r\n                  \u003cspan class=\"hljs-title function_\"\u003esetShallowSuspenseContext\u003c/span\u003e(\r\n                    suspenseStackCursor.\u003cspan class=\"hljs-property\"\u003ecurrent\u003c/span\u003e,\r\n                    \u003cspan class=\"hljs-title class_\"\u003eForceSuspenseFallback\u003c/span\u003e,\r\n                  ),\r\n                );\r\n                \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e workInProgress.\u003cspan class=\"hljs-property\"\u003echild\u003c/span\u003e;\r\n              }\r\n              row = row.\u003cspan class=\"hljs-property\"\u003esibling\u003c/span\u003e;\r\n            }\r\n          }\r\n        } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\r\n          \u003cspan class=\"hljs-title function_\"\u003ecutOffTailIfNeeded\u003c/span\u003e(renderState, \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e);\r\n        }\r\n        \u003cspan class=\"hljs-comment\"\u003e// Next we're going to render the tail.\u003c/span\u003e\r\n      } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\r\n        \u003cspan class=\"hljs-comment\"\u003e// Append the rendered row to the child list.\u003c/span\u003e\r\n        \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (!didSuspendAlready) {\r\n          \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e suspended = \u003cspan class=\"hljs-title function_\"\u003efindFirstSuspended\u003c/span\u003e(renderedTail);\r\n          \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (suspended !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n            workInProgress.\u003cspan class=\"hljs-property\"\u003eeffectTag\u003c/span\u003e |= \u003cspan class=\"hljs-title class_\"\u003eDidCapture\u003c/span\u003e;\r\n            didSuspendAlready = \u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e;\r\n            \u003cspan class=\"hljs-title function_\"\u003ecutOffTailIfNeeded\u003c/span\u003e(renderState, \u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e);\r\n            \u003cspan class=\"hljs-comment\"\u003e// This might have been modified.\u003c/span\u003e\r\n            \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (\r\n              renderState.\u003cspan class=\"hljs-property\"\u003etail\u003c/span\u003e === \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e \u0026#x26;\u0026#x26;\r\n              renderState.\u003cspan class=\"hljs-property\"\u003etailMode\u003c/span\u003e === \u003cspan class=\"hljs-string\"\u003e'hidden'\u003c/span\u003e\r\n            ) {\r\n              \u003cspan class=\"hljs-comment\"\u003e// We need to delete the row we just rendered.\u003c/span\u003e\r\n              \u003cspan class=\"hljs-comment\"\u003e// Ensure we transfer the update queue to the parent.\u003c/span\u003e\r\n              \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e newThennables = suspended.\u003cspan class=\"hljs-property\"\u003eupdateQueue\u003c/span\u003e;\r\n              \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (newThennables !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n                workInProgress.\u003cspan class=\"hljs-property\"\u003eupdateQueue\u003c/span\u003e = newThennables;\r\n                workInProgress.\u003cspan class=\"hljs-property\"\u003eeffectTag\u003c/span\u003e |= \u003cspan class=\"hljs-title class_\"\u003eUpdate\u003c/span\u003e;\r\n              }\r\n              \u003cspan class=\"hljs-comment\"\u003e// Reset the effect list to what it w as before we rendered this\u003c/span\u003e\r\n              \u003cspan class=\"hljs-comment\"\u003e// child. The nested children have already appended themselves.\u003c/span\u003e\r\n              \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e lastEffect = (workInProgress.\u003cspan class=\"hljs-property\"\u003elastEffect\u003c/span\u003e =\r\n                renderState.\u003cspan class=\"hljs-property\"\u003elastEffect\u003c/span\u003e);\r\n              \u003cspan class=\"hljs-comment\"\u003e// Remove any effects that were appended after this point.\u003c/span\u003e\r\n              \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (lastEffect !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n                lastEffect.\u003cspan class=\"hljs-property\"\u003enextEffect\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n              }\r\n              \u003cspan class=\"hljs-comment\"\u003e// We're done.\u003c/span\u003e\r\n              \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n            }\r\n          } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (\r\n            \u003cspan class=\"hljs-title function_\"\u003enow\u003c/span\u003e() \u003e renderState.\u003cspan class=\"hljs-property\"\u003etailExpiration\u003c/span\u003e \u0026#x26;\u0026#x26;\r\n            renderExpirationTime \u003e \u003cspan class=\"hljs-title class_\"\u003eNever\u003c/span\u003e\r\n          ) {\r\n            \u003cspan class=\"hljs-comment\"\u003e// We have now passed our CPU deadline and we'll just give up further\u003c/span\u003e\r\n            \u003cspan class=\"hljs-comment\"\u003e// attempts to render the main content and only render fallbacks.\u003c/span\u003e\r\n            \u003cspan class=\"hljs-comment\"\u003e// The assumption is that this is usually faster.\u003c/span\u003e\r\n            workInProgress.\u003cspan class=\"hljs-property\"\u003eeffectTag\u003c/span\u003e |= \u003cspan class=\"hljs-title class_\"\u003eDidCapture\u003c/span\u003e;\r\n            didSuspendAlready = \u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e;\r\n\r\n            \u003cspan class=\"hljs-title function_\"\u003ecutOffTailIfNeeded\u003c/span\u003e(renderState, \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e);\r\n\r\n            \u003cspan class=\"hljs-comment\"\u003e// Since nothing actually suspended, there will nothing to ping this\u003c/span\u003e\r\n            \u003cspan class=\"hljs-comment\"\u003e// to get it started back up to attempt the next item. If we can show\u003c/span\u003e\r\n            \u003cspan class=\"hljs-comment\"\u003e// them, then they really have the same priority as this render.\u003c/span\u003e\r\n            \u003cspan class=\"hljs-comment\"\u003e// So we'll pick it back up the very next render pass once we've had\u003c/span\u003e\r\n            \u003cspan class=\"hljs-comment\"\u003e// an opportunity to yield for paint.\u003c/span\u003e\r\n\r\n            \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e nextPriority = renderExpirationTime - \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e;\r\n            workInProgress.\u003cspan class=\"hljs-property\"\u003eexpirationTime\u003c/span\u003e = workInProgress.\u003cspan class=\"hljs-property\"\u003echildExpirationTime\u003c/span\u003e = nextPriority;\r\n            \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (enableSchedulerTracing) {\r\n              \u003cspan class=\"hljs-title function_\"\u003emarkSpawnedWork\u003c/span\u003e(nextPriority);\r\n            }\r\n          }\r\n        }\r\n        \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (renderState.\u003cspan class=\"hljs-property\"\u003eisBackwards\u003c/span\u003e) {\r\n          \u003cspan class=\"hljs-comment\"\u003e// The effect list of the backwards tail will have been added\u003c/span\u003e\r\n          \u003cspan class=\"hljs-comment\"\u003e// to the end. This breaks the guarantee that life-cycles fire in\u003c/span\u003e\r\n          \u003cspan class=\"hljs-comment\"\u003e// sibling order but that isn't a strong guarantee promised by React.\u003c/span\u003e\r\n          \u003cspan class=\"hljs-comment\"\u003e// Especially since these might also just pop in during future commits.\u003c/span\u003e\r\n          \u003cspan class=\"hljs-comment\"\u003e// Append to the beginning of the list.\u003c/span\u003e\r\n          renderedTail.\u003cspan class=\"hljs-property\"\u003esibling\u003c/span\u003e = workInProgress.\u003cspan class=\"hljs-property\"\u003echild\u003c/span\u003e;\r\n          workInProgress.\u003cspan class=\"hljs-property\"\u003echild\u003c/span\u003e = renderedTail;\r\n        } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\r\n          \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e previousSibling = renderState.\u003cspan class=\"hljs-property\"\u003elast\u003c/span\u003e;\r\n          \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (previousSibling !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n            previousSibling.\u003cspan class=\"hljs-property\"\u003esibling\u003c/span\u003e = renderedTail;\r\n          } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\r\n            workInProgress.\u003cspan class=\"hljs-property\"\u003echild\u003c/span\u003e = renderedTail;\r\n          }\r\n          renderState.\u003cspan class=\"hljs-property\"\u003elast\u003c/span\u003e = renderedTail;\r\n        }\r\n      }\r\n\r\n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (renderState.\u003cspan class=\"hljs-property\"\u003etail\u003c/span\u003e !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n        \u003cspan class=\"hljs-comment\"\u003e// We still have tail rows to render.\u003c/span\u003e\r\n        \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (renderState.\u003cspan class=\"hljs-property\"\u003etailExpiration\u003c/span\u003e === \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e) {\r\n          \u003cspan class=\"hljs-comment\"\u003e// Heuristic for how long we're willing to spend rendering rows\u003c/span\u003e\r\n          \u003cspan class=\"hljs-comment\"\u003e// until we just give up and show what we have so far.\u003c/span\u003e\r\n          \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-variable constant_\"\u003eTAIL_EXPIRATION_TIMEOUT_MS\u003c/span\u003e = \u003cspan class=\"hljs-number\"\u003e500\u003c/span\u003e;\r\n          renderState.\u003cspan class=\"hljs-property\"\u003etailExpiration\u003c/span\u003e = \u003cspan class=\"hljs-title function_\"\u003enow\u003c/span\u003e() + \u003cspan class=\"hljs-variable constant_\"\u003eTAIL_EXPIRATION_TIMEOUT_MS\u003c/span\u003e;\r\n        }\r\n        \u003cspan class=\"hljs-comment\"\u003e// Pop a row.\u003c/span\u003e\r\n        \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e next = renderState.\u003cspan class=\"hljs-property\"\u003etail\u003c/span\u003e;\r\n        renderState.\u003cspan class=\"hljs-property\"\u003erendering\u003c/span\u003e = next;\r\n        renderState.\u003cspan class=\"hljs-property\"\u003etail\u003c/span\u003e = next.\u003cspan class=\"hljs-property\"\u003esibling\u003c/span\u003e;\r\n        renderState.\u003cspan class=\"hljs-property\"\u003elastEffect\u003c/span\u003e = workInProgress.\u003cspan class=\"hljs-property\"\u003elastEffect\u003c/span\u003e;\r\n        next.\u003cspan class=\"hljs-property\"\u003esibling\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n\r\n        \u003cspan class=\"hljs-comment\"\u003e// Restore the context.\u003c/span\u003e\r\n        \u003cspan class=\"hljs-comment\"\u003e// \u003cspan class=\"hljs-doctag\"\u003eTODO:\u003c/span\u003e We can probably just avoid popping it instead and only\u003c/span\u003e\r\n        \u003cspan class=\"hljs-comment\"\u003e// setting it the first time we go from not suspended to suspended.\u003c/span\u003e\r\n        \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e suspenseContext = suspenseStackCursor.\u003cspan class=\"hljs-property\"\u003ecurrent\u003c/span\u003e;\r\n        \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (didSuspendAlready) {\r\n          suspenseContext = \u003cspan class=\"hljs-title function_\"\u003esetShallowSuspenseContext\u003c/span\u003e(\r\n            suspenseContext,\r\n            \u003cspan class=\"hljs-title class_\"\u003eForceSuspenseFallback\u003c/span\u003e,\r\n          );\r\n        } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\r\n          suspenseContext = \u003cspan class=\"hljs-title function_\"\u003esetDefaultShallowSuspenseContext\u003c/span\u003e(suspenseContext);\r\n        }\r\n        \u003cspan class=\"hljs-title function_\"\u003epushSuspenseContext\u003c/span\u003e(workInProgress, suspenseContext);\r\n        \u003cspan class=\"hljs-comment\"\u003e// Do a pass over the next row.\u003c/span\u003e\r\n        \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e next;\r\n      }\r\n      \u003cspan class=\"hljs-keyword\"\u003ebreak\u003c/span\u003e;\r\n    }\r\n    \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eFundamentalComponent\u003c/span\u003e: {\r\n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (enableFundamentalAPI) {\r\n        \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e fundamentalImpl = workInProgress.\u003cspan class=\"hljs-property\"\u003etype\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eimpl\u003c/span\u003e;\r\n        \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003efundamentalInstance\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eReactFundamentalComponentInstance\u003c/span\u003e\u0026#x3C;\r\n          any,\r\n          any,\r\n        \u003e | \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e =\r\n          workInProgress.\u003cspan class=\"hljs-property\"\u003estateNode\u003c/span\u003e;\r\n\r\n        \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (fundamentalInstance === \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n          \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e getInitialState = fundamentalImpl.\u003cspan class=\"hljs-property\"\u003egetInitialState\u003c/span\u003e;\r\n          \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e fundamentalState;\r\n          \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (getInitialState !== \u003cspan class=\"hljs-literal\"\u003eundefined\u003c/span\u003e) {\r\n            fundamentalState = \u003cspan class=\"hljs-title function_\"\u003egetInitialState\u003c/span\u003e(newProps);\r\n          }\r\n          fundamentalInstance = workInProgress.\u003cspan class=\"hljs-property\"\u003estateNode\u003c/span\u003e = \u003cspan class=\"hljs-title function_\"\u003ecreateFundamentalStateInstance\u003c/span\u003e(\r\n            workInProgress,\r\n            newProps,\r\n            fundamentalImpl,\r\n            fundamentalState || {},\r\n          );\r\n          \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e instance = ((\u003cspan class=\"hljs-title function_\"\u003egetFundamentalComponentInstance\u003c/span\u003e(\r\n            fundamentalInstance,\r\n          ): any): \u003cspan class=\"hljs-title class_\"\u003eInstance\u003c/span\u003e);\r\n          fundamentalInstance.\u003cspan class=\"hljs-property\"\u003einstance\u003c/span\u003e = instance;\r\n          \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (fundamentalImpl.\u003cspan class=\"hljs-property\"\u003ereconcileChildren\u003c/span\u003e === \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e) {\r\n            \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n          }\r\n          \u003cspan class=\"hljs-title function_\"\u003eappendAllChildren\u003c/span\u003e(instance, workInProgress, \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e, \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e);\r\n          \u003cspan class=\"hljs-title function_\"\u003emountFundamentalComponent\u003c/span\u003e(fundamentalInstance);\r\n        } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\r\n          \u003cspan class=\"hljs-comment\"\u003e// We fire update in commit phase\u003c/span\u003e\r\n          \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e prevProps = fundamentalInstance.\u003cspan class=\"hljs-property\"\u003eprops\u003c/span\u003e;\r\n          fundamentalInstance.\u003cspan class=\"hljs-property\"\u003eprevProps\u003c/span\u003e = prevProps;\r\n          fundamentalInstance.\u003cspan class=\"hljs-property\"\u003eprops\u003c/span\u003e = newProps;\r\n          fundamentalInstance.\u003cspan class=\"hljs-property\"\u003ecurrentFiber\u003c/span\u003e = workInProgress;\r\n          \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (supportsPersistence) {\r\n            \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e instance = \u003cspan class=\"hljs-title function_\"\u003ecloneFundamentalInstance\u003c/span\u003e(fundamentalInstance);\r\n            fundamentalInstance.\u003cspan class=\"hljs-property\"\u003einstance\u003c/span\u003e = instance;\r\n            \u003cspan class=\"hljs-title function_\"\u003eappendAllChildren\u003c/span\u003e(instance, workInProgress, \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e, \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e);\r\n          }\r\n          \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e shouldUpdate = \u003cspan class=\"hljs-title function_\"\u003eshouldUpdateFundamentalComponent\u003c/span\u003e(\r\n            fundamentalInstance,\r\n          );\r\n          \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (shouldUpdate) {\r\n            \u003cspan class=\"hljs-title function_\"\u003emarkUpdate\u003c/span\u003e(workInProgress);\r\n          }\r\n        }\r\n      }\r\n      \u003cspan class=\"hljs-keyword\"\u003ebreak\u003c/span\u003e;\r\n    }\r\n    \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eScopeComponent\u003c/span\u003e: {\r\n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (enableScopeAPI) {\r\n        \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (current === \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n          \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e type = workInProgress.\u003cspan class=\"hljs-property\"\u003etype\u003c/span\u003e;\r\n          \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003escopeInstance\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eReactScopeInstance\u003c/span\u003e = {\r\n            \u003cspan class=\"hljs-attr\"\u003efiber\u003c/span\u003e: workInProgress,\r\n            \u003cspan class=\"hljs-attr\"\u003emethods\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e,\r\n          };\r\n          workInProgress.\u003cspan class=\"hljs-property\"\u003estateNode\u003c/span\u003e = scopeInstance;\r\n          scopeInstance.\u003cspan class=\"hljs-property\"\u003emethods\u003c/span\u003e = \u003cspan class=\"hljs-title function_\"\u003ecreateScopeMethods\u003c/span\u003e(type, scopeInstance);\r\n          \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (enableFlareAPI) {\r\n            \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e listeners = newProps.\u003cspan class=\"hljs-property\"\u003elisteners\u003c/span\u003e;\r\n            \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (listeners != \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n              \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e rootContainerInstance = \u003cspan class=\"hljs-title function_\"\u003egetRootHostContainer\u003c/span\u003e();\r\n              \u003cspan class=\"hljs-title function_\"\u003eupdateEventListeners\u003c/span\u003e(\r\n                listeners,\r\n                workInProgress,\r\n                rootContainerInstance,\r\n              );\r\n            }\r\n          }\r\n          \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (workInProgress.\u003cspan class=\"hljs-property\"\u003eref\u003c/span\u003e !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n            \u003cspan class=\"hljs-title function_\"\u003emarkRef\u003c/span\u003e(workInProgress);\r\n            \u003cspan class=\"hljs-title function_\"\u003emarkUpdate\u003c/span\u003e(workInProgress);\r\n          }\r\n        } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\r\n          \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (enableFlareAPI) {\r\n            \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e prevListeners = current.\u003cspan class=\"hljs-property\"\u003ememoizedProps\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003elisteners\u003c/span\u003e;\r\n            \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e nextListeners = newProps.\u003cspan class=\"hljs-property\"\u003elisteners\u003c/span\u003e;\r\n            \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (\r\n              prevListeners !== nextListeners ||\r\n              workInProgress.\u003cspan class=\"hljs-property\"\u003eref\u003c/span\u003e !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e\r\n            ) {\r\n              \u003cspan class=\"hljs-title function_\"\u003emarkUpdate\u003c/span\u003e(workInProgress);\r\n            }\r\n          } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\r\n            \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (workInProgress.\u003cspan class=\"hljs-property\"\u003eref\u003c/span\u003e !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n              \u003cspan class=\"hljs-title function_\"\u003emarkUpdate\u003c/span\u003e(workInProgress);\r\n            }\r\n          }\r\n          \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (current.\u003cspan class=\"hljs-property\"\u003eref\u003c/span\u003e !== workInProgress.\u003cspan class=\"hljs-property\"\u003eref\u003c/span\u003e) {\r\n            \u003cspan class=\"hljs-title function_\"\u003emarkRef\u003c/span\u003e(workInProgress);\r\n          }\r\n        }\r\n      }\r\n      \u003cspan class=\"hljs-keyword\"\u003ebreak\u003c/span\u003e;\r\n    }\r\n    \u003cspan class=\"hljs-attr\"\u003edefault\u003c/span\u003e:\r\n      \u003cspan class=\"hljs-title function_\"\u003einvariant\u003c/span\u003e(\r\n        \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e,\r\n        \u003cspan class=\"hljs-string\"\u003e'Unknown unit of work tag (%s). This error is likely caused by a bug in '\u003c/span\u003e +\r\n          \u003cspan class=\"hljs-string\"\u003e'React. Please file an issue.'\u003c/span\u003e,\r\n        workInProgress.\u003cspan class=\"hljs-property\"\u003etag\u003c/span\u003e,\r\n      );\r\n  }\r\n\r\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch6 id=\"pophostcontainer\"\u003epopHostContainer\u003c/h6\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// packages\\react-reconciler\\src\\ReactFiberHostContext.js\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003epopHostContainer\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003efiber: Fiber\u003c/span\u003e) {\r\n  \u003cspan class=\"hljs-title function_\"\u003epop\u003c/span\u003e(contextStackCursor, fiber);\r\n  \u003cspan class=\"hljs-title function_\"\u003epop\u003c/span\u003e(contextFiberStackCursor, fiber);\r\n  \u003cspan class=\"hljs-title function_\"\u003epop\u003c/span\u003e(rootInstanceStackCursor, fiber);\r\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch6 id=\"poptoplevellegacycontextobject\"\u003epopTopLevelLegacyContextObject\u003c/h6\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// packages\\react-reconciler\\src\\ReactFiberContext.js\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003epopTopLevelContextObject\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003efiber: Fiber\u003c/span\u003e): \u003cspan class=\"hljs-keyword\"\u003evoid\u003c/span\u003e {\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (disableLegacyContext) {\r\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e;\r\n  } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\r\n    \u003cspan class=\"hljs-title function_\"\u003epop\u003c/span\u003e(didPerformWorkStackCursor, fiber);\r\n    \u003cspan class=\"hljs-title function_\"\u003epop\u003c/span\u003e(contextStackCursor, fiber);\r\n  }\r\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch6 id=\"popdispatcher\"\u003epopDispatcher\u003c/h6\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// packages\\react-reconciler\\src\\ReactFiberWorkLoop.js\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003epopDispatcher\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003eprevDispatcher\u003c/span\u003e) {\r\n  \u003cspan class=\"hljs-title class_\"\u003eReactCurrentDispatcher\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ecurrent\u003c/span\u003e = prevDispatcher;\r\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch5 id=\"finishsyncrender\"\u003efinishSyncRender\u003c/h5\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// packages\\react-reconciler\\src\\ReactFiberWorkLoop.js\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003efinishSyncRender\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003eroot, exitStatus, expirationTime\u003c/span\u003e) {\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (exitStatus === \u003cspan class=\"hljs-title class_\"\u003eRootLocked\u003c/span\u003e) {\r\n    \u003cspan class=\"hljs-comment\"\u003e// This root has a lock that prevents it from committing. Exit. If we\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// begin work on the root again, without any intervening updates, it\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// will finish without doing additional work.\u003c/span\u003e\r\n    \u003cspan class=\"hljs-title function_\"\u003emarkRootSuspendedAtTime\u003c/span\u003e(root, expirationTime);\r\n  } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\r\n    \u003cspan class=\"hljs-comment\"\u003e// Set this to null to indicate there's no in-progress render.\u003c/span\u003e\r\n    workInProgressRoot = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n\r\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (__DEV__) {\r\n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (\r\n        exitStatus === \u003cspan class=\"hljs-title class_\"\u003eRootSuspended\u003c/span\u003e ||\r\n        exitStatus === \u003cspan class=\"hljs-title class_\"\u003eRootSuspendedWithDelay\u003c/span\u003e\r\n      ) {\r\n        \u003cspan class=\"hljs-title function_\"\u003eflushSuspensePriorityWarningInDEV\u003c/span\u003e();\r\n      }\r\n    }\r\n    \u003cspan class=\"hljs-title function_\"\u003ecommitRoot\u003c/span\u003e(root);\r\n  }\r\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch5 id=\"commitroot\"\u003ecommitRoot\u003c/h5\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// packages\\react-reconciler\\src\\ReactFiberWorkLoop.js\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003ecommitRoot\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003eroot\u003c/span\u003e) {\r\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e renderPriorityLevel = \u003cspan class=\"hljs-title function_\"\u003egetCurrentPriorityLevel\u003c/span\u003e();\r\n  \u003cspan class=\"hljs-title function_\"\u003erunWithPriority\u003c/span\u003e(\r\n    \u003cspan class=\"hljs-title class_\"\u003eImmediatePriority\u003c/span\u003e,\r\n    commitRootImpl.\u003cspan class=\"hljs-title function_\"\u003ebind\u003c/span\u003e(\u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e, root, renderPriorityLevel),\r\n  );\r\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n}\r\n\r\n\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003ecommitRootImpl\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003eroot, renderPriorityLevel\u003c/span\u003e) {\r\n  \u003cspan class=\"hljs-title function_\"\u003eflushPassiveEffects\u003c/span\u003e();\r\n  \u003cspan class=\"hljs-title function_\"\u003eflushRenderPhaseStrictModeWarningsInDEV\u003c/span\u003e();\r\n\r\n  \u003cspan class=\"hljs-title function_\"\u003einvariant\u003c/span\u003e(\r\n    (executionContext \u0026#x26; (\u003cspan class=\"hljs-title class_\"\u003eRenderContext\u003c/span\u003e | \u003cspan class=\"hljs-title class_\"\u003eCommitContext\u003c/span\u003e)) === \u003cspan class=\"hljs-title class_\"\u003eNoContext\u003c/span\u003e,\r\n    \u003cspan class=\"hljs-string\"\u003e'Should not already be working.'\u003c/span\u003e,\r\n  );\r\n\r\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e finishedWork = root.\u003cspan class=\"hljs-property\"\u003efinishedWork\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e expirationTime = root.\u003cspan class=\"hljs-property\"\u003efinishedExpirationTime\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (finishedWork === \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n  }\r\n  root.\u003cspan class=\"hljs-property\"\u003efinishedWork\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n  root.\u003cspan class=\"hljs-property\"\u003efinishedExpirationTime\u003c/span\u003e = \u003cspan class=\"hljs-title class_\"\u003eNoWork\u003c/span\u003e;\r\n\r\n  \u003cspan class=\"hljs-title function_\"\u003einvariant\u003c/span\u003e(\r\n    finishedWork !== root.\u003cspan class=\"hljs-property\"\u003ecurrent\u003c/span\u003e,\r\n    \u003cspan class=\"hljs-string\"\u003e'Cannot commit the same tree as before. This error is likely caused by '\u003c/span\u003e +\r\n      \u003cspan class=\"hljs-string\"\u003e'a bug in React. Please file an issue.'\u003c/span\u003e,\r\n  );\r\n\r\n  \u003cspan class=\"hljs-comment\"\u003e// commitRoot never returns a continuation; it always finishes synchronously.\u003c/span\u003e\r\n  \u003cspan class=\"hljs-comment\"\u003e// So we can clear these now to allow a new callback to be scheduled.\u003c/span\u003e\r\n  root.\u003cspan class=\"hljs-property\"\u003ecallbackNode\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n  root.\u003cspan class=\"hljs-property\"\u003ecallbackExpirationTime\u003c/span\u003e = \u003cspan class=\"hljs-title class_\"\u003eNoWork\u003c/span\u003e;\r\n  root.\u003cspan class=\"hljs-property\"\u003ecallbackPriority\u003c/span\u003e = \u003cspan class=\"hljs-title class_\"\u003eNoPriority\u003c/span\u003e;\r\n  root.\u003cspan class=\"hljs-property\"\u003enextKnownPendingLevel\u003c/span\u003e = \u003cspan class=\"hljs-title class_\"\u003eNoWork\u003c/span\u003e;\r\n\r\n  \u003cspan class=\"hljs-title function_\"\u003estartCommitTimer\u003c/span\u003e();\r\n\r\n  \u003cspan class=\"hljs-comment\"\u003e// Update the first and last pending times on this root. The new first\u003c/span\u003e\r\n  \u003cspan class=\"hljs-comment\"\u003e// pending time is whatever is left on the root fiber.\u003c/span\u003e\r\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e remainingExpirationTimeBeforeCommit = \u003cspan class=\"hljs-title function_\"\u003egetRemainingExpirationTime\u003c/span\u003e(\r\n    finishedWork,\r\n  );\r\n  \u003cspan class=\"hljs-title function_\"\u003emarkRootFinishedAtTime\u003c/span\u003e(\r\n    root,\r\n    expirationTime,\r\n    remainingExpirationTimeBeforeCommit,\r\n  );\r\n\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (root === workInProgressRoot) {\r\n    \u003cspan class=\"hljs-comment\"\u003e// We can reset these now that they are finished.\u003c/span\u003e\r\n    workInProgressRoot = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n    workInProgress = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n    renderExpirationTime = \u003cspan class=\"hljs-title class_\"\u003eNoWork\u003c/span\u003e;\r\n  } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\r\n    \u003cspan class=\"hljs-comment\"\u003e// This indicates that the last root we worked on is not the same one that\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// we're committing now. This most commonly happens when a suspended root\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// times out.\u003c/span\u003e\r\n  }\r\n\r\n  \u003cspan class=\"hljs-comment\"\u003e// Get the list of effects.\u003c/span\u003e\r\n  \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e firstEffect;\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (finishedWork.\u003cspan class=\"hljs-property\"\u003eeffectTag\u003c/span\u003e \u003e \u003cspan class=\"hljs-title class_\"\u003ePerformedWork\u003c/span\u003e) {\r\n    \u003cspan class=\"hljs-comment\"\u003e// A fiber's effect list consists only of its children, not itself. So if\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// the root has an effect, we need to add it to the end of the list. The\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// resulting list is the set that would belong to the root's parent, if it\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// had one; that is, all the effects in the tree including the root.\u003c/span\u003e\r\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (finishedWork.\u003cspan class=\"hljs-property\"\u003elastEffect\u003c/span\u003e !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n      finishedWork.\u003cspan class=\"hljs-property\"\u003elastEffect\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003enextEffect\u003c/span\u003e = finishedWork;\r\n      firstEffect = finishedWork.\u003cspan class=\"hljs-property\"\u003efirstEffect\u003c/span\u003e;\r\n    } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\r\n      firstEffect = finishedWork;\r\n    }\r\n  } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\r\n    \u003cspan class=\"hljs-comment\"\u003e// There is no effect on the root.\u003c/span\u003e\r\n    firstEffect = finishedWork.\u003cspan class=\"hljs-property\"\u003efirstEffect\u003c/span\u003e;\r\n  }\r\n\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (firstEffect !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e prevExecutionContext = executionContext;\r\n    executionContext |= \u003cspan class=\"hljs-title class_\"\u003eCommitContext\u003c/span\u003e;\r\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e prevInteractions = \u003cspan class=\"hljs-title function_\"\u003epushInteractions\u003c/span\u003e(root);\r\n\r\n    \u003cspan class=\"hljs-comment\"\u003e// Reset this to null before calling lifecycles\u003c/span\u003e\r\n    \u003cspan class=\"hljs-title class_\"\u003eReactCurrentOwner\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ecurrent\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n\r\n    \u003cspan class=\"hljs-comment\"\u003e// The commit phase is broken into several sub-phases. We do a separate pass\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// of the effect list for each phase: all mutation effects come before all\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// layout effects, and so on.\u003c/span\u003e\r\n\r\n    \u003cspan class=\"hljs-comment\"\u003e// The first phase a \"before mutation\" phase. We use this phase to read the\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// state of the host tree right before we mutate it. This is where\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// getSnapshotBeforeUpdate is called.\u003c/span\u003e\r\n    \u003cspan class=\"hljs-title function_\"\u003estartCommitSnapshotEffectsTimer\u003c/span\u003e();\r\n    \u003cspan class=\"hljs-title function_\"\u003eprepareForCommit\u003c/span\u003e(root.\u003cspan class=\"hljs-property\"\u003econtainerInfo\u003c/span\u003e);\r\n    nextEffect = firstEffect;\r\n    \u003cspan class=\"hljs-keyword\"\u003edo\u003c/span\u003e {\r\n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (__DEV__) {\r\n        \u003cspan class=\"hljs-title function_\"\u003einvokeGuardedCallback\u003c/span\u003e(\u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e, commitBeforeMutationEffects, \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e);\r\n        \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (\u003cspan class=\"hljs-title function_\"\u003ehasCaughtError\u003c/span\u003e()) {\r\n          \u003cspan class=\"hljs-title function_\"\u003einvariant\u003c/span\u003e(nextEffect !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'Should be working on an effect.'\u003c/span\u003e);\r\n          \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e error = \u003cspan class=\"hljs-title function_\"\u003eclearCaughtError\u003c/span\u003e();\r\n          \u003cspan class=\"hljs-title function_\"\u003ecaptureCommitPhaseError\u003c/span\u003e(nextEffect, error);\r\n          nextEffect = nextEffect.\u003cspan class=\"hljs-property\"\u003enextEffect\u003c/span\u003e;\r\n        }\r\n      } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\r\n        \u003cspan class=\"hljs-keyword\"\u003etry\u003c/span\u003e {\r\n          \u003cspan class=\"hljs-title function_\"\u003ecommitBeforeMutationEffects\u003c/span\u003e();\r\n        } \u003cspan class=\"hljs-keyword\"\u003ecatch\u003c/span\u003e (error) {\r\n          \u003cspan class=\"hljs-title function_\"\u003einvariant\u003c/span\u003e(nextEffect !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'Should be working on an effect.'\u003c/span\u003e);\r\n          \u003cspan class=\"hljs-title function_\"\u003ecaptureCommitPhaseError\u003c/span\u003e(nextEffect, error);\r\n          nextEffect = nextEffect.\u003cspan class=\"hljs-property\"\u003enextEffect\u003c/span\u003e;\r\n        }\r\n      }\r\n    } \u003cspan class=\"hljs-keyword\"\u003ewhile\u003c/span\u003e (nextEffect !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e);\r\n    \u003cspan class=\"hljs-title function_\"\u003estopCommitSnapshotEffectsTimer\u003c/span\u003e();\r\n\r\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (enableProfilerTimer) {\r\n      \u003cspan class=\"hljs-comment\"\u003e// Mark the current commit time to be shared by all Profilers in this\u003c/span\u003e\r\n      \u003cspan class=\"hljs-comment\"\u003e// batch. This enables them to be grouped later.\u003c/span\u003e\r\n      \u003cspan class=\"hljs-title function_\"\u003erecordCommitTime\u003c/span\u003e();\r\n    }\r\n\r\n    \u003cspan class=\"hljs-comment\"\u003e// The next phase is the mutation phase, where we mutate the host tree.\u003c/span\u003e\r\n    \u003cspan class=\"hljs-title function_\"\u003estartCommitHostEffectsTimer\u003c/span\u003e();\r\n    nextEffect = firstEffect;\r\n    \u003cspan class=\"hljs-keyword\"\u003edo\u003c/span\u003e {\r\n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (__DEV__) {\r\n        \u003cspan class=\"hljs-title function_\"\u003einvokeGuardedCallback\u003c/span\u003e(\r\n          \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e,\r\n          commitMutationEffects,\r\n          \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e,\r\n          root,\r\n          renderPriorityLevel,\r\n        );\r\n        \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (\u003cspan class=\"hljs-title function_\"\u003ehasCaughtError\u003c/span\u003e()) {\r\n          \u003cspan class=\"hljs-title function_\"\u003einvariant\u003c/span\u003e(nextEffect !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'Should be working on an effect.'\u003c/span\u003e);\r\n          \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e error = \u003cspan class=\"hljs-title function_\"\u003eclearCaughtError\u003c/span\u003e();\r\n          \u003cspan class=\"hljs-title function_\"\u003ecaptureCommitPhaseError\u003c/span\u003e(nextEffect, error);\r\n          nextEffect = nextEffect.\u003cspan class=\"hljs-property\"\u003enextEffect\u003c/span\u003e;\r\n        }\r\n      } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\r\n        \u003cspan class=\"hljs-keyword\"\u003etry\u003c/span\u003e {\r\n          \u003cspan class=\"hljs-title function_\"\u003ecommitMutationEffects\u003c/span\u003e(root, renderPriorityLevel);\r\n        } \u003cspan class=\"hljs-keyword\"\u003ecatch\u003c/span\u003e (error) {\r\n          \u003cspan class=\"hljs-title function_\"\u003einvariant\u003c/span\u003e(nextEffect !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'Should be working on an effect.'\u003c/span\u003e);\r\n          \u003cspan class=\"hljs-title function_\"\u003ecaptureCommitPhaseError\u003c/span\u003e(nextEffect, error);\r\n          nextEffect = nextEffect.\u003cspan class=\"hljs-property\"\u003enextEffect\u003c/span\u003e;\r\n        }\r\n      }\r\n    } \u003cspan class=\"hljs-keyword\"\u003ewhile\u003c/span\u003e (nextEffect !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e);\r\n    \u003cspan class=\"hljs-title function_\"\u003estopCommitHostEffectsTimer\u003c/span\u003e();\r\n    \u003cspan class=\"hljs-title function_\"\u003eresetAfterCommit\u003c/span\u003e(root.\u003cspan class=\"hljs-property\"\u003econtainerInfo\u003c/span\u003e);\r\n\r\n    \u003cspan class=\"hljs-comment\"\u003e// The work-in-progress tree is now the current tree. This must come after\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// the mutation phase, so that the previous tree is still current during\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// componentWillUnmount, but before the layout phase, so that the finished\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// work is current during componentDidMount/Update.\u003c/span\u003e\r\n    root.\u003cspan class=\"hljs-property\"\u003ecurrent\u003c/span\u003e = finishedWork;\r\n\r\n    \u003cspan class=\"hljs-comment\"\u003e// The next phase is the layout phase, where we call effects that read\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// the host tree after it's been mutated. The idiomatic use case for this is\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// layout, but class component lifecycles also fire here for legacy reasons.\u003c/span\u003e\r\n    \u003cspan class=\"hljs-title function_\"\u003estartCommitLifeCyclesTimer\u003c/span\u003e();\r\n    nextEffect = firstEffect;\r\n    \u003cspan class=\"hljs-keyword\"\u003edo\u003c/span\u003e {\r\n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (__DEV__) {\r\n        \u003cspan class=\"hljs-title function_\"\u003einvokeGuardedCallback\u003c/span\u003e(\r\n          \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e,\r\n          commitLayoutEffects,\r\n          \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e,\r\n          root,\r\n          expirationTime,\r\n        );\r\n        \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (\u003cspan class=\"hljs-title function_\"\u003ehasCaughtError\u003c/span\u003e()) {\r\n          \u003cspan class=\"hljs-title function_\"\u003einvariant\u003c/span\u003e(nextEffect !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'Should be working on an effect.'\u003c/span\u003e);\r\n          \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e error = \u003cspan class=\"hljs-title function_\"\u003eclearCaughtError\u003c/span\u003e();\r\n          \u003cspan class=\"hljs-title function_\"\u003ecaptureCommitPhaseError\u003c/span\u003e(nextEffect, error);\r\n          nextEffect = nextEffect.\u003cspan class=\"hljs-property\"\u003enextEffect\u003c/span\u003e;\r\n        }\r\n      } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\r\n        \u003cspan class=\"hljs-keyword\"\u003etry\u003c/span\u003e {\r\n          \u003cspan class=\"hljs-title function_\"\u003ecommitLayoutEffects\u003c/span\u003e(root, expirationTime);\r\n        } \u003cspan class=\"hljs-keyword\"\u003ecatch\u003c/span\u003e (error) {\r\n          \u003cspan class=\"hljs-title function_\"\u003einvariant\u003c/span\u003e(nextEffect !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e'Should be working on an effect.'\u003c/span\u003e);\r\n          \u003cspan class=\"hljs-title function_\"\u003ecaptureCommitPhaseError\u003c/span\u003e(nextEffect, error);\r\n          nextEffect = nextEffect.\u003cspan class=\"hljs-property\"\u003enextEffect\u003c/span\u003e;\r\n        }\r\n      }\r\n    } \u003cspan class=\"hljs-keyword\"\u003ewhile\u003c/span\u003e (nextEffect !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e);\r\n    \u003cspan class=\"hljs-title function_\"\u003estopCommitLifeCyclesTimer\u003c/span\u003e();\r\n\r\n    nextEffect = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n\r\n    \u003cspan class=\"hljs-comment\"\u003e// Tell Scheduler to yield at the end of the frame, so the browser has an\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// opportunity to paint.\u003c/span\u003e\r\n    \u003cspan class=\"hljs-title function_\"\u003erequestPaint\u003c/span\u003e();\r\n\r\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (enableSchedulerTracing) {\r\n      \u003cspan class=\"hljs-title function_\"\u003epopInteractions\u003c/span\u003e(((\u003cspan class=\"hljs-attr\"\u003eprevInteractions\u003c/span\u003e: any): \u003cspan class=\"hljs-title class_\"\u003eSet\u003c/span\u003e\u0026#x3C;\u003cspan class=\"hljs-title class_\"\u003eInteraction\u003c/span\u003e\u003e));\r\n    }\r\n    executionContext = prevExecutionContext;\r\n  } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\r\n    \u003cspan class=\"hljs-comment\"\u003e// No effects.\u003c/span\u003e\r\n    root.\u003cspan class=\"hljs-property\"\u003ecurrent\u003c/span\u003e = finishedWork;\r\n    \u003cspan class=\"hljs-comment\"\u003e// Measure these anyway so the flamegraph explicitly shows that there were\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// no effects.\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// \u003cspan class=\"hljs-doctag\"\u003eTODO:\u003c/span\u003e Maybe there's a better way to report this.\u003c/span\u003e\r\n    \u003cspan class=\"hljs-title function_\"\u003estartCommitSnapshotEffectsTimer\u003c/span\u003e();\r\n    \u003cspan class=\"hljs-title function_\"\u003estopCommitSnapshotEffectsTimer\u003c/span\u003e();\r\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (enableProfilerTimer) {\r\n      \u003cspan class=\"hljs-title function_\"\u003erecordCommitTime\u003c/span\u003e();\r\n    }\r\n    \u003cspan class=\"hljs-title function_\"\u003estartCommitHostEffectsTimer\u003c/span\u003e();\r\n    \u003cspan class=\"hljs-title function_\"\u003estopCommitHostEffectsTimer\u003c/span\u003e();\r\n    \u003cspan class=\"hljs-title function_\"\u003estartCommitLifeCyclesTimer\u003c/span\u003e();\r\n    \u003cspan class=\"hljs-title function_\"\u003estopCommitLifeCyclesTimer\u003c/span\u003e();\r\n  }\r\n\r\n  \u003cspan class=\"hljs-title function_\"\u003estopCommitTimer\u003c/span\u003e();\r\n\r\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e rootDidHavePassiveEffects = rootDoesHavePassiveEffects;\r\n\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (rootDoesHavePassiveEffects) {\r\n    \u003cspan class=\"hljs-comment\"\u003e// This commit has passive effects. Stash a reference to them. But don't\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// schedule a callback until after flushing layout work.\u003c/span\u003e\r\n    rootDoesHavePassiveEffects = \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e;\r\n    rootWithPendingPassiveEffects = root;\r\n    pendingPassiveEffectsExpirationTime = expirationTime;\r\n    pendingPassiveEffectsRenderPriority = renderPriorityLevel;\r\n  } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\r\n    \u003cspan class=\"hljs-comment\"\u003e// We are done with the effect chain at this point so let's clear the\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// nextEffect pointers to assist with GC. If we have passive effects, we'll\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// clear this in flushPassiveEffects.\u003c/span\u003e\r\n    nextEffect = firstEffect;\r\n    \u003cspan class=\"hljs-keyword\"\u003ewhile\u003c/span\u003e (nextEffect !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n      \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e nextNextEffect = nextEffect.\u003cspan class=\"hljs-property\"\u003enextEffect\u003c/span\u003e;\r\n      nextEffect.\u003cspan class=\"hljs-property\"\u003enextEffect\u003c/span\u003e = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n      nextEffect = nextNextEffect;\r\n    }\r\n  }\r\n\r\n  \u003cspan class=\"hljs-comment\"\u003e// Check if there's remaining work on this root\u003c/span\u003e\r\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e remainingExpirationTime = root.\u003cspan class=\"hljs-property\"\u003efirstPendingTime\u003c/span\u003e;\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (remainingExpirationTime !== \u003cspan class=\"hljs-title class_\"\u003eNoWork\u003c/span\u003e) {\r\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (enableSchedulerTracing) {\r\n      \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (spawnedWorkDuringRender !== \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\r\n        \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e expirationTimes = spawnedWorkDuringRender;\r\n        spawnedWorkDuringRender = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n        \u003cspan class=\"hljs-keyword\"\u003efor\u003c/span\u003e (\u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e i = \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e; i \u0026#x3C; expirationTimes.\u003cspan class=\"hljs-property\"\u003elength\u003c/span\u003e; i++) {\r\n          \u003cspan class=\"hljs-title function_\"\u003escheduleInteractions\u003c/span\u003e(\r\n            root,\r\n            expirationTimes[i],\r\n            root.\u003cspan class=\"hljs-property\"\u003ememoizedInteractions\u003c/span\u003e,\r\n          );\r\n        }\r\n      }\r\n      \u003cspan class=\"hljs-title function_\"\u003eschedulePendingInteractions\u003c/span\u003e(root, remainingExpirationTime);\r\n    }\r\n  } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\r\n    \u003cspan class=\"hljs-comment\"\u003e// If there's no remaining work, we can clear the set of already failed\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// error boundaries.\u003c/span\u003e\r\n    legacyErrorBoundariesThatAlreadyFailed = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n  }\r\n\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (enableSchedulerTracing) {\r\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (!rootDidHavePassiveEffects) {\r\n      \u003cspan class=\"hljs-comment\"\u003e// If there are no passive effects, then we can complete the pending interactions.\u003c/span\u003e\r\n      \u003cspan class=\"hljs-comment\"\u003e// Otherwise, we'll wait until after the passive effects are flushed.\u003c/span\u003e\r\n      \u003cspan class=\"hljs-comment\"\u003e// Wait to do this until after remaining work has been scheduled,\u003c/span\u003e\r\n      \u003cspan class=\"hljs-comment\"\u003e// so that we don't prematurely signal complete for interactions when there's e.g. hidden work.\u003c/span\u003e\r\n      \u003cspan class=\"hljs-title function_\"\u003efinishPendingInteractions\u003c/span\u003e(root, expirationTime);\r\n    }\r\n  }\r\n\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (remainingExpirationTime === \u003cspan class=\"hljs-title class_\"\u003eSync\u003c/span\u003e) {\r\n    \u003cspan class=\"hljs-comment\"\u003e// Count the number of times the root synchronously re-renders without\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// finishing. If there are too many, it indicates an infinite update loop.\u003c/span\u003e\r\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (root === rootWithNestedUpdates) {\r\n      nestedUpdateCount++;\r\n    } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\r\n      nestedUpdateCount = \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e;\r\n      rootWithNestedUpdates = root;\r\n    }\r\n  } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\r\n    nestedUpdateCount = \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e;\r\n  }\r\n\r\n  \u003cspan class=\"hljs-title function_\"\u003eonCommitRoot\u003c/span\u003e(finishedWork.\u003cspan class=\"hljs-property\"\u003estateNode\u003c/span\u003e, expirationTime);\r\n\r\n  \u003cspan class=\"hljs-comment\"\u003e// Always call this before exiting `commitRoot`, to ensure that any\u003c/span\u003e\r\n  \u003cspan class=\"hljs-comment\"\u003e// additional work on this root is scheduled.\u003c/span\u003e\r\n  \u003cspan class=\"hljs-title function_\"\u003eensureRootIsScheduled\u003c/span\u003e(root);\r\n\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (hasUncaughtError) {\r\n    hasUncaughtError = \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e;\r\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e error = firstUncaughtError;\r\n    firstUncaughtError = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n    \u003cspan class=\"hljs-keyword\"\u003ethrow\u003c/span\u003e error;\r\n  }\r\n\r\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e ((executionContext \u0026#x26; \u003cspan class=\"hljs-title class_\"\u003eLegacyUnbatchedContext\u003c/span\u003e) !== \u003cspan class=\"hljs-title class_\"\u003eNoContext\u003c/span\u003e) {\r\n    \u003cspan class=\"hljs-comment\"\u003e// This is a legacy edge case. We just committed the initial mount of\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// a ReactDOM.render-ed root inside of batchedUpdates. The commit fired\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// synchronously, but layout updates should be deferred until the end\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// of the batch.\u003c/span\u003e\r\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n  }\r\n\r\n  \u003cspan class=\"hljs-comment\"\u003e// If layout work was scheduled, flush it now.\u003c/span\u003e\r\n  \u003cspan class=\"hljs-title function_\"\u003eflushSyncCallbackQueue\u003c/span\u003e();\r\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e;\r\n}\n\u003c/code\u003e\u003c/pre\u003e"])</script><script>self.__next_f.push([1,"5:[\"$\",\"div\",null,{\"children\":[[\"$\",\"h1\",null,{\"className\":\"text-3xl font-semibold\",\"children\":\"react源码阅读\"}],[\"$\",\"div\",null,{\"className\":\"fixed right-12 bottom-20 \",\"children\":[\"$\",\"$L13\",null,{\"toc\":\"$14\"}]}],[\"$\",\"div\",null,{\"className\":\"page_content__nM6Lc\",\"dangerouslySetInnerHTML\":{\"__html\":\"$15\"}}]]}]\n10:[[\"$\",\"meta\",\"0\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}],[\"$\",\"meta\",\"1\",{\"charSet\":\"utf-8\"}],[\"$\",\"title\",\"2\",{\"children\":\"文章 | react源码阅读\"}],[\"$\",\"meta\",\"3\",{\"name\":\"description\",\"content\":\"新宸悦雨 博客 网站 个人网站\"}],[\"$\",\"meta\",\"4\",{\"name\":\"google-site-verification\",\"content\":\"LiZ4kQwHGTLadwCnDnrXngpwNqoQjmFOCOVTtr_PWVo\"}],[\"$\",\"link\",\"5\",{\"rel\":\"icon\",\"href\":\"/icon.svg?d2cf70afa15ddfd8\",\"type\":\"image/svg+xml\",\"sizes\":\"any\"}]]\n4:null\n"])</script></body></html>