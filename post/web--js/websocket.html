<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="/_next/static/css/f8ad259a7d5c0bf2.css" data-precedence="next"/><link rel="stylesheet" href="/_next/static/css/2715c8fee6b9b9b3.css" data-precedence="next"/><link rel="preload" as="script" fetchPriority="low" href="/_next/static/chunks/webpack-b9e10351bdf2da00.js"/><script src="/_next/static/chunks/fd9d1056-046e85abdd898386.js" async=""></script><script src="/_next/static/chunks/23-7c06e0849434312b.js" async=""></script><script src="/_next/static/chunks/main-app-c5d9736a6945eeb9.js" async=""></script><script src="/_next/static/chunks/257-d6408e43d3a4c1f7.js" async=""></script><script src="/_next/static/chunks/231-75c2bb16e5311c25.js" async=""></script><script src="/_next/static/chunks/app/layout-5aac403eda8ffac1.js" async=""></script><script src="/_next/static/chunks/app/post/%5Bcategory%5D/%5Btitle%5D/page-bb1b5c27d30bc491.js" async=""></script><title>文章 | websocket</title><meta name="description" content="新宸悦雨 博客 网站 个人网站"/><meta name="google-site-verification" content="LiZ4kQwHGTLadwCnDnrXngpwNqoQjmFOCOVTtr_PWVo"/><link rel="icon" href="/icon.svg?d2cf70afa15ddfd8" type="image/svg+xml" sizes="any"/><script src="/_next/static/chunks/polyfills-78c92fac7aa8fdd8.js" noModule=""></script></head><body class="min-h-screen bg-background font-sans antialiased __variable_aaf875"><script>!function(){try{var d=document.documentElement,c=d.classList;c.remove('light','dark');var e=localStorage.getItem('theme');if('system'===e||(!e&&true)){var t='(prefers-color-scheme: dark)',m=window.matchMedia(t);if(m.media!==t||m.matches){d.style.colorScheme = 'dark';c.add('dark')}else{d.style.colorScheme = 'light';c.add('light')}}else if(e){c.add(e|| '')}if(e==='light'||e==='dark')d.style.colorScheme=e}catch(e){}}()</script><script>
    function setColor() {
      const color = localStorage.getItem('primary-color')
      const el = document.documentElement
      el.classList.remove("rose","blue","green","orange")
      color && el.classList.add(color)
    }
    setColor()
  </script><header class="sticky top-0 z-50 w-full border-b border-primary/40 bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60"><div class="container flex h-14 max-w-screen-2xl items-center justify-between"><div class="mr-4 flex"><a class="mr-6 flex items-center space-x-2" href="/"><span class="inline-block w-8 h-8"><svg viewBox="0 0 64 64"><g fill="none" fill-rule="evenodd"><circle cx="32" cy="32" r="26" fill="hsl(var(--primary))"></circle><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="26" height="26" x="19" y="10" viewBox="0 0 24 24"><path fill="hsl(var(--background))" d="M5.438 2c-.512 0-1.02.203-1.407.594L2.594 4.03a1.987 1.987 0 0 0 0 2.813l2.125 2.125C3.977 10.46 3.207 12.016 3 12.375c-.469.813-1 1.617-1 2.625 0 1.473.805 2.746 2 3.438.184.105 4.188 2.906 4.188 2.906h.03C8.896 21.75 9.66 22 10.5 22h3c.832 0 1.613-.223 2.281-.625.38-.227 4.031-2.664 5.219-3.75.688-.633 1-1.621 1-2.625s-.414-1.754-1-2.625c-.277-.43-1.023-1.96-1.719-3.406l2.125-2.125a1.987 1.987 0 0 0 0-2.813L19.97 2.594a1.987 1.987 0 0 0-2.813 0l-1.5 1.5A2.2 2.2 0 0 0 15 4H9a2.8 2.8 0 0 0-.656.094l-1.5-1.5A1.98 1.98 0 0 0 5.437 2M9.5 10a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3m5 0a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3M12 13.813c.395 0 .79.054 1 .187.95.59 3 2.883 3 4 0 .559-1.328 1.781-2 2-.953.309-3.047.309-4 0-.672-.219-2-1.441-2-2 0-1.117 2.05-3.41 3-4 .21-.133.605-.187 1-.187M11 17c-.363 0-.57.43-.312.688l1.03 1.218c.16.16.403.16.563 0l1.031-1.218C13.57 17.43 13.364 17 13 17Z"></path></svg><text fill="hsl(var(--background))" data-text-alignment="C" font-family="Fira Mono" font-size="14" font-weight="700" letter-spacing="0.81" transform="translate(-4 33)"><tspan x="17.07" y="17">XCYY</tspan></text><circle cx="32" cy="32" r="30" stroke="hsl(var(--primary))" stroke-width="2"></circle></g></svg></span><span class="text-primary">新宸悦雨</span></a><nav class="hidden items-center gap-4 text-sm lg:gap-6 md:flex"><a class="transition-colors hover:text-primary/80 text-foreground/60" href="/">首页</a><a class="transition-colors hover:text-primary/80 text-primary" href="/post">博客</a></nav></div><nav class="flex items-center space-x-2"><button class="inline-flex items-center justify-center whitespace-nowrap text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 hover:bg-accent h-9 rounded-md px-3 text-primary hover:text-primary !fouse-visible:outline-none" type="button" id="radix-:R36ja:" aria-haspopup="menu" aria-expanded="false" data-state="closed"><span class="inline-block w-3 h-3 rounded-full bg-primary"></span><span class="sr-only">Toggle color</span></button><button class="inline-flex items-center justify-center whitespace-nowrap text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 hover:bg-accent h-9 rounded-md px-3 text-primary hover:text-primary !fouse-visible:outline-none" type="button" id="radix-:R56ja:" aria-haspopup="menu" aria-expanded="false" data-state="closed"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-sun h-[1.2rem] w-[1.2rem] rotate-0 scale-100 transition-all dark:-rotate-90 dark:scale-0"><circle cx="12" cy="12" r="4"></circle><path d="M12 2v2"></path><path d="M12 20v2"></path><path d="m4.93 4.93 1.41 1.41"></path><path d="m17.66 17.66 1.41 1.41"></path><path d="M2 12h2"></path><path d="M20 12h2"></path><path d="m6.34 17.66-1.41 1.41"></path><path d="m19.07 4.93-1.41 1.41"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-moon absolute h-[1.2rem] w-[1.2rem] rotate-90 scale-0 transition-all dark:rotate-0 dark:scale-100"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path></svg><span class="sr-only">Toggle theme</span></button><div class="md:hidden"><button class="inline-flex items-center justify-center whitespace-nowrap text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 hover:bg-accent h-9 rounded-md px-3 text-primary hover:text-primary !fouse-visible:outline-none" type="button" id="radix-:R76ja:" aria-haspopup="menu" aria-expanded="false" data-state="closed"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-list h-[1.2rem] w-[1.2rem] rotate-0 scale-100 transition-all"><line x1="8" x2="21" y1="6" y2="6"></line><line x1="8" x2="21" y1="12" y2="12"></line><line x1="8" x2="21" y1="18" y2="18"></line><line x1="3" x2="3.01" y1="6" y2="6"></line><line x1="3" x2="3.01" y1="12" y2="12"></line><line x1="3" x2="3.01" y1="18" y2="18"></line></svg><span class="sr-only">Toggle Nav</span></button></div></nav></div></header><main class="container max-w-screen-2xl py-6"><div><h1 class="text-3xl font-semibold">websocket</h1><div class="fixed right-12 bottom-20 "><button class="inline-flex items-center justify-center whitespace-nowrap text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 p-3 rounded-full h-12 w-12 shadow-md shadow-primary" type="button" id="radix-:Rkvfffaja:" aria-haspopup="menu" aria-expanded="false" data-state="closed">目录</button></div><div class="page_content__nM6Lc">
<h2 id="介绍">介绍</h2>
<p><strong>WebSockets</strong> 是一种先进的技术。它可以在用户的浏览器和服务器之间打开交互式通信会话。使用此API，您可以向服务器发送消息并接收事件驱动的响应，而无需通过轮询服务器的方式以获得响应。</p>
<h2 id="web-api">web api</h2>
<p><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/WebSocket"><code>WebSocket</code></a></p>
<p>用于连接WebSocket服务器的主要接口，之后可以在这个连接上发送 和接受数据。</p>
<p><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/CloseEvent"><code>CloseEvent</code></a></p>
<p>连接关闭时WebSocket对象发送的事件。</p>
<p><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/MessageEvent"><code>MessageEvent</code></a></p>
<p>当从服务器获取到消息的时候WebSocket对象触发的事件。</p>
<p>WebSocket 不应当用于混合的上下文环境；也就是说，不应该在用HTTPS加载的页面中打开非安全版本的WebSocket，反之亦然。而实际上一些浏览器也明确禁止这一行为，包括 Firefox 8 及更高版本。</p>
<p>使用示例：</p>
<pre><code class="hljs language-javascript"><span class="hljs-keyword">const</span> ws = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebSocket</span>(<span class="hljs-string">'ws://xxx.com/xxx'</span>)
ws.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'open'</span>,<span class="hljs-function"><span class="hljs-params">e</span>=></span>{})
ws.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'message'</span>,<span class="hljs-function"><span class="hljs-params">e</span>=></span>{
    cosnole.<span class="hljs-title function_">log</span>(e.<span class="hljs-property">data</span>)
})
ws.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'error'</span>,<span class="hljs-function"><span class="hljs-params">e</span>=></span>{})
ws.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'close'</span>,<span class="hljs-function"><span class="hljs-params">e</span>=></span>{})
ws.<span class="hljs-title function_">send</span>(<span class="hljs-string">'hello'</span>)
</code></pre>
<h2 id="websocket协议主要内容参考rfc-6455">websocket协议主要内容(参考<a href="https://tools.ietf.org/html/rfc6455#page-4">RFC 6455</a>)</h2>
<p>websocket协议基于TCP协议，通过HTTP进行握手。</p>
<blockquote>
<p>The WebSocket Protocol is an independent TCP-based protocol.  Its
only relationship to HTTP is that its handshake is interpreted by
HTTP servers as an Upgrade request.</p>
<p>By default, the WebSocket Protocol uses port 80 for regular WebSocket
connections and port 443 for WebSocket connections tunneled over
Transport Layer Security (TLS)</p>
</blockquote>
<p>The protocol has two parts: a handshake and the data transfer.</p>
<h3 id="握手">握手</h3>
<p>The handshake from the client looks as follows:</p>
<pre><code class="hljs language-swift">    <span class="hljs-type">GET</span> <span class="hljs-regexp">/chat HTTP/</span><span class="hljs-number">1.1</span>
    <span class="hljs-type">Host</span>: server.example.com
    <span class="hljs-type">Upgrade</span>: websocket  <span class="hljs-comment">// 将协议升级为websocket</span>
    <span class="hljs-type">Connection</span>: <span class="hljs-type">Upgrade</span> <span class="hljs-comment">// 升级协议</span>
    <span class="hljs-type">Sec</span><span class="hljs-operator">-</span><span class="hljs-type">WebSocket</span><span class="hljs-operator">-</span><span class="hljs-type">Key</span>: dGhlIHNhbXBsZSBub25jZQ<span class="hljs-operator">==</span> <span class="hljs-comment">// </span>
    <span class="hljs-type">Origin</span>: http:<span class="hljs-comment">//example.com</span>
    <span class="hljs-type">Sec</span><span class="hljs-operator">-</span><span class="hljs-type">WebSocket</span><span class="hljs-operator">-</span><span class="hljs-type">Protocol</span>: chat, superchat <span class="hljs-comment">// 期望使用的子协议</span>
    <span class="hljs-type">Sec</span><span class="hljs-operator">-</span><span class="hljs-type">WebSocket</span><span class="hljs-operator">-</span><span class="hljs-type">Version</span>: <span class="hljs-number">13</span> <span class="hljs-comment">// websocket版本</span>
    <span class="hljs-comment">// ...其他http请求头</span>
</code></pre>
<p>The handshake from the server looks as follows:</p>
<pre><code class="hljs language-yaml">    <span class="hljs-string">HTTP/1.1</span> <span class="hljs-number">101</span> <span class="hljs-string">Switching</span> <span class="hljs-string">Protocols</span>
    <span class="hljs-attr">Upgrade:</span> <span class="hljs-string">websocket</span>
    <span class="hljs-attr">Connection:</span> <span class="hljs-string">Upgrade</span>
    <span class="hljs-attr">Sec-WebSocket-Accept:</span> <span class="hljs-string">s3pPLMBiTxaQ9kYGzzhZRbK+xOo=</span> <span class="hljs-string">//</span> <span class="hljs-string">base64(SHA1(Sec-WebSocket-Key</span> <span class="hljs-string">+</span> <span class="hljs-string">GUID))</span>
    <span class="hljs-attr">Sec-WebSocket-Protocol:</span> <span class="hljs-string">chat</span> <span class="hljs-string">//</span> <span class="hljs-string">确定使用的子协议</span>
    <span class="hljs-attr">Sec-WebSocket-Version:</span> <span class="hljs-number">13</span> <span class="hljs-string">//</span> <span class="hljs-string">如果不支持请求头中的版本，则发回支持的websocket版本</span>
    <span class="hljs-string">//</span> <span class="hljs-string">...其他http响应头</span>
</code></pre>
<p>其中<code>Sec-WebSocket-Accept</code>的值是由<code>Sec-WebSocket-Key</code>和<code>GUID</code>拼接，拼接后进行SHA1编码，然后再编码为base64格式的字符串。GUID是一个常量字符串。</p>
<blockquote>
<p>Globally Unique Identifier (GUID, <a href="https://tools.ietf.org/html/rfc4122">[RFC4122]</a>) "258EAFA5-E914-47DA-95CA-C5AB0DC85B11"</p>
</blockquote>
<h3 id="数据">数据</h3>
<p>数据是通过一个或多个数据帧来传送，单个数据帧的格式如下：</p>
<pre><code class="hljs language-lua">      <span class="hljs-number">0</span>                   <span class="hljs-number">1</span>                   <span class="hljs-number">2</span>                   <span class="hljs-number">3</span>
      <span class="hljs-number">0</span> <span class="hljs-number">1</span> <span class="hljs-number">2</span> <span class="hljs-number">3</span> <span class="hljs-number">4</span> <span class="hljs-number">5</span> <span class="hljs-number">6</span> <span class="hljs-number">7</span> <span class="hljs-number">8</span> <span class="hljs-number">9</span> <span class="hljs-number">0</span> <span class="hljs-number">1</span> <span class="hljs-number">2</span> <span class="hljs-number">3</span> <span class="hljs-number">4</span> <span class="hljs-number">5</span> <span class="hljs-number">6</span> <span class="hljs-number">7</span> <span class="hljs-number">8</span> <span class="hljs-number">9</span> <span class="hljs-number">0</span> <span class="hljs-number">1</span> <span class="hljs-number">2</span> <span class="hljs-number">3</span> <span class="hljs-number">4</span> <span class="hljs-number">5</span> <span class="hljs-number">6</span> <span class="hljs-number">7</span> <span class="hljs-number">8</span> <span class="hljs-number">9</span> <span class="hljs-number">0</span> <span class="hljs-number">1</span>
     +-+-+-+-+<span class="hljs-comment">-------+-+-------------+-------------------------------+</span>
     |F|R|R|R| opcode|M| Payload <span class="hljs-built_in">len</span> |    Extended payload length    |
     |I|S|S|S|  (<span class="hljs-number">4</span>)  |A|     (<span class="hljs-number">7</span>)     |             (<span class="hljs-number">16</span>/<span class="hljs-number">64</span>)           |
     |N|V|V|V|       |S|             |   (<span class="hljs-keyword">if</span> payload <span class="hljs-built_in">len</span>==<span class="hljs-number">126</span>/<span class="hljs-number">127</span>)   |
     | |<span class="hljs-number">1</span>|<span class="hljs-number">2</span>|<span class="hljs-number">3</span>|       |K|             |                               |
     +-+-+-+-+<span class="hljs-comment">-------+-+-------------+ - - - - - - - - - - - - - - - +</span>
     |     Extended payload length continued, <span class="hljs-keyword">if</span> payload <span class="hljs-built_in">len</span> == <span class="hljs-number">127</span>  |
     + - - - - - - - - - - - - - - - +<span class="hljs-comment">-------------------------------+</span>
     |                               |Masking-key, <span class="hljs-keyword">if</span> MASK set to <span class="hljs-number">1</span>  |
     +<span class="hljs-comment">-------------------------------+-------------------------------+</span>
     | Masking-key (continued)       |          Payload Data         |
     +<span class="hljs-comment">-------------------------------- - - - - - - - - - - - - - - - +</span>
     :                     Payload Data continued ...                :
     + - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - +
     |                     Payload Data continued ...                |
     +<span class="hljs-comment">---------------------------------------------------------------+</span>
</code></pre>
<p>FIN：1 bit，是否为最后一个数据帧。</p>
<p>RSV1, RSV2, RSV3：1 bit each，一般都为0，当需要拓展协议时供拓展使用。</p>
<p>opcode：4 bits，用于解释"Payload data"的作用，如果接收到无法识别的opcode则接收失败</p>
<ol>
<li>
<p>0x0：连续帧</p>
<ol start="2">
<li>0x1：文本帧</li>
<li>0x2：二进制帧</li>
<li>0x3-0x7：保留用于其他非控制帧</li>
<li>0x8：关闭连接</li>
<li>0x9：ping</li>
<li>0xA：pong</li>
<li>0xB-0xF：保留用于其他控制帧</li>
</ol>
</li>
</ol>
<p>Mask：1 bit，"Payload data"是否经过掩码处理，值为1时需要设置“Masking-key”。客户端发送数据时必须为1。</p>
<p>Payload length:  7 bits, 7+16 bits, or 7+64 bits，</p>
<p>Masking-key:  0 or 4 bytes，掩码</p>
<p>Payload data：实际数据内容</p>
<p>编码/解码</p>
<p>随机生成一个32位的掩码，然后通过以下算法计算编码/解码后的数据：</p>
<pre><code class="hljs language-ini"><span class="hljs-attr">j</span> = i MOD <span class="hljs-number">4</span>
<span class="hljs-attr">transformed-octet-i</span> = original-octet-i XOR masking-key-octet-j
即
掩码的第1个字节与数据的第1个字节进行按位异或运算，得到编码/解码后的第1个字节
掩码的第2个字节与数据的第2个字节进行按位异或运算，得到编码/解码/解码后的第2个字节
掩码的第3个字节与数据的第3个字节进行按位异或运算，得到编码/解码后的第3个字节
掩码的第4个字节与数据的第4个字节进行按位异或运算，得到编码/解码后的第4个字节
掩码的第1个字节与数据的第5个字节进行按位异或运算，得到编码/解码后的第5个字节
掩码的第2个字节与数据的第6个字节进行按位异或运算，得到编码/解码后的第6个字节
直到全部编码/解码完成
</code></pre>
<h2 id="websocket协议简单实现nodejs">websocket协议简单实现(nodejs)</h2>
<p>server.js</p>
<pre><code class="hljs language-javascript"><span class="hljs-meta">
'use strict'</span>;

<span class="hljs-keyword">const</span> http = <span class="hljs-built_in">require</span>(<span class="hljs-string">'http'</span>)
<span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>)
<span class="hljs-keyword">const</span> crypto = <span class="hljs-built_in">require</span>(<span class="hljs-string">'crypto'</span>)

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">GUID</span> = <span class="hljs-string">'258EAFA5-E914-47DA-95CA-C5AB0DC85B11'</span>
<span class="hljs-keyword">const</span> hostname = <span class="hljs-string">'localhost'</span>
<span class="hljs-keyword">const</span> port = <span class="hljs-number">8080</span>

<span class="hljs-keyword">const</span> server = http.<span class="hljs-title function_">createServer</span>(<span class="hljs-function">(<span class="hljs-params">req,res</span>)=></span>{
    <span class="hljs-keyword">const</span> {url} = req
    res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">'Content-Type'</span>,<span class="hljs-string">'utf8'</span>)
    
    <span class="hljs-keyword">if</span>(url === <span class="hljs-string">'/'</span>){
        res.<span class="hljs-title function_">writeHead</span>(<span class="hljs-number">200</span>, { <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'text/html'</span> })
        fs.<span class="hljs-title function_">readFile</span>(__dirname + <span class="hljs-string">"/index.html"</span>, <span class="hljs-string">"utf-8"</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">error, data</span>){
            <span class="hljs-keyword">if</span>(error)
                res.<span class="hljs-title function_">end</span>(<span class="hljs-string">"404"</span>);
            <span class="hljs-keyword">else</span>
                res.<span class="hljs-title function_">end</span>(data.<span class="hljs-title function_">toString</span>());
        });
    }<span class="hljs-keyword">else</span> {
        res.<span class="hljs-title function_">end</span>(<span class="hljs-string">'404'</span>)
    }
}).<span class="hljs-title function_">on</span>(<span class="hljs-string">'upgrade'</span>,<span class="hljs-function">(<span class="hljs-params">req, socket,head</span>)=></span>{
    
    <span class="hljs-keyword">const</span> {headers} = req
    <span class="hljs-keyword">const</span> key = crypto.<span class="hljs-title function_">createHash</span>(<span class="hljs-string">'sha1'</span>).<span class="hljs-title function_">update</span>(headers[<span class="hljs-string">"sec-websocket-key"</span>]+<span class="hljs-variable constant_">GUID</span>).<span class="hljs-title function_">digest</span>(<span class="hljs-string">'base64'</span>)
    <span class="hljs-comment">// 握手</span>
    socket.<span class="hljs-title function_">write</span>([
        <span class="hljs-string">'HTTP/1.1 101 Switching Protocols'</span>,
        <span class="hljs-string">'Upgrade: websocket'</span>,
        <span class="hljs-string">'Connection: Upgrade'</span>,
        <span class="hljs-string">`sec-websocket-accept: <span class="hljs-subst">${key}</span>`</span>
    ].<span class="hljs-title function_">join</span>(<span class="hljs-string">'\r\n'</span>)+<span class="hljs-string">'\r\n\r\n'</span>)
    
    <span class="hljs-comment">// 接收数据</span>
    socket.<span class="hljs-title function_">on</span>(<span class="hljs-string">'data'</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">buf</span>) {
        <span class="hljs-keyword">let</span> values = <span class="hljs-string">''</span>
        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> value <span class="hljs-keyword">of</span> buf.<span class="hljs-title function_">values</span>()){
            values += value.<span class="hljs-title function_">toString</span>(<span class="hljs-number">2</span>)
        }
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(values) 
        <span class="hljs-comment">// 10000001 10000111 10010001 01011010 11010011 01010100 11111001 00111111 10111111 00111000 11111110 01110100 11111101</span>
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">decodeFrame</span>(buf)) <span class="hljs-comment">// hello..</span>
    });
    
    <span class="hljs-comment">// 发送数据</span>
    socket.<span class="hljs-title function_">send</span>(<span class="hljs-title function_">encodeFrame</span>(<span class="hljs-string">'hi'</span>))
}).<span class="hljs-title function_">listen</span>(port,hostname,<span class="hljs-function">()=></span>{
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'server started, click http://'</span>+hostname+<span class="hljs-string">':'</span>+port+<span class="hljs-string">' to view the page'</span>)
})

<span class="hljs-comment">// 解码</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">decodeFrame</span>(<span class="hljs-params">buf</span>) {
    <span class="hljs-keyword">const</span> length = buf.<span class="hljs-title function_">readUInt8</span>(<span class="hljs-number">1</span>) &#x26; <span class="hljs-number">0x7f</span>
    <span class="hljs-keyword">const</span> mask = buf.<span class="hljs-title function_">slice</span>(<span class="hljs-number">2</span>,<span class="hljs-number">6</span>)
    <span class="hljs-keyword">const</span> payload = buf.<span class="hljs-title function_">slice</span>(<span class="hljs-number">6</span>)
    <span class="hljs-keyword">let</span> formattedBuf = <span class="hljs-title class_">Buffer</span>.<span class="hljs-title function_">alloc</span>(payload.<span class="hljs-property">length</span>)
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> i=<span class="hljs-number">0</span>;i&#x3C;payload.<span class="hljs-property">length</span>;i++) {
        formattedBuf[i] = mask[i%<span class="hljs-number">4</span>] ^ payload[i]
    }
    <span class="hljs-keyword">return</span> formattedBuf
}

<span class="hljs-comment">// 编码</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">encodeFrame</span>(<span class="hljs-params">str</span>) {
    <span class="hljs-keyword">const</span> payload = <span class="hljs-title class_">Buffer</span>.<span class="hljs-title function_">from</span>(str)
    <span class="hljs-keyword">const</span> frame = <span class="hljs-title class_">Buffer</span>.<span class="hljs-title function_">alloc</span>(payload.<span class="hljs-property">length</span>+<span class="hljs-number">2</span>)
    frame.<span class="hljs-title function_">writeUInt8</span>(<span class="hljs-number">0b10000001</span>)
    frame.<span class="hljs-title function_">writeUInt8</span>(<span class="hljs-number">0b00000010</span>,<span class="hljs-number">1</span>)
    payload.<span class="hljs-title function_">copy</span>(frame,<span class="hljs-number">2</span>)
    <span class="hljs-keyword">return</span> frame
}
</code></pre>
<p>index.html</p>
<pre><code class="hljs language-html"><span class="hljs-tag">&#x3C;<span class="hljs-name">html</span>></span>
  <span class="hljs-tag">&#x3C;<span class="hljs-name">head</span>></span>
    <span class="hljs-tag">&#x3C;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"utf-8"</span>/></span>
  <span class="hljs-tag">&#x3C;/<span class="hljs-name">head</span>></span>
  <span class="hljs-tag">&#x3C;<span class="hljs-name">body</span>></span>
    <span class="hljs-tag">&#x3C;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"container"</span>></span><span class="hljs-tag">&#x3C;/<span class="hljs-name">div</span>></span>
    <span class="hljs-tag">&#x3C;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text/babel"</span>></span><span class="javascript">
    <span class="hljs-keyword">const</span> client = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebSocket</span>(<span class="hljs-string">'ws://localhost:8080'</span>)
    client.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'message'</span>, <span class="hljs-function"><span class="hljs-params">e</span>=></span>{
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(e)
    })
    client.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'open'</span>, <span class="hljs-function"><span class="hljs-params">e</span>=></span>{
      client.<span class="hljs-title function_">send</span>(<span class="hljs-string">'hello..'</span>)
    })
    </span><span class="hljs-tag">&#x3C;/<span class="hljs-name">script</span>></span>
  <span class="hljs-tag">&#x3C;/<span class="hljs-name">body</span>></span>
<span class="hljs-tag">&#x3C;/<span class="hljs-name">html</span>></span>
</code></pre></div></div></main><script src="/_next/static/chunks/webpack-b9e10351bdf2da00.js" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0]);self.__next_f.push([2,null])</script><script>self.__next_f.push([1,"1:HL[\"/_next/static/css/f8ad259a7d5c0bf2.css\",\"style\"]\n2:HL[\"/_next/static/css/2715c8fee6b9b9b3.css\",\"style\"]\n"])</script><script>self.__next_f.push([1,"3:I[5751,[],\"\"]\n6:I[9275,[],\"\"]\n9:I[1343,[],\"\"]\na:I[9512,[\"257\",\"static/chunks/257-d6408e43d3a4c1f7.js\",\"231\",\"static/chunks/231-75c2bb16e5311c25.js\",\"185\",\"static/chunks/app/layout-5aac403eda8ffac1.js\"],\"ThemeProvider\"]\nb:I[9890,[\"257\",\"static/chunks/257-d6408e43d3a4c1f7.js\",\"231\",\"static/chunks/231-75c2bb16e5311c25.js\",\"185\",\"static/chunks/app/layout-5aac403eda8ffac1.js\"],\"ColorProvider\"]\nc:I[1998,[\"257\",\"static/chunks/257-d6408e43d3a4c1f7.js\",\"231\",\"static/chunks/231-75c2bb16e5311c25.js\",\"185\",\"static/chunks/app/layout-5aac403eda8ffac1.js\"],\"default\"]\nd:I[3408,[\"257\",\"static/chunks/257-d6408e43d3a4c1f7.js\",\"231\",\"static/chunks/231-75c2bb16e5311c25.js\",\"185\",\"static/chunks/app/layout-5aac403eda8ffac1.js\"],\"ColorToggle\"]\ne:I[6345,[\"257\",\"static/chunks/257-d6408e43d3a4c1f7.js\",\"231\",\"static/chunks/231-75c2bb16e5311c25.js\",\"185\",\"static/chunks/app/layout-5aac403eda8ffac1.js\"],\"ThemeToggle\"]\nf:I[7970,[\"257\",\"static/chunks/257-d6408e43d3a4c1f7.js\",\"231\",\"static/chunks/231-75c2bb16e5311c25.js\",\"185\",\"static/chunks/app/layout-5aac403eda8ffac1.js\"],\"NavToggle\"]\n11:I[6130,[],\"\"]\n7:[\"category\",\"web--js\",\"d\"]\n8:[\"title\",\"websocket\",\"d\"]\n12:[]\n"])</script><script>self.__next_f.push([1,"0:[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/f8ad259a7d5c0bf2.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\"}]],[\"$\",\"$L3\",null,{\"buildId\":\"GB6GWdwB48S_6jQAbWqVr\",\"assetPrefix\":\"\",\"initialCanonicalUrl\":\"/post/web--js/websocket\",\"initialTree\":[\"\",{\"children\":[\"post\",{\"children\":[[\"category\",\"web--js\",\"d\"],{\"children\":[[\"title\",\"websocket\",\"d\"],{\"children\":[\"__PAGE__?{\\\"category\\\":\\\"web--js\\\",\\\"title\\\":\\\"websocket\\\"}\",{}]}]}]}]},\"$undefined\",\"$undefined\",true],\"initialSeedData\":[\"\",{\"children\":[\"post\",{\"children\":[[\"category\",\"web--js\",\"d\"],{\"children\":[[\"title\",\"websocket\",\"d\"],{\"children\":[\"__PAGE__\",{},[[\"$L4\",\"$L5\"],null],null]},[\"$\",\"$L6\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"post\",\"children\",\"$7\",\"children\",\"$8\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L9\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"styles\":[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/2715c8fee6b9b9b3.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\"}]]}],null]},[\"$\",\"$L6\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"post\",\"children\",\"$7\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L9\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"styles\":null}],null]},[\"$\",\"$L6\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"post\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L9\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"styles\":null}],null]},[[\"$\",\"html\",null,{\"lang\":\"en\",\"suppressHydrationWarning\":true,\"children\":[\"$\",\"body\",null,{\"className\":\"min-h-screen bg-background font-sans antialiased __variable_aaf875\",\"children\":[\"$\",\"$La\",null,{\"attribute\":\"class\",\"defaultTheme\":\"system\",\"enableSystem\":true,\"disableTransitionOnChange\":true,\"children\":[\"$\",\"$Lb\",null,{\"children\":[[\"$\",\"header\",null,{\"className\":\"sticky top-0 z-50 w-full border-b border-primary/40 bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60\",\"children\":[\"$\",\"div\",null,{\"className\":\"container flex h-14 max-w-screen-2xl items-center justify-between\",\"children\":[[\"$\",\"div\",null,{\"className\":\"mr-4 flex\",\"children\":[[\"$\",\"a\",null,{\"className\":\"mr-6 flex items-center space-x-2\",\"href\":\"/\",\"children\":[[\"$\",\"span\",null,{\"className\":\"inline-block w-8 h-8\",\"children\":[\"$\",\"svg\",null,{\"viewBox\":\"0 0 64 64\",\"children\":[\"$\",\"g\",null,{\"fill\":\"none\",\"fillRule\":\"evenodd\",\"children\":[[\"$\",\"circle\",null,{\"cx\":32,\"cy\":32,\"r\":26,\"fill\":\"hsl(var(--primary))\"}],[\"$\",\"svg\",null,{\"xmlns\":\"http://www.w3.org/2000/svg\",\"xmlnsXlink\":\"http://www.w3.org/1999/xlink\",\"width\":26,\"height\":26,\"x\":19,\"y\":10,\"viewBox\":\"0 0 24 24\",\"children\":[\"$\",\"path\",null,{\"fill\":\"hsl(var(--background))\",\"d\":\"M5.438 2c-.512 0-1.02.203-1.407.594L2.594 4.03a1.987 1.987 0 0 0 0 2.813l2.125 2.125C3.977 10.46 3.207 12.016 3 12.375c-.469.813-1 1.617-1 2.625 0 1.473.805 2.746 2 3.438.184.105 4.188 2.906 4.188 2.906h.03C8.896 21.75 9.66 22 10.5 22h3c.832 0 1.613-.223 2.281-.625.38-.227 4.031-2.664 5.219-3.75.688-.633 1-1.621 1-2.625s-.414-1.754-1-2.625c-.277-.43-1.023-1.96-1.719-3.406l2.125-2.125a1.987 1.987 0 0 0 0-2.813L19.97 2.594a1.987 1.987 0 0 0-2.813 0l-1.5 1.5A2.2 2.2 0 0 0 15 4H9a2.8 2.8 0 0 0-.656.094l-1.5-1.5A1.98 1.98 0 0 0 5.437 2M9.5 10a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3m5 0a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3M12 13.813c.395 0 .79.054 1 .187.95.59 3 2.883 3 4 0 .559-1.328 1.781-2 2-.953.309-3.047.309-4 0-.672-.219-2-1.441-2-2 0-1.117 2.05-3.41 3-4 .21-.133.605-.187 1-.187M11 17c-.363 0-.57.43-.312.688l1.03 1.218c.16.16.403.16.563 0l1.031-1.218C13.57 17.43 13.364 17 13 17Z\"}]}],[\"$\",\"text\",null,{\"fill\":\"hsl(var(--background))\",\"data-text-alignment\":\"C\",\"fontFamily\":\"Fira Mono\",\"fontSize\":14,\"fontWeight\":700,\"letterSpacing\":0.81,\"transform\":\"translate(-4 33)\",\"children\":[\"$\",\"tspan\",null,{\"x\":17.07,\"y\":17,\"children\":\"XCYY\"}]}],[\"$\",\"circle\",null,{\"cx\":32,\"cy\":32,\"r\":30,\"stroke\":\"hsl(var(--primary))\",\"strokeWidth\":2}]]}]}]}],[\"$\",\"span\",null,{\"className\":\"text-primary\",\"children\":\"新宸悦雨\"}]]}],[\"$\",\"$Lc\",null,{}]]}],[\"$\",\"nav\",null,{\"className\":\"flex items-center space-x-2\",\"children\":[[\"$\",\"$Ld\",null,{}],[\"$\",\"$Le\",null,{}],[\"$\",\"div\",null,{\"className\":\"md:hidden\",\"children\":[\"$\",\"$Lf\",null,{}]}]]}]]}]}],[\"$\",\"main\",null,{\"className\":\"container max-w-screen-2xl py-6\",\"children\":[\"$\",\"$L6\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L9\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[[\"$\",\"title\",null,{\"children\":\"404: This page could not be found.\"}],[\"$\",\"div\",null,{\"style\":{\"fontFamily\":\"system-ui,\\\"Segoe UI\\\",Roboto,Helvetica,Arial,sans-serif,\\\"Apple Color Emoji\\\",\\\"Segoe UI Emoji\\\"\",\"height\":\"100vh\",\"textAlign\":\"center\",\"display\":\"flex\",\"flexDirection\":\"column\",\"alignItems\":\"center\",\"justifyContent\":\"center\"},\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"style\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}\"}}],[\"$\",\"h1\",null,{\"className\":\"next-error-h1\",\"style\":{\"display\":\"inline-block\",\"margin\":\"0 20px 0 0\",\"padding\":\"0 23px 0 0\",\"fontSize\":24,\"fontWeight\":500,\"verticalAlign\":\"top\",\"lineHeight\":\"49px\"},\"children\":\"404\"}],[\"$\",\"div\",null,{\"style\":{\"display\":\"inline-block\"},\"children\":[\"$\",\"h2\",null,{\"style\":{\"fontSize\":14,\"fontWeight\":400,\"lineHeight\":\"49px\",\"margin\":0},\"children\":\"This page could not be found.\"}]}]]}]}]],\"notFoundStyles\":[],\"styles\":null}]}]]}]}]}]}],null],null],\"couldBeIntercepted\":false,\"initialHead\":[false,\"$L10\"],\"globalErrorComponent\":\"$11\",\"missingSlots\":\"$W12\"}]]\n"])</script><script>self.__next_f.push([1,"13:I[789,[\"257\",\"static/chunks/257-d6408e43d3a4c1f7.js\",\"472\",\"static/chunks/app/post/%5Bcategory%5D/%5Btitle%5D/page-bb1b5c27d30bc491.js\"],\"default\"]\n14:T52a9,"])</script><script>self.__next_f.push([1,"\n\u003ch2 id=\"介绍\"\u003e介绍\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eWebSockets\u003c/strong\u003e 是一种先进的技术。它可以在用户的浏览器和服务器之间打开交互式通信会话。使用此API，您可以向服务器发送消息并接收事件驱动的响应，而无需通过轮询服务器的方式以获得响应。\u003c/p\u003e\n\u003ch2 id=\"web-api\"\u003eweb api\u003c/h2\u003e\n\u003cp\u003e\u003ca href=\"https://developer.mozilla.org/zh-CN/docs/Web/API/WebSocket\"\u003e\u003ccode\u003eWebSocket\u003c/code\u003e\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e用于连接WebSocket服务器的主要接口，之后可以在这个连接上发送 和接受数据。\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://developer.mozilla.org/zh-CN/docs/Web/API/CloseEvent\"\u003e\u003ccode\u003eCloseEvent\u003c/code\u003e\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e连接关闭时WebSocket对象发送的事件。\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://developer.mozilla.org/zh-CN/docs/Web/API/MessageEvent\"\u003e\u003ccode\u003eMessageEvent\u003c/code\u003e\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e当从服务器获取到消息的时候WebSocket对象触发的事件。\u003c/p\u003e\n\u003cp\u003eWebSocket 不应当用于混合的上下文环境；也就是说，不应该在用HTTPS加载的页面中打开非安全版本的WebSocket，反之亦然。而实际上一些浏览器也明确禁止这一行为，包括 Firefox 8 及更高版本。\u003c/p\u003e\n\u003cp\u003e使用示例：\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e ws = \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eWebSocket\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e'ws://xxx.com/xxx'\u003c/span\u003e)\r\nws.\u003cspan class=\"hljs-title function_\"\u003eaddEventListener\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e'open'\u003c/span\u003e,\u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-params\"\u003ee\u003c/span\u003e=\u003e\u003c/span\u003e{})\r\nws.\u003cspan class=\"hljs-title function_\"\u003eaddEventListener\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e'message'\u003c/span\u003e,\u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-params\"\u003ee\u003c/span\u003e=\u003e\u003c/span\u003e{\r\n    cosnole.\u003cspan class=\"hljs-title function_\"\u003elog\u003c/span\u003e(e.\u003cspan class=\"hljs-property\"\u003edata\u003c/span\u003e)\r\n})\r\nws.\u003cspan class=\"hljs-title function_\"\u003eaddEventListener\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e'error'\u003c/span\u003e,\u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-params\"\u003ee\u003c/span\u003e=\u003e\u003c/span\u003e{})\r\nws.\u003cspan class=\"hljs-title function_\"\u003eaddEventListener\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e'close'\u003c/span\u003e,\u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-params\"\u003ee\u003c/span\u003e=\u003e\u003c/span\u003e{})\r\nws.\u003cspan class=\"hljs-title function_\"\u003esend\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e'hello'\u003c/span\u003e)\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2 id=\"websocket协议主要内容参考rfc-6455\"\u003ewebsocket协议主要内容(参考\u003ca href=\"https://tools.ietf.org/html/rfc6455#page-4\"\u003eRFC 6455\u003c/a\u003e)\u003c/h2\u003e\n\u003cp\u003ewebsocket协议基于TCP协议，通过HTTP进行握手。\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eThe WebSocket Protocol is an independent TCP-based protocol.  Its\r\nonly relationship to HTTP is that its handshake is interpreted by\r\nHTTP servers as an Upgrade request.\u003c/p\u003e\n\u003cp\u003eBy default, the WebSocket Protocol uses port 80 for regular WebSocket\r\nconnections and port 443 for WebSocket connections tunneled over\r\nTransport Layer Security (TLS)\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eThe protocol has two parts: a handshake and the data transfer.\u003c/p\u003e\n\u003ch3 id=\"握手\"\u003e握手\u003c/h3\u003e\n\u003cp\u003eThe handshake from the client looks as follows:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-swift\"\u003e    \u003cspan class=\"hljs-type\"\u003eGET\u003c/span\u003e \u003cspan class=\"hljs-regexp\"\u003e/chat HTTP/\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e1.1\u003c/span\u003e\r\n    \u003cspan class=\"hljs-type\"\u003eHost\u003c/span\u003e: server.example.com\r\n    \u003cspan class=\"hljs-type\"\u003eUpgrade\u003c/span\u003e: websocket  \u003cspan class=\"hljs-comment\"\u003e// 将协议升级为websocket\u003c/span\u003e\r\n    \u003cspan class=\"hljs-type\"\u003eConnection\u003c/span\u003e: \u003cspan class=\"hljs-type\"\u003eUpgrade\u003c/span\u003e \u003cspan class=\"hljs-comment\"\u003e// 升级协议\u003c/span\u003e\r\n    \u003cspan class=\"hljs-type\"\u003eSec\u003c/span\u003e\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003e\u003cspan class=\"hljs-type\"\u003eWebSocket\u003c/span\u003e\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003e\u003cspan class=\"hljs-type\"\u003eKey\u003c/span\u003e: dGhlIHNhbXBsZSBub25jZQ\u003cspan class=\"hljs-operator\"\u003e==\u003c/span\u003e \u003cspan class=\"hljs-comment\"\u003e// \u003c/span\u003e\r\n    \u003cspan class=\"hljs-type\"\u003eOrigin\u003c/span\u003e: http:\u003cspan class=\"hljs-comment\"\u003e//example.com\u003c/span\u003e\r\n    \u003cspan class=\"hljs-type\"\u003eSec\u003c/span\u003e\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003e\u003cspan class=\"hljs-type\"\u003eWebSocket\u003c/span\u003e\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003e\u003cspan class=\"hljs-type\"\u003eProtocol\u003c/span\u003e: chat, superchat \u003cspan class=\"hljs-comment\"\u003e// 期望使用的子协议\u003c/span\u003e\r\n    \u003cspan class=\"hljs-type\"\u003eSec\u003c/span\u003e\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003e\u003cspan class=\"hljs-type\"\u003eWebSocket\u003c/span\u003e\u003cspan class=\"hljs-operator\"\u003e-\u003c/span\u003e\u003cspan class=\"hljs-type\"\u003eVersion\u003c/span\u003e: \u003cspan class=\"hljs-number\"\u003e13\u003c/span\u003e \u003cspan class=\"hljs-comment\"\u003e// websocket版本\u003c/span\u003e\r\n    \u003cspan class=\"hljs-comment\"\u003e// ...其他http请求头\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThe handshake from the server looks as follows:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-yaml\"\u003e    \u003cspan class=\"hljs-string\"\u003eHTTP/1.1\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e101\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eSwitching\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eProtocols\u003c/span\u003e\r\n    \u003cspan class=\"hljs-attr\"\u003eUpgrade:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ewebsocket\u003c/span\u003e\r\n    \u003cspan class=\"hljs-attr\"\u003eConnection:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eUpgrade\u003c/span\u003e\r\n    \u003cspan class=\"hljs-attr\"\u003eSec-WebSocket-Accept:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003es3pPLMBiTxaQ9kYGzzhZRbK+xOo=\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e//\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003ebase64(SHA1(Sec-WebSocket-Key\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e+\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003eGUID))\u003c/span\u003e\r\n    \u003cspan class=\"hljs-attr\"\u003eSec-WebSocket-Protocol:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003echat\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e//\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e确定使用的子协议\u003c/span\u003e\r\n    \u003cspan class=\"hljs-attr\"\u003eSec-WebSocket-Version:\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e13\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e//\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e如果不支持请求头中的版本，则发回支持的websocket版本\u003c/span\u003e\r\n    \u003cspan class=\"hljs-string\"\u003e//\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e...其他http响应头\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e其中\u003ccode\u003eSec-WebSocket-Accept\u003c/code\u003e的值是由\u003ccode\u003eSec-WebSocket-Key\u003c/code\u003e和\u003ccode\u003eGUID\u003c/code\u003e拼接，拼接后进行SHA1编码，然后再编码为base64格式的字符串。GUID是一个常量字符串。\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eGlobally Unique Identifier (GUID, \u003ca href=\"https://tools.ietf.org/html/rfc4122\"\u003e[RFC4122]\u003c/a\u003e) \"258EAFA5-E914-47DA-95CA-C5AB0DC85B11\"\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003ch3 id=\"数据\"\u003e数据\u003c/h3\u003e\n\u003cp\u003e数据是通过一个或多个数据帧来传送，单个数据帧的格式如下：\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-lua\"\u003e      \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e                   \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e                   \u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e                   \u003cspan class=\"hljs-number\"\u003e3\u003c/span\u003e\r\n      \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e3\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e4\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e5\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e6\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e7\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e8\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e9\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e3\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e4\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e5\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e6\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e7\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e8\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e9\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e3\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e4\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e5\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e6\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e7\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e8\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e9\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e\r\n     +-+-+-+-+\u003cspan class=\"hljs-comment\"\u003e-------+-+-------------+-------------------------------+\u003c/span\u003e\r\n     |F|R|R|R| opcode|M| Payload \u003cspan class=\"hljs-built_in\"\u003elen\u003c/span\u003e |    Extended payload length    |\r\n     |I|S|S|S|  (\u003cspan class=\"hljs-number\"\u003e4\u003c/span\u003e)  |A|     (\u003cspan class=\"hljs-number\"\u003e7\u003c/span\u003e)     |             (\u003cspan class=\"hljs-number\"\u003e16\u003c/span\u003e/\u003cspan class=\"hljs-number\"\u003e64\u003c/span\u003e)           |\r\n     |N|V|V|V|       |S|             |   (\u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e payload \u003cspan class=\"hljs-built_in\"\u003elen\u003c/span\u003e==\u003cspan class=\"hljs-number\"\u003e126\u003c/span\u003e/\u003cspan class=\"hljs-number\"\u003e127\u003c/span\u003e)   |\r\n     | |\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e|\u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e|\u003cspan class=\"hljs-number\"\u003e3\u003c/span\u003e|       |K|             |                               |\r\n     +-+-+-+-+\u003cspan class=\"hljs-comment\"\u003e-------+-+-------------+ - - - - - - - - - - - - - - - +\u003c/span\u003e\r\n     |     Extended payload length continued, \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e payload \u003cspan class=\"hljs-built_in\"\u003elen\u003c/span\u003e == \u003cspan class=\"hljs-number\"\u003e127\u003c/span\u003e  |\r\n     + - - - - - - - - - - - - - - - +\u003cspan class=\"hljs-comment\"\u003e-------------------------------+\u003c/span\u003e\r\n     |                               |Masking-key, \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e MASK set to \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e  |\r\n     +\u003cspan class=\"hljs-comment\"\u003e-------------------------------+-------------------------------+\u003c/span\u003e\r\n     | Masking-key (continued)       |          Payload Data         |\r\n     +\u003cspan class=\"hljs-comment\"\u003e-------------------------------- - - - - - - - - - - - - - - - +\u003c/span\u003e\r\n     :                     Payload Data continued ...                :\r\n     + - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - +\r\n     |                     Payload Data continued ...                |\r\n     +\u003cspan class=\"hljs-comment\"\u003e---------------------------------------------------------------+\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eFIN：1 bit，是否为最后一个数据帧。\u003c/p\u003e\n\u003cp\u003eRSV1, RSV2, RSV3：1 bit each，一般都为0，当需要拓展协议时供拓展使用。\u003c/p\u003e\n\u003cp\u003eopcode：4 bits，用于解释\"Payload data\"的作用，如果接收到无法识别的opcode则接收失败\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\n\u003cp\u003e0x0：连续帧\u003c/p\u003e\n\u003col start=\"2\"\u003e\n\u003cli\u003e0x1：文本帧\u003c/li\u003e\n\u003cli\u003e0x2：二进制帧\u003c/li\u003e\n\u003cli\u003e0x3-0x7：保留用于其他非控制帧\u003c/li\u003e\n\u003cli\u003e0x8：关闭连接\u003c/li\u003e\n\u003cli\u003e0x9：ping\u003c/li\u003e\n\u003cli\u003e0xA：pong\u003c/li\u003e\n\u003cli\u003e0xB-0xF：保留用于其他控制帧\u003c/li\u003e\n\u003c/ol\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eMask：1 bit，\"Payload data\"是否经过掩码处理，值为1时需要设置“Masking-key”。客户端发送数据时必须为1。\u003c/p\u003e\n\u003cp\u003ePayload length:  7 bits, 7+16 bits, or 7+64 bits，\u003c/p\u003e\n\u003cp\u003eMasking-key:  0 or 4 bytes，掩码\u003c/p\u003e\n\u003cp\u003ePayload data：实际数据内容\u003c/p\u003e\n\u003cp\u003e编码/解码\u003c/p\u003e\n\u003cp\u003e随机生成一个32位的掩码，然后通过以下算法计算编码/解码后的数据：\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-ini\"\u003e\u003cspan class=\"hljs-attr\"\u003ej\u003c/span\u003e = i MOD \u003cspan class=\"hljs-number\"\u003e4\u003c/span\u003e\r\n\u003cspan class=\"hljs-attr\"\u003etransformed-octet-i\u003c/span\u003e = original-octet-i XOR masking-key-octet-j\r\n即\r\n掩码的第1个字节与数据的第1个字节进行按位异或运算，得到编码/解码后的第1个字节\r\n掩码的第2个字节与数据的第2个字节进行按位异或运算，得到编码/解码/解码后的第2个字节\r\n掩码的第3个字节与数据的第3个字节进行按位异或运算，得到编码/解码后的第3个字节\r\n掩码的第4个字节与数据的第4个字节进行按位异或运算，得到编码/解码后的第4个字节\r\n掩码的第1个字节与数据的第5个字节进行按位异或运算，得到编码/解码后的第5个字节\r\n掩码的第2个字节与数据的第6个字节进行按位异或运算，得到编码/解码后的第6个字节\r\n直到全部编码/解码完成\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2 id=\"websocket协议简单实现nodejs\"\u003ewebsocket协议简单实现(nodejs)\u003c/h2\u003e\n\u003cp\u003eserver.js\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-meta\"\u003e\r\n'use strict'\u003c/span\u003e;\r\n\r\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e http = \u003cspan class=\"hljs-built_in\"\u003erequire\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e'http'\u003c/span\u003e)\r\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e fs = \u003cspan class=\"hljs-built_in\"\u003erequire\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e'fs'\u003c/span\u003e)\r\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e crypto = \u003cspan class=\"hljs-built_in\"\u003erequire\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e'crypto'\u003c/span\u003e)\r\n\r\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-variable constant_\"\u003eGUID\u003c/span\u003e = \u003cspan class=\"hljs-string\"\u003e'258EAFA5-E914-47DA-95CA-C5AB0DC85B11'\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e hostname = \u003cspan class=\"hljs-string\"\u003e'localhost'\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e port = \u003cspan class=\"hljs-number\"\u003e8080\u003c/span\u003e\r\n\r\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e server = http.\u003cspan class=\"hljs-title function_\"\u003ecreateServer\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e(\u003cspan class=\"hljs-params\"\u003ereq,res\u003c/span\u003e)=\u003e\u003c/span\u003e{\r\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e {url} = req\r\n    res.\u003cspan class=\"hljs-title function_\"\u003esetHeader\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e'Content-Type'\u003c/span\u003e,\u003cspan class=\"hljs-string\"\u003e'utf8'\u003c/span\u003e)\r\n    \r\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e(url === \u003cspan class=\"hljs-string\"\u003e'/'\u003c/span\u003e){\r\n        res.\u003cspan class=\"hljs-title function_\"\u003ewriteHead\u003c/span\u003e(\u003cspan class=\"hljs-number\"\u003e200\u003c/span\u003e, { \u003cspan class=\"hljs-string\"\u003e'Content-Type'\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e'text/html'\u003c/span\u003e })\r\n        fs.\u003cspan class=\"hljs-title function_\"\u003ereadFile\u003c/span\u003e(__dirname + \u003cspan class=\"hljs-string\"\u003e\"/index.html\"\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\"utf-8\"\u003c/span\u003e, \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e (\u003cspan class=\"hljs-params\"\u003eerror, data\u003c/span\u003e){\r\n            \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e(error)\r\n                res.\u003cspan class=\"hljs-title function_\"\u003eend\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\"404\"\u003c/span\u003e);\r\n            \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e\r\n                res.\u003cspan class=\"hljs-title function_\"\u003eend\u003c/span\u003e(data.\u003cspan class=\"hljs-title function_\"\u003etoString\u003c/span\u003e());\r\n        });\r\n    }\u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\r\n        res.\u003cspan class=\"hljs-title function_\"\u003eend\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e'404'\u003c/span\u003e)\r\n    }\r\n}).\u003cspan class=\"hljs-title function_\"\u003eon\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e'upgrade'\u003c/span\u003e,\u003cspan class=\"hljs-function\"\u003e(\u003cspan class=\"hljs-params\"\u003ereq, socket,head\u003c/span\u003e)=\u003e\u003c/span\u003e{\r\n    \r\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e {headers} = req\r\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e key = crypto.\u003cspan class=\"hljs-title function_\"\u003ecreateHash\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e'sha1'\u003c/span\u003e).\u003cspan class=\"hljs-title function_\"\u003eupdate\u003c/span\u003e(headers[\u003cspan class=\"hljs-string\"\u003e\"sec-websocket-key\"\u003c/span\u003e]+\u003cspan class=\"hljs-variable constant_\"\u003eGUID\u003c/span\u003e).\u003cspan class=\"hljs-title function_\"\u003edigest\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e'base64'\u003c/span\u003e)\r\n    \u003cspan class=\"hljs-comment\"\u003e// 握手\u003c/span\u003e\r\n    socket.\u003cspan class=\"hljs-title function_\"\u003ewrite\u003c/span\u003e([\r\n        \u003cspan class=\"hljs-string\"\u003e'HTTP/1.1 101 Switching Protocols'\u003c/span\u003e,\r\n        \u003cspan class=\"hljs-string\"\u003e'Upgrade: websocket'\u003c/span\u003e,\r\n        \u003cspan class=\"hljs-string\"\u003e'Connection: Upgrade'\u003c/span\u003e,\r\n        \u003cspan class=\"hljs-string\"\u003e`sec-websocket-accept: \u003cspan class=\"hljs-subst\"\u003e${key}\u003c/span\u003e`\u003c/span\u003e\r\n    ].\u003cspan class=\"hljs-title function_\"\u003ejoin\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e'\\r\\n'\u003c/span\u003e)+\u003cspan class=\"hljs-string\"\u003e'\\r\\n\\r\\n'\u003c/span\u003e)\r\n    \r\n    \u003cspan class=\"hljs-comment\"\u003e// 接收数据\u003c/span\u003e\r\n    socket.\u003cspan class=\"hljs-title function_\"\u003eon\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e'data'\u003c/span\u003e, \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e (\u003cspan class=\"hljs-params\"\u003ebuf\u003c/span\u003e) {\r\n        \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e values = \u003cspan class=\"hljs-string\"\u003e''\u003c/span\u003e\r\n        \u003cspan class=\"hljs-keyword\"\u003efor\u003c/span\u003e(\u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e value \u003cspan class=\"hljs-keyword\"\u003eof\u003c/span\u003e buf.\u003cspan class=\"hljs-title function_\"\u003evalues\u003c/span\u003e()){\r\n            values += value.\u003cspan class=\"hljs-title function_\"\u003etoString\u003c/span\u003e(\u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e)\r\n        }\r\n        \u003cspan class=\"hljs-variable language_\"\u003econsole\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003elog\u003c/span\u003e(values) \r\n        \u003cspan class=\"hljs-comment\"\u003e// 10000001 10000111 10010001 01011010 11010011 01010100 11111001 00111111 10111111 00111000 11111110 01110100 11111101\u003c/span\u003e\r\n        \u003cspan class=\"hljs-variable language_\"\u003econsole\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003elog\u003c/span\u003e(\u003cspan class=\"hljs-title function_\"\u003edecodeFrame\u003c/span\u003e(buf)) \u003cspan class=\"hljs-comment\"\u003e// hello..\u003c/span\u003e\r\n    });\r\n    \r\n    \u003cspan class=\"hljs-comment\"\u003e// 发送数据\u003c/span\u003e\r\n    socket.\u003cspan class=\"hljs-title function_\"\u003esend\u003c/span\u003e(\u003cspan class=\"hljs-title function_\"\u003eencodeFrame\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e'hi'\u003c/span\u003e))\r\n}).\u003cspan class=\"hljs-title function_\"\u003elisten\u003c/span\u003e(port,hostname,\u003cspan class=\"hljs-function\"\u003e()=\u003e\u003c/span\u003e{\r\n    \u003cspan class=\"hljs-variable language_\"\u003econsole\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003elog\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e'server started, click http://'\u003c/span\u003e+hostname+\u003cspan class=\"hljs-string\"\u003e':'\u003c/span\u003e+port+\u003cspan class=\"hljs-string\"\u003e' to view the page'\u003c/span\u003e)\r\n})\r\n\r\n\u003cspan class=\"hljs-comment\"\u003e// 解码\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003edecodeFrame\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003ebuf\u003c/span\u003e) {\r\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e length = buf.\u003cspan class=\"hljs-title function_\"\u003ereadUInt8\u003c/span\u003e(\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e) \u0026#x26; \u003cspan class=\"hljs-number\"\u003e0x7f\u003c/span\u003e\r\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e mask = buf.\u003cspan class=\"hljs-title function_\"\u003eslice\u003c/span\u003e(\u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e,\u003cspan class=\"hljs-number\"\u003e6\u003c/span\u003e)\r\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e payload = buf.\u003cspan class=\"hljs-title function_\"\u003eslice\u003c/span\u003e(\u003cspan class=\"hljs-number\"\u003e6\u003c/span\u003e)\r\n    \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e formattedBuf = \u003cspan class=\"hljs-title class_\"\u003eBuffer\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003ealloc\u003c/span\u003e(payload.\u003cspan class=\"hljs-property\"\u003elength\u003c/span\u003e)\r\n    \u003cspan class=\"hljs-keyword\"\u003efor\u003c/span\u003e(\u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e i=\u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e;i\u0026#x3C;payload.\u003cspan class=\"hljs-property\"\u003elength\u003c/span\u003e;i++) {\r\n        formattedBuf[i] = mask[i%\u003cspan class=\"hljs-number\"\u003e4\u003c/span\u003e] ^ payload[i]\r\n    }\r\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e formattedBuf\r\n}\r\n\r\n\u003cspan class=\"hljs-comment\"\u003e// 编码\u003c/span\u003e\r\n\u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eencodeFrame\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003estr\u003c/span\u003e) {\r\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e payload = \u003cspan class=\"hljs-title class_\"\u003eBuffer\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003efrom\u003c/span\u003e(str)\r\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e frame = \u003cspan class=\"hljs-title class_\"\u003eBuffer\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003ealloc\u003c/span\u003e(payload.\u003cspan class=\"hljs-property\"\u003elength\u003c/span\u003e+\u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e)\r\n    frame.\u003cspan class=\"hljs-title function_\"\u003ewriteUInt8\u003c/span\u003e(\u003cspan class=\"hljs-number\"\u003e0b10000001\u003c/span\u003e)\r\n    frame.\u003cspan class=\"hljs-title function_\"\u003ewriteUInt8\u003c/span\u003e(\u003cspan class=\"hljs-number\"\u003e0b00000010\u003c/span\u003e,\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e)\r\n    payload.\u003cspan class=\"hljs-title function_\"\u003ecopy\u003c/span\u003e(frame,\u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e)\r\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e frame\r\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eindex.html\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-html\"\u003e\u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;\u003cspan class=\"hljs-name\"\u003ehtml\u003c/span\u003e\u003e\u003c/span\u003e\r\n  \u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;\u003cspan class=\"hljs-name\"\u003ehead\u003c/span\u003e\u003e\u003c/span\u003e\r\n    \u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;\u003cspan class=\"hljs-name\"\u003emeta\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003echarset\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e\"utf-8\"\u003c/span\u003e/\u003e\u003c/span\u003e\r\n  \u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;/\u003cspan class=\"hljs-name\"\u003ehead\u003c/span\u003e\u003e\u003c/span\u003e\r\n  \u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;\u003cspan class=\"hljs-name\"\u003ebody\u003c/span\u003e\u003e\u003c/span\u003e\r\n    \u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;\u003cspan class=\"hljs-name\"\u003ediv\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003eid\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e\"container\"\u003c/span\u003e\u003e\u003c/span\u003e\u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;/\u003cspan class=\"hljs-name\"\u003ediv\u003c/span\u003e\u003e\u003c/span\u003e\r\n    \u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;\u003cspan class=\"hljs-name\"\u003escript\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003etype\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e\"text/babel\"\u003c/span\u003e\u003e\u003c/span\u003e\u003cspan class=\"javascript\"\u003e\r\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e client = \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eWebSocket\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e'ws://localhost:8080'\u003c/span\u003e)\r\n    client.\u003cspan class=\"hljs-title function_\"\u003eaddEventListener\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e'message'\u003c/span\u003e, \u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-params\"\u003ee\u003c/span\u003e=\u003e\u003c/span\u003e{\r\n      \u003cspan class=\"hljs-variable language_\"\u003econsole\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003elog\u003c/span\u003e(e)\r\n    })\r\n    client.\u003cspan class=\"hljs-title function_\"\u003eaddEventListener\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e'open'\u003c/span\u003e, \u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-params\"\u003ee\u003c/span\u003e=\u003e\u003c/span\u003e{\r\n      client.\u003cspan class=\"hljs-title function_\"\u003esend\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e'hello..'\u003c/span\u003e)\r\n    })\r\n    \u003c/span\u003e\u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;/\u003cspan class=\"hljs-name\"\u003escript\u003c/span\u003e\u003e\u003c/span\u003e\r\n  \u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;/\u003cspan class=\"hljs-name\"\u003ebody\u003c/span\u003e\u003e\u003c/span\u003e\r\n\u003cspan class=\"hljs-tag\"\u003e\u0026#x3C;/\u003cspan class=\"hljs-name\"\u003ehtml\u003c/span\u003e\u003e\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e"])</script><script>self.__next_f.push([1,"5:[\"$\",\"div\",null,{\"children\":[[\"$\",\"h1\",null,{\"className\":\"text-3xl font-semibold\",\"children\":\"websocket\"}],[\"$\",\"div\",null,{\"className\":\"fixed right-12 bottom-20 \",\"children\":[\"$\",\"$L13\",null,{\"toc\":\"\\n\u003cul\u003e\\n\u003cli\u003e\u003ca href=\\\"#%E4%BB%8B%E7%BB%8D\\\"\u003e介绍\u003c/a\u003e\u003c/li\u003e\\n\u003cli\u003e\u003ca href=\\\"#web-api\\\"\u003eweb api\u003c/a\u003e\u003c/li\u003e\\n\u003cli\u003e\u003ca href=\\\"#websocket%E5%8D%8F%E8%AE%AE%E4%B8%BB%E8%A6%81%E5%86%85%E5%AE%B9%E5%8F%82%E8%80%83rfc-6455\\\"\u003ewebsocket协议主要内容(参考RFC 6455)\u003c/a\u003e\\n\u003cul\u003e\\n\u003cli\u003e\u003ca href=\\\"#%E6%8F%A1%E6%89%8B\\\"\u003e握手\u003c/a\u003e\u003c/li\u003e\\n\u003cli\u003e\u003ca href=\\\"#%E6%95%B0%E6%8D%AE\\\"\u003e数据\u003c/a\u003e\u003c/li\u003e\\n\u003c/ul\u003e\\n\u003c/li\u003e\\n\u003cli\u003e\u003ca href=\\\"#websocket%E5%8D%8F%E8%AE%AE%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0nodejs\\\"\u003ewebsocket协议简单实现(nodejs)\u003c/a\u003e\u003c/li\u003e\\n\u003c/ul\u003e\"}]}],[\"$\",\"div\",null,{\"className\":\"page_content__nM6Lc\",\"dangerouslySetInnerHTML\":{\"__html\":\"$14\"}}]]}]\n10:[[\"$\",\"meta\",\"0\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}],[\"$\",\"meta\",\"1\",{\"charSet\":\"utf-8\"}],[\"$\",\"title\",\"2\",{\"children\":\"文章 | websocket\"}],[\"$\",\"meta\",\"3\",{\"name\":\"description\",\"content\":\"新宸悦雨 博客 网站 个人网站\"}],[\"$\",\"meta\",\"4\",{\"name\":\"google-site-verification\",\"content\":\"LiZ4kQwHGTLadwCnDnrXngpwNqoQjmFOCOVTtr_PWVo\"}],[\"$\",\"link\",\"5\",{\"rel\":\"icon\",\"href\":\"/icon.svg?d2cf70afa15ddfd8\",\"type\":\"image/svg+xml\",\"sizes\":\"any\"}]]\n4:null\n"])</script></body></html>